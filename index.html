<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d1b3e">
<title>Mi App</title>
<link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAzkm6TXJEXeHD32lQo5p8Ic5OQjxGhyfc",
    authDomain: "strattpllaner.firebaseapp.com",
    projectId: "strattpllaner",
    storageBucket: "strattpllaner.firebasestorage.app",
    messagingSenderId: "472334811137",
    appId: "1:472334811137:web:020c74f3b535ba2c29c000",
    measurementId: "G-PLFH68F2FK"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  window._fbAuth = auth;
  window._fbDb   = db;

  // Map modular-style functions to compat equivalents
  window._fbFns = {
    signInWithEmailAndPassword: (a, email, pass) => a.signInWithEmailAndPassword(email, pass),
    createUserWithEmailAndPassword: (a, email, pass) => a.createUserWithEmailAndPassword(email, pass),
    sendPasswordResetEmail: (a, email) => a.sendPasswordResetEmail(email),
    signOut: (a) => a.signOut(),
    onAuthStateChanged: (a, cb) => a.onAuthStateChanged(cb),
    doc: (db, ...path) => {
      if (path.length === 1 && typeof path[0] === 'string' && path[0].includes('/')) {
        path = path[0].split('/');
      }
      let ref = db;
      for (let i = 0; i < path.length; i += 2) {
        ref = ref.collection(path[i]).doc(path[i+1]);
      }
      return ref;
    },
    collection: (db, ...path) => {
      if (path.length === 1 && typeof path[0] === 'string' && path[0].includes('/')) {
        path = path[0].split('/');
      }
      let ref = db;
      for (let i = 0; i < path.length; i++) {
        ref = i % 2 === 0 ? ref.collection(path[i]) : ref.doc(path[i]);
      }
      return ref;
    },
    setDoc: (ref, data, opts) => opts?.merge ? ref.set(data, { merge: true }) : ref.set(data),
    getDoc: async (ref) => {
      const snap = await ref.get();
      return { exists: () => snap.exists, data: () => snap.data(), id: snap.id };
    },
    getDocs: async (q) => {
      const snap = await q.get();
      const docs = [];
      snap.forEach(d => docs.push({ id: d.id, data: () => d.data() }));
      return { forEach: (cb) => docs.forEach(cb), docs };
    },
    addDoc: (ref, data) => ref.add(data),
    updateDoc: (ref, data) => ref.update(data),
    deleteDoc: (ref) => ref.delete(),
    query: (ref, ...constraints) => {
      let q = ref;
      constraints.forEach(c => { q = c(q); });
      return q;
    },
    where: (field, op, val) => (ref) => ref.where(field, op, val),
    orderBy: (field, dir) => (ref) => ref.orderBy(field, dir || 'asc'),
    limit: (n) => (ref) => ref.limit(n),
    startAt: (...args) => (ref) => ref.startAt(...args),
    endAt: (...args) => (ref) => ref.endAt(...args),
    arrayUnion: (...items) => firebase.firestore.FieldValue.arrayUnion(...items),
    arrayRemove: (...items) => firebase.firestore.FieldValue.arrayRemove(...items),
    serverTimestamp: () => firebase.firestore.FieldValue.serverTimestamp(),
    onSnapshot: (ref, cb, errCb) => ref.onSnapshot(snap => {
      const docs = [];
      snap.forEach(d => docs.push({ id: d.id, data: () => d.data() }));
      cb({ forEach: (fn) => docs.forEach(fn), docs });
    }, errCb || (() => {})),
  };

  // Listen for auth state changes
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      try {
        const snap = await db.collection('users').doc(user.uid).get();
        if (snap.exists) {
          const data = snap.data();
          window._fbCurrentUser = user;
          window._fbUserData    = data;
          if (typeof restoreSaveData === 'function') {
            regData.email = user.email;
            restoreSaveData(data);
            setTimeout(restoreProfilePhoto, 150);
          }
          const splash = document.getElementById('splash-screen');
          if (splash && !splash.classList.contains('hidden')) {
            splash.classList.add('hidden');
            if (typeof showToast === 'function') showToast('Sesión restaurada ✓');
          }
        }
      } catch(e) { console.warn('Load data error:', e); }
    }
  });
</script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
/* iOS: prevent 300ms tap delay and fix touch events everywhere */
button, [onclick], .nav-btn, .panel-item, .block, .streak-section,
.mascota-type-btn, .mascota-color-dot, .mascota-acc-btn,
.tsk-item, .task-item, .splash-tab, .back-btn, .add-btn {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  cursor: pointer;
}
html {
  height:100%; height:100dvh;
  overflow:hidden;
  overscroll-behavior:none;
  background:#0d1b3e;
}
:root {
  --navy:#0d1b3e; --navy-mid:#122050; --teal:#2a6496; --teal-light:#3a85c4;
  --yellow:#f0c040; --green:#5edc8a; --pink:#e8527a; --purple:#8b62e0;
  --blue-block:#2d6fa0;
}
body {
  background:var(--navy); display:flex; justify-content:center;
  align-items:flex-start; min-height:100vh; min-height:100dvh;
  font-family:"Nunito",sans-serif; padding:0; margin:0;
  overflow:hidden;
}
.phone {
  width:100%; max-width:480px;
  height:100vh; height:100dvh;
  background:var(--navy);
  border-radius:0; padding:22px 20px 0; position:relative;
  display:flex; flex-direction:column; gap:14px; overflow:hidden;
}

/* TOP BAR */
.top-bar { display:flex; justify-content:space-between; align-items:center; }
.add-btn {
  width:44px; height:28px; background:var(--teal); border-radius:20px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; transition:transform .15s; box-shadow:0 4px 12px rgba(42,100,150,.5);
}
.add-btn:hover { transform:scale(1.08); }
.add-btn span { color:#fff; font-size:20px; font-weight:800; line-height:1; }
.profile-card {
  background:var(--navy-mid); border:2px solid var(--teal); border-radius:10px;
  width:82px; height:82px; position:relative; overflow:visible;
  cursor:pointer; transition:transform .2s;
}
.profile-card:hover { transform:scale(1.04); }
.profile-default {
  width:100%; height:100%; display:flex; align-items:center; justify-content:center;
  font-size:34px; background:linear-gradient(135deg,var(--teal),var(--navy-mid)); border-radius:8px;
}
.xp-badge {
  position:absolute; top:-8px; left:-8px; background:var(--navy);
  border:2px solid var(--yellow); border-radius:12px; padding:1px 7px;
  display:flex; align-items:center; gap:4px; font-size:11px; font-weight:800; color:var(--yellow);
  z-index:10;
}

/* USERNAME */
.username-section { display:flex; align-items:center; gap:8px; margin-top:-4px; }
.username-label {
  font-family:'Special Elite',cursive; color:#fff; font-size:15px; cursor:pointer;
  border-bottom:1.5px solid rgba(255,255,255,.35); padding-bottom:2px; flex:1; transition:border-color .2s;
}
.username-label:hover { border-color:var(--teal-light); }
.username-edit {
  display:none; flex:1; background:transparent; border:none;
  border-bottom:2px solid var(--teal-light); color:#fff;
  font-family:'Special Elite',cursive; font-size:15px; outline:none; padding-bottom:2px;
}

/* STREAK */
.streak-section {
  background:linear-gradient(135deg,#1a2a50,#0f1e3a);
  border:1.5px solid rgba(240,192,64,.35); border-radius:18px;
  padding:12px 14px 10px; display:flex; align-items:center; gap:0;
  cursor:pointer; transition:transform .15s;
  flex-direction:column;
}
.streak-section:hover { transform:scale(1.01); }
.streak-section-top { display:flex; align-items:center; gap:12px; width:100%; }
.streak-fire { font-size:28px; line-height:1; flex-shrink:0; }
.streak-info { flex:1; min-width:0; }
.streak-title { color:rgba(255,255,255,.5); font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; }
.streak-count { color:var(--yellow); font-size:24px; font-weight:800; line-height:1.1; }
.streak-sub { color:rgba(255,255,255,.4); font-size:10px; }
.streak-dots { display:flex; gap:4px; flex-wrap:wrap; max-width:80px; }
.streak-dot { width:10px; height:10px; border-radius:50%; background:rgba(255,255,255,.1); }
.streak-dot.done { background:var(--yellow); }
.streak-dot.today-dot { background:var(--green); }

/* ── Home pet strip ── */
.streak-pet-strip {
  width:100%; display:flex; align-items:center; gap:10px;
  border-top:1px solid rgba(255,255,255,.07); margin-top:10px; padding-top:9px;
}
.home-pet-wrap {
  position:relative; width:52px; height:52px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
}
.home-pet-glow {
  position:absolute; inset:-4px; border-radius:50%;
  opacity:.5; filter:blur(10px); pointer-events:none;
  transition:background .4s;
}
.home-pet-emoji {
  font-size:34px; line-height:1; position:relative; z-index:1;
  animation:homePetBounce 2.8s ease-in-out infinite;
  transition:filter .4s;
}
@keyframes homePetBounce {
  0%,100% { transform:translateY(0) rotate(-3deg) scale(1); }
  50%      { transform:translateY(-5px) rotate(3deg) scale(1.07); }
}
.streak-section.legendary .home-pet-emoji {
  animation:homePetLegendary 2s ease-in-out infinite;
}
@keyframes homePetLegendary {
  0%,100% { transform:translateY(0) rotate(-4deg) scale(1); filter:drop-shadow(0 0 10px rgba(180,100,255,.9)); }
  50%      { transform:translateY(-8px) rotate(4deg) scale(1.12); filter:drop-shadow(0 0 20px rgba(180,100,255,1)); }
}
.streak-section.sad-pet .home-pet-emoji {
  animation:homePetSad 2.5s ease-in-out infinite;
  filter:grayscale(.5) brightness(.75) !important;
}
@keyframes homePetSad {
  0%,100% { transform:translateY(0) rotate(-1deg); }
  50%      { transform:translateY(3px) rotate(1deg); }
}

/* Home pet accessories (small) */
.home-pet-acc-hat    { position:absolute; top:-10px; left:50%; transform:translateX(-40%); font-size:16px; z-index:2; pointer-events:none; }
.home-pet-acc-collar { position:absolute; bottom:2px;  left:50%; transform:translateX(-50%); font-size:12px; z-index:2; pointer-events:none; }
.home-pet-acc-wand   { position:absolute; right:-4px;  top:4px;  font-size:14px; z-index:2; pointer-events:none; }

.home-pet-info { flex:1; min-width:0; }
.home-pet-name {
  color:#fff; font-size:12px; font-weight:800;
  font-family:'Special Elite',cursive; white-space:nowrap;
  overflow:hidden; text-overflow:ellipsis;
}
.home-pet-mood { color:rgba(255,255,255,.4); font-size:10px; margin-top:1px; }
.home-pet-hp-row { display:flex; align-items:center; gap:6px; margin-top:4px; }
.home-pet-hp-track {
  flex:1; height:4px; background:rgba(255,255,255,.08); border-radius:4px; overflow:hidden;
}
.home-pet-hp-fill {
  height:100%; border-radius:4px;
  transition:width .6s ease, background .4s;
}
.home-pet-lvl {
  font-size:9px; font-weight:800; color:rgba(255,255,255,.35);
  white-space:nowrap; flex-shrink:0;
}

/* BLOCKS */
.blocks-section {
  display:flex; flex-wrap:nowrap; gap:5px; padding:0;
  background:transparent; justify-content:space-between;
}
.block {
  border-radius:12px; transition:transform .2s,filter .2s; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  flex:1; height:32px;
}
.block:hover { transform:scale(1.08); filter:brightness(1.2); }
.block .b-icon { font-size:16px; line-height:1; }
.b1{background:var(--blue-block);}
.b2{background:var(--yellow);}
.b3{background:var(--blue-block);}
.b4{background:var(--green);}
.b5{background:var(--purple);}
.b6{background:var(--pink);}

/* CALENDAR + CHART */
.cal-chart-row { display:flex; gap:10px; align-items:stretch; }

.calendar-section {
  background:var(--cal-bg, rgba(255,255,255,.06)); border-radius:14px; padding:8px 8px 10px;
  flex:0 0 50%; box-shadow:0 4px 20px rgba(0,0,0,.3);
  display:flex; flex-direction:column; gap:4px;
  border:1.5px solid var(--cal-border, rgba(255,255,255,.1));
  transition:background .5s, border-color .5s;
}
.cal-nav { display:flex; align-items:center; justify-content:space-between; }
.cal-title { font-family:'Special Elite',cursive; font-size:11px; color:var(--cal-text, rgba(255,255,255,.9)); text-align:center; flex:1; }
.cal-arrow {
  width:18px; height:18px; background:var(--cal-arrow-bg, rgba(255,255,255,.1)); border-radius:50%; border:none;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:11px; color:var(--cal-text, rgba(255,255,255,.8)); transition:background .15s; flex-shrink:0;
}
.cal-arrow:hover { background:var(--cal-arrow-hover, rgba(255,255,255,.2)); }
.cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; width:100%; }
.cal-header { font-size:7px; font-weight:800; color:var(--cal-header-color, rgba(255,255,255,.35)); text-align:center; padding:2px 0; text-transform:uppercase; }
.cal-day {
  aspect-ratio:1; display:flex; align-items:center; justify-content:center;
  font-size:8px; border-radius:50%; cursor:pointer; color:var(--cal-day-color, rgba(255,255,255,.8));
  font-weight:600; transition:background .15s;
}
.cal-day:hover { background:var(--cal-hover, rgba(255,255,255,.12)); }
.cal-day.today { background:var(--teal); color:#fff; }
.cal-day.marked { background:var(--yellow); color:#333; }
.cal-day.in-selected-week { background:var(--cal-week-bg, rgba(255,255,255,.08)); border-radius:4px; }
.cal-day.in-selected-week.today { background:var(--teal); border-radius:50%; }
.cal-day.empty { cursor:default; pointer-events:none; }

/* CHART */
.chart-section {
  flex:1; background:var(--navy-mid); border-radius:12px; padding:10px 8px;
  display:flex; flex-direction:column; gap:5px; justify-content:space-between;
  transition:background .5s; border:1.5px solid rgba(255,255,255,.06);
}
.chart-header { display:flex; align-items:center; justify-content:space-between; }
.chart-title { color:rgba(255,255,255,.5); font-size:9px; font-weight:800; text-transform:uppercase; letter-spacing:.8px; }
.chart-week-label { color:var(--yellow); font-size:8px; font-weight:800; }
.chart-bars { display:flex; align-items:flex-end; gap:3px; height:68px; }
.chart-bar-wrap { display:flex; flex-direction:column; align-items:center; gap:2px; flex:1; }
.chart-bar { width:100%; border-radius:4px 4px 0 0; min-height:3px; transition:height .5s cubic-bezier(.34,1.56,.64,1); }
.chart-bar-label { color:rgba(255,255,255,.4); font-size:7px; font-weight:700; }
.chart-legend { display:flex; gap:5px; flex-wrap:wrap; }
.chart-legend-item { display:flex; align-items:center; gap:3px; font-size:7px; color:rgba(255,255,255,.5); }
.legend-dot { width:5px; height:5px; border-radius:50%; }
.chart-total { text-align:center; background:rgba(255,255,255,.05); border-radius:6px; padding:4px; margin-top:2px; }
.chart-total-num { color:var(--green); font-size:13px; font-weight:800; line-height:1; }
.chart-total-label { color:rgba(255,255,255,.3); font-size:7px; }

/* TASKS */
.tasks-below { background:var(--navy-mid); border-radius:12px; overflow:hidden; }
.tasks-below-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:8px 12px; border-bottom:1px solid rgba(255,255,255,.06);
}
.tasks-below-title { color:rgba(255,255,255,.6); font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:1px; }
.tasks-add-btn {
  width:20px; height:20px; background:var(--teal); border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:14px; color:#fff; font-weight:800; transition:transform .15s;
}
.tasks-add-btn:hover { transform:scale(1.15); }
.tasks-list { padding:6px 8px 8px; display:flex; flex-direction:column; gap:5px; max-height:340px; overflow-y:auto; }
.tasks-list::-webkit-scrollbar { width:3px; }
.tasks-list::-webkit-scrollbar-thumb { background:var(--teal); border-radius:3px; }
.task-item {
  display:flex; align-items:center; gap:8px;
  background:rgba(255,255,255,.04); border-radius:8px; padding:6px 10px;
  border-left:3px solid var(--teal-light); cursor:pointer; transition:opacity .2s;
}
.task-item.done-task { opacity:.4; }
.task-item.done-task .task-name { text-decoration:line-through; }
.task-check {
  width:14px; height:14px; border:1.5px solid rgba(255,255,255,.3);
  border-radius:4px; flex-shrink:0; display:flex; align-items:center;
  justify-content:center; font-size:9px; color:#fff; transition:background .15s;
}
.task-item.done-task .task-check { background:var(--green); border-color:var(--green); }
.task-name { color:#fff; font-size:11px; font-weight:600; flex:1; }
.task-del { color:rgba(255,255,255,.2); font-size:12px; cursor:pointer; padding:0 2px; }
.task-del:hover { color:var(--pink); }
.tasks-empty { color:rgba(255,255,255,.25); font-size:11px; text-align:center; padding:12px 0; }
.task-input-row {
  display:none; padding:6px 8px; gap:6px; align-items:center;
  border-top:1px solid rgba(255,255,255,.06);
}
.task-input-row.open { display:flex; }
.task-input-field {
  flex:1; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
  border-radius:8px; color:#fff; font-size:11px; padding:5px 8px;
  outline:none; font-family:'Nunito',sans-serif;
}
.task-input-field::placeholder { color:rgba(255,255,255,.3); }
.task-input-ok { background:var(--teal); color:#fff; border:none; border-radius:8px; padding:5px 10px; font-size:11px; font-weight:800; cursor:pointer; }

/* ══════════════════════════
   TASK MANAGEMENT SYSTEM
══════════════════════════ */
/* Panel tabs */
.tsk-tabs {
  display: flex; gap: 0; background: rgba(255,255,255,.04);
  border-bottom: 1px solid rgba(255,255,255,.07);
}
.tsk-tab {
  flex: 1; background: transparent; border: none; border-bottom: 2px solid transparent;
  color: rgba(255,255,255,.35); font-size: 11px; font-weight: 800;
  padding: 11px 4px; cursor: pointer; transition: all .2s; font-family: inherit;
  text-align: center;
}
.tsk-tab.active { color: #fff; border-bottom-color: var(--teal-light); }

/* Progress */
.tsk-progress-wrap {
  padding: 10px 16px 6px; position: relative;
  border-bottom: 1px solid rgba(255,255,255,.05);
}
.tsk-progress-bar {
  height: 4px; border-radius: 4px;
  background: linear-gradient(90deg, var(--green), var(--teal-light));
  transition: width .4s cubic-bezier(.34,1.56,.64,1);
  width: 0%; box-shadow: 0 0 8px rgba(94,220,138,.35);
}
.tsk-progress-label {
  color: rgba(255,255,255,.3); font-size: 9px; font-weight: 800;
  text-transform: uppercase; letter-spacing: .8px; margin-top: 5px;
}

/* Task list */
.tsk-list { padding: 8px 12px 80px; display: flex; flex-direction: column; gap: 4px; }
.tsk-section-label {
  color: rgba(255,255,255,.25); font-size: 9px; font-weight: 800;
  text-transform: uppercase; letter-spacing: 1px;
  padding: 10px 2px 4px; display: flex; align-items: center; gap: 6px;
}
.tsk-section-label::after { content:''; flex:1; height:1px; background:rgba(255,255,255,.07); }

/* Task row */
.tsk-item {
  display: flex; align-items: center; gap: 8px;
  background: rgba(255,255,255,.04); border-radius: 10px;
  padding: 9px 10px; border: 1px solid rgba(255,255,255,.06);
  cursor: pointer; transition: all .18s; position: relative; overflow: hidden;
}
.tsk-item::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
  border-radius: 3px 0 0 3px;
}
.tsk-item:hover { background: rgba(255,255,255,.07); transform: translateX(2px); }
.tsk-item.tsk-done { opacity: .45; }
.tsk-item.tsk-done .tsk-item-name { text-decoration: line-through; }
.tsk-item-check {
  width: 20px; height: 20px; border-radius: 6px; flex-shrink: 0;
  border: 2px solid rgba(255,255,255,.2); display: flex; align-items: center;
  justify-content: center; font-size: 11px; transition: all .2s; background: transparent;
}
.tsk-item.tsk-done .tsk-item-check { background: var(--green); border-color: var(--green); color: #fff; }
.tsk-item-emoji { font-size: 16px; flex-shrink: 0; }
.tsk-item-body { flex: 1; min-width: 0; }
.tsk-item-name { color: #fff; font-size: 12px; font-weight: 700; line-height: 1.3; }
.tsk-item-meta {
  display: flex; align-items: center; gap: 5px; margin-top: 2px;
}
.tsk-item-badge {
  font-size: 8px; font-weight: 800; padding: 1px 5px; border-radius: 4px;
  text-transform: uppercase; letter-spacing: .5px;
}
.tsk-badge-daily   { background: rgba(58,133,196,.2); color: var(--teal-light); }
.tsk-badge-weekly  { background: rgba(139,98,224,.2); color: var(--purple); }
.tsk-badge-once    { background: rgba(94,220,138,.15); color: var(--green); }
.tsk-item-days { font-size: 9px; color: rgba(255,255,255,.3); font-weight: 700; }
.tsk-item-del {
  width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center;
  justify-content: center; color: rgba(255,255,255,.2); font-size: 14px;
  transition: all .15s; flex-shrink: 0; cursor: pointer;
}
.tsk-item-del:hover { background: rgba(232,82,122,.2); color: var(--pink); }

/* Day-reset indicator */
.tsk-streak-badge {
  font-size: 9px; font-weight: 800; color: var(--yellow);
  background: rgba(240,192,64,.12); border-radius: 4px; padding: 1px 5px;
}

/* Empty state */
.tsk-empty {
  display: flex; flex-direction: column; align-items: center; gap: 8px;
  padding: 40px 20px; color: rgba(255,255,255,.3); text-align: center;
}
.tsk-empty-icon { font-size: 40px; }
.tsk-empty-text { font-size: 12px; font-weight: 700; }
.tsk-empty-add {
  background: var(--teal); color: #fff; border: none; border-radius: 10px;
  padding: 8px 18px; font-size: 11px; font-weight: 800; cursor: pointer;
  font-family: inherit; margin-top: 4px;
}

/* Header add button */
.tsk-header-btn {
  background: rgba(255,255,255,.08); border: none; color: #fff;
  width: 30px; height: 30px; border-radius: 8px; font-size: 18px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all .15s; font-family: inherit; line-height: 1;
}
.tsk-header-btn:hover { background: var(--teal); }

/* ── Add Task Modal ── */
.tsk-modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.65); z-index: 900;
  opacity: 0; pointer-events: none; transition: opacity .2s;
}
.tsk-modal-overlay.open { opacity: 1; pointer-events: all; }
.tsk-modal {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%);
  width: 100%; max-width: 480px; z-index: 901;
  background: var(--navy-mid); border-radius: 20px 20px 0 0;
  padding: 20px 18px 32px; display: flex; flex-direction: column; gap: 10px;
  transition: transform .3s cubic-bezier(.34,1.3,.64,1);
  border-top: 1px solid rgba(255,255,255,.1);
}
.tsk-modal.open { transform: translateX(-50%) translateY(0); }
.tsk-modal-title {
  color: #fff; font-size: 15px; font-weight: 800; margin-bottom: 2px;
  font-family: 'Special Elite', cursive;
}
.tsk-modal-input {
  background: rgba(255,255,255,.07); border: 1.5px solid rgba(255,255,255,.12);
  border-radius: 10px; color: #fff; font-size: 14px; padding: 10px 12px;
  font-family: inherit; outline: none; width: 100%;
}
.tsk-modal-input:focus { border-color: var(--teal-light); }
.tsk-modal-label { color: rgba(255,255,255,.4); font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: -4px; }

.tsk-type-row { display: flex; gap: 6px; }
.tsk-type-btn {
  flex: 1; background: rgba(255,255,255,.06); border: 1.5px solid rgba(255,255,255,.1);
  color: rgba(255,255,255,.5); font-size: 10px; font-weight: 800; padding: 8px 4px;
  border-radius: 9px; cursor: pointer; transition: all .15s; font-family: inherit;
}
.tsk-type-btn.active {
  background: rgba(42,100,150,.25); border-color: var(--teal-light); color: #fff;
  box-shadow: 0 0 10px rgba(42,100,150,.3);
}

.tsk-days-wrap { display: flex; flex-direction: column; gap: 6px; }
.tsk-days-row { display: flex; gap: 5px; }
.tsk-day-btn {
  flex: 1; background: rgba(255,255,255,.06); border: 1.5px solid rgba(255,255,255,.1);
  color: rgba(255,255,255,.4); font-size: 10px; font-weight: 800; padding: 7px 2px;
  border-radius: 8px; cursor: pointer; transition: all .15s; font-family: inherit;
}
.tsk-day-btn.active {
  background: rgba(139,98,224,.25); border-color: var(--purple); color: var(--purple);
}

.tsk-emoji-row { display: flex; gap: 5px; flex-wrap: wrap; }
.tsk-emoji-opt {
  width: 36px; height: 36px; border-radius: 8px; font-size: 18px;
  background: rgba(255,255,255,.06); border: 1.5px solid rgba(255,255,255,.1);
  cursor: pointer; transition: all .15s; display: flex; align-items: center; justify-content: center;
}
.tsk-emoji-opt.active { border-color: var(--yellow); background: rgba(240,192,64,.12); }

.tsk-modal-actions { display: flex; gap: 8px; margin-top: 2px; }
.tsk-modal-cancel {
  flex: 1; background: rgba(255,255,255,.07); border: none; color: rgba(255,255,255,.5);
  border-radius: 10px; padding: 11px; font-size: 12px; font-weight: 800; cursor: pointer; font-family: inherit;
}
.tsk-modal-ok {
  flex: 2; background: var(--teal); border: none; color: #fff;
  border-radius: 10px; padding: 11px; font-size: 13px; font-weight: 800; cursor: pointer; font-family: inherit;
  transition: background .15s;
}
.tsk-modal-ok:hover { background: var(--teal-light); }

/* Home tasks enriched display */
.home-tsk-section { font-size: 9px; color: rgba(255,255,255,.25); font-weight:800; text-transform:uppercase; letter-spacing:1px; padding: 6px 2px 3px; }
/* ══ TASK SYSTEM END ══ */

/* ══ SOCIAL SYSTEM — FORTNITE STYLE ══ */

/* Mi tarjeta de jugador */
.soc-player-card {
  background: linear-gradient(135deg, #0e2246, #162e5a);
  border: 1.5px solid rgba(42,100,150,.5);
  border-radius: 18px; padding: 14px 16px;
  display: flex; align-items: center; gap: 12px;
  position: relative; overflow: hidden;
}
.soc-player-card::before {
  content:''; position:absolute; inset:0;
  background: linear-gradient(120deg, transparent 60%, rgba(58,133,196,.07));
  pointer-events:none;
}
.soc-player-avatar { font-size: 36px; line-height:1; flex-shrink:0; }
.soc-player-info { flex:1; min-width:0; }
.soc-player-name {
  color: #fff; font-size: 14px; font-weight: 800;
  font-family: 'Special Elite', cursive;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.soc-player-tag {
  display: inline-flex; align-items: center; gap: 5px;
  margin-top: 4px; background: rgba(42,100,150,.25);
  border: 1px solid rgba(42,100,150,.4); border-radius: 20px;
  padding: 3px 10px; font-size: 11px; font-weight: 800; color: var(--teal-light);
  cursor: pointer; transition: background .2s;
  user-select: all;
}
.soc-player-tag:hover { background: rgba(42,100,150,.4); }
.soc-copy-btn {
  width: 36px; height: 36px; background: rgba(42,100,150,.3);
  border: 1.5px solid rgba(42,100,150,.4); border-radius: 12px;
  font-size: 16px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; flex-shrink:0; transition: all .15s;
}
.soc-copy-btn:hover { background: rgba(42,100,150,.6); transform: scale(1.08); }
.soc-copy-btn.copied { background: rgba(94,220,138,.25); border-color: var(--green); }

/* Sección agregar amigo */
.soc-add-section {
  background: var(--navy-mid);
  border: 1.5px solid rgba(255,255,255,.07);
  border-radius: 18px; padding: 14px 16px;
  display: flex; flex-direction: column; gap: 10px;
}
.soc-add-label {
  color: rgba(255,255,255,.5); font-size: 10px; font-weight: 800;
  text-transform: uppercase; letter-spacing: 1px;
}
.soc-add-row { display: flex; gap: 8px; }
.soc-add-input {
  flex: 1; background: rgba(255,255,255,.06);
  border: 1.5px solid rgba(255,255,255,.1); border-radius: 12px;
  color: #fff; font-size: 13px; font-weight: 700; padding: 10px 14px;
  outline: none; font-family: 'Nunito', sans-serif; transition: border-color .2s;
  letter-spacing: .3px;
}
.soc-add-input:focus { border-color: var(--teal); }
.soc-add-input::placeholder { color: rgba(255,255,255,.2); font-weight:400; }
.soc-add-search-btn {
  background: var(--teal); color: #fff; border: none;
  border-radius: 12px; padding: 0 16px; font-size: 12px;
  font-weight: 800; cursor: pointer; white-space: nowrap;
  font-family: 'Nunito', sans-serif; transition: all .15s;
  min-width: 72px;
}
.soc-add-search-btn:hover { background: var(--teal-light); transform: scale(1.04); }
.soc-add-search-btn:disabled { opacity:.5; cursor:default; transform:none; }

/* Resultado de búsqueda */
.soc-search-result-wrap { display:flex; flex-direction:column; gap:0; }
.soc-result-card {
  background: rgba(255,255,255,.04); border: 1.5px solid rgba(255,255,255,.08);
  border-radius: 14px; padding: 12px 14px;
  display: flex; align-items: center; gap: 12px;
  animation: soc-slide-in .25s ease;
}
@keyframes soc-slide-in {
  from { opacity:0; transform:translateY(8px) scale(.97); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}
.soc-result-avatar { font-size: 28px; flex-shrink:0; }
.soc-result-info { flex:1; min-width:0; }
.soc-result-name {
  color: #fff; font-size: 13px; font-weight: 800;
  font-family: 'Special Elite', cursive;
}
.soc-result-tag { color: var(--teal-light); font-size: 11px; font-weight: 700; }
.soc-result-meta { color: rgba(255,255,255,.35); font-size: 10px; margin-top:2px; }
.soc-result-action-wrap { display:flex; flex-direction:column; align-items:flex-end; gap:4px; }
.soc-req-btn {
  padding: 8px 16px; border-radius: 20px; border: none;
  font-size: 11px; font-weight: 800; cursor: pointer;
  font-family: 'Nunito', sans-serif; transition: all .18s;
  white-space: nowrap;
}
.soc-req-btn.add  { background: var(--teal); color: #fff; }
.soc-req-btn.add:hover { background: var(--teal-light); transform: scale(1.06); }
.soc-req-btn.sent { background: rgba(240,192,64,.12); color: var(--yellow); border:1.5px solid rgba(240,192,64,.3); cursor:default; }
.soc-req-btn.already { background: rgba(94,220,138,.12); color: var(--green); border:1.5px solid rgba(94,220,138,.3); cursor:default; }
.soc-result-msg {
  color: rgba(255,255,255,.35); font-size: 11px; text-align: center; padding: 12px 0;
}
.soc-result-error { color: var(--pink); font-size: 11px; text-align: center; padding: 10px 0; }
.soc-search-hint {
  display:flex; align-items:center; gap:6px;
  color: rgba(255,255,255,.2); font-size: 10px;
}
.soc-search-hint span { font-size:14px; }

/* Sección labels */
.soc-section-label {
  display: flex; align-items: center; justify-content: space-between;
  color: rgba(255,255,255,.4); font-size: 9px; font-weight: 800;
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;
}
.soc-pending-count {
  background: var(--pink); color: #fff; border-radius: 20px;
  padding: 1px 8px; font-size: 9px; font-weight: 800;
  animation: pendingPulse 2s ease-in-out infinite;
}
@keyframes pendingPulse {
  0%,100% { box-shadow: 0 0 0 rgba(232,82,122,0); }
  50%      { box-shadow: 0 0 8px rgba(232,82,122,.6); }
}

/* Solicitudes recibidas */
.soc-pending-card {
  background: linear-gradient(135deg, rgba(240,192,64,.07), rgba(240,192,64,.03));
  border: 1.5px solid rgba(240,192,64,.2); border-radius: 14px;
  padding: 12px 14px; display: flex; align-items: center; gap: 12px;
  margin-bottom: 6px; animation: soc-slide-in .2s ease;
}
.soc-pending-avatar { font-size: 26px; flex-shrink:0; }
.soc-pending-info { flex:1; min-width:0; }
.soc-pending-name { color: #fff; font-size: 12px; font-weight: 800; }
.soc-pending-sub { color: rgba(255,255,255,.35); font-size: 10px; margin-top:1px; }
.soc-pending-btns { display:flex; gap:6px; }
.soc-pending-accept {
  width: 32px; height: 32px; background: var(--green); border: none;
  border-radius: 50%; font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform .15s, box-shadow .15s;
}
.soc-pending-accept:hover { transform: scale(1.15); box-shadow: 0 0 12px rgba(94,220,138,.5); }
.soc-pending-reject {
  width: 32px; height: 32px; background: rgba(232,82,122,.15);
  border: 1.5px solid rgba(232,82,122,.3); border-radius: 50%;
  font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform .15s; color: var(--pink);
}
.soc-pending-reject:hover { transform: scale(1.12); background: rgba(232,82,122,.3); }

/* Tarjetas de amigos */
.soc-friend-card {
  background: var(--navy-mid); border: 1.5px solid rgba(255,255,255,.06);
  border-radius: 14px; padding: 11px 14px;
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 6px; cursor: pointer;
  transition: transform .15s, border-color .15s, background .15s;
  position: relative; overflow:hidden;
}
.soc-friend-card::before {
  content:''; position:absolute; left:0; top:0; bottom:0;
  width: 3px; background: var(--teal); border-radius: 3px 0 0 3px;
  opacity: 0; transition: opacity .2s;
}
.soc-friend-card:hover { transform: translateX(4px); border-color: rgba(42,100,150,.35); background: rgba(42,100,150,.07); }
.soc-friend-card:hover::before { opacity: 1; }
.soc-friend-avatar { font-size: 26px; flex-shrink:0; }
.soc-friend-info { flex:1; min-width:0; }
.soc-friend-name {
  color: #fff; font-size: 13px; font-weight: 800;
  font-family: 'Special Elite', cursive;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.soc-friend-chips { display:flex; gap:5px; margin-top:3px; flex-wrap:wrap; }
.soc-chip {
  border-radius: 8px; padding: 2px 7px; font-size: 9px; font-weight: 800;
}
.soc-chip-xp  { background: rgba(240,192,64,.1); color: var(--yellow); border:1px solid rgba(240,192,64,.2); }
.soc-chip-str { background: rgba(255,120,50,.1); color: #ff8040; border:1px solid rgba(255,120,50,.2); }
.soc-friend-actions { display:flex; gap:6px; flex-shrink:0; }
.soc-btn {
  width: 32px; height: 32px; border-radius: 50%; border: none;
  cursor: pointer; font-size: 14px; display: flex; align-items: center;
  justify-content: center; transition: transform .15s;
}
.soc-btn:hover { transform: scale(1.15); }
.soc-btn-chat   { background: rgba(42,100,150,.4); }
.soc-btn-remove { background: rgba(232,82,122,.12); border:1px solid rgba(232,82,122,.2); color:var(--pink); }

.soc-empty {
  color: rgba(255,255,255,.2); text-align: center; padding: 18px 0; font-size: 11px;
}

/* ── CHAT ── */
.chat-xp-compare-btn {
  background: rgba(139,98,224,.2); border: 1.5px solid rgba(139,98,224,.4);
  border-radius: 20px; padding: 5px 12px; color: #c49eff;
  font-size: 10px; font-weight: 800; cursor: pointer; white-space: nowrap;
  transition: background .15s; flex-shrink:0;
}
.chat-xp-compare-btn:hover { background: rgba(139,98,224,.35); }
.xp-compare-card {
  background: linear-gradient(135deg, rgba(139,98,224,.12), rgba(42,100,150,.12));
  border: 1.5px solid rgba(139,98,224,.25); border-radius: 16px;
  padding: 14px 16px; margin-bottom: 4px;
}
.xp-compare-title {
  color: rgba(255,255,255,.5); font-size: 9px; font-weight: 800;
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;
}
.xp-compare-row { margin-bottom: 8px; }
.xp-compare-label { display: flex; justify-content: space-between; margin-bottom: 3px; }
.xp-compare-user { color: #fff; font-size: 11px; font-weight: 800; }
.xp-compare-val  { color: var(--yellow); font-size: 11px; font-weight: 800; }
.xp-compare-bar-track { height: 8px; background: rgba(255,255,255,.06); border-radius: 8px; overflow: hidden; }
.xp-compare-bar-fill  { height: 100%; border-radius: 8px; transition: width .8s cubic-bezier(.34,1.2,.64,1); }
.xp-compare-result {
  text-align: center; font-size: 11px; font-weight: 800; margin-top: 8px;
  padding: 6px 10px; border-radius: 10px; background: rgba(255,255,255,.05);
}
.chat-messages-wrap {
  flex: 1; overflow-y: auto; padding: 8px 2px;
  display: flex; flex-direction: column; gap: 5px; min-height: 0;
}
.chat-messages-wrap::-webkit-scrollbar { width: 3px; }
.chat-messages-wrap::-webkit-scrollbar-thumb { background: var(--teal); border-radius: 3px; }
.chat-bubble-wrap { display: flex; flex-direction: column; max-width: 78%; }
.chat-bubble-wrap.mine   { align-self: flex-end; align-items: flex-end; }
.chat-bubble-wrap.theirs { align-self: flex-start; align-items: flex-start; }
.chat-bubble {
  padding: 8px 12px; border-radius: 16px;
  font-size: 12px; line-height: 1.4; word-break: break-word;
}
.chat-bubble-wrap.mine   .chat-bubble { background: var(--teal); color: #fff; border-bottom-right-radius: 4px; }
.chat-bubble-wrap.theirs .chat-bubble { background: var(--navy-mid); color: #fff; border-bottom-left-radius: 4px; border:1px solid rgba(255,255,255,.08); }
.chat-time { color: rgba(255,255,255,.2); font-size: 9px; margin-top: 2px; }
.chat-date-sep { text-align: center; color: rgba(255,255,255,.18); font-size: 9px; font-weight: 700; padding: 4px 0; }
.chat-loading { color: rgba(255,255,255,.25); text-align: center; padding: 20px; font-size: 11px; }
.chat-input-row {
  display: flex; gap: 8px; padding: 8px 0 4px;
  border-top: 1px solid rgba(255,255,255,.07);
}
.chat-input {
  flex: 1; background: var(--navy-mid); border: 1.5px solid rgba(255,255,255,.1);
  border-radius: 20px; color: #fff; font-size: 12px; padding: 9px 14px;
  outline: none; font-family: 'Nunito', sans-serif; transition: border-color .2s;
}
.chat-input:focus { border-color: var(--teal); }
.chat-input::placeholder { color: rgba(255,255,255,.3); }
.chat-send-btn {
  width: 38px; height: 38px; background: var(--teal); border: none;
  border-radius: 50%; color: #fff; font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  flex-shrink:0; transition: transform .15s;
}
.chat-send-btn:hover { transform: scale(1.1); }

/* BOTTOM NAV */
.bottom-nav {
  margin:0 -20px; background:var(--teal); border-radius:0 0 32px 32px;
  display:flex; align-items:center; justify-content:space-around;
  padding:10px 0 env(safe-area-inset-bottom, 14px);
  flex-shrink:0;
  z-index:5;
}
.nav-btn {
  display:flex; flex-direction:column; align-items:center; gap:3px;
  cursor:pointer; transition:transform .15s;
  color:rgba(255,255,255,.7); font-size:8px; font-weight:800;
  text-transform:uppercase; letter-spacing:.5px;
}
.nav-btn:hover { transform:translateY(-3px); color:#fff; }
.nav-btn.active { color:#fff; }
.nav-icon { width:26px; height:26px; display:flex; align-items:center; justify-content:center; font-size:17px; }

/* PANELS */
.panel {
  position:absolute; top:0; left:0; right:0; bottom:0;
  background:var(--navy); border-radius:0;
  padding:24px 18px; padding-bottom:max(24px, env(safe-area-inset-bottom));
  display:flex; flex-direction:column; gap:14px;
  z-index:10; overflow-y:auto; overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  opacity:0; pointer-events:none;
  transform:translateY(100%);
  transition: transform 0s, opacity 0s;
}
.panel.open { opacity:1; pointer-events:all; transform:translateY(0); }
.panel.anim-slide-up   { transform:translateY(60px); }
.panel.anim-slide-down { transform:translateY(-60px); }
.panel.anim-slide-left { transform:translateX(100%); }
.panel.anim-slide-right{ transform:translateX(-100%); }
.panel.anim-zoom       { transform:scale(.85); }
.panel.anim-flip       { transform:perspective(600px) rotateY(90deg); }
.panel-header { display:flex; align-items:center; gap:12px; }
.back-btn {
  width:34px; height:34px; background:var(--teal); border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:17px; color:#fff; transition:transform .15s; flex-shrink:0;
}
.back-btn:hover { transform:scale(1.1); }
.panel-title { font-family:'Special Elite',cursive; color:#fff; font-size:19px; }
.panel-content { flex:1; display:flex; flex-direction:column; gap:10px; }
.panel-item {
  background:var(--navy-mid); border-radius:12px; padding:12px 14px;
  display:flex; align-items:center; gap:12px; cursor:pointer;
  transition:transform .15s,background .15s; border-left:4px solid transparent;
}
.panel-item:hover { transform:translateX(4px); background:rgba(255,255,255,.05); }
.panel-item.c1{border-left-color:var(--green)}
.panel-item.c2{border-left-color:var(--yellow)}
.panel-item.c3{border-left-color:var(--pink)}
.panel-item.c4{border-left-color:var(--purple)}
.panel-item.c5{border-left-color:var(--teal-light)}
.panel-item-icon{font-size:20px}
.panel-item-text{flex:1}
.panel-item-text strong{display:block;color:#fff;font-size:13px}
.panel-item-text span{color:rgba(255,255,255,.4);font-size:11px}
.panel-item-arrow{color:rgba(255,255,255,.3);font-size:15px}
.divider{height:1px;background:rgba(255,255,255,.07);margin:2px 0;}

/* STREAK PANEL */
.streak-week-row { display:flex; gap:5px; justify-content:center; }
.streak-day-box {
  display:flex; flex-direction:column; align-items:center; gap:3px;
  background:rgba(255,255,255,.05); border-radius:10px; padding:7px 4px;
  flex:1; cursor:pointer; transition:background .2s; border:1.5px solid transparent;
}
.streak-day-box.active { background:rgba(240,192,64,.15); border-color:var(--yellow); }
.streak-day-box .sdb-emoji { font-size:16px; }
.streak-day-box .sdb-day { color:rgba(255,255,255,.4); font-size:8px; font-weight:800; text-transform:uppercase; }
.streak-day-box .sdb-done { color:var(--yellow); font-size:10px; font-weight:800; min-height:12px; }
.streak-big { text-align:center; }
.streak-big-num { font-size:64px; font-weight:800; color:var(--yellow); line-height:1; }
.streak-big-label { color:rgba(255,255,255,.5); font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:1px; }
.streak-icon-row { font-size:36px; text-align:center; }
.streak-edit-section { display:flex; flex-direction:column; gap:8px; }
.streak-input-label { color:rgba(255,255,255,.5); font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; }
.streak-input {
  background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.15);
  border-radius:10px; color:#fff; font-size:13px; padding:8px 12px;
  outline:none; font-family:'Nunito',sans-serif; width:100%;
}
.streak-save-btn {
  background:var(--yellow); color:#333; border:none; border-radius:10px;
  padding:8px; font-size:12px; font-weight:800; cursor:pointer; width:100%; transition:transform .15s;
}
.streak-save-btn:hover { transform:scale(1.02); }

/* ══════════════════════════════
   MASCOTA DE RACHA
══════════════════════════════ */
/* Section divider */
.mascota-section-title {
  display:flex; align-items:center; gap:8px;
  color:rgba(255,255,255,.35); font-size:9px; font-weight:800;
  text-transform:uppercase; letter-spacing:1.5px; padding:2px 0;
}
.mascota-section-title::before,
.mascota-section-title::after {
  content:''; flex:1; height:1px; background:rgba(255,255,255,.08);
}

/* Main pet display card */
.mascota-card {
  background:var(--navy-mid);
  border-radius:20px; padding:18px 16px 14px;
  display:flex; flex-direction:column; align-items:center; gap:10px;
  border:1.5px solid rgba(255,255,255,.08); position:relative; overflow:hidden;
  transition:border-color .3s, box-shadow .3s;
}
.mascota-card.happy  { border-color:rgba(94,220,138,.35);  box-shadow:0 0 20px rgba(94,220,138,.1); }
.mascota-card.sad    { border-color:rgba(232,82,122,.3);   box-shadow:0 0 20px rgba(232,82,122,.08); }
.mascota-card.legendary-pet { border-color:rgba(139,98,224,.5); box-shadow:0 0 24px rgba(139,98,224,.2); }

/* Ambient glow behind pet */
.mascota-glow {
  position:absolute; width:120px; height:120px; border-radius:50%;
  top:10px; left:50%; transform:translateX(-50%);
  filter:blur(30px); opacity:.35; pointer-events:none;
  transition:background .5s;
}

/* Pet canvas area */
.mascota-display {
  position:relative; width:120px; height:120px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; user-select:none;
}
.mascota-body {
  font-size:72px; line-height:1;
  transition:transform .3s cubic-bezier(.34,1.6,.64,1), filter .3s;
  position:relative; z-index:2;
  animation:mascotaIdle 3s ease-in-out infinite;
}
@keyframes mascotaIdle {
  0%,100% { transform:translateY(0) rotate(-2deg) scale(1); }
  50%      { transform:translateY(-6px) rotate(2deg) scale(1.04); }
}
.mascota-card.sad .mascota-body {
  animation:mascotaSad 2s ease-in-out infinite;
  filter:grayscale(.5) brightness(.8);
}
@keyframes mascotaSad {
  0%,100% { transform:translateY(0) rotate(-1deg); }
  50%      { transform:translateY(3px) rotate(1deg); }
}
.mascota-card.legendary-pet .mascota-body {
  animation:mascotaLegendary 2s ease-in-out infinite;
  filter:drop-shadow(0 0 12px rgba(139,98,224,.9));
}
@keyframes mascotaLegendary {
  0%,100% { transform:translateY(0) rotate(-3deg) scale(1); filter:drop-shadow(0 0 12px rgba(139,98,224,.9)); }
  50%      { transform:translateY(-10px) rotate(3deg) scale(1.1); filter:drop-shadow(0 0 22px rgba(180,100,255,1)); }
}

/* Accessory overlay */
.mascota-acc {
  position:absolute; font-size:28px; z-index:3; pointer-events:none;
  transition:all .3s;
}
.mascota-acc.hat    { top:-14px; left:50%; transform:translateX(-40%); }
.mascota-acc.collar { bottom:4px; left:50%; transform:translateX(-50%); font-size:20px; }
.mascota-acc.wand   { right:-8px; top:20%; font-size:24px; }

/* Tap sparkle */
.pet-sparkle {
  position:absolute; font-size:16px; pointer-events:none; z-index:10;
  animation:sparkleUp .7s ease forwards;
}
@keyframes sparkleUp {
  0%   { opacity:1; transform:translate(0,0) scale(1); }
  100% { opacity:0; transform:translate(var(--sx),var(--sy)) scale(0); }
}

/* Pet info row */
.mascota-info-row {
  display:flex; align-items:center; gap:10px; width:100%;
}
.mascota-name-edit {
  flex:1; background:transparent; border:none; border-bottom:1.5px solid rgba(255,255,255,.15);
  color:#fff; font-size:15px; font-weight:800; font-family:'Special Elite',cursive;
  outline:none; padding:2px 4px; text-align:center; transition:border-color .2s;
}
.mascota-name-edit:focus { border-bottom-color:var(--teal); }
.mascota-level-badge {
  background:rgba(42,100,150,.3); border:1px solid rgba(42,100,150,.5);
  border-radius:20px; padding:3px 10px;
  color:var(--teal-light); font-size:10px; font-weight:800; white-space:nowrap;
}

/* Mood + happiness bar */
.mascota-mood-row {
  display:flex; align-items:center; gap:8px; width:100%;
}
.mascota-mood-icon { font-size:16px; flex-shrink:0; }
.mascota-hp-track {
  flex:1; height:8px; background:rgba(255,255,255,.08);
  border-radius:8px; overflow:hidden;
}
.mascota-hp-fill {
  height:100%; border-radius:8px;
  transition:width .6s cubic-bezier(.34,1.2,.64,1), background .5s;
}
.mascota-mood-label {
  font-size:10px; font-weight:800; color:rgba(255,255,255,.4);
  min-width:40px; text-align:right;
}

/* Stat chips */
.mascota-stats {
  display:flex; gap:6px; width:100%; justify-content:center; flex-wrap:wrap;
}
.mascota-stat {
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
  border-radius:20px; padding:4px 10px;
  display:flex; align-items:center; gap:5px; font-size:10px;
}
.mascota-stat .ms-icon { font-size:12px; }
.mascota-stat .ms-val  { color:#fff; font-weight:800; }
.mascota-stat .ms-lbl  { color:rgba(255,255,255,.35); }

/* Customizer section */
.mascota-customizer {
  width:100%; display:flex; flex-direction:column; gap:10px;
  background:var(--navy-mid); border-radius:16px; padding:12px 14px;
  border:1.5px solid rgba(255,255,255,.07);
}
.mascota-cust-label {
  color:rgba(255,255,255,.35); font-size:9px; font-weight:800;
  text-transform:uppercase; letter-spacing:1px; margin-bottom:2px;
}
.mascota-type-row {
  display:flex; gap:6px; flex-wrap:wrap;
}
.mascota-type-btn {
  width:52px; min-height:52px; height:auto; border-radius:12px;
  background:rgba(255,255,255,.06); border:2px solid transparent;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  cursor:pointer; transition:all .18s; flex-shrink:0; padding:4px 2px;
  text-align:center;
}
.mascota-type-btn:hover  { background:rgba(255,255,255,.12); transform:scale(1.1); }
.mascota-type-btn.active {
  border-color:var(--teal); background:rgba(42,100,150,.25);
  box-shadow:0 0 10px rgba(42,100,150,.4);
}

/* Color swatches */
.mascota-color-row { display:flex; gap:7px; flex-wrap:wrap; }
.mascota-color-dot {
  width:26px; height:26px; border-radius:50%; cursor:pointer;
  border:2.5px solid transparent; transition:transform .15s, border-color .15s;
  flex-shrink:0;
}
.mascota-color-dot:hover  { transform:scale(1.2); }
.mascota-color-dot.active { border-color:#fff; transform:scale(1.15); }

/* Accessory buttons */
.mascota-acc-row { display:flex; gap:6px; flex-wrap:wrap; }
.mascota-acc-btn {
  padding:5px 10px; border-radius:10px; font-size:13px;
  background:rgba(255,255,255,.06); border:1.5px solid rgba(255,255,255,.1);
  cursor:pointer; transition:all .18s; display:flex; align-items:center; gap:4px;
}
.mascota-acc-btn span { font-size:9px; color:rgba(255,255,255,.4); font-weight:700; }
.mascota-acc-btn:hover  { background:rgba(255,255,255,.12); }
.mascota-acc-btn.active {
  border-color:var(--yellow); background:rgba(240,192,64,.15);
}

/* Evolution unlock banner */
.mascota-evo-banner {
  width:100%; padding:10px 14px;
  background:linear-gradient(135deg,rgba(139,98,224,.2),rgba(100,60,200,.1));
  border:1.5px solid rgba(139,98,224,.4); border-radius:12px;
  display:flex; align-items:center; gap:10px;
  animation:evoPulse 2s ease-in-out infinite;
}
@keyframes evoPulse {
  0%,100% { box-shadow:0 0 8px rgba(139,98,224,.3); }
  50%      { box-shadow:0 0 20px rgba(139,98,224,.6); }
}
.mascota-evo-text { flex:1; }
.mascota-evo-text strong { color:#c49eff; font-size:12px; display:block; }
.mascota-evo-text span   { color:rgba(255,255,255,.4); font-size:10px; }
.mascota-evo-icon { font-size:26px; }

/* Pet tap button */
.mascota-tap-btn {
  width:100%; padding:9px; border-radius:12px;
  background:rgba(255,255,255,.06); border:1.5px solid rgba(255,255,255,.1);
  color:rgba(255,255,255,.5); font-size:11px; font-weight:800;
  font-family:'Nunito',sans-serif; cursor:pointer; transition:all .2s;
}
.mascota-tap-btn:hover { background:rgba(255,255,255,.1); color:#fff; }
.emoji-picker { display:flex; gap:8px; flex-wrap:wrap; }
.emoji-opt {
  width:34px; height:34px; background:rgba(255,255,255,.07); border-radius:8px;
  display:flex; align-items:center; justify-content:center; font-size:18px;
  cursor:pointer; transition:background .15s; border:1.5px solid transparent;
}
.emoji-opt:hover { background:rgba(255,255,255,.15); }
.emoji-opt.selected { border-color:var(--yellow); background:rgba(240,192,64,.15); }

/* ══ FRIEND PROFILE PANEL ══ */
.fp-chat-btn {
  background:rgba(42,100,150,.25); border:1.5px solid rgba(42,100,150,.45);
  border-radius:20px; padding:5px 12px; color:var(--teal-light);
  font-size:10px; font-weight:800; cursor:pointer; font-family:'Nunito',sans-serif;
  transition:all .18s; flex-shrink:0; white-space:nowrap;
}
.fp-chat-btn:hover { background:rgba(42,100,150,.45); transform:scale(1.04); }
.fp-loading {
  color:rgba(255,255,255,.3); text-align:center; padding:40px; font-size:13px;
}

/* Hero card */
.fp-hero {
  background:linear-gradient(135deg,var(--navy-mid),var(--navy));
  border:1.5px solid rgba(255,255,255,.08); border-radius:20px;
  padding:20px 16px 16px; display:flex; flex-direction:column;
  align-items:center; gap:8px; position:relative; overflow:hidden;
}
.fp-hero::before {
  content:''; position:absolute; inset:0;
  background-image:linear-gradient(rgba(42,100,150,.05) 1px,transparent 1px),linear-gradient(90deg,rgba(42,100,150,.05) 1px,transparent 1px);
  background-size:20px 20px; pointer-events:none;
}
.fp-hero::after {
  content:''; position:absolute; top:0; left:0; right:0; height:60px;
  background:linear-gradient(180deg,rgba(42,100,150,.12),transparent);
  pointer-events:none;
}
.fp-avatar-wrap {
  width:80px; height:80px; border-radius:50%;
  border:3px solid var(--teal); overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(135deg,var(--teal),var(--navy-mid));
  box-shadow:0 0 20px rgba(42,100,150,.5); z-index:2; position:relative;
  flex-shrink:0;
}
.fp-avatar-emoji { font-size:38px; line-height:1; }
.fp-name {
  font-family:'Special Elite',cursive; font-size:18px; color:#fff; z-index:2;
  text-shadow:0 0 20px rgba(42,100,150,.6);
}
.fp-tag { color:rgba(255,255,255,.35); font-size:10px; z-index:2; }
.fp-level-badge {
  background:linear-gradient(135deg,#2a1e08,#5a420e);
  border:1.5px solid rgba(240,192,64,.4); border-radius:20px;
  padding:3px 10px; font-size:10px; font-weight:800; color:var(--yellow);
  z-index:2;
}

/* Stats row */
.fp-stats-row {
  display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
}
.fp-stat-chip {
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
  border-radius:20px; padding:6px 14px; display:flex; flex-direction:column;
  align-items:center; gap:1px; min-width:56px;
}
.fp-stat-val { color:#fff; font-size:14px; font-weight:800; line-height:1.1; font-family:'Special Elite',cursive; }
.fp-stat-lbl { color:rgba(255,255,255,.35); font-size:9px; }

/* Badges section */
.fp-section-label {
  color:rgba(255,255,255,.3); font-size:9px; font-weight:800;
  text-transform:uppercase; letter-spacing:1.2px;
  display:flex; align-items:center; gap:8px;
}
.fp-section-label::before,.fp-section-label::after {
  content:''; flex:1; height:1px; background:rgba(255,255,255,.06);
}
.fp-badges-row {
  display:flex; flex-wrap:wrap; gap:6px; justify-content:center;
}
.fp-badge-chip {
  display:inline-flex; align-items:center; gap:5px;
  background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
  border-radius:10px; padding:5px 10px; font-size:11px; color:#fff;
}
.fp-no-badges { color:rgba(255,255,255,.2); font-size:11px; text-align:center; padding:8px; }

/* Pet section */
.fp-pet-card {
  background:var(--navy-mid); border:1.5px solid rgba(255,255,255,.07);
  border-radius:16px; padding:14px; display:flex; align-items:center; gap:14px;
}
.fp-pet-emoji-wrap {
  width:64px; height:64px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:36px; flex-shrink:0; position:relative;
  background:linear-gradient(135deg,rgba(255,255,255,.05),transparent);
  border:2px solid rgba(255,255,255,.1);
  animation:fpPetFloat 3s ease-in-out infinite;
}
@keyframes fpPetFloat {
  0%,100% { transform:translateY(0) scale(1); }
  50% { transform:translateY(-5px) scale(1.04); }
}
.fp-pet-info { flex:1; }
.fp-pet-name { color:#fff; font-size:13px; font-weight:800; }
.fp-pet-level { color:rgba(255,255,255,.4); font-size:10px; margin-top:2px; }
.fp-pet-hp-bar {
  height:5px; background:rgba(255,255,255,.08); border-radius:5px;
  margin-top:6px; overflow:hidden;
}
.fp-pet-hp-fill {
  height:100%; border-radius:5px;
  transition:width .8s cubic-bezier(.34,1.2,.64,1);
}
.fp-pet-mood { font-size:20px; flex-shrink:0; }

/* Streak section */
.fp-streak-row {
  background:var(--navy-mid); border:1.5px solid rgba(255,255,255,.07);
  border-radius:16px; padding:12px 14px; display:flex; align-items:center; gap:12px;
}
.fp-streak-num { font-size:32px; font-weight:900; color:var(--yellow); font-family:'Special Elite',cursive; line-height:1; }
.fp-streak-info { flex:1; }
.fp-streak-label { color:rgba(255,255,255,.5); font-size:10px; font-weight:700; }
.fp-streak-dots { display:flex; flex-wrap:wrap; gap:3px; margin-top:5px; }
.fp-streak-dot {
  width:7px; height:7px; border-radius:50%;
  background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.15);
  transition:background .2s;
}
.fp-streak-dot.done { background:var(--yellow); border-color:var(--yellow); box-shadow:0 0 4px rgba(240,192,64,.5); }

/* Action buttons */
.fp-actions { display:flex; gap:8px; }
.fp-action-btn {
  flex:1; padding:11px; border-radius:14px; border:none;
  font-size:12px; font-weight:800; cursor:pointer; font-family:'Nunito',sans-serif;
  transition:all .18s; display:flex; align-items:center; justify-content:center; gap:6px;
}
.fp-action-chat { background:var(--teal); color:#fff; box-shadow:0 4px 14px rgba(42,100,150,.4); }
.fp-action-chat:hover { filter:brightness(1.12); transform:scale(1.02); }
.fp-action-remove { background:rgba(232,82,122,.1); border:1.5px solid rgba(232,82,122,.25); color:var(--pink); }
.fp-action-remove:hover { background:rgba(232,82,122,.22); }

/* Pet type display from type index */
.fp-pet-emoji-legendary {
  animation:fpLegendaryFloat 2s ease-in-out infinite, fpGoldenGlow 3s ease-in-out infinite;
}
@keyframes fpLegendaryFloat {
  0%,100% { transform:translateY(0) scale(1) rotate(-3deg); }
  50% { transform:translateY(-8px) scale(1.08) rotate(3deg); }
}
@keyframes fpGoldenGlow {
  0%,100% { filter:drop-shadow(0 0 6px #f0c040); }
  50% { filter:drop-shadow(0 0 14px #f0c040) drop-shadow(0 0 28px rgba(240,192,64,.4)); }
}


.inv-avatar-preview-card {
  background:var(--navy-mid); border-radius:18px; padding:16px;
  display:flex; flex-direction:column; align-items:center; gap:10px;
  border:1.5px solid rgba(255,255,255,.08); margin-bottom:4px;
}
.inv-avatar-preview-wrap {
  width:80px; height:80px; border-radius:50%; position:relative;
  border:3px solid var(--teal); overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(135deg,var(--teal),var(--navy-mid));
  box-shadow:0 0 20px rgba(42,100,150,.4);
}
.inv-avatar-preview-emoji { font-size:42px; line-height:1; }
.inv-avatar-preview-img { width:100%; height:100%; object-fit:cover; position:absolute; inset:0; display:none; }
.inv-avatar-preview-label {
  color:rgba(255,255,255,.5); font-size:10px; font-weight:800;
  text-transform:uppercase; letter-spacing:1px;
}
.inv-avatar-preview-name { color:#fff; font-size:14px; font-weight:800; font-family:'Special Elite',cursive; }
.inv-avatar-photo-btn {
  width:100%; padding:10px; border-radius:12px;
  background:rgba(42,100,150,.2); border:1.5px solid rgba(42,100,150,.4);
  color:var(--teal-light); font-size:12px; font-weight:800;
  cursor:pointer; font-family:'Nunito',sans-serif; transition:all .18s;
  display:flex; align-items:center; justify-content:center; gap:7px;
}
.inv-avatar-photo-btn:hover { background:rgba(42,100,150,.35); transform:scale(1.02); }
.inv-avatar-photo-remove {
  width:100%; padding:9px; border-radius:12px; margin-top:-4px;
  background:rgba(232,82,122,.08); border:1.5px solid rgba(232,82,122,.2);
  color:var(--pink); font-size:11px; font-weight:700;
  cursor:pointer; font-family:'Nunito',sans-serif; transition:all .18s;
  display:none;
}
.inv-avatar-photo-remove:hover { background:rgba(232,82,122,.18); }

.inv-avatar-section-label {
  color:rgba(255,255,255,.3); font-size:9px; font-weight:800;
  text-transform:uppercase; letter-spacing:1.2px;
  display:flex; align-items:center; gap:8px; padding:2px 0;
}
.inv-avatar-section-label::before,.inv-avatar-section-label::after {
  content:''; flex:1; height:1px; background:rgba(255,255,255,.07);
}

.inv-avatar-grid {
  display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
}
.inv-avatar-btn {
  aspect-ratio:1; border-radius:14px; font-size:26px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; transition:all .18s;
  background:rgba(255,255,255,.05); border:2px solid transparent;
  position:relative; overflow:hidden;
}
.inv-avatar-btn:hover { background:rgba(255,255,255,.12); transform:scale(1.08); }
.inv-avatar-btn.equipped {
  border-color:var(--teal); background:rgba(42,100,150,.2);
  box-shadow:0 0 12px rgba(42,100,150,.4);
}
.inv-avatar-btn.locked {
  opacity:.35; cursor:not-allowed; filter:grayscale(.6);
}
.inv-avatar-btn.locked::after {
  content:'🔒'; position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; background:rgba(0,0,0,.35); border-radius:12px;
}
.inv-avatar-btn .av-check {
  position:absolute; top:3px; right:3px;
  width:14px; height:14px; border-radius:50%; background:var(--teal);
  display:none; align-items:center; justify-content:center;
  font-size:8px; color:#fff; font-weight:900;
}
.inv-avatar-btn.equipped .av-check { display:flex; }

/* ══ CHAT EMOJI PICKER ══ */
.chat-emoji-btn {
  width:36px; height:36px; background:rgba(255,255,255,.07); border:1.5px solid rgba(255,255,255,.12);
  border-radius:10px; font-size:18px; cursor:pointer; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  transition:all .18s;
}
.chat-emoji-btn:hover, .chat-emoji-btn.active { background:rgba(255,255,255,.15); border-color:var(--teal); }
.chat-emoji-panel {
  display:none; background:var(--navy-mid); border-top:1.5px solid rgba(255,255,255,.08);
  padding:10px 8px; max-height:0; overflow:hidden;
  transition:max-height .3s cubic-bezier(.4,0,.2,1);
}
.chat-emoji-panel.open { display:block; max-height:180px; }
.chat-emoji-grid {
  display:flex; flex-wrap:wrap; gap:4px; max-height:158px; overflow-y:auto;
  scrollbar-width:thin; scrollbar-color:var(--teal) transparent;
}
.chat-emoji-grid::-webkit-scrollbar { width:3px; }
.chat-emoji-grid::-webkit-scrollbar-thumb { background:var(--teal); border-radius:3px; }
.chat-emoji-item {
  width:34px; height:34px; font-size:20px; border-radius:8px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; transition:background .14s, transform .14s;
  background:rgba(255,255,255,.03);
}
.chat-emoji-item:hover { background:rgba(255,255,255,.12); transform:scale(1.18); }

/* ══ THEME BACKGROUND SYMBOLS ══ */
.theme-bg-symbols {
  position:fixed; inset:0; pointer-events:none; z-index:0;
  overflow:hidden; opacity:0; transition:opacity 1s ease;
}
.theme-bg-symbols.visible { opacity:1; }
.theme-sym {
  position:absolute; user-select:none; pointer-events:none;
  animation:symFloat var(--dur,12s) ease-in-out infinite;
  opacity:var(--op,.08);
  font-size:var(--sz,48px);
  color:var(--teal-light);
}
@keyframes symFloat {
  0%   { transform:translate(0,0) rotate(var(--r0,0deg)) scale(1); }
  33%  { transform:translate(var(--mx,15px),var(--my,-20px)) rotate(var(--r1,8deg)) scale(1.05); }
  66%  { transform:translate(var(--mx2,-10px),var(--my2,10px)) rotate(var(--r2,-5deg)) scale(.95); }
  100% { transform:translate(0,0) rotate(var(--r0,0deg)) scale(1); }
}

/* ══ SVG SHOP ICONS ══ */
.shop-svg-icon {
  width:100%; height:100%; display:flex; align-items:center; justify-content:center;
}
.shop-svg-icon svg { width:32px; height:32px; }
.sli-icon .shop-svg-icon svg { width:26px; height:26px; }


.login-group { display:flex; flex-direction:column; gap:5px; }
.login-label { color:rgba(255,255,255,.5); font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:1px; }
.login-input {
  background:rgba(255,255,255,.07); border:1.5px solid rgba(255,255,255,.15);
  border-radius:10px; color:#fff; font-size:14px; padding:10px 14px;
  outline:none; font-family:'Nunito',sans-serif; transition:border-color .2s;
}
.login-input:focus { border-color:var(--teal-light); }
.login-btn {
  background:var(--teal); color:#fff; border:none; border-radius:12px;
  padding:12px; font-size:14px; font-weight:800; cursor:pointer;
  transition:transform .15s,filter .15s; letter-spacing:.5px;
}
.login-btn:hover { transform:scale(1.02); filter:brightness(1.1); }
.login-divider { display:flex; align-items:center; gap:10px; }
.login-divider-line { flex:1; height:1px; background:rgba(255,255,255,.1); }
.login-divider-text { color:rgba(255,255,255,.3); font-size:11px; }
.login-secondary {
  background:rgba(255,255,255,.06); color:rgba(255,255,255,.7);
  border:1.5px solid rgba(255,255,255,.12); border-radius:12px;
  padding:11px; font-size:13px; font-weight:700; cursor:pointer; transition:background .15s;
}
.login-secondary:hover { background:rgba(255,255,255,.1); }
.login-google {
  background:#fff; color:#333; border:none; border-radius:12px; padding:11px;
  font-size:13px; font-weight:700; cursor:pointer;
  display:flex; align-items:center; justify-content:center; gap:8px; transition:transform .15s;
}
.login-google:hover { transform:scale(1.02); }

/* TOAST */
.toast {
  position:absolute; bottom:75px; left:50%;
  transform:translateX(-50%) translateY(20px);
  background:var(--teal); color:#fff; padding:7px 16px;
  border-radius:20px; font-size:12px; font-weight:700;
  opacity:0; transition:opacity .3s,transform .3s;
  pointer-events:none; white-space:nowrap; z-index:30;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* APARIENCIA */
.appear-section-label { color:rgba(255,255,255,.4); font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:1.2px; padding:0 2px; }
.theme-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
.theme-swatch {
  border-radius:14px; height:56px; cursor:pointer; position:relative;
  transition:transform .2s, box-shadow .2s; border:2px solid transparent; overflow:hidden;
  display:flex; flex-direction:column; justify-content:flex-end;
}
.theme-swatch:hover { transform:scale(1.07); }
.theme-swatch.active { border-color:#fff; box-shadow:0 0 0 3px rgba(255,255,255,.3), 0 0 16px rgba(255,255,255,.2); }
.theme-swatch::after { content:attr(data-name); font-size:7px; font-weight:800; color:rgba(255,255,255,.9); text-align:center; padding:3px 0; background:rgba(0,0,0,.35); text-transform:uppercase; letter-spacing:.5px; }
.theme-swatch .check-mark { position:absolute; top:4px; right:4px; width:14px; height:14px; border-radius:50%; background:#fff; display:none; align-items:center; justify-content:center; font-size:8px; color:#333; font-weight:900; }
.theme-swatch.active .check-mark { display:flex; }
.custom-color-row { display:flex; align-items:center; gap:10px; background:var(--navy-mid); border-radius:12px; padding:10px 14px; }
.color-preview-box { width:36px; height:36px; border-radius:10px; border:2px solid rgba(255,255,255,.2); transition:background .2s; flex-shrink:0; }
.color-pick-btn { flex:1; background:var(--teal); color:#fff; border-radius:10px; padding:8px 12px; font-size:12px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:6px; font-family:'Nunito',sans-serif; }
.color-pick-btn input[type=color] { display:none; }
.reset-color-btn { background:rgba(255,255,255,.08); color:rgba(255,255,255,.6); border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:8px 10px; font-size:11px; font-weight:800; cursor:pointer; font-family:'Nunito',sans-serif; transition:background .15s; }
.reset-color-btn:hover { background:rgba(255,255,255,.15); color:#fff; }
.theme-preview-strip { background:var(--preview-bg, #0d1b3e); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:8px; transition:background .3s; border:1px solid rgba(255,255,255,.08); }
.tps-header { display:flex; align-items:center; gap:8px; }
.tps-circle { width:24px; height:24px; border-radius:50%; flex-shrink:0; transition:background .3s; }
.tps-line { height:8px; border-radius:4px; background:rgba(255,255,255,.15); }
.tps-row { display:flex; gap:6px; }
.tps-block { flex:1; height:28px; border-radius:8px; transition:background .3s; }
.tps-bar { height:12px; border-radius:6px; transition:background .3s; }

/* AVATAR */
/* ══ AVATAR / PERFIL — Rediseño llamativo ══ */

@keyframes avatarRingRotate {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}
@keyframes avatarRingRotateRev {
  from { transform: rotate(0deg); }
  to   { transform: rotate(-360deg); }
}
@keyframes avatarPulseGlow {
  0%,100% { opacity:.5; transform:scale(1); }
  50%      { opacity:1; transform:scale(1.08); }
}
@keyframes avatarScanline {
  0%   { top:-10%; }
  100% { top:110%; }
}
@keyframes avatarBadgePop {
  0%   { transform:scale(0) rotate(-20deg); opacity:0; }
  70%  { transform:scale(1.15) rotate(4deg); opacity:1; }
  100% { transform:scale(1) rotate(0deg); opacity:1; }
}
@keyframes avatarFloatIn {
  from { opacity:0; transform:translateY(14px) scale(.95); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}

/* ── Contenedor principal del perfil en el panel ── */
.profile-hero {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  padding: 24px 16px 20px;
  border-radius: 20px;
  background: linear-gradient(160deg, rgba(20,30,60,.9) 0%, rgba(10,18,40,.95) 100%);
  border: 1px solid rgba(42,100,150,.2);
  overflow: hidden;
  animation: avatarFloatIn .4s ease;
}

/* Fondo de malla tipo holograma */
.profile-hero::before {
  content: '';
  position: absolute; inset: 0;
  background-image:
    linear-gradient(rgba(42,100,150,.06) 1px, transparent 1px),
    linear-gradient(90deg, rgba(42,100,150,.06) 1px, transparent 1px);
  background-size: 24px 24px;
  pointer-events: none;
}

/* Degradado superior decorativo */
.profile-hero::after {
  content: '';
  position: absolute; top:0; left:0; right:0; height:80px;
  background: linear-gradient(180deg, rgba(42,100,150,.15), transparent);
  pointer-events: none;
}

/* ── Anillo exterior giratorio ── */
.avatar-ring-outer {
  position: absolute;
  width: 130px; height: 130px;
  border-radius: 50%;
  border: 2px dashed rgba(42,100,150,.4);
  animation: avatarRingRotate 12s linear infinite;
  pointer-events: none;
}
.avatar-ring-outer::before {
  content: '';
  position: absolute;
  top: -3px; left: 50%;
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--teal-light);
  transform: translateX(-50%);
  box-shadow: 0 0 8px var(--teal-light);
}

/* ── Anillo medio con gradiente ── */
.avatar-ring-mid {
  position: absolute;
  width: 114px; height: 114px;
  border-radius: 50%;
  background: conic-gradient(
    from 0deg,
    var(--teal) 0%, rgba(58,133,196,.2) 40%,
    transparent 60%, var(--teal) 100%
  );
  animation: avatarRingRotateRev 6s linear infinite;
  pointer-events: none;
}

/* ── Wrapper del avatar ── */
.avatar-wrapper {
  width: 96px; height: 96px;
  border-radius: 50%;
  position: relative;
  cursor: pointer;
  border: 3px solid var(--teal);
  box-shadow:
    0 0 0 2px rgba(42,100,150,.3),
    0 0 24px rgba(42,100,150,.5),
    inset 0 0 20px rgba(0,0,0,.3);
  transition: transform .25s, box-shadow .25s;
  overflow: hidden;
  background: linear-gradient(135deg, var(--teal), var(--navy-mid));
  display: flex; align-items: center; justify-content: center;
  z-index: 2;
}
.avatar-wrapper:hover {
  transform: scale(1.08);
  box-shadow:
    0 0 0 3px var(--teal-light),
    0 0 36px rgba(58,133,196,.8),
    inset 0 0 20px rgba(0,0,0,.3);
}

/* Línea de scan al hacer hover */
.avatar-wrapper::after {
  content: '';
  position: absolute;
  left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, rgba(58,200,220,.8), transparent);
  top: -10%;
  opacity: 0;
  transition: opacity .2s;
  animation: avatarScanline 1.8s linear infinite;
  animation-play-state: paused;
}
.avatar-wrapper:hover::after { opacity:1; animation-play-state:running; }

.avatar-emoji { font-size: 46px; line-height:1; transition:opacity .2s, transform .2s; }
.avatar-wrapper:hover .avatar-emoji { transform: scale(.85); }

.avatar-overlay {
  position: absolute; inset: 0; border-radius: 50%;
  background: rgba(0,0,0,.55);
  display: flex; flex-direction:column; align-items: center; justify-content: center;
  gap: 2px;
  font-size: 20px; opacity: 0; transition: opacity .2s;
}
.avatar-overlay span { font-size: 9px; color: rgba(255,255,255,.7); font-weight:800; letter-spacing:.5px; }
.avatar-wrapper:hover .avatar-overlay { opacity: 1; }

/* ── Info del perfil ── */
.profile-hero-name {
  font-family: 'Special Elite', cursive;
  font-size: 18px; color: #fff;
  margin-top: 14px;
  text-shadow: 0 0 20px rgba(42,100,150,.5);
  z-index: 2;
}
.profile-hero-level {
  font-size: 11px; color: rgba(255,255,255,.4);
  margin-top: 2px; z-index: 2;
}

/* ── Badge de nivel ── */
.profile-hero-badge {
  position: absolute; top: 12px; right: 12px;
  background: linear-gradient(135deg, #2a1e08, #5a420e);
  border: 1.5px solid rgba(240,192,64,.4);
  border-radius: 20px; padding: 4px 10px;
  font-size: 10px; font-weight: 800; color: var(--yellow);
  z-index: 3;
  animation: avatarBadgePop .5s .2s both;
}

/* ── Chips de stats bajo el nombre ── */
.profile-hero-stats {
  display: flex; gap: 8px; margin-top: 10px; z-index: 2;
  flex-wrap: wrap; justify-content: center;
}
.profile-stat-chip {
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.1);
  border-radius: 20px; padding: 5px 12px;
  display: flex; align-items:center; gap:5px;
  font-size: 11px;
}
.profile-stat-chip .psc-val { color:#fff; font-weight:800; }
.profile-stat-chip .psc-lbl { color:rgba(255,255,255,.35); }

/* ── Botones de foto rediseñados ── */
.photo-btn {
  background: linear-gradient(135deg, var(--teal), rgba(42,100,150,.8));
  color: #fff; border: none; border-radius: 12px;
  padding: 9px 22px; font-size: 12px; font-weight: 800;
  cursor: pointer; font-family: 'Nunito', sans-serif;
  transition: transform .15s, filter .15s;
  box-shadow: 0 4px 14px rgba(42,100,150,.45);
  z-index: 2; position:relative;
  letter-spacing: .3px;
}
.photo-btn:hover { transform: scale(1.05) translateY(-1px); filter: brightness(1.15); }
.photo-remove-btn {
  background: transparent; color: rgba(232,82,122,.7);
  border: 1.5px solid rgba(232,82,122,.3); border-radius: 12px;
  padding: 6px 16px; font-size: 11px; font-weight: 700;
  cursor: pointer; font-family: 'Nunito', sans-serif;
  transition: all .15s;
}
.photo-remove-btn:hover { background: rgba(232,82,122,.1); color: var(--pink); }
@keyframes photoReveal { from{opacity:0;transform:scale(.9)} to{opacity:1;transform:scale(1)} }
#profileImgPanel, #profileImgHome { animation:photoReveal .4s ease forwards; }

/* ══════════════════════════════════════════
   SPLASH SCREEN — Sistema de registro completo
══════════════════════════════════════════ */
#splash-screen {
  position:fixed; inset:0; z-index:100;
  background:linear-gradient(160deg, #0d1b3e 0%, #122050 50%, #0a1628 100%);
  display:flex; flex-direction:column; align-items:center;
  overflow:hidden;
  transition:opacity .6s ease, transform .6s ease;
}
#splash-inner {
  width:100%; height:100%;
  display:flex; flex-direction:column; align-items:center;
  justify-content:flex-start;
  padding:20px 0 50px;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  gap:0;
}
/* iOS fix: cursor:pointer makes all clickable elements receive touch events */
#splash-screen button,
#splash-screen .splash-tab,
#splash-screen .splash-btn,
#splash-screen .splash-google,
#splash-screen .pw-toggle,
#splash-screen .splash-footer span,
#splash-screen [onclick] {
  cursor:pointer;
  -webkit-tap-highlight-color:rgba(255,255,255,.1);
  touch-action:manipulation;
}
#splash-screen.hiding { opacity:0; transform:scale(1.04); pointer-events:none; }
#splash-screen.hidden { display:none; }

#splash-stars { position:absolute; inset:0; pointer-events:none; }

/* Brain icon */
.splash-brain-wrap {
  position:relative; margin-bottom:32px;
  animation:brainFloat 3s ease-in-out infinite;
}
@keyframes brainFloat {
  0%,100%{ transform:translateY(0) rotate(-2deg); }
  50%    { transform:translateY(-18px) rotate(2deg); }
}
.splash-brain {
  width:180px; height:171px;
  filter:drop-shadow(0 0 28px rgba(130,100,220,1)) drop-shadow(0 0 60px rgba(100,70,200,.6));
}

/* Splash pages container */
.splash-pages {
  width:88%; max-width:360px; position:relative; z-index:2;
  overflow:visible;
}

/* Individual page */
.splash-page {
  display:none; flex-direction:column; gap:14px;
  animation:pageIn .4s cubic-bezier(.34,1.3,.64,1) forwards;
}
.splash-page.active { display:flex; }
.splash-page.exit-left  { animation:pageOut .3s ease forwards; }

@keyframes pageIn {
  from { opacity:0; transform:translateX(40px) scale(.97); }
  to   { opacity:1; transform:translateX(0)    scale(1); }
}
@keyframes pageOut {
  from { opacity:1; transform:translateX(0); }
  to   { opacity:0; transform:translateX(-40px); }
}

/* Splash title */
.splash-title {
  font-family:'Special Elite',cursive; color:rgba(255,255,255,.5);
  font-size:12px; letter-spacing:3px; text-transform:uppercase;
  text-align:center; margin-bottom:2px; position:relative; z-index:2;
}

/* Step indicator dots */
.splash-steps {
  display:flex; justify-content:center; gap:6px; margin-bottom:4px;
  position:relative; z-index:2;
}
.splash-step-dot {
  width:6px; height:6px; border-radius:50%;
  background:rgba(255,255,255,.2); transition:all .3s ease;
}
.splash-step-dot.active { background:var(--teal-light); transform:scale(1.4); }
.splash-step-dot.done   { background:var(--green); }

/* Field wrapper */
.splash-field-wrap {
  background:rgba(255,255,255,.04); border:2.5px solid rgba(255,255,255,.15);
  border-radius:18px; padding:14px 20px;
  display:flex; align-items:center; gap:12px;
  transition:border-color .2s, box-shadow .2s;
  backdrop-filter:blur(6px);
}
.splash-field-wrap:focus-within {
  border-color:var(--teal-light);
  box-shadow:0 0 20px rgba(42,100,150,.4), inset 0 0 10px rgba(42,100,150,.05);
}
.splash-field-wrap.error { border-color:var(--pink); box-shadow:0 0 16px rgba(232,82,122,.3); }
.splash-field-wrap.success { border-color:var(--green); }

.splash-field-icon { font-size:20px; }
.splash-field {
  flex:1; background:transparent; border:none;
  color:#fff; font-size:15px; font-family:'Nunito',sans-serif;
  outline:none; font-weight:600;
}
.splash-field::placeholder { color:rgba(255,255,255,.3); }

/* Password strength bar */
.pw-strength-wrap {
  display:none; flex-direction:column; gap:5px;
  padding:0 4px;
}
.pw-strength-wrap.visible { display:flex; }
.pw-strength-bar-bg {
  height:4px; border-radius:4px; background:rgba(255,255,255,.1); overflow:hidden;
}
.pw-strength-bar-fill {
  height:100%; border-radius:4px; width:0;
  transition:width .4s ease, background .4s ease;
}
.pw-strength-label {
  font-size:10px; font-weight:700; text-align:right;
  color:rgba(255,255,255,.4);
}

/* Password show/hide */
.pw-toggle {
  cursor:pointer; color:rgba(255,255,255,.4); font-size:16px;
  transition:color .2s; user-select:none; padding:0 2px;
}
.pw-toggle:hover { color:rgba(255,255,255,.8); }

/* Field helper text */
.splash-helper {
  font-size:10px; font-weight:700; padding:0 6px;
  color:rgba(255,255,255,.35); min-height:14px;
  transition:color .2s;
}
.splash-helper.error { color:var(--pink); }
.splash-helper.ok    { color:var(--green); }

/* Main CTA button */
.splash-btn {
  background:var(--teal); border:none; border-radius:18px;
  padding:16px; color:#fff; font-size:16px; font-weight:800;
  font-family:'Nunito',sans-serif; cursor:pointer; letter-spacing:.5px;
  box-shadow:0 6px 24px rgba(42,100,150,.5);
  transition:transform .15s, filter .15s, box-shadow .15s;
  display:flex; align-items:center; justify-content:center; gap:10px;
  position:relative; overflow:hidden; width:100%;
}
.splash-btn:hover { transform:scale(1.02); filter:brightness(1.12); box-shadow:0 8px 32px rgba(42,100,150,.7); }
.splash-btn:active { transform:scale(.98); }
.splash-btn::after {
  content:''; position:absolute; inset:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);
  transform:translateX(-100%); animation:btnShimmer 2.5s ease infinite;
}
@keyframes btnShimmer { 0%{transform:translateX(-100%)} 60%,100%{transform:translateX(100%)} }
.splash-btn-icon { font-size:22px; transition:transform .3s; }
.splash-btn:hover .splash-btn-icon { transform:translateX(4px); }
.splash-btn:disabled { opacity:.5; cursor:not-allowed; transform:none; }

/* Secondary link */
.splash-footer {
  text-align:center; color:rgba(255,255,255,.25); font-size:11px;
  margin-top:2px; position:relative; z-index:2;
}
.splash-footer span { color:var(--teal-light); cursor:pointer; font-weight:700; }
.splash-footer span:hover { text-decoration:underline; }

/* Divider OR */
.splash-or { display:flex; align-items:center; gap:10px; }
.splash-or-line { flex:1; height:1px; background:rgba(255,255,255,.1); }
.splash-or-text { color:rgba(255,255,255,.3); font-size:11px; }

/* Google btn */
.splash-google {
  background:#fff; color:#333; border:none; border-radius:16px;
  padding:13px; font-size:13px; font-weight:700; cursor:pointer;
  display:flex; align-items:center; justify-content:center; gap:8px;
  transition:transform .15s, box-shadow .15s; width:100%;
  font-family:'Nunito',sans-serif;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
}
.splash-google:hover { transform:scale(1.02); box-shadow:0 6px 20px rgba(0,0,0,.4); }

/* Success avatar section */
.reg-success-box {
  display:flex; flex-direction:column; align-items:center; gap:12px;
  background:rgba(255,255,255,.04); border:1.5px solid rgba(94,220,138,.3);
  border-radius:20px; padding:20px; text-align:center;
}
.reg-avatar-big {
  width:80px; height:80px; border-radius:50%;
  background:linear-gradient(135deg,var(--teal),var(--purple));
  border:3px solid var(--green); display:flex; align-items:center;
  justify-content:center; font-size:40px;
  box-shadow:0 0 24px rgba(94,220,138,.5);
  animation:successPop .6s cubic-bezier(.34,1.6,.64,1);
}
@keyframes successPop {
  from{ transform:scale(0) rotate(-20deg); opacity:0; }
  to  { transform:scale(1) rotate(0deg);   opacity:1; }
}
.reg-success-name { color:#fff; font-size:17px; font-weight:800; }
.reg-success-sub  { color:rgba(255,255,255,.4); font-size:12px; }
.reg-badge-row { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
.reg-badge {
  background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
  border-radius:20px; padding:4px 12px; font-size:11px; font-weight:700;
  color:rgba(255,255,255,.6); display:flex; align-items:center; gap:4px;
}

/* ── inline validation icons ── */
.splash-field-wrap .val-icon {
  font-size:14px; min-width:16px; text-align:center;
  transition:opacity .2s; opacity:0;
}
.splash-field-wrap .val-icon.show { opacity:1; }

/* ── Tab mode switcher (login vs register) ── */
.splash-mode-tabs {
  display:flex; background:rgba(255,255,255,.06); border-radius:14px; padding:3px;
  gap:3px; margin-bottom:2px;
}
.splash-tab {
  flex:1; padding:8px; border-radius:11px; text-align:center;
  font-size:12px; font-weight:800; cursor:pointer; color:rgba(255,255,255,.4);
  transition:all .25s;
}
.splash-tab.active {
  background:var(--teal); color:#fff;
  box-shadow:0 3px 10px rgba(42,100,150,.5);
}

/* ══ SPECIAL EFFECTS ══ */
@keyframes bgShift {
  0%  { background-position:0% 50%; }
  50% { background-position:100% 50%; }
  100%{ background-position:0% 50%; }
}
body {
  background:linear-gradient(-45deg,#0d1b3e,#0a1628,#122050,#0d2244);
  background-size:400% 400%;
  animation:bgShift 12s ease infinite;
}
#particles-canvas { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; opacity:0.35; }
.phone { z-index:1; }
.profile-card {
  box-shadow:0 0 0 2px var(--teal), 0 0 18px rgba(42,100,150,.6), 0 0 40px rgba(42,100,150,.2);
  animation:profileGlow 3s ease-in-out infinite;
}
@keyframes profileGlow {
  0%,100%{ box-shadow:0 0 0 2px var(--teal),0 0 18px rgba(42,100,150,.6),0 0 40px rgba(42,100,150,.2); }
  50%    { box-shadow:0 0 0 2px var(--teal-light),0 0 28px rgba(58,133,196,.9),0 0 60px rgba(58,133,196,.3); }
}
.xp-badge { animation:xpPulse 2s ease-in-out infinite; }
@keyframes xpPulse {
  0%,100%{ box-shadow:0 0 6px rgba(240,192,64,.4); }
  50%    { box-shadow:0 0 14px rgba(240,192,64,.9),0 0 28px rgba(240,192,64,.4); }
}
.streak-fire { animation:firePulse 1.5s ease-in-out infinite; filter:drop-shadow(0 0 6px rgba(240,150,40,.8)); }
@keyframes firePulse {
  0%,100%{ transform:scale(1) rotate(-3deg); filter:drop-shadow(0 0 6px rgba(240,150,40,.8)); }
  50%    { transform:scale(1.15) rotate(3deg); filter:drop-shadow(0 0 16px rgba(255,180,40,1)); }
}
.streak-section { position:relative; overflow:hidden; }
#flame-container { position:absolute; inset:0; pointer-events:none; z-index:0; border-radius:14px; overflow:hidden; }
.streak-section > *:not(#flame-container) { position:relative; z-index:1; }
.flame-particle {
  position:absolute; border-radius:50% 50% 20% 20%; pointer-events:none;
  animation:flameRise var(--dur,.8s) ease-out forwards; transform-origin:center bottom;
}
@keyframes flameRise {
  0%  { transform:translateY(0) scaleX(1) scaleY(1) rotate(var(--rot,0deg)); opacity:1; }
  40% { transform:translateY(calc(var(--fy,-60px)*.4)) scaleX(.8) scaleY(1.3) rotate(calc(var(--rot,0deg)*-1)); opacity:.9; }
  100%{ transform:translateY(var(--fy,-80px)) translateX(var(--fx,0px)) scaleX(.3) scaleY(.2) rotate(var(--rot2,20deg)); opacity:0; }
}
.block { position:relative; overflow:hidden; }
.block::after { content:''; position:absolute; inset:0; background:radial-gradient(circle,rgba(255,255,255,.4) 0%,transparent 70%); transform:scale(0); border-radius:inherit; transition:transform .4s ease,opacity .4s ease; opacity:0; }
.block:active::after { transform:scale(2.5); opacity:1; transition:none; }
.b1:hover,.b3:hover{ box-shadow:0 0 16px rgba(45,111,160,.8); }
.b2:hover{ box-shadow:0 0 16px rgba(240,192,64,.8); }
.b4:hover{ box-shadow:0 0 16px rgba(94,220,138,.8); }
.b5:hover{ box-shadow:0 0 16px rgba(139,98,224,.8); }
.b6:hover{ box-shadow:0 0 16px rgba(232,82,122,.8); }
@keyframes slideInTask { from{transform:translateX(-20px);opacity:0} to{transform:translateX(0);opacity:1} }
.task-item { animation:slideInTask .3s ease forwards; }
@keyframes checkPop { 0%{transform:scale(0)} 70%{transform:scale(1.3)} 100%{transform:scale(1)} }
.task-item.done-task .task-check { animation:checkPop .3s ease forwards; }
.confetti-piece { position:fixed; width:8px; height:8px; border-radius:2px; pointer-events:none; z-index:999; animation:confettiFall var(--dur,1.2s) ease forwards; }
@keyframes confettiFall { 0%{transform:translateY(0) rotate(0deg) scale(1);opacity:1} 100%{transform:translateY(var(--fy,300px)) translateX(var(--fx,50px)) rotate(720deg) scale(0);opacity:0} }
.toast { box-shadow:0 0 20px rgba(42,100,150,.7); }
.nav-btn.active .nav-icon { filter:drop-shadow(0 0 6px rgba(255,255,255,.8)); }
.cal-day.today { box-shadow:0 0 10px rgba(42,100,150,.7); animation:todayPulse 2s ease-in-out infinite; }
@keyframes todayPulse { 0%,100%{box-shadow:0 0 10px rgba(42,100,150,.7)} 50%{box-shadow:0 0 20px rgba(58,133,196,1)} }
@keyframes growBar { from{transform:scaleY(0);transform-origin:bottom} to{transform:scaleY(1);transform-origin:bottom} }
.chart-bar { animation:growBar .6s cubic-bezier(.34,1.56,.64,1) forwards; }
.cal-title {
  background:linear-gradient(90deg,var(--teal-light,#aaa) 0%,#fff 50%,var(--teal-light,#aaa) 100%); background-size:200%;
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  background-clip:text;
  animation:shimmer 3s linear infinite;
}
@keyframes shimmer { 0%{background-position:200%} 100%{background-position:-200%} }
.streak-dot.done { animation:dotWave .4s ease both; }
@keyframes dotWave { 0%{transform:scale(0) translateY(4px);opacity:0} 60%{transform:scale(1.3) translateY(-2px)} 100%{transform:scale(1) translateY(0);opacity:1} }

/* ══ RACHA LEGENDARIA (7+ días) ══ */
.streak-section.legendary {
  border-color: rgba(139,98,224,.6) !important;
  background: linear-gradient(135deg,#1a1035,#0e0a1e) !important;
  box-shadow: 0 0 24px rgba(139,98,224,.25), inset 0 0 30px rgba(139,98,224,.08);
}
.streak-section.legendary::after {
  content:''; position:absolute; inset:0; border-radius:14px; pointer-events:none;
  background: radial-gradient(ellipse at 30% 50%, rgba(139,98,224,.18) 0%, transparent 65%);
}
.streak-section.legendary .streak-count { color: #c49eff !important; }
.streak-section.legendary .streak-dot.done { background: #8b62e0 !important; box-shadow: 0 0 6px rgba(139,98,224,.8); }
.streak-section.legendary .streak-dot.today-dot { background: #b48fff !important; box-shadow: 0 0 8px rgba(180,143,255,.9); }
.streak-section.legendary .streak-fire {
  filter: drop-shadow(0 0 10px rgba(139,98,224,1)) drop-shadow(0 0 22px rgba(100,60,200,.8)) !important;
  animation: firePulseLegendary 1.5s ease-in-out infinite !important;
}
@keyframes firePulseLegendary {
  0%,100% { transform:scale(1) rotate(-3deg); filter:drop-shadow(0 0 10px rgba(139,98,224,1)) drop-shadow(0 0 22px rgba(100,60,200,.8)); }
  50%      { transform:scale(1.18) rotate(3deg); filter:drop-shadow(0 0 20px rgba(180,100,255,1)) drop-shadow(0 0 40px rgba(139,98,224,.9)); }
}
.streak-section.legendary .streak-sub { color: rgba(180,143,255,.5) !important; }

/* Panel racha legendaria */
.streak-big-num.legendary { color: #c49eff !important; text-shadow: 0 0 30px rgba(139,98,224,.7); }
.streak-day-box.legendary-box.active {
  background: rgba(139,98,224,.2) !important;
  border-color: #8b62e0 !important;
  box-shadow: 0 0 10px rgba(139,98,224,.3);
}
.streak-day-box.legendary-box.active .sdb-done { color: #c49eff !important; }

/* Legendary badge */
.legendary-badge {
  display: none; align-items: center; gap: 6px;
  background: linear-gradient(135deg, rgba(139,98,224,.25), rgba(100,60,200,.15));
  border: 1.5px solid rgba(139,98,224,.5); border-radius: 20px;
  padding: 5px 14px; font-size: 11px; font-weight: 800;
  color: #c49eff; text-align:center; justify-content:center;
  animation: legendaryPop .5s cubic-bezier(.34,1.6,.64,1) forwards;
}
.legendary-badge.show { display: flex; }
@keyframes legendaryPop {
  from { transform:scale(0) rotate(-5deg); opacity:0; }
  to   { transform:scale(1) rotate(0deg);  opacity:1; }
}

/* ══ OG BADGE — multicolor animated ══ */
.og-badge-text {
  font-family: 'Special Elite', cursive;
  font-weight: 900;
  font-size: 28px;
  background: linear-gradient(90deg, #ff0080, #ff8c00, #ffe100, #00ff88, #00c8ff, #a855f7, #ff0080);
  background-size: 300% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: ogShift 2.5s linear infinite;
  letter-spacing: 2px;
  line-height: 1;
}
@keyframes ogShift {
  0%   { background-position: 0% 50%; }
  100% { background-position: 300% 50%; }
}
.og-badge-glow {
  position: absolute; inset: 0; border-radius: 50%;
  background: conic-gradient(from 0deg, #ff0080, #ff8c00, #ffe100, #00ff88, #00c8ff, #a855f7, #ff0080);
  opacity: 0.35;
  animation: ogRotate 3s linear infinite;
  filter: blur(6px);
}
@keyframes ogRotate { to { transform: rotate(360deg); } }

/* Card in inventory with OG glow */
.inv-badge-card.og-card {
  border-color: transparent !important;
  background: linear-gradient(var(--navy-mid), var(--navy-mid)) padding-box,
              conic-gradient(from 0deg, #ff0080, #ff8c00, #ffe100, #00ff88, #00c8ff, #a855f7, #ff0080) border-box;
  border: 2px solid transparent;
  animation: ogCardGlow 3s linear infinite;
}
@keyframes ogCardGlow {
  0%, 100% { box-shadow: 0 0 12px rgba(255,0,128,.4), 0 0 24px rgba(168,85,247,.2); }
  33%       { box-shadow: 0 0 12px rgba(0,200,255,.4), 0 0 24px rgba(0,255,136,.2); }
  66%       { box-shadow: 0 0 12px rgba(255,225,0,.4), 0 0 24px rgba(255,140,0,.2); }
}

/* Profile active badge OG variant */
.profile-active-badge.og-active {
  background: transparent;
  border: 1.5px solid transparent;
  background-clip: padding-box;
  animation: ogBadgeBorder 2.5s linear infinite;
}
@keyframes ogBadgeBorder {
  0%   { box-shadow: 0 0 0 1.5px #ff0080; }
  25%  { box-shadow: 0 0 0 1.5px #ffe100; }
  50%  { box-shadow: 0 0 0 1.5px #00c8ff; }
  75%  { box-shadow: 0 0 0 1.5px #a855f7; }
  100% { box-shadow: 0 0 0 1.5px #ff0080; }
}

/* ══ CEO BADGE — dorado, blanco y negro ══ */
.ceo-badge-text {
  font-family: 'Special Elite', cursive;
  font-weight: 900;
  font-size: 24px;
  background: linear-gradient(160deg, #ffffff 0%, #f5d060 30%, #c8950a 55%, #1a1a1a 80%, #f5d060 100%);
  background-size: 200% 200%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: ceoShift 4s ease-in-out infinite;
  letter-spacing: 2px;
  line-height: 1;
}
@keyframes ceoShift {
  0%,100% { background-position: 0% 0%; }
  50%     { background-position: 100% 100%; }
}
.ceo-badge-glow {
  position: absolute; inset: 0; border-radius: 50%;
  background: conic-gradient(from 0deg, #f5d060, #ffffff, #1a1a1a, #f5d060, #c8950a, #ffffff, #f5d060);
  opacity: 0.4;
  animation: ceoRotate 5s linear infinite;
  filter: blur(7px);
}
@keyframes ceoRotate { to { transform: rotate(360deg); } }

/* CEO card — locked, never obtainable */
.inv-badge-card.ceo-card {
  border-color: transparent !important;
  background: linear-gradient(var(--navy-mid), var(--navy-mid)) padding-box,
              conic-gradient(from 0deg, #f5d060, #ffffff, #1a1a1a, #f5d060, #c8950a, #ffffff) border-box;
  border: 2px solid transparent;
  animation: ceoCardGlow 4s ease-in-out infinite;
  cursor: not-allowed;
}
@keyframes ceoCardGlow {
  0%,100% { box-shadow: 0 0 14px rgba(245,208,96,.5), 0 0 28px rgba(200,149,10,.2); }
  50%     { box-shadow: 0 0 20px rgba(255,255,255,.4), 0 0 40px rgba(245,208,96,.3); }
}
.ceo-card .inv-badge-equip {
  background: rgba(245,208,96,.08) !important;
  border-color: rgba(245,208,96,.2) !important;
  color: rgba(245,208,96,.35) !important;
  cursor: not-allowed !important;
}
.ceo-locked-label {
  font-size: 8px; font-weight: 800; letter-spacing: 1px;
  color: rgba(245,208,96,.45); text-transform: uppercase;
  margin-top: -4px;
}

/* Profile active badge CEO variant */
.profile-active-badge.ceo-active {
  background: transparent;
  border: 1.5px solid transparent;
  animation: ceoBadgeBorder 4s ease-in-out infinite;
}
@keyframes ceoBadgeBorder {
  0%,100% { box-shadow: 0 0 0 1.5px #f5d060; }
  33%     { box-shadow: 0 0 0 1.5px #ffffff; }
  66%     { box-shadow: 0 0 0 1.5px #1a1a1a; }
}

/* ══ Locked theme swatch in Apariencia ══ */
.theme-swatch.locked {
  opacity: .45; cursor: not-allowed; filter: grayscale(.6);
}
.theme-swatch.locked::before {
  content: '🔒'; position: absolute; inset: 0; display: flex;
  align-items: center; justify-content: center;
  font-size: 18px; z-index: 2;
  background: rgba(0,0,0,.35); border-radius: 12px;
}
.theme-swatch.locked:hover { transform: none; }
.theme-swatch.locked .check-mark { display: none !important; }

/* ══════════════════════════════
   COIN BADGE (top bar)
══════════════════════════════ */
.coin-badge {
  display:flex; align-items:center; gap:5px;
  background:linear-gradient(135deg,rgba(240,192,64,.15),rgba(240,192,64,.05));
  border:1.5px solid rgba(240,192,64,.4); border-radius:20px;
  padding:4px 10px 4px 7px; cursor:pointer; transition:all .2s;
  animation:coinGlow 3s ease-in-out infinite;
}
.coin-badge:hover { transform:scale(1.06); background:rgba(240,192,64,.2); }
@keyframes coinGlow {
  0%,100%{ box-shadow:0 0 6px rgba(240,192,64,.2); }
  50%    { box-shadow:0 0 14px rgba(240,192,64,.5); }
}
.coin-icon { font-size:16px; line-height:1; }
.coin-count { color:var(--yellow); font-size:13px; font-weight:800; font-family:'Special Elite',cursive; }

/* ══════════════════════════════
   TIENDA PANEL
══════════════════════════════ */
.shop-coin-header {
  display:flex; align-items:center; justify-content:space-between;
  background:linear-gradient(135deg,rgba(240,192,64,.12),rgba(240,192,64,.04));
  border:1.5px solid rgba(240,192,64,.3); border-radius:14px;
  padding:12px 16px;
}
.shop-coin-left { display:flex; align-items:center; gap:10px; }
.shop-coin-big  { font-size:32px; }
.shop-coin-info strong { display:block; color:var(--yellow); font-size:20px; font-weight:800; line-height:1; font-family:'Special Elite',cursive; }
.shop-coin-info span   { color:rgba(255,255,255,.4); font-size:10px; }
.shop-earn-btn {
  background:rgba(240,192,64,.15); border:1.5px solid rgba(240,192,64,.35);
  border-radius:10px; padding:7px 12px; color:var(--yellow);
  font-size:11px; font-weight:800; cursor:pointer; font-family:'Nunito',sans-serif;
  transition:all .2s;
}
.shop-earn-btn:hover { background:rgba(240,192,64,.28); transform:scale(1.04); }

/* Tab bar */
.shop-tabs {
  display:flex; background:rgba(255,255,255,.05); border-radius:12px; padding:3px; gap:2px;
}
.shop-tab {
  flex:1; padding:7px 4px; border-radius:9px; text-align:center;
  font-size:10px; font-weight:800; cursor:pointer; color:rgba(255,255,255,.35);
  transition:all .22s; letter-spacing:.3px; text-transform:uppercase;
  display:flex; flex-direction:column; align-items:center; gap:2px;
}
.shop-tab .st-icon { font-size:14px; }
.shop-tab.active {
  background:var(--teal); color:#fff;
  box-shadow:0 3px 10px rgba(42,100,150,.5);
}

/* Shop grid */
.shop-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:10px;
  padding-bottom:4px;
}
.shop-card {
  background:var(--navy-mid); border-radius:16px; padding:14px 12px 12px;
  display:flex; flex-direction:column; align-items:center; gap:8px;
  border:1.5px solid rgba(255,255,255,.07); cursor:pointer;
  transition:transform .2s, border-color .2s, box-shadow .2s;
  position:relative; overflow:hidden;
}
.shop-card::before {
  content:''; position:absolute; inset:0; opacity:0;
  background:radial-gradient(ellipse at 50% 0%, rgba(255,255,255,.08) 0%, transparent 70%);
  transition:opacity .2s;
}
.shop-card:hover { transform:translateY(-3px); box-shadow:0 8px 24px rgba(0,0,0,.3); }
.shop-card:hover::before { opacity:1; }
.shop-card.owned  { border-color:rgba(94,220,138,.4); }
.shop-card.owned::after {
  content:'✓ Tuyo'; position:absolute; top:7px; right:7px;
  background:var(--green); color:#fff; font-size:8px; font-weight:800;
  padding:2px 7px; border-radius:10px;
}
.shop-card.equipped { border-color:rgba(42,100,150,.7); box-shadow:0 0 14px rgba(42,100,150,.3); }
.shop-card.equipped::after {
  content:'✦ Activo'; position:absolute; top:7px; right:7px;
  background:var(--teal); color:#fff; font-size:8px; font-weight:800;
  padding:2px 7px; border-radius:10px;
}
.shop-card-preview {
  width:56px; height:56px; border-radius:14px;
  display:flex; align-items:center; justify-content:center;
  font-size:30px; position:relative; flex-shrink:0;
}
.shop-card-name  { color:#fff; font-size:12px; font-weight:800; text-align:center; line-height:1.2; }
.shop-card-desc  { color:rgba(255,255,255,.35); font-size:9px; text-align:center; line-height:1.3; }
.shop-card-price {
  display:flex; align-items:center; gap:4px;
  background:rgba(240,192,64,.12); border:1px solid rgba(240,192,64,.25);
  border-radius:20px; padding:3px 10px; margin-top:2px;
}
.shop-card-price .pc { font-size:12px; }
.shop-card-price span { color:var(--yellow); font-size:11px; font-weight:800; font-family:'Special Elite',cursive; }
.shop-card-price.free { background:rgba(94,220,138,.1); border-color:rgba(94,220,138,.3); }
.shop-card-price.free span { color:var(--green); }

/* Shop list (for streak shields etc) */
.shop-list { display:flex; flex-direction:column; gap:8px; }
.shop-list-item {
  background:var(--navy-mid); border-radius:14px; padding:12px 14px;
  display:flex; align-items:center; gap:12px;
  border:1.5px solid rgba(255,255,255,.07); cursor:pointer;
  transition:transform .15s, border-color .2s;
}
.shop-list-item:hover { transform:translateX(3px); }
.shop-list-item.owned  { border-color:rgba(94,220,138,.35); }
.sli-icon  { width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px; flex-shrink:0; }
.sli-info  { flex:1; }
.sli-name  { color:#fff; font-size:13px; font-weight:800; }
.sli-desc  { color:rgba(255,255,255,.35); font-size:10px; margin-top:2px; }
.sli-price {
  display:flex; align-items:center; gap:4px; flex-shrink:0;
  background:rgba(240,192,64,.1); border:1px solid rgba(240,192,64,.25);
  border-radius:16px; padding:4px 10px;
}
.sli-price .pc  { font-size:13px; }
.sli-price span { color:var(--yellow); font-size:12px; font-weight:800; font-family:'Special Elite',cursive; }

/* Purchase confirm modal */
.shop-modal-overlay {
  position:absolute; inset:0; background:rgba(0,0,0,.65);
  display:flex; align-items:center; justify-content:center;
  z-index:50; border-radius:0; opacity:0; pointer-events:none;
  transition:opacity .25s; backdrop-filter:blur(4px);
}
.shop-modal-overlay.open { opacity:1; pointer-events:all; }
.shop-modal {
  background:var(--navy-mid); border-radius:22px; padding:24px 20px;
  width:85%; max-width:300px; display:flex; flex-direction:column;
  align-items:center; gap:14px; text-align:center;
  border:1.5px solid rgba(255,255,255,.1);
  box-shadow:0 20px 60px rgba(0,0,0,.5);
  transform:scale(.85) translateY(20px); transition:transform .3s cubic-bezier(.34,1.4,.64,1);
}
.shop-modal-overlay.open .shop-modal { transform:scale(1) translateY(0); }
.shop-modal-emoji { font-size:52px; min-height:56px; display:flex; align-items:center; justify-content:center; }
.shop-modal-name  { color:#fff; font-size:16px; font-weight:800; }
.shop-modal-price {
  display:flex; align-items:center; gap:6px;
  background:rgba(240,192,64,.12); border-radius:20px; padding:5px 16px;
  border:1px solid rgba(240,192,64,.3);
}
.shop-modal-price .pc { font-size:18px; }
.shop-modal-price span { color:var(--yellow); font-size:16px; font-weight:800; font-family:'Special Elite',cursive; }
.shop-modal-desc  { color:rgba(255,255,255,.4); font-size:12px; line-height:1.5; }
.shop-modal-btns  { display:flex; gap:8px; width:100%; }
.shop-modal-cancel {
  flex:1; padding:11px; border-radius:12px; border:1.5px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06); color:rgba(255,255,255,.6);
  font-size:13px; font-weight:800; cursor:pointer; font-family:'Nunito',sans-serif; transition:background .15s;
}
.shop-modal-cancel:hover { background:rgba(255,255,255,.12); }
.shop-modal-confirm {
  flex:2; padding:11px; border-radius:12px; border:none;
  background:var(--teal); color:#fff; font-size:13px; font-weight:800;
  cursor:pointer; font-family:'Nunito',sans-serif;
  box-shadow:0 4px 14px rgba(42,100,150,.4); transition:filter .15s, transform .15s;
}
.shop-modal-confirm:hover { filter:brightness(1.12); transform:scale(1.02); }
.shop-modal-confirm:disabled { opacity:.4; cursor:not-allowed; transform:none; }

/* Not enough coins message */
.shop-no-coins {
  color:var(--pink); font-size:11px; font-weight:700;
  animation:shake .4s ease;
}
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }

/* ══════════════════════════════
   INVENTARIO
══════════════════════════════ */
.inv-empty {
  display:flex; flex-direction:column; align-items:center; gap:10px;
  padding:32px 16px; text-align:center;
}
.inv-empty-icon { font-size:44px; opacity:.4; }
.inv-empty-text { color:rgba(255,255,255,.3); font-size:12px; font-weight:700; }
.inv-empty-btn {
  background:var(--teal); color:#fff; border:none; border-radius:12px;
  padding:8px 18px; font-size:12px; font-weight:800; cursor:pointer;
  font-family:'Nunito',sans-serif; transition:filter .15s;
  margin-top:4px;
}
.inv-empty-btn:hover { filter:brightness(1.12); }

/* Power card in inventory */
.inv-power-card {
  background:var(--navy-mid); border-radius:14px; padding:13px 14px;
  display:flex; align-items:center; gap:12px;
  border:1.5px solid rgba(255,255,255,.07);
  transition:border-color .2s;
}
.inv-power-card:hover { border-color:rgba(94,220,138,.3); }
.inv-power-icon {
  width:46px; height:46px; border-radius:13px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center; font-size:24px;
  background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.08);
}
.inv-power-info { flex:1; min-width:0; }
.inv-power-name { color:#fff; font-size:13px; font-weight:800; }
.inv-power-desc { color:rgba(255,255,255,.35); font-size:10px; margin-top:2px; line-height:1.3; }
.inv-power-qty  {
  background:rgba(94,220,138,.12); border:1px solid rgba(94,220,138,.25);
  border-radius:20px; padding:2px 9px; font-size:10px; font-weight:800;
  color:var(--green); margin-top:4px; display:inline-block;
}
.inv-use-btn {
  flex-shrink:0; background:var(--teal); color:#fff; border:none;
  border-radius:10px; padding:7px 13px; font-size:11px; font-weight:800;
  cursor:pointer; font-family:'Nunito',sans-serif; transition:all .15s;
  white-space:nowrap;
}
.inv-use-btn:hover { filter:brightness(1.12); transform:scale(1.04); }
.inv-use-btn:disabled { opacity:.35; cursor:not-allowed; transform:none; }

/* Badge grid in inventory */
.inv-badge-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:9px;
}
.inv-badge-card {
  background:var(--navy-mid); border-radius:14px; padding:12px 10px;
  display:flex; flex-direction:column; align-items:center; gap:7px;
  border:1.5px solid rgba(255,255,255,.07); cursor:pointer;
  transition:transform .2s, border-color .2s, box-shadow .2s;
  position:relative;
}
.inv-badge-card:hover { transform:translateY(-2px); }
.inv-badge-card.equipped-badge {
  border-color:var(--yellow);
  box-shadow:0 0 14px rgba(240,192,64,.25);
}
.inv-badge-card.equipped-badge::after {
  content:'✦ Activo'; position:absolute; top:6px; right:6px;
  background:var(--yellow); color:#333; font-size:7.5px; font-weight:800;
  padding:2px 6px; border-radius:8px;
}
.inv-badge-emoji { font-size:32px; }
.inv-badge-name  { color:#fff; font-size:11px; font-weight:800; text-align:center; line-height:1.2; }
.inv-badge-desc  { color:rgba(255,255,255,.3); font-size:9px; text-align:center; }
.inv-badge-equip {
  width:100%; padding:5px; border-radius:8px; border:none;
  font-size:10px; font-weight:800; cursor:pointer; font-family:'Nunito',sans-serif;
  transition:all .15s;
}
.inv-badge-equip.equip-btn  { background:rgba(240,192,64,.15); color:var(--yellow); border:1px solid rgba(240,192,64,.3); }
.inv-badge-equip.equip-btn:hover  { background:rgba(240,192,64,.28); }
.inv-badge-equip.unequip-btn { background:rgba(255,255,255,.07); color:rgba(255,255,255,.4); }
.inv-badge-equip.unequip-btn:hover { background:rgba(255,255,255,.12); color:#fff; }

/* Equipped badge display on profile */
.profile-active-badge {
  display:inline-flex; align-items:center; gap:4px;
  background:rgba(240,192,64,.12); border:1px solid rgba(240,192,64,.3);
  border-radius:12px; padding:2px 8px; font-size:10px; font-weight:700;
  color:var(--yellow); margin-top:2px;
}

/* Power used toast effect */
@keyframes powerUse {
  0%  { transform:scale(1); }
  40% { transform:scale(1.08); }
  100%{ transform:scale(1); }
}

/* ══════════════════════════════
   SETTINGS / CONFIG PANEL
══════════════════════════════ */
.cfg-section-label {
  color:rgba(255,255,255,.35); font-size:9px; font-weight:800;
  text-transform:uppercase; letter-spacing:1.5px; padding:0 4px;
  margin-top:2px;
}

/* Profile preview card */
.cfg-profile-card {
  display:flex; align-items:center; gap:14px;
  background:linear-gradient(135deg,var(--navy-mid),rgba(42,100,150,.25));
  border:1.5px solid rgba(42,100,150,.4); border-radius:16px;
  padding:14px 16px; position:relative; overflow:hidden;
}
.cfg-profile-card::before {
  content:''; position:absolute; inset:0;
  background:radial-gradient(ellipse at 20% 50%, rgba(58,133,196,.15) 0%, transparent 60%);
  pointer-events:none;
}
.cfg-avatar-wrap {
  width:54px; height:54px; border-radius:50%; position:relative;
  border:2.5px solid var(--teal); cursor:pointer; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  overflow:hidden; transition:box-shadow .2s;
}
.cfg-avatar-wrap:hover { box-shadow:0 0 16px rgba(58,133,196,.6); }
.cfg-avatar-emoji { font-size:28px; line-height:1; }
.cfg-avatar-overlay {
  position:absolute; inset:0; background:rgba(0,0,0,.5);
  display:flex; align-items:center; justify-content:center;
  font-size:16px; opacity:0; transition:opacity .2s; border-radius:50%;
}
.cfg-avatar-wrap:hover .cfg-avatar-overlay { opacity:1; }
.cfg-profile-info { flex:1; }
.cfg-profile-name { color:#fff; font-size:14px; font-weight:800; }
.cfg-profile-sub  { color:rgba(255,255,255,.4); font-size:11px; margin-top:2px; }
.cfg-edit-btn {
  width:34px; height:34px; background:rgba(255,255,255,.08);
  border:1.5px solid rgba(255,255,255,.15); border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; color:rgba(255,255,255,.6); transition:all .2s; flex-shrink:0;
}
.cfg-edit-btn:hover { background:var(--teal); color:#fff; border-color:var(--teal); }

/* Setting row */
.cfg-row {
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  background:var(--navy-mid); border-radius:14px; padding:11px 14px;
  transition:background .15s;
}
.cfg-row-left { display:flex; align-items:center; gap:12px; flex:1; min-width:0; }
.cfg-icon-box {
  width:38px; height:38px; border-radius:11px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:18px; box-shadow:0 3px 10px rgba(0,0,0,.3);
}
.cfg-row-text { display:flex; flex-direction:column; min-width:0; }
.cfg-row-text strong { color:#fff; font-size:13px; display:block; }
.cfg-row-text span   { color:rgba(255,255,255,.4); font-size:10px; margin-top:1px; transition:color .2s; }

/* Toggle switch */
.cfg-toggle { position:relative; display:inline-block; width:44px; height:24px; flex-shrink:0; }
.cfg-toggle input { opacity:0; width:0; height:0; position:absolute; }
.cfg-toggle-track {
  position:absolute; inset:0; border-radius:24px;
  background:rgba(255,255,255,.12); transition:background .3s;
  cursor:pointer; box-shadow:inset 0 1px 3px rgba(0,0,0,.3);
}
.cfg-toggle input:checked + .cfg-toggle-track {
  background:var(--track-on, var(--green));
  box-shadow:0 0 10px color-mix(in srgb, var(--track-on, var(--green)) 60%, transparent);
}
.cfg-toggle-thumb {
  position:absolute; top:3px; left:3px;
  width:18px; height:18px; border-radius:50%;
  background:#fff; transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  box-shadow:0 2px 6px rgba(0,0,0,.3);
}
.cfg-toggle input:checked ~ .cfg-toggle-track .cfg-toggle-thumb { transform:translateX(20px); }

/* Slider */
.cfg-slider-wrap {
  display:flex; align-items:center; gap:8px;
  padding:6px 14px 10px;
  animation:cfgSlideDown .3s ease forwards;
}
@keyframes cfgSlideDown { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }
.cfg-slider-icon { font-size:14px; flex-shrink:0; }
.cfg-slider {
  flex:1; -webkit-appearance:none; height:4px; border-radius:4px;
  background:linear-gradient(to right, var(--green) 0%, var(--green) var(--fill,100%), rgba(255,255,255,.15) var(--fill,100%), rgba(255,255,255,.15) 100%);
  outline:none; cursor:pointer;
}
.cfg-slider::-webkit-slider-thumb {
  -webkit-appearance:none; width:18px; height:18px; border-radius:50%;
  background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.4), 0 0 0 3px rgba(94,220,138,.4);
  cursor:pointer; transition:transform .15s;
}
.cfg-slider::-webkit-slider-thumb:hover { transform:scale(1.2); }

/* Sub-options container */
.cfg-sub-opts {
  padding:0 4px 4px 14px;
  animation:cfgSlideDown .3s ease forwards;
}
.cfg-chip-row { display:flex; gap:6px; flex-wrap:wrap; }
.cfg-chip {
  padding:5px 12px; border-radius:20px; font-size:11px; font-weight:700;
  background:rgba(255,255,255,.07); color:rgba(255,255,255,.45);
  border:1.5px solid rgba(255,255,255,.1); cursor:pointer; transition:all .2s;
  user-select:none;
}
.cfg-chip:hover { background:rgba(255,255,255,.12); color:rgba(255,255,255,.7); }
.cfg-chip.active {
  background:rgba(42,100,150,.35); color:var(--teal-light);
  border-color:var(--teal); box-shadow:0 0 8px rgba(42,100,150,.3);
}

/* Stepper (focus time) */
.cfg-stepper {
  display:flex; align-items:center; gap:4px; flex-shrink:0;
}
.cfg-stepper-btn {
  width:28px; height:28px; border-radius:8px;
  background:rgba(255,255,255,.1); color:#fff;
  display:flex; align-items:center; justify-content:center;
  font-size:18px; font-weight:800; cursor:pointer;
  transition:background .15s, transform .15s; user-select:none; line-height:1;
}
.cfg-stepper-btn:hover  { background:var(--teal); }
.cfg-stepper-btn:active { transform:scale(.9); }
.cfg-stepper-val {
  min-width:32px; text-align:center; color:#fff;
  font-size:16px; font-weight:800; font-family:'Special Elite',cursive;
  transition:transform .15s;
}
.cfg-stepper-unit { color:rgba(255,255,255,.4); font-size:10px; font-weight:700; }

/* Focus start button */
.cfg-focus-start-btn {
  width:100%; margin-top:8px; padding:9px;
  background:linear-gradient(135deg,rgba(46,125,79,.5),rgba(94,220,138,.25));
  border:1.5px solid rgba(94,220,138,.4); border-radius:12px;
  color:var(--green); font-size:12px; font-weight:800;
  font-family:'Nunito',sans-serif; cursor:pointer;
  display:flex; align-items:center; justify-content:center; gap:8px;
  transition:all .2s;
}
.cfg-focus-start-btn:hover { background:linear-gradient(135deg,rgba(46,125,79,.8),rgba(94,220,138,.4)); transform:scale(1.01); }
.cfg-focus-start-btn.running {
  background:linear-gradient(135deg,rgba(232,82,122,.3),rgba(232,82,122,.15));
  border-color:rgba(232,82,122,.5); color:var(--pink);
}

/* Mute countdown badge */
.cfg-mute-countdown {
  margin-top:8px; padding:8px 12px;
  background:rgba(139,98,224,.15); border:1px solid rgba(139,98,224,.3);
  border-radius:10px; font-size:11px; color:rgba(255,255,255,.6);
  display:flex; align-items:center; gap:6px; animation:cfgSlideDown .3s ease;
}
.cfg-mute-countdown strong { color:var(--purple); }

/* Save button */
.cfg-save-btn {
  width:100%; padding:12px; margin-top:4px;
  background:var(--teal); border:none; border-radius:14px;
  color:#fff; font-size:13px; font-weight:800;
  font-family:'Nunito',sans-serif; cursor:pointer;
  transition:transform .15s, filter .15s;
  box-shadow:0 4px 16px rgba(42,100,150,.4);
}
.cfg-save-btn:hover { transform:scale(1.01); filter:brightness(1.1); }

/* ── GANG badge ── */
@keyframes gangFlicker {
  0%,100% { opacity:1; }
  92%     { opacity:1; }
  93%     { opacity:.6; }
  94%     { opacity:1; }
  97%     { opacity:.7; }
  98%     { opacity:1; }
}
.gang-badge-text {
  font-family:'Special Elite',cursive;
  background: linear-gradient(90deg,#555,#aaa,#333,#888,#555);
  background-size:300%;
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  background-clip:text;
  animation:gangFlicker 4s ease-in-out infinite;
  font-weight:800; letter-spacing:2px;
}
.gang-active {
  background:linear-gradient(135deg,#111,#222) !important;
  border-color:rgba(150,150,150,.4) !important;
  box-shadow:0 2px 8px rgba(0,0,0,.6) !important;
}
.profile-active-badge.luck-active {
  background:linear-gradient(135deg,#041208,#0d2818) !important;
  border-color:rgba(94,220,138,.5) !important;
  box-shadow:0 0 10px rgba(94,220,138,.5),0 0 20px rgba(94,220,138,.2) !important;
}
.gang-card {
  background:linear-gradient(135deg,#111,#1a1a1a) !important;
  border:1.5px solid rgba(120,120,120,.3) !important;
}
.gang-badge-glow {
  position:absolute; inset:-4px; border-radius:50%;
  background:radial-gradient(circle,rgba(100,100,100,.4),transparent 70%);
  filter:blur(8px); pointer-events:none;
}

/* ── GANG badge CSS end ── */

/* ── LUCK badge ── */
@keyframes luckFlow {
  0%   { background-position: 0% 50%; }
  50%  { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
@keyframes luckGlowPulse {
  0%,100% { opacity:.5; }
  50%     { opacity:.9; }
}
@keyframes luckBgFlow {
  0%   { background-position: 0% 50%; }
  50%  { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
@keyframes luckFloat {
  0%,100% { transform:translateY(0) rotate(0deg); opacity:.8; }
  50%     { transform:translateY(-20px) rotate(15deg); opacity:.4; }
}
.luck-badge-text {
  font-family:'Special Elite',cursive;
  font-weight:900;
  font-size:16px;
  background: linear-gradient(90deg, #5edc8a, #2d8a4e, #a8f0c0, #5edc8a, #1a5c30, #5edc8a);
  background-size: 400%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: luckFlow 3s ease-in-out infinite;
  letter-spacing: 3px;
}
.luck-badge-glow {
  position:absolute; inset:-8px; border-radius:50%;
  background: radial-gradient(circle, rgba(94,220,138,.55) 0%, rgba(45,138,78,.25) 50%, transparent 75%);
  pointer-events:none;
  animation: luckGlowFade 2.5s ease-in-out infinite;
}
@keyframes luckGlowFade {
  0%,100% { opacity:.6; }
  50%     { opacity:1; }
}
.luck-card {
  background: linear-gradient(135deg,#041208,#071a10,#0d2818) !important;
  border: 2px solid #2d8a4e !important;
  box-shadow: 0 0 14px rgba(94,220,138,.35), 0 0 30px rgba(94,220,138,.1) !important;
  position:relative;
  overflow:hidden;
}
.luck-card::after {
  content:'';
  position:absolute;
  inset:0;
  background: radial-gradient(ellipse at 50% 0%, rgba(94,220,138,.12) 0%, transparent 65%);
  pointer-events:none;
}
.luck-active {
  background:linear-gradient(135deg,#041208,#0d2818) !important;
  border-color:rgba(94,220,138,.5) !important;
  box-shadow:0 0 12px rgba(94,220,138,.5),0 0 24px rgba(94,220,138,.2) !important;
}
/* ── LUCK badge CSS end ── */

/* ── GymBro VS comparison ── */
.gb-vs-header {
  display:flex;align-items:center;gap:10px;
  background:rgba(255,255,255,.04);border-radius:16px;
  padding:14px;margin-bottom:14px;
}
.gb-vs-player {
  flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;text-align:center;
}
.gb-vs-avatar { font-size:32px; }
.gb-vs-name { font-size:12px;font-weight:800;color:#fff;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap; }
.gb-vs-badge { font-size:10px;color:rgba(255,255,255,.4);font-weight:700; }
.gb-vs-divider {
  width:36px;height:36px;border-radius:50%;
  background:linear-gradient(135deg,#e8527a,#8b62e0);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;font-weight:900;color:#fff;flex-shrink:0;
}
.gb-week-row {
  background:rgba(255,255,255,.03);border-radius:14px;
  padding:12px;margin-bottom:8px;
  border:1px solid rgba(255,255,255,.06);
}
.gb-week-label {
  color:rgba(255,255,255,.35);font-size:9px;font-weight:800;
  text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;
  display:flex;align-items:center;justify-content:space-between;
}
.gb-stat-row { display:flex;align-items:center;gap:6px;margin-bottom:6px; }
.gb-stat-label { color:rgba(255,255,255,.5);font-size:11px;font-weight:700;width:70px;flex-shrink:0; }
.gb-bar-wrap { flex:1;position:relative;display:flex;align-items:center;gap:6px; }
.gb-bar-me { height:8px;border-radius:4px 0 0 4px;background:var(--teal);min-width:3px;transition:width .5s; }
.gb-bar-them { height:8px;border-radius:0 4px 4px 0;background:#e8527a;min-width:3px;transition:width .5s; }
.gb-val-me { font-size:10px;font-weight:800;color:var(--teal);min-width:28px;text-align:right; }
.gb-val-them { font-size:10px;font-weight:800;color:#e8527a;min-width:28px; }
.gb-winner-badge {
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 8px;border-radius:8px;font-size:10px;font-weight:800;
}

/* ── Enhanced confetti ── */
.confetti-piece { position:fixed; pointer-events:none; z-index:9999; animation:confettiFall var(--dur,2s) cubic-bezier(.25,.46,.45,.94) forwards; }
@keyframes confettiFall { 0%{transform:translateY(0) rotate(0deg) scale(1);opacity:1} 80%{opacity:.8} 100%{transform:translateY(var(--fy,300px)) translateX(var(--fx,50px)) rotate(720deg) scale(0);opacity:0} }


/* ══ MYSTERY BADGE ??? ══ */
.mystery-badge-text {
  font-family: 'Special Elite', cursive;
  font-size: 22px;
  font-weight: 900;
  background: linear-gradient(90deg, #888, #fff, #555, #fff, #888);
  background-size: 300% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: mysteryShift 3s linear infinite;
  letter-spacing: 2px;
  text-shadow: none;
}
@keyframes mysteryShift {
  0%   { background-position: 0% center; }
  100% { background-position: 300% center; }
}
.mystery-badge-glow {
  position: absolute; inset: -6px; border-radius: 50%;
  background: radial-gradient(circle, rgba(150,150,150,.6) 0%, transparent 70%);
  animation: mysteryPulse 2.5s ease-in-out infinite;
  pointer-events: none;
}
@keyframes mysteryPulse {
  0%,100% { opacity:.3; transform:scale(1); }
  50%     { opacity:.7; transform:scale(1.15); }
}
.inv-badge-card.mystery-card { border-color: rgba(180,180,180,.3); }
.profile-active-badge.mystery-active {
  border-color: transparent;
  animation: mysteryBorder 3s linear infinite;
}
@keyframes mysteryBorder {
  0%,100% { box-shadow: 0 0 6px rgba(180,180,180,.5); }
  50%     { box-shadow: 0 0 14px rgba(255,255,255,.7); }
}

/* ══ GYMBROS BADGE ══ */
.gymbro-badge-text {
  font-family: 'Special Elite', cursive;
  font-size: 14px;
  font-weight: 900;
  background: linear-gradient(90deg, #ff6b35, #f7c59f, #ff6b35);
  background-size: 200% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: gymbroShift 2s linear infinite;
  letter-spacing: 1px;
}
@keyframes gymbroShift {
  0%   { background-position: 0% center; }
  100% { background-position: 200% center; }
}
.gymbro-badge-glow {
  position: absolute; inset: -6px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,107,53,.5) 0%, transparent 70%);
  animation: gymbroPulse 2s ease-in-out infinite;
  pointer-events: none;
}
@keyframes gymbroPulse {
  0%,100% { opacity:.4; transform:scale(1); }
  50%     { opacity:.8; transform:scale(1.1); }
}
.inv-badge-card.gymbro-card { border-color: rgba(255,107,53,.4); }

/* GymBro selector in social */
.gymbro-section {
  background: linear-gradient(135deg, rgba(255,107,53,.08), rgba(247,197,159,.05));
  border: 1.5px solid rgba(255,107,53,.3);
  border-radius: 14px;
  padding: 12px 14px;
  margin-bottom: 10px;
}
.gymbro-label {
  color: rgba(255,255,255,.5); font-size: 10px; font-weight: 800;
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;
}
.gymbro-row { display: flex; align-items: center; gap: 10px; }
.gymbro-avatar { font-size: 28px; }
.gymbro-info { flex: 1; min-width: 0; }
.gymbro-name { color: #fff; font-size: 13px; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.gymbro-sub  { color: rgba(255,107,53,.8); font-size: 10px; font-weight: 700; }
.gymbro-btn  {
  background: rgba(255,107,53,.15); border: 1.5px solid rgba(255,107,53,.4);
  color: #ff6b35; border-radius: 8px; padding: 5px 10px;
  font-size: 11px; font-weight: 800; cursor: pointer; transition: background .15s;
}
.gymbro-btn:hover { background: rgba(255,107,53,.28); }
.gymbro-badge-strip {
  display: flex; align-items: center; gap: 6px;
  margin-top: 8px; padding-top: 8px;
  border-top: 1px solid rgba(255,107,53,.2);
  font-size: 11px; color: rgba(255,255,255,.45);
}

/* Chat gymbro badge banner */
.chat-gymbro-banner {
  display: flex; align-items: center; justify-content: center; gap: 6px;
  background: linear-gradient(90deg, rgba(255,107,53,.12), rgba(247,197,159,.08), rgba(255,107,53,.12));
  border-top: 1px solid rgba(255,107,53,.25);
  border-bottom: 1px solid rgba(255,107,53,.25);
  padding: 5px 14px; font-size: 11px; font-weight: 800; color: #ff6b35;
  letter-spacing: .5px;
}


/* ══ RUTINA PANEL — GYM DARK THEME ══ */
@keyframes weightSway { 0%,100%{transform:rotate(-3deg);} 50%{transform:rotate(3deg);} }
@keyframes gymPulse { 0%,100%{opacity:.6;} 50%{opacity:1;} }

#panel-rutina { background:linear-gradient(160deg,#0a0a0a,#111,#0d0d0d) !important; }
#panel-rutina .panel-header { background:linear-gradient(90deg,#111,#1a1a1a) !important; border-bottom:1px solid rgba(255,255,255,.06) !important; }
#panel-rutina .panel-title { color:#eee !important; }
#panel-rutina .back-btn { color:#aaa !important; }
#panel-rutina .panel-content { background:transparent !important; }

.rutina-gym-header {
  background:linear-gradient(135deg,#111,#1a1a1a);
  border:1px solid rgba(255,255,255,.06);
  border-radius:16px; padding:14px 16px;
  display:flex; align-items:center; gap:12px; margin-bottom:12px;
  position:relative; overflow:hidden;
}
.rutina-gym-header::before {
  content:'🏋️'; position:absolute; right:-8px; top:50%; transform:translateY(-50%) rotate(-15deg);
  font-size:56px; opacity:.07; pointer-events:none;
}
.rutina-gym-deco { font-size:28px; animation:weightSway 3s ease-in-out infinite; }
.rutina-gym-title { color:#fff; font-size:15px; font-weight:800; font-family:'Special Elite',cursive; letter-spacing:1px; }
.rutina-gym-sub { color:rgba(255,255,255,.35); font-size:10px; margin-top:2px; }

.rutina-day-tabs { display:flex; gap:4px; overflow-x:auto; padding-bottom:4px; scrollbar-width:none; }
.rutina-day-tabs::-webkit-scrollbar { display:none; }
.rutina-day-tab { flex-shrink:0; padding:5px 11px; border-radius:20px; background:rgba(255,255,255,.06); color:rgba(255,255,255,.35); font-size:10px; font-weight:800; cursor:pointer; transition:all .2s; border:1.5px solid rgba(255,255,255,.06); }
.rutina-day-tab.active { background:#222; color:#fff; border-color:rgba(255,255,255,.2); box-shadow:0 2px 12px rgba(0,0,0,.5); }
.rutina-day-tab.rest { color:rgba(94,220,138,.5); border-color:rgba(94,220,138,.1); }
.rutina-day-tab.today-tab { border-color:rgba(255,255,255,.3) !important; }

.rutina-exercise-list { display:flex; flex-direction:column; gap:8px; margin-top:4px; }
.rutina-exercise-card {
  background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.07);
  border-radius:14px; padding:11px 14px;
  display:flex; align-items:center; gap:12px;
  transition:all .2s; cursor:pointer;
  position:relative; overflow:hidden;
}
.rutina-exercise-card::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:3px;
  background:var(--ex-color,#444); border-radius:3px 0 0 3px; transition:width .3s;
}
.rutina-exercise-card:hover { background:rgba(255,255,255,.07); }
.rutina-exercise-card.done { background:rgba(94,220,138,.05); border-color:rgba(94,220,138,.15); }
.rutina-exercise-card.done::before { background:var(--green); width:4px; }
.rutina-ex-icon { width:38px; height:38px; border-radius:10px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:18px; background:rgba(255,255,255,.05); }
.rutina-ex-info { flex:1; min-width:0; }
.rutina-ex-name { color:#eee; font-size:12px; font-weight:800; }
.rutina-ex-name.crossed { text-decoration:line-through; opacity:.4; }
.rutina-ex-detail { color:rgba(255,255,255,.3); font-size:10px; margin-top:1px; }
.rutina-ex-check { width:24px; height:24px; border-radius:50%; border:2px solid rgba(255,255,255,.15); display:flex; align-items:center; justify-content:center; flex-shrink:0; font-size:12px; transition:all .2s; }
.rutina-exercise-card.done .rutina-ex-check { background:var(--green); border-color:var(--green); color:#111; font-weight:800; }
.rutina-ex-delete { width:22px; height:22px; border-radius:50%; background:rgba(232,82,122,.1); border:1px solid rgba(232,82,122,.2); color:var(--pink); font-size:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all .2s; margin-left:2px; }
.rutina-ex-delete:hover { background:rgba(232,82,122,.25); }

.rutina-progress-bar { height:5px; background:rgba(255,255,255,.06); border-radius:6px; overflow:hidden; margin:6px 0 2px; }
.rutina-progress-fill { height:100%; background:linear-gradient(90deg,#444,#888); border-radius:6px; transition:width .5s ease; }
.rutina-progress-fill.complete { background:linear-gradient(90deg,var(--green),#88ffbb); }

.rutina-stats-row { display:flex; gap:6px; margin-bottom:10px; }
.rutina-stat-chip { flex:1; background:rgba(255,255,255,.04); border-radius:10px; padding:8px 6px; text-align:center; border:1px solid rgba(255,255,255,.06); }
.rutina-stat-num { color:#fff; font-size:15px; font-weight:800; }
.rutina-stat-label { color:rgba(255,255,255,.3); font-size:8px; margin-top:1px; text-transform:uppercase; letter-spacing:.5px; }

.rutina-rest-day { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px 20px; gap:10px; }
.rutina-rest-emoji { font-size:48px; }
.rutina-rest-title { color:#fff; font-size:16px; font-weight:800; }
.rutina-rest-sub { color:rgba(255,255,255,.3); font-size:11px; text-align:center; line-height:1.6; }

/* Add exercise form */
.rutina-add-form {
  background:#111; border:1px solid rgba(255,255,255,.08);
  border-radius:14px; padding:12px 14px; margin-top:8px;
}
.rutina-add-title { color:rgba(255,255,255,.5); font-size:9px; font-weight:800; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
.rutina-add-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
.rutina-add-input {
  flex:1; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
  border-radius:10px; padding:8px 10px; color:#fff; font-size:12px; font-weight:600;
  font-family:'Nunito',sans-serif; outline:none;
}
.rutina-add-input::placeholder { color:rgba(255,255,255,.25); }
.rutina-add-input:focus { border-color:rgba(255,255,255,.25); background:rgba(255,255,255,.09); }
.rutina-add-input.small { width:70px; flex:none; text-align:center; }
.rutina-add-btn {
  padding:8px 14px; border-radius:10px; border:none; cursor:pointer;
  background:#222; color:#eee; font-size:11px; font-weight:800;
  font-family:'Nunito',sans-serif; transition:all .2s; white-space:nowrap;
  border:1px solid rgba(255,255,255,.12);
}
.rutina-add-btn:hover { background:#333; }

/* Day complete reward banner */
.rutina-complete-banner {
  background:linear-gradient(135deg,#111,#1a1a1a);
  border:1.5px solid rgba(94,220,138,.3);
  border-radius:14px; padding:12px 16px;
  display:flex; align-items:center; gap:10px; margin-bottom:8px;
  animation:gymPulse 2s ease-in-out infinite;
}
.rutina-complete-banner-text { color:var(--green); font-size:12px; font-weight:800; }
.rutina-complete-banner-sub { color:rgba(255,255,255,.4); font-size:10px; }

/* Decorative weights strip */
.rutina-weights-strip {
  display:flex; align-items:center; justify-content:center; gap:6px;
  padding:8px 0; opacity:.15; pointer-events:none; user-select:none;
  font-size:18px; letter-spacing:4px;
}
/* ══ RUTINA END ══ */

/* ══════════════════════════════
   PROGRESS PANEL
══════════════════════════════ */
.prog-panel-content {
  display: flex; flex-direction: column; gap: 0;
  background: var(--navy); min-height: 100%;
}

/* KPI Strip */
.prog-kpi-strip {
  display: grid; grid-template-columns: repeat(4,1fr);
  gap: 1px; background: rgba(255,255,255,.06);
  border-bottom: 1px solid rgba(255,255,255,.07);
}
.prog-kpi {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 12px 6px; gap: 2px; background: var(--navy);
}
.prog-kpi-val {
  color: #fff; font-size: 20px; font-weight: 800;
  font-family: 'Special Elite', cursive; line-height: 1;
}
.prog-kpi-lbl {
  color: rgba(255,255,255,.35); font-size: 9px; font-weight: 700;
  text-transform: uppercase; letter-spacing: .8px;
}

/* Chart area */
.prog-chart-wrap {
  padding: 14px 16px 10px;
  border-bottom: 1px solid rgba(255,255,255,.06);
}
.prog-chart-header {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;
}
.prog-chart-title { color: #fff; font-size: 13px; font-weight: 800; }
.prog-chart-period { color: rgba(255,255,255,.3); font-size: 10px; font-weight: 700; }
.prog-view-toggle {
  display: flex; gap: 2px; background: rgba(255,255,255,.05);
  border-radius: 8px; padding: 2px;
}
.prog-vtbtn {
  background: transparent; border: none; color: rgba(255,255,255,.4);
  font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 6px;
  cursor: pointer; transition: all .2s; font-family: inherit;
}
.prog-vtbtn.active {
  background: var(--teal); color: #fff;
  box-shadow: 0 2px 8px rgba(42,100,150,.4);
}
.prog-chart-canvas {
  display: flex; align-items: flex-end; gap: 3px;
  height: 90px; overflow-x: auto;
}
.prog-bar-group {
  display: flex; flex-direction: column; align-items: center; gap: 2px; flex-shrink: 0;
  cursor: pointer; transition: opacity .2s;
}
.prog-bar-group:hover { opacity: .8; }
.prog-bar-group.selected .prog-bar-lbl { color: var(--yellow); font-weight: 900; }
.prog-bars-inner {
  display: flex; align-items: flex-end; gap: 1px; height: 72px;
}
.prog-bar {
  width: 7px; border-radius: 3px 3px 0 0; min-height: 2px;
  transition: height .3s cubic-bezier(.34,1.56,.64,1);
}
.prog-bar-lbl {
  color: rgba(255,255,255,.3); font-size: 7px; font-weight: 700;
  text-align: center; min-width: 18px; line-height: 1;
}
.prog-chart-legend {
  display: flex; gap: 12px; margin-top: 8px;
  font-size: 9px; color: rgba(255,255,255,.4); font-weight: 700;
  align-items: center;
}
.prog-leg-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-right: 3px; }

/* Calendar */
.prog-cal-section {
  padding: 14px 16px 10px;
  border-bottom: 1px solid rgba(255,255,255,.06);
}
.prog-cal-header {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;
}
.prog-cal-title { color: #fff; font-size: 12px; font-weight: 800; }
.prog-cal-arrow {
  background: rgba(255,255,255,.07); border: none; color: rgba(255,255,255,.6);
  width: 26px; height: 26px; border-radius: 6px; cursor: pointer;
  font-size: 15px; line-height: 1; font-family: inherit;
  display: flex; align-items: center; justify-content: center;
  transition: background .15s;
}
.prog-cal-arrow:hover { background: rgba(255,255,255,.14); }
.prog-cal-grid {
  display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px;
}
.prog-cal-dh {
  text-align: center; color: rgba(255,255,255,.25);
  font-size: 9px; font-weight: 800; text-transform: uppercase;
  padding: 2px 0 4px;
}
.prog-cal-day {
  aspect-ratio: 1; border-radius: 6px; display: flex; flex-direction: column;
  align-items: center; justify-content: center; cursor: pointer;
  font-size: 11px; font-weight: 700; color: rgba(255,255,255,.5);
  position: relative; transition: all .15s; gap: 1px;
  background: rgba(255,255,255,.03); border: 1px solid transparent;
}
.prog-cal-day:hover { background: rgba(255,255,255,.08); }
.prog-cal-day.today { border-color: var(--teal-light); color: #fff; background: rgba(58,133,196,.12); }
.prog-cal-day.selected { background: var(--teal); color: #fff; border-color: var(--teal-light);
  box-shadow: 0 0 12px rgba(42,100,150,.5); }
.prog-cal-day.has-data .prog-cal-dots { display: flex; }
.prog-cal-dots { display: none; gap: 2px; position: absolute; bottom: 2px; }
.prog-cal-dot { width: 3px; height: 3px; border-radius: 50%; }
.prog-cal-day.empty { background: transparent; cursor: default; border-color: transparent; }
.prog-cal-day.good { background: rgba(94,220,138,.1); border-color: rgba(94,220,138,.2); }
.prog-cal-day.great { background: rgba(94,220,138,.2); border-color: rgba(94,220,138,.4); }
.prog-cal-day.perfect { background: rgba(94,220,138,.35); border-color: rgba(94,220,138,.6);
  box-shadow: 0 0 8px rgba(94,220,138,.3); }

/* Day Detail */
.prog-day-detail {
  padding: 14px 16px; flex: 1;
  animation: progDetailIn .25s ease;
}
@keyframes progDetailIn {
  from { opacity:0; transform:translateY(8px); }
  to   { opacity:1; transform:translateY(0); }
}
.prog-day-header {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;
}
.prog-day-title { color: #fff; font-size: 14px; font-weight: 800; font-family:'Special Elite',cursive; }
.prog-day-compare {
  display: flex; gap: 6px; font-size: 10px; font-weight: 700;
}
.prog-cmp-chip {
  padding: 3px 8px; border-radius: 6px; font-weight: 800; font-size: 9px;
}
.prog-cmp-up   { background: rgba(94,220,138,.15); color: var(--green); }
.prog-cmp-down { background: rgba(232,82,122,.15); color: var(--pink); }
.prog-cmp-eq   { background: rgba(255,255,255,.07); color: rgba(255,255,255,.4); }

.prog-subtabs {
  display: flex; gap: 4px; margin-bottom: 12px;
  background: rgba(255,255,255,.04); border-radius: 10px; padding: 3px;
}
.prog-stab {
  flex: 1; background: transparent; border: none; color: rgba(255,255,255,.4);
  font-size: 10px; font-weight: 800; padding: 7px 4px; border-radius: 8px;
  cursor: pointer; transition: all .2s; font-family: inherit; text-align: center;
}
.prog-stab.active { background: var(--teal); color: #fff; box-shadow: 0 2px 8px rgba(42,100,150,.35); }

.prog-detail-section { margin-bottom: 14px; }
.prog-detail-label {
  color: rgba(255,255,255,.35); font-size: 9px; font-weight: 800;
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;
}
.prog-items-list { display: flex; flex-direction: column; gap: 5px; }
.prog-item {
  display: flex; align-items: center; gap: 8px;
  background: rgba(255,255,255,.04); border-radius: 9px;
  padding: 8px 10px; border: 1px solid rgba(255,255,255,.06);
}
.prog-item-icon { font-size: 14px; flex-shrink: 0; }
.prog-item-text { flex: 1; color: #fff; font-size: 11px; font-weight: 700; }
.prog-item-status {
  font-size: 10px; font-weight: 800; padding: 2px 7px; border-radius: 5px;
}
.prog-item.done   { border-color: rgba(94,220,138,.2); }
.prog-item.done .prog-item-text { color: rgba(255,255,255,.7); text-decoration: line-through; }
.prog-item.done .prog-item-status { background: rgba(94,220,138,.15); color: var(--green); }
.prog-item.failed { border-color: rgba(232,82,122,.2); opacity: .65; }
.prog-item.failed .prog-item-status { background: rgba(232,82,122,.15); color: var(--pink); }
.prog-item.pending .prog-item-status { background: rgba(255,255,255,.07); color: rgba(255,255,255,.3); }
.prog-empty-hint {
  color: rgba(255,255,255,.2); font-size: 10px; text-align: center;
  padding: 10px 0; font-style: italic;
}
/* ══ PROGRESS PANEL END ══ */

/* ══════════════════════════════
   RANKING PANEL
══════════════════════════════ */
.rnk-refresh-btn {
  background: rgba(255,255,255,.07); border: none; color: rgba(255,255,255,.5);
  width: 30px; height: 30px; border-radius: 8px; font-size: 16px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all .2s; font-family: inherit;
}
.rnk-refresh-btn:hover { background: rgba(255,255,255,.14); transform: rotate(30deg); }
.rnk-refresh-btn.spinning { animation: rnkSpin .7s linear; }
@keyframes rnkSpin { to { transform: rotate(360deg); } }

/* Info strip */
.rnk-info-strip {
  display: flex; align-items: center; justify-content: space-around;
  padding: 12px 10px; background: rgba(255,255,255,.03);
  border-bottom: 1px solid rgba(255,255,255,.06);
}
.rnk-info-item { display: flex; flex-direction: column; align-items: center; gap: 2px; }
.rnk-info-val  { color: #fff; font-size: 16px; font-weight: 800; font-family: 'Special Elite', cursive; line-height: 1; }
.rnk-info-lbl  { color: rgba(255,255,255,.3); font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .7px; }
.rnk-info-sep  { width: 1px; height: 28px; background: rgba(255,255,255,.08); }

/* Podium */
.rnk-podium {
  display: flex; align-items: flex-end; justify-content: center;
  gap: 6px; padding: 20px 16px 10px;
  background: linear-gradient(180deg, rgba(240,192,64,.04) 0%, transparent 100%);
  border-bottom: 1px solid rgba(255,255,255,.06);
  min-height: 140px;
}
.rnk-podium-slot {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  flex: 1; max-width: 110px; cursor: pointer;
  transition: transform .2s;
}
.rnk-podium-slot:hover { transform: translateY(-3px); }
.rnk-pod-avatar {
  width: 48px; height: 48px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 26px; border: 2px solid transparent;
  position: relative; flex-shrink: 0;
  box-shadow: 0 4px 14px rgba(0,0,0,.3);
}
.rnk-pod-avatar.me { box-shadow: 0 0 16px rgba(42,100,150,.6); }
.rnk-pod-crown {
  position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
  font-size: 16px; line-height: 1;
}
.rnk-pod-name {
  font-size: 10px; font-weight: 800; color: #fff; text-align: center;
  max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  line-height: 1.2;
}
.rnk-pod-xp {
  font-size: 11px; font-weight: 800; color: var(--yellow);
  font-family: 'Special Elite', cursive;
}
.rnk-pod-streak { font-size: 9px; color: rgba(255,255,255,.4); font-weight: 700; }
.rnk-pod-bar {
  width: 100%; border-radius: 6px 6px 0 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 900; color: rgba(0,0,0,.5);
  font-family: 'Special Elite', cursive;
}

/* 1st place */
.rnk-podium-slot:nth-child(1) .rnk-pod-bar { height: 54px; background: linear-gradient(180deg,#f0c040,#c89010); box-shadow: 0 -4px 16px rgba(240,192,64,.4); }
.rnk-podium-slot:nth-child(1) .rnk-pod-avatar { border-color: #f0c040; }
/* 2nd */
.rnk-podium-slot:nth-child(2) .rnk-pod-bar { height: 38px; background: linear-gradient(180deg,#c0c8d0,#8090a0); }
.rnk-podium-slot:nth-child(2) .rnk-pod-avatar { border-color: #c0c8d0; }
/* 3rd */
.rnk-podium-slot:nth-child(3) .rnk-pod-bar { height: 28px; background: linear-gradient(180deg,#cd7f32,#8b4510); }
.rnk-podium-slot:nth-child(3) .rnk-pod-avatar { border-color: #cd7f32; }

/* Me badge on podium */
.rnk-me-tag {
  font-size: 8px; font-weight: 900; background: var(--teal);
  color: #fff; padding: 1px 5px; border-radius: 4px; margin-top: -2px;
}

/* List */
.rnk-list-header {
  display: grid; grid-template-columns: 44px 1fr 60px;
  padding: 6px 14px; gap: 8px;
  border-bottom: 1px solid rgba(255,255,255,.05);
}
.rnk-list { display: flex; flex-direction: column; overflow-y: auto; }
.rnk-row {
  display: grid; grid-template-columns: 44px 1fr 60px;
  align-items: center; gap: 8px;
  padding: 8px 14px; border-bottom: 1px solid rgba(255,255,255,.04);
  transition: background .15s; cursor: pointer;
  animation: rnkRowIn .3s ease both;
}
@keyframes rnkRowIn { from { opacity:0; transform:translateX(-8px); } to { opacity:1; transform:none; } }
.rnk-row:hover { background: rgba(255,255,255,.05); }
.rnk-row.me-row {
  background: rgba(42,100,150,.12);
  border-color: rgba(42,100,150,.3);
  position: sticky; bottom: 0; z-index: 2;
}
.rnk-row-pos {
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 800; color: rgba(255,255,255,.5);
  font-family: 'Special Elite', cursive;
}
.rnk-row-pos.top10 { color: var(--yellow); }
.rnk-row-pos.friend-pos { color: var(--green); }
.rnk-row-player {
  display: flex; align-items: center; gap: 8px; min-width: 0;
}
.rnk-row-avatar { font-size: 20px; flex-shrink: 0; }
.rnk-row-info { min-width: 0; }
.rnk-row-name {
  font-size: 12px; font-weight: 800; color: #fff;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.rnk-row-sub { font-size: 9px; color: rgba(255,255,255,.3); font-weight: 700; }
.rnk-row-xp {
  text-align: right; font-size: 12px; font-weight: 800;
  color: var(--yellow); font-family: 'Special Elite', cursive;
}
.rnk-row-xp.me-xp { color: var(--teal-light); }

/* Friend chip in list */
.rnk-friend-chip {
  font-size: 8px; font-weight: 900; background: rgba(94,220,138,.15);
  color: var(--green); padding: 1px 4px; border-radius: 4px; margin-left: 4px;
}
.rnk-gymbro-chip {
  font-size: 8px; font-weight: 900; background: rgba(255,107,53,.15);
  color: #ff6b35; padding: 1px 4px; border-radius: 4px; margin-left: 4px;
}

/* Loading */
.rnk-loading {
  display: flex; flex-direction: column; align-items: center; gap: 12px;
  padding: 40px 20px; color: rgba(255,255,255,.35); font-size: 12px; font-weight: 700;
}
.rnk-spinner {
  width: 28px; height: 28px; border: 3px solid rgba(255,255,255,.1);
  border-top-color: var(--teal); border-radius: 50%;
  animation: rnkSpinAnim .8s linear infinite;
}
@keyframes rnkSpinAnim { to { transform: rotate(360deg); } }
.rnk-empty {
  display: flex; flex-direction: column; align-items: center; gap: 8px;
  padding: 40px 20px; color: rgba(255,255,255,.3); font-size: 12px; font-weight: 700;
  text-align: center;
}

/* My position sticky footer */
.rnk-my-pos-footer {
  position: sticky; bottom: 0; left: 0; right: 0;
  background: linear-gradient(0deg, var(--navy) 80%, transparent);
  padding: 8px 14px 12px; z-index: 5;
}
.rnk-my-pos-row {
  background: rgba(42,100,150,.18);
  border: 1.5px solid rgba(42,100,150,.4);
  border-radius: 10px; padding: 8px 12px;
  display: grid; grid-template-columns: 44px 1fr 60px;
  align-items: center; gap: 8px;
}
/* ══ RANKING PANEL END ══ */

/* ══════════════════════════════
   NOTAS PANEL
══════════════════════════════ */
.notas-quote {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 14px 16px; margin: 0;
  background: linear-gradient(135deg, rgba(42,100,150,.18), rgba(139,98,224,.1));
  border-bottom: 1px solid rgba(255,255,255,.07);
}
.notas-quote-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
.notas-quote-text {
  color: rgba(255,255,255,.7); font-size: 12px; font-style: italic;
  font-weight: 600; line-height: 1.5;
  font-family: 'Georgia', serif;
}

.notas-tabs {
  display: flex; background: rgba(255,255,255,.04);
  border-bottom: 1px solid rgba(255,255,255,.07);
}
.notas-tab {
  flex: 1; background: transparent; border: none; border-bottom: 2px solid transparent;
  color: rgba(255,255,255,.35); font-size: 12px; font-weight: 800;
  padding: 12px 4px; cursor: pointer; transition: all .2s; font-family: inherit;
}
.notas-tab.active { color: #fff; border-bottom-color: var(--teal-light); }

/* ── Rutina tab ── */
.notas-add-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px 4px;
}
.notas-ex-select {
  flex: 1; background: rgba(255,255,255,.07); border: 1.5px solid rgba(255,255,255,.1);
  border-radius: 9px; color: #fff; font-size: 12px; padding: 8px 10px;
  font-family: inherit; outline: none; appearance: none;
}
.notas-ex-select option { background: #1a2a3a; color: #fff; }
.notas-custom-ex {
  flex: 1; background: rgba(255,255,255,.07); border: 1.5px solid rgba(255,255,255,.1);
  border-radius: 9px; color: #fff; font-size: 12px; padding: 8px 10px;
  font-family: inherit; outline: none;
}
.notas-custom-ex:focus, .notas-ex-select:focus { border-color: var(--teal-light); }
.notas-weight-input {
  background: rgba(255,255,255,.07); border: 1.5px solid rgba(255,255,255,.1);
  border-radius: 9px; color: #fff; font-size: 12px; padding: 8px 10px;
  font-family: inherit; outline: none; min-width: 0;
}
.notas-weight-input:focus { border-color: var(--teal-light); }
.notas-weight-input::placeholder { color: rgba(255,255,255,.3); }
.notas-add-btn {
  background: var(--teal); border: none; color: #fff; width: 36px; height: 36px;
  border-radius: 9px; font-size: 20px; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center; font-family: inherit;
  transition: background .15s;
}
.notas-add-btn:hover { background: var(--teal-light); }

.notas-routine-list { padding: 8px 14px 80px; display: flex; flex-direction: column; gap: 10px; }

.notas-ex-group {}
.notas-ex-name {
  display: flex; align-items: center; justify-content: space-between;
  color: #fff; font-size: 12px; font-weight: 800;
  padding: 6px 0 4px; border-bottom: 1px solid rgba(255,255,255,.08); margin-bottom: 6px;
}
.notas-ex-trend {
  font-size: 10px; font-weight: 800; padding: 2px 7px; border-radius: 5px;
}
.notas-trend-up   { background: rgba(94,220,138,.15); color: var(--green); }
.notas-trend-down { background: rgba(232,82,122,.15); color: var(--pink); }
.notas-trend-eq   { background: rgba(255,255,255,.07); color: rgba(255,255,255,.4); }

.notas-entry {
  display: flex; align-items: center; gap: 8px;
  background: rgba(255,255,255,.04); border-radius: 8px;
  padding: 7px 10px; border: 1px solid rgba(255,255,255,.05);
  margin-bottom: 4px;
}
.notas-entry-date { color: rgba(255,255,255,.3); font-size: 9px; font-weight: 800; min-width: 36px; }
.notas-entry-weight {
  font-size: 14px; font-weight: 900; color: var(--yellow);
  font-family: 'Special Elite', cursive; flex-shrink: 0;
}
.notas-entry-unit { color: rgba(255,255,255,.4); font-size: 10px; margin-left: -4px; }
.notas-entry-series { color: rgba(255,255,255,.55); font-size: 11px; flex: 1; }
.notas-entry-del {
  width: 22px; height: 22px; border-radius: 5px; display: flex; align-items: center;
  justify-content: center; color: rgba(255,255,255,.2); font-size: 13px;
  cursor: pointer; transition: all .15s;
}
.notas-entry-del:hover { background: rgba(232,82,122,.2); color: var(--pink); }

.notas-empty {
  display: flex; flex-direction: column; align-items: center; gap: 8px;
  padding: 40px 20px; color: rgba(255,255,255,.25); font-size: 12px;
  font-weight: 700; text-align: center;
}
.notas-empty > div:first-child { font-size: 36px; }

/* ── General tab ── */
.notas-general-wrap {
  display: flex; flex-direction: column; height: calc(100vh - 180px); padding: 12px 14px;
}
.notas-general-area {
  flex: 1; background: rgba(255,255,255,.05); border: 1.5px solid rgba(255,255,255,.09);
  border-radius: 12px; color: #fff; font-size: 13px; line-height: 1.6;
  padding: 12px; font-family: inherit; outline: none; resize: none;
  transition: border-color .2s;
}
.notas-general-area:focus { border-color: var(--teal-light); }
.notas-general-area::placeholder { color: rgba(255,255,255,.2); }
.notas-general-footer {
  display: flex; justify-content: space-between; align-items: center;
  padding: 8px 2px 0;
}
.notas-general-chars { color: rgba(255,255,255,.2); font-size: 9px; font-weight: 700; }
.notas-general-saved { color: rgba(94,220,138,.6); font-size: 9px; font-weight: 800; }
.notas-general-saved.unsaved { color: rgba(240,192,64,.6); }

/* ── Power multi-buy ── */
.poder-qty-row {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  margin: 10px 0 4px;
}
.poder-qty-btn {
  width: 32px; height: 32px; border-radius: 8px; border: none;
  background: rgba(255,255,255,.1); color: #fff; font-size: 18px; font-weight: 800;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-family: inherit; transition: background .15s; flex-shrink: 0;
}
.poder-qty-btn:hover { background: var(--teal); }
.poder-qty-num {
  font-size: 22px; font-weight: 900; color: #fff;
  font-family: 'Special Elite', cursive; min-width: 32px; text-align: center;
}
.poder-qty-total {
  text-align: center; font-size: 11px; color: rgba(255,255,255,.4);
  font-weight: 700; margin-bottom: 2px;
}
/* ══ NOTAS END ══ */

/* ══ CEO MODE — Dark Prestige Theme ══ */

@keyframes ceoShift {
  0%,100% { background-position: 0% 50%; }
  50%      { background-position: 100% 50%; }
}
@keyframes ceoNameShimmer {
  0%,100% { background-position: 0% center; }
  50%      { background-position: 100% center; }
}
@keyframes ceoAvatarBorder {
  0%,100% { box-shadow: 0 0 0 2px #8a6a1a, 0 0 12px rgba(180,140,40,.25); }
  50%      { box-shadow: 0 0 0 2.5px #c9a84c, 0 0 18px rgba(180,140,40,.35); }
}
@keyframes ceoParticle {
  0%   { transform: translateY(0) translateX(0) scale(1); opacity:.8; }
  100% { transform: translateY(-100px) translateX(var(--tx)) scale(0); opacity:0; }
}

/* ── Etiqueta CEO flotante ── */
@keyframes ceoBadgeFloat {
  0%,100% { transform: translateX(-50%) translateY(0px); }
  50%      { transform: translateX(-50%) translateY(-3px); }
}
@keyframes ceoScanline {
  0%   { top: -10%; }
  100% { top: 110%; }
}
@keyframes ceoLetterGlow {
  0%,100% { opacity:.5; }
  50%      { opacity:1; }
}
@keyframes ceoCornerSpin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

/* VIP body background — dark charcoal, barely tinted */
body.vip-mode {
  background: linear-gradient(160deg, #0e0e12, #131018, #0e0e12) !important;
  background-size: 400% 400% !important;
  animation: ceoShift 12s ease infinite !important;
}
.vip-mode .phone {
  background: linear-gradient(170deg, #0f0f14, #141019, #0f0f14) !important;
}

/* VIP profile card — thin gold border, no heavy glow */
.vip-mode .profile-card {
  border: 2px solid #7a5c18 !important;
  animation: ceoAvatarBorder 3s ease-in-out infinite !important;
  background: linear-gradient(135deg, #18140a, #0f0f14) !important;
}

/* VIP username — subtle gold shimmer, not blinding */
.vip-mode .username-label {
  background: linear-gradient(90deg, #8a6a1a, #d4aa50, #f0d080, #c8960a, #8a6a1a);
  background-size: 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: ceoNameShimmer 4s ease infinite;
  border-bottom-color: rgba(180,140,40,.3) !important;
  font-size: 16px !important;
  font-weight: 800 !important;
}

/* VIP streak section */
.vip-mode .streak-section {
  background: linear-gradient(135deg, #18140a, #0f0f14) !important;
  border-color: rgba(180,140,40,.3) !important;
  box-shadow: 0 4px 20px rgba(140,100,20,.12) !important;
}

/* VIP blocks — muted dark gold */
.vip-mode .b1 { background: linear-gradient(135deg,#2a1e08,#5a420e) !important; }
.vip-mode .b2 { background: linear-gradient(135deg,#4a3410,#7a5c1a) !important; }
.vip-mode .b3 { background: linear-gradient(135deg,#221a06,#4a3410) !important; }
.vip-mode .b4 { background: linear-gradient(135deg,#1a1406,#3a2a0c) !important; }
.vip-mode .b5 { background: linear-gradient(135deg,#241c08,#4a3410) !important; }
.vip-mode .b6 { background: linear-gradient(135deg,#2a1e08,#604818) !important; }

/* VIP panels */
.vip-mode .chart-section {
  background: linear-gradient(135deg,#14110a,#0f0f14) !important;
}

/* VIP add button */
.vip-mode .add-btn {
  background: linear-gradient(135deg,#3a2a0c,#6a4e14) !important;
  box-shadow: 0 4px 12px rgba(140,100,20,.3) !important;
}

/* ══ CEO MODE BADGE — efecto especial ══ */
.ceo-badge {
  position: fixed;
  top: 14px; left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  pointer-events: none;
  animation: ceoBadgeFloat 4s ease-in-out infinite;
}

/* Contenedor principal del badge */
.ceo-badge-inner {
  position: relative;
  background: linear-gradient(135deg, #0a0a0f 0%, #16120a 50%, #0a0a0f 100%);
  border: 1.5px solid #5a4210;
  border-radius: 6px;
  padding: 5px 14px 5px 10px;
  display: flex;
  align-items: center;
  gap: 7px;
  overflow: hidden;
}

/* Línea de scan que cruza */
.ceo-badge-inner::after {
  content: '';
  position: absolute;
  left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(200,160,50,.6), transparent);
  animation: ceoScanline 3s linear infinite;
}

/* Esquinas decorativas */
.ceo-corner {
  position: absolute;
  width: 6px; height: 6px;
  border-color: #c8a032;
  border-style: solid;
  opacity: .7;
}
.ceo-corner.tl { top:2px; left:2px;  border-width:1.5px 0 0 1.5px; }
.ceo-corner.tr { top:2px; right:2px; border-width:1.5px 1.5px 0 0; }
.ceo-corner.bl { bottom:2px; left:2px;  border-width:0 0 1.5px 1.5px; }
.ceo-corner.br { bottom:2px; right:2px; border-width:0 1.5px 1.5px 0; }

/* Corona */
.ceo-badge-crown {
  font-size: 13px;
  filter: drop-shadow(0 0 4px rgba(200,160,50,.5));
}

/* Texto CEO — letras con brillo individual */
.ceo-badge-text {
  display: flex;
  align-items: center;
  gap: 1px;
  font-family: 'Special Elite', cursive;
  letter-spacing: 3px;
  font-size: 11px;
  font-weight: 800;
}
.ceo-letter {
  color: #c8a032;
  text-shadow: 0 0 6px rgba(200,160,50,.4);
  animation: ceoLetterGlow 2s ease-in-out infinite;
  display: inline-block;
}
.ceo-letter:nth-child(1) { animation-delay: 0s; }
.ceo-letter:nth-child(2) { animation-delay: .3s; }
.ceo-letter:nth-child(3) { animation-delay: .6s; }

/* Separador | */
.ceo-sep {
  color: rgba(200,160,50,.25);
  font-size: 10px;
  margin: 0 2px;
}

/* Texto MODE — más tenue */
.ceo-mode-text {
  color: rgba(200,160,50,.45);
  font-family: 'Nunito', sans-serif;
  font-size: 8px;
  font-weight: 800;
  letter-spacing: 2px;
  text-transform: uppercase;
}

/* Punto de estado — parpadea como sistema activo */
.ceo-status-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  background: #4a9a4a;
  margin-left: 4px;
  animation: ceoLetterGlow 1.5s ease-in-out infinite;
  box-shadow: 0 0 4px rgba(74,154,74,.6);
}

/* VIP particle container */
#vipParticles {
  position: fixed; inset: 0; pointer-events: none; z-index: 9998; overflow: hidden;
}
.vip-particle {
  position: absolute; font-size: 12px; opacity: 0;
  animation: ceoParticle 3s ease-out forwards;
}
</style>
</head>
<body>

<!-- ══ SPLASH SCREEN ══ -->
<div id="splash-screen">
  <canvas id="splash-stars"></canvas>
  <div id="splash-inner">

  <div class="splash-brain-wrap">
    <svg class="splash-brain" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <radialGradient id="bgCircle" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="#1e3060"/>
          <stop offset="100%" stop-color="#0d1b3e"/>
        </radialGradient>
        <filter id="glow"><feGaussianBlur stdDeviation="3" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
      </defs>
      <circle cx="150" cy="150" r="148" fill="url(#bgCircle)"/>
      <circle cx="150" cy="150" r="145" fill="none" stroke="#3a85c4" stroke-width="3" opacity="0.6"/>
      <text x="38" y="202" font-family="Arial Black, Impact, sans-serif" font-size="130" font-weight="900" fill="#ffffff" filter="url(#glow)">S</text>
      <text x="152" y="202" font-family="Arial Black, Impact, sans-serif" font-size="130" font-weight="900" fill="#ffffff" filter="url(#glow)">P</text>
      <line x1="150" y1="60" x2="150" y2="240" stroke="rgba(255,255,255,0.25)" stroke-width="2.5" stroke-dasharray="6 5"/>
    </svg>
  </div>

  <!-- Mode tabs -->
  <div class="splash-pages" style="width:88%;max-width:360px;">
    <div class="splash-mode-tabs" id="modeTabs">
      <div class="splash-tab active" id="tabLogin" onclick="switchMode('login')">Iniciar sesión</div>
      <div class="splash-tab" id="tabRegister" onclick="switchMode('register')">Crear cuenta</div>
    </div>
  </div>

  <!-- Step dots (only for register) -->
  <div class="splash-steps" id="splashStepDots" style="display:none;">
    <div class="splash-step-dot active" id="dot0"></div>
    <div class="splash-step-dot" id="dot1"></div>
    <div class="splash-step-dot" id="dot2"></div>
  </div>

  <!-- Title -->
  <div class="splash-title" id="splashTitle">Bienvenido</div>

  <!-- ── PAGE: Login ── -->
  <div class="splash-pages" id="pageWrap">

    <div class="splash-page active" id="pageLogin">
      <div class="splash-field-wrap" id="loginUserWrap">
        <span class="splash-field-icon">👤</span>
        <input class="splash-field" id="splashUser" type="text" placeholder="Usuario o email"
          onkeydown="if(event.key==='Enter')document.getElementById('splashPass').focus()"
          oninput="clearFieldError('loginUserWrap')">
        <span class="val-icon" id="loginUserIcon"></span>
      </div>
      <div class="splash-field-wrap" id="loginPassWrap">
        <span class="splash-field-icon">🔒</span>
        <input class="splash-field" id="splashPass" type="password" placeholder="Contraseña"
          onkeydown="if(event.key==='Enter')doSplashLogin()"
          oninput="clearFieldError('loginPassWrap')">
        <span class="pw-toggle" onclick="togglePw('splashPass',this)">👁</span>
      </div>
      <div class="splash-helper" id="loginHelper"></div>
      <button class="splash-btn" id="loginBtn" onclick="doSplashLogin()">
        <span id="splashBtnText">Iniciar sesión</span>
        <span class="splash-btn-icon" id="splashBtnIcon">🔐</span>
      </button>
      <div class="splash-or">
        <div class="splash-or-line"></div><div class="splash-or-text">o</div><div class="splash-or-line"></div>
      </div>
      <button class="splash-google" onclick="doGoogleSignIn()">
        <span style="font-size:16px;font-weight:900;color:#4285F4;">G</span> Continuar con Google
      </button>
      <div class="splash-footer">
        ¿Olvidaste tu contraseña? <span onclick="showForgotPassword()">Recuperar</span>
      </div>
    </div>

    <!-- ── PAGE: Register Step 1 — Credenciales ── -->
    <div class="splash-page" id="pageReg1">
      <div style="color:rgba(255,255,255,.5);font-size:11px;font-weight:700;text-align:center;letter-spacing:1px;text-transform:uppercase;">Paso 1 de 3 · Tus credenciales</div>
      <!-- Email -->
      <div class="splash-field-wrap" id="regEmailWrap">
        <span class="splash-field-icon">📧</span>
        <input class="splash-field" id="regEmail" type="email" placeholder="correo@ejemplo.com"
          oninput="validateEmail()" onblur="validateEmail()">
        <span class="val-icon" id="regEmailIcon"></span>
      </div>
      <div class="splash-helper" id="regEmailHelper"></div>
      <!-- Password -->
      <div class="splash-field-wrap" id="regPassWrap">
        <span class="splash-field-icon">🔒</span>
        <input class="splash-field" id="regPass" type="password" placeholder="Contraseña (mín. 6 caracteres)"
          oninput="checkPasswordStrength()" onblur="validateRegPass()">
        <span class="pw-toggle" onclick="togglePw('regPass',this)">👁</span>
      </div>
      <div class="pw-strength-wrap" id="pwStrengthWrap">
        <div class="pw-strength-bar-bg"><div class="pw-strength-bar-fill" id="pwBar"></div></div>
        <div class="pw-strength-label" id="pwLabel">Introduce una contraseña</div>
      </div>
      <!-- Confirm password -->
      <div class="splash-field-wrap" id="regPass2Wrap">
        <span class="splash-field-icon">🔑</span>
        <input class="splash-field" id="regPass2" type="password" placeholder="Confirmar contraseña"
          oninput="validateConfirmPass()" onblur="validateConfirmPass()"
          onkeydown="if(event.key==='Enter')goRegStep2()">
        <span class="pw-toggle" onclick="togglePw('regPass2',this)">👁</span>
        <span class="val-icon" id="regPass2Icon"></span>
      </div>
      <div class="splash-helper" id="regPassHelper"></div>
      <button class="splash-btn" onclick="goRegStep2()">
        Continuar <span class="splash-btn-icon">→</span>
      </button>
    </div>

    <!-- ── PAGE: Register Step 2 — Perfil ── -->
    <div class="splash-page" id="pageReg2">
      <div style="color:rgba(255,255,255,.5);font-size:11px;font-weight:700;text-align:center;letter-spacing:1px;text-transform:uppercase;">Paso 2 de 3 · Tu perfil</div>
      <!-- Username -->
      <div class="splash-field-wrap" id="regUserWrap">
        <span class="splash-field-icon">👤</span>
        <input class="splash-field" id="regUser" type="text" placeholder="Nombre de usuario"
          oninput="validateUsername()" onblur="validateUsername()"
          onkeydown="if(event.key==='Enter')document.getElementById('regName').focus()">
        <span class="val-icon" id="regUserIcon"></span>
      </div>
      <div class="splash-helper" id="regUserHelper"></div>
      <!-- Display name -->
      <div class="splash-field-wrap" id="regNameWrap">
        <span class="splash-field-icon">✨</span>
        <input class="splash-field" id="regName" type="text" placeholder="Nombre para mostrar"
          oninput="clearFieldError('regNameWrap')"
          onkeydown="if(event.key==='Enter')document.getElementById('regBirth').focus()">
      </div>
      <!-- Birthday (optional) -->
      <div class="splash-field-wrap">
        <span class="splash-field-icon">🎂</span>
        <input class="splash-field" id="regBirth" type="date" placeholder="Fecha de nacimiento (opcional)"
          style="color-scheme:dark;">
      </div>
      <div class="splash-helper" style="color:rgba(255,255,255,.25);">La fecha de nacimiento es opcional</div>
      <button class="splash-btn" onclick="goRegStep3()">
        Continuar <span class="splash-btn-icon">→</span>
      </button>
    </div>

    <!-- ── PAGE: Register Step 3 — Avatar & Términos ── -->
    <div class="splash-page" id="pageReg3">
      <div style="color:rgba(255,255,255,.5);font-size:11px;font-weight:700;text-align:center;letter-spacing:1px;text-transform:uppercase;">Paso 3 de 3 · Tu avatar</div>
      <!-- Avatar picker -->
      <div style="display:flex;flex-direction:column;align-items:center;gap:10px;background:rgba(255,255,255,.04);border-radius:18px;padding:16px;">
        <div style="font-size:56px;cursor:pointer;" id="regAvatarDisplay" onclick="cycleAvatar()">🧑‍🌾</div>
        <div style="color:rgba(255,255,255,.5);font-size:11px;">Toca para cambiar emoji</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;" id="avatarGrid"></div>
      </div>
      <!-- Terms -->
      <div style="display:flex;align-items:flex-start;gap:10px;background:rgba(255,255,255,.04);border-radius:14px;padding:12px 14px;">
        <div id="termsCheck" onclick="toggleTerms()"
          style="width:20px;height:20px;border-radius:6px;border:2px solid rgba(255,255,255,.3);flex-shrink:0;margin-top:2px;
          cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all .2s;">
        </div>
        <div style="font-size:11px;color:rgba(255,255,255,.5);line-height:1.5;">
          Acepto los <span style="color:var(--teal-light);cursor:pointer;" onclick="showToast('Términos próximamente')">Términos de servicio</span>
          y la <span style="color:var(--teal-light);cursor:pointer;" onclick="showToast('Privacidad próximamente')">Política de privacidad</span>
        </div>
      </div>
      <div class="splash-helper" id="termsHelper"></div>
      <button class="splash-btn" id="createAccountBtn" onclick="createAccount()">
        Crear cuenta 🚀 <span class="splash-btn-icon">✨</span>
      </button>
      <div style="text-align:center;">
        <span style="color:var(--teal-light);cursor:pointer;font-size:11px;font-weight:700;" onclick="goRegStep2()">← Volver</span>
      </div>
    </div>

    <!-- ── PAGE: Register Success ── -->
    <div class="splash-page" id="pageRegSuccess">
      <div class="reg-success-box">
        <div class="reg-avatar-big" id="successAvatar">🧑‍🌾</div>
        <div class="reg-success-name" id="successName">¡Hola, Usuario!</div>
        <div class="reg-success-sub">Tu cuenta ha sido creada</div>
        <div class="reg-badge-row">
          <div class="reg-badge">🏆 Nivel 1</div>
          <div class="reg-badge">⚡ 0 XP</div>
          <div class="reg-badge">🔥 Racha nueva</div>
        </div>
      </div>
      <button class="splash-btn" onclick="enterAppFromSplash()">
        ¡Entrar a la app! <span class="splash-btn-icon">🚀</span>
      </button>
    </div>

    <!-- ── PAGE: Forgot Password ── -->
    <div class="splash-page" id="pageForgot">
      <div style="text-align:center;padding:4px 0;">
        <div style="font-size:40px;">🔑</div>
        <div style="color:rgba(255,255,255,.5);font-size:11px;margin-top:6px;font-weight:700;">Introduce tu email para recibir instrucciones</div>
      </div>
      <div class="splash-field-wrap" id="forgotEmailWrap">
        <span class="splash-field-icon">📧</span>
        <input class="splash-field" id="forgotEmail" type="email" placeholder="correo@ejemplo.com"
          onkeydown="if(event.key==='Enter')sendForgotPassword()">
      </div>
      <div class="splash-helper" id="forgotHelper"></div>
      <button class="splash-btn" onclick="sendForgotPassword()">
        Enviar instrucciones <span class="splash-btn-icon">📨</span>
      </button>
      <div style="text-align:center;">
        <span style="color:var(--teal-light);cursor:pointer;font-size:11px;font-weight:700;" onclick="switchMode('login')">← Volver al login</span>
      </div>
    </div>

  </div><!-- end pageWrap -->

  <div class="splash-footer" id="splashFooterMain">
    ¿Ya tienes cuenta? <span onclick="switchMode('login')">Iniciar sesión</span>
  </div>

  </div><!-- end splash-inner -->
</div><!-- end splash-screen -->

<canvas id="particles-canvas"></canvas>
<div class="phone" id="phone">

  <!-- HOME -->
  <div id="home" style="flex:1;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;gap:14px;padding-bottom:8px;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;">
    <div class="top-bar">
      <div class="add-btn" onclick="openPanel('social')" style="font-size:20px;"><span>💬</span></div>
      <div class="coin-badge" onclick="openPanel('tienda')">
        <span class="coin-icon">🪙</span>
        <span class="coin-count" id="coinDisplay">0</span>
      </div>
      <div class="profile-card" onclick="openPanel('perfil')">
        <div class="xp-badge"><span>✦</span><span id="xp">0</span></div>
        <div class="profile-default" id="profileAvatarHome">🧑‍🌾</div>
        <img id="profileImgHome" src="" alt="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:8px;position:absolute;top:0;left:0;">
      </div>
    </div>

    <div class="username-section">
      <span style="color:rgba(255,255,255,.4);font-size:14px;">+</span>
      <span class="username-label" id="usernameLabel" onclick="editUsername()">Nombre de Usuario</span>
      <input class="username-edit" id="usernameInput" placeholder="Tu nombre..."
        onblur="saveUsername()" onkeydown="if(event.key==='Enter')saveUsername()">
    </div>

    <div class="streak-section" onclick="openPanel('racha')" onmousedown="spawnFlames(event)" ontouchstart="spawnFlames(event)">
      <div id="flame-container"></div>

      <!-- Top row: fire + info + dots -->
      <div class="streak-section-top">
        <div class="streak-fire" id="streakEmoji">🔥</div>
        <div class="streak-info">
          <div class="streak-title">Racha actual</div>
          <div class="streak-count"><span id="streakCount">1</span> días</div>
          <div class="streak-sub" id="streakGoalLabel">Meta: 100 días</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;">
          <div class="streak-dots" id="streakDots"></div>
          <div class="legendary-badge" id="legendaryBadge">⚡ ¡LEGENDARIO!</div>
        </div>
      </div>

      <!-- Pet strip -->
      <div class="streak-pet-strip" id="homePetStrip">
        <div class="home-pet-wrap" id="homePetWrap">
          <div class="home-pet-glow"        id="homePetGlow"></div>
          <div class="home-pet-acc-hat"     id="homePetHat"></div>
          <div class="home-pet-emoji"       id="homePetEmoji">🐱</div>
          <div class="home-pet-acc-collar"  id="homePetCollar"></div>
          <div class="home-pet-acc-wand"    id="homePetWand"></div>
        </div>
        <div class="home-pet-info">
          <div class="home-pet-name" id="homePetName">Chispa</div>
          <div class="home-pet-mood" id="homePetMood">😊 Contento</div>
          <div class="home-pet-hp-row">
            <div class="home-pet-hp-track">
              <div class="home-pet-hp-fill" id="homePetHpFill" style="width:60%;background:#5edc8a;"></div>
            </div>
            <div class="home-pet-lvl" id="homePetLvl">Nv.1</div>
          </div>
        </div>
      </div>
    </div>

    <div class="blocks-section">
      <div class="block b1" onclick="openPanel('tareas')"><span class="b-icon">📋</span></div>
      <div class="block b2" onclick="openPanel('notas')"><span class="b-icon">📝</span></div>
      <div class="block b3" onclick="openPanel('stats')"><span class="b-icon">📊</span></div>
      <div class="block b4" onclick="openPanel('habitos')"><span class="b-icon">🌿</span></div>
      <div class="block b5" onclick="openPanel('metas')"><span class="b-icon">🎯</span></div>

    </div>

    <div class="cal-chart-row">
      <div class="calendar-section">
        <div class="cal-nav">
          <button class="cal-arrow" onclick="changeMonth(-1)">‹</button>
          <div class="cal-title" id="calMonthLabel"></div>
          <button class="cal-arrow" onclick="changeMonth(1)">›</button>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
      <div class="chart-section" onclick="openPanel('stats')" style="cursor:pointer;" title="Ver progreso completo">
        <div class="chart-header">
          <div class="chart-title">Progreso</div>
          <div class="chart-week-label" id="chartWeekLabel">Sem 1</div>
        </div>
        <div class="chart-bars" id="chartBars"></div>
        <div class="chart-legend">
          <div class="chart-legend-item"><div class="legend-dot" style="background:var(--green)"></div>Tareas</div>
          <div class="chart-legend-item"><div class="legend-dot" style="background:var(--purple)"></div>Hábitos</div>
        </div>
        <div class="chart-total">
          <div class="chart-total-num" id="chartTotalNum">0</div>
          <div class="chart-total-label">actividades esta semana</div>
        </div>
      </div>
    </div>

    <div class="tasks-below">
      <div class="tasks-below-header">
        <div class="tasks-below-title">📌 Mis Tareas</div>
        <div style="display:flex;gap:6px;align-items:center;">
          <div class="tasks-add-btn" onclick="openPanel('tareas')" style="font-size:11px;width:auto;padding:0 8px;font-weight:800;">Ver todas</div>
          <div class="tasks-add-btn" onclick="openAddTaskModalFromHome()">+</div>
        </div>
      </div>
      <div class="task-input-row" id="taskInputRow">
        <input class="task-input-field" id="taskField" placeholder="Escribe una tarea..."
          onkeydown="if(event.key==='Enter')addTask()">
        <button class="task-input-ok" onclick="addTask()">OK</button>
      </div>
      <div class="tasks-list" id="tasksList">
        <div class="tasks-empty" id="tasksEmpty">Toca + para agregar una tarea</div>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-btn active" id="navHome" onclick="goHome()"><div class="nav-icon">📌</div>Inicio</div>
    <div class="nav-btn" id="navRutina" onclick="openPanel('rutina')"><div class="nav-icon">💪</div>Rutina</div>
    <div class="nav-btn" id="navNuevo" onclick="openPanel('nuevo')"><div class="nav-icon" style="background:rgba(255,255,255,.15);border-radius:50%;width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:20px;">+</div>Nuevo</div>
    <div class="nav-btn" id="navTienda" onclick="openPanel('tienda')"><div class="nav-icon">🛒</div>Tienda</div>
    <div class="nav-btn" id="navMenu" onclick="openPanel('menu')"><div class="nav-icon">☰</div>Menú</div>
  </div>

  <!-- PANELS (all original panels preserved) -->
  <div class="panel" id="panel-racha" onscroll="if(!document.getElementById('mascotaTypeRow').children.length)buildMascotaPanel()">
    <div class="panel-header"><div class="back-btn" onclick="closePanel('racha')">←</div><div class="panel-title">🔥 Mi Racha</div></div>
    <div class="panel-content">
      <div class="streak-big">
        <div class="streak-icon-row" id="panelStreakEmoji">🔥</div>
        <div class="streak-big-num" id="panelStreakNum">1</div>
        <div class="streak-big-label">días seguidos</div>
        <div class="legendary-badge" id="panelLegendaryBadge" style="margin:8px auto 0;">🔮 ¡Racha Legendaria!</div>
      </div>
      <div class="streak-week-row" id="streakWeekRow"></div>
      <div style="color:rgba(255,255,255,.35);font-size:11px;text-align:center;margin-top:2px;margin-bottom:10px;">🔒 La racha sube completando todas tus tareas del día</div>

      <!-- ══ MASCOTA ══ -->
      <div class="mascota-section-title" style="font-size:15px;font-weight:800;margin-bottom:4px;">🐾 Tu Mascota de Racha</div>
      <div style="color:rgba(255,255,255,.35);font-size:11px;text-align:center;margin-bottom:8px;">Personalízala a tu gusto — crece con tu racha</div>

      <!-- Pet display card -->
      <div class="mascota-card" id="mascotaCard">
        <div class="mascota-glow" id="mascotaGlow"></div>

        <div class="mascota-display" id="mascotaDisplay" onclick="tapPet(event)">
          <div class="mascota-acc hat"    id="mascotaHat"></div>
          <div class="mascota-body"       id="mascotaBody">🐱</div>
          <div class="mascota-acc collar" id="mascotaCollar"></div>
          <div class="mascota-acc wand"   id="mascotaWand"></div>
        </div>

        <div class="mascota-info-row">
          <input class="mascota-name-edit" id="mascotaNameInput" value="Chispa"
            maxlength="12" placeholder="Nombre..." oninput="petName=this.value">
          <div class="mascota-level-badge" id="mascotaLvlBadge">Nv.1</div>
        </div>

        <div class="mascota-mood-row">
          <div class="mascota-mood-icon" id="mascotaMoodIcon">😊</div>
          <div class="mascota-hp-track">
            <div class="mascota-hp-fill" id="mascotaHpFill" style="width:60%;background:var(--green)"></div>
          </div>
          <div class="mascota-mood-label" id="mascotaMoodLabel">Contento</div>
        </div>

        <div class="mascota-stats">
          <div class="mascota-stat"><span class="ms-icon">🔥</span><span class="ms-val" id="petStatDays">1</span><span class="ms-lbl">días</span></div>
          <div class="mascota-stat"><span class="ms-icon">❤️</span><span class="ms-val" id="petStatHp">60</span><span class="ms-lbl">ánimo</span></div>
          <div class="mascota-stat"><span class="ms-icon">⭐</span><span class="ms-val" id="petStatLvl">1</span><span class="ms-lbl">nivel</span></div>
        </div>

        <div class="mascota-evo-banner" id="mascotaEvoBanner" style="display:none;">
          <div class="mascota-evo-icon" id="evoIcon">✨</div>
          <div class="mascota-evo-text">
            <strong id="evoBannerTitle">¡Evolución disponible!</strong>
            <span id="evoBannerDesc">Tu mascota está lista para evolucionar</span>
          </div>
        </div>

        <button class="mascota-tap-btn" onclick="tapPet({clientX:window.innerWidth/2,clientY:200})">
          👆 ¡Toca a tu mascota!
        </button>
      </div>

      <!-- Customizer -->
      <div class="mascota-customizer">
        <div class="mascota-cust-label">🐾 Tipo de mascota</div>
        <div class="mascota-type-row" id="mascotaTypeRow"></div>

        <div class="mascota-cust-label" style="margin-top:10px;">🎨 Color / Aura</div>
        <div class="mascota-color-row" id="mascotaColorRow"></div>

        <div class="mascota-cust-label" style="margin-top:10px;">🎁 Accesorios</div>
        <div class="mascota-acc-row" id="mascotaAccRow" style="flex-direction:column;align-items:flex-start;"></div>
      </div>
    </div>
  </div>

  <div class="panel" id="panel-tareas">
    <div class="panel-header" style="border-bottom:1px solid rgba(255,255,255,.07);">
      <div class="back-btn" onclick="closePanel('tareas')">←</div>
      <div class="panel-title">📋 Mis Tareas</div>
      <button class="tsk-header-btn" onclick="openAddTaskModal()" title="Nueva tarea">＋</button>
    </div>
    <div class="panel-content" style="padding:0;gap:0;">

      <!-- Tabs -->
      <div class="tsk-tabs">
        <button class="tsk-tab active" id="tskTabDaily"   onclick="tskSwitchTab('daily',this)">📅 Diarias</button>
        <button class="tsk-tab"        id="tskTabWeekly"  onclick="tskSwitchTab('weekly',this)">📆 Semanales</button>
        <button class="tsk-tab"        id="tskTabOnce"    onclick="tskSwitchTab('once',this)">✅ Únicas</button>
      </div>

      <!-- Progress bar -->
      <div class="tsk-progress-wrap" id="tskProgressWrap">
        <div class="tsk-progress-bar" id="tskProgressBar"></div>
        <div class="tsk-progress-label" id="tskProgressLabel">0 / 0 completadas hoy</div>
      </div>

      <!-- Task list -->
      <div class="tsk-list" id="tskList"></div>

      <!-- Empty state -->
      <div class="tsk-empty" id="tskEmpty" style="display:none;">
        <div class="tsk-empty-icon">📭</div>
        <div class="tsk-empty-text">Sin tareas en esta sección</div>
        <button class="tsk-empty-add" onclick="openAddTaskModal()">＋ Agregar tarea</button>
      </div>

    </div>
  </div>

  <!-- ══ ADD TASK MODAL ══ -->
  <div class="tsk-modal-overlay" id="tskModalOverlay" onclick="closeAddTaskModal()"></div>
  <div class="tsk-modal" id="tskModal">
    <div class="tsk-modal-title" id="tskModalTitle">Nueva Tarea</div>

    <input class="tsk-modal-input" id="tskModalName" placeholder="Nombre de la tarea..." maxlength="80"
      onkeydown="if(event.key==='Enter')tskModalConfirm()">

    <div class="tsk-modal-label">Tipo</div>
    <div class="tsk-type-row">
      <button class="tsk-type-btn active" id="tskTypeOnce"   onclick="tskSelectType('once',this)">✅ Única</button>
      <button class="tsk-type-btn"        id="tskTypeDaily"  onclick="tskSelectType('daily',this)">📅 Diaria</button>
      <button class="tsk-type-btn"        id="tskTypeWeekly" onclick="tskSelectType('weekly',this)">📆 Semanal</button>
    </div>

    <!-- Weekly day selector (shows only when type=weekly) -->
    <div class="tsk-days-wrap" id="tskDaysWrap" style="display:none;">
      <div class="tsk-modal-label">Días de la semana</div>
      <div class="tsk-days-row" id="tskDaysRow">
        <button class="tsk-day-btn" data-day="0">Lu</button>
        <button class="tsk-day-btn" data-day="1">Ma</button>
        <button class="tsk-day-btn" data-day="2">Mi</button>
        <button class="tsk-day-btn" data-day="3">Ju</button>
        <button class="tsk-day-btn" data-day="4">Vi</button>
        <button class="tsk-day-btn" data-day="5">Sá</button>
        <button class="tsk-day-btn" data-day="6">Do</button>
      </div>
    </div>

    <div class="tsk-modal-label">Emoji / ícono</div>
    <div class="tsk-emoji-row" id="tskEmojiRow">
      <button class="tsk-emoji-opt active" data-emoji="📋">📋</button>
      <button class="tsk-emoji-opt" data-emoji="⭐">⭐</button>
      <button class="tsk-emoji-opt" data-emoji="🎯">🎯</button>
      <button class="tsk-emoji-opt" data-emoji="📚">📚</button>
      <button class="tsk-emoji-opt" data-emoji="💪">💪</button>
      <button class="tsk-emoji-opt" data-emoji="🧠">🧠</button>
      <button class="tsk-emoji-opt" data-emoji="💻">💻</button>
      <button class="tsk-emoji-opt" data-emoji="🏃">🏃</button>
      <button class="tsk-emoji-opt" data-emoji="🎵">🎵</button>
      <button class="tsk-emoji-opt" data-emoji="🍎">🍎</button>
    </div>

    <div class="tsk-modal-actions">
      <button class="tsk-modal-cancel" onclick="closeAddTaskModal()">Cancelar</button>
      <button class="tsk-modal-ok" id="tskModalOkBtn" onclick="tskModalConfirm()">Agregar</button>
    </div>
  </div>

  <div class="panel" id="panel-notas">
    <div class="panel-header" style="border-bottom:1px solid rgba(255,255,255,.07);">
      <div class="back-btn" onclick="closePanel('notas')">←</div>
      <div class="panel-title">📝 Notas</div>
    </div>
    <div class="panel-content" style="padding:0;gap:0;overflow-y:auto;">

      <!-- ── Frase de disciplina ── -->
      <div class="notas-quote" id="notasQuote">
        <span class="notas-quote-icon">💬</span>
        <span class="notas-quote-text" id="notasQuoteText"></span>
      </div>

      <!-- ── Tabs ── -->
      <div class="notas-tabs">
        <button class="notas-tab active" id="notasTabRutina" onclick="notasSwitchTab('rutina',this)">🏋️ Rutina</button>
        <button class="notas-tab" id="notasTabGeneral" onclick="notasSwitchTab('general',this)">📋 General</button>
      </div>

      <!-- ══ TAB: Notas de Rutina ══ -->
      <div id="notasTabRutinaContent">

        <!-- Add exercise note -->
        <div class="notas-add-bar">
          <select class="notas-ex-select" id="notasExSelect">
            <option value="">— Ejercicio —</option>
            <option>Press de banca</option><option>Sentadilla</option><option>Peso muerto</option>
            <option>Press militar</option><option>Jalón al pecho</option><option>Remo con barra</option>
            <option>Curl de bíceps</option><option>Extensión tríceps</option><option>Zancadas</option>
            <option>Plancha</option><option>Burpees</option><option>Fondos</option>
            <option>Dominadas</option><option>Hip thrust</option><option value="_custom">Otro...</option>
          </select>
          <input class="notas-custom-ex" id="notasCustomEx" placeholder="Nombre del ejercicio..." style="display:none;">
        </div>
        <div class="notas-add-bar" style="gap:6px;">
          <input class="notas-weight-input" id="notasWeight" type="number" step="0.5" min="0" placeholder="Peso (kg)" style="flex:1;">
          <input class="notas-weight-input" id="notasSeries" placeholder="Series/Reps" style="flex:1;">
          <button class="notas-add-btn" onclick="notasAddRoutineEntry()">＋</button>
        </div>

        <!-- Exercise notes list grouped by exercise -->
        <div class="notas-routine-list" id="notasRoutineList"></div>

        <!-- Empty state -->
        <div class="notas-empty" id="notasRoutineEmpty" style="display:none;">
          <div>🏋️</div><div>Anota tus primeros pesos aquí</div>
        </div>
      </div>

      <!-- ══ TAB: Notas Generales ══ -->
      <div id="notasTabGeneralContent" style="display:none;">
        <div class="notas-general-wrap">
          <textarea class="notas-general-area" id="notasGeneralArea"
            placeholder="Escribe aquí tus notas de trabajo, tareas, hábitos, cambios..."
            oninput="notasAutoSave()"></textarea>
          <div class="notas-general-footer">
            <span class="notas-general-chars" id="notasGenChars">0 caracteres</span>
            <span class="notas-general-saved" id="notasGenSaved">●  Guardado</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="panel" id="panel-habitos">
    <div class="panel-header"><div class="back-btn" onclick="closePanel('habitos')">←</div><div class="panel-title">🌿 Hábitos</div>
      <button onclick="openAddHabitModal()" style="margin-left:auto;background:var(--teal);border:none;border-radius:20px;color:#fff;font-size:18px;font-weight:800;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:manipulation;">+</button>
    </div>
    <div class="panel-content" id="habitPanelContent">
      <div style="color:rgba(255,255,255,.3);text-align:center;font-size:12px;padding:20px;">Cargando hábitos...</div>
    </div>
  </div>

  <!-- ══ PANEL: Progreso ══ -->
  <div class="panel" id="panel-stats">
    <div class="panel-header" style="border-bottom:1px solid rgba(255,255,255,.07);">
      <div class="back-btn" onclick="closePanel('stats')">←</div>
      <div class="panel-title">📊 Progreso</div>
    </div>
    <div class="panel-content prog-panel-content" style="padding:0;gap:0;overflow-y:auto;">

      <!-- ── KPI strip ── -->
      <div class="prog-kpi-strip" id="progKpiStrip">
        <div class="prog-kpi"><span class="prog-kpi-val" id="progKpiXP">0</span><span class="prog-kpi-lbl">XP Total</span></div>
        <div class="prog-kpi"><span class="prog-kpi-val" id="progKpiStreak">1</span><span class="prog-kpi-lbl">Días racha</span></div>
        <div class="prog-kpi"><span class="prog-kpi-val" id="progKpiTasks">0</span><span class="prog-kpi-lbl">Tareas</span></div>
        <div class="prog-kpi"><span class="prog-kpi-val" id="progKpiHabits">0</span><span class="prog-kpi-lbl">Hábitos</span></div>
      </div>

      <!-- ── Main chart ── -->
      <div class="prog-chart-wrap">
        <div class="prog-chart-header">
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="prog-chart-title">Actividad</span>
            <span class="prog-chart-period" id="progChartPeriod">Esta semana</span>
          </div>
          <div class="prog-view-toggle">
            <button class="prog-vtbtn active" id="pvtWeek" onclick="progSetView('week',this)">Sem</button>
            <button class="prog-vtbtn" id="pvtMonth" onclick="progSetView('month',this)">Mes</button>
          </div>
        </div>
        <div class="prog-chart-canvas" id="progChartCanvas"></div>
        <div class="prog-chart-legend">
          <span><span class="prog-leg-dot" style="background:var(--green)"></span>Tareas</span>
          <span><span class="prog-leg-dot" style="background:var(--purple)"></span>Hábitos</span>
          <span><span class="prog-leg-dot" style="background:var(--teal-light)"></span>Rutina</span>
        </div>
      </div>

      <!-- ── Calendar ── -->
      <div class="prog-cal-section">
        <div class="prog-cal-header">
          <button class="prog-cal-arrow" onclick="progChangeMonth(-1)">‹</button>
          <span class="prog-cal-title" id="progCalLabel">Enero 2025</span>
          <button class="prog-cal-arrow" onclick="progChangeMonth(1)">›</button>
        </div>
        <div class="prog-cal-grid" id="progCalGrid"></div>
      </div>

      <!-- ── Day Detail ── -->
      <div class="prog-day-detail" id="progDayDetail" style="display:none;">
        <div class="prog-day-header">
          <span class="prog-day-title" id="progDayTitle">Lunes 1</span>
          <div class="prog-day-compare" id="progDayCompare"></div>
        </div>

        <!-- Sub-tabs -->
        <div class="prog-subtabs">
          <button class="prog-stab active" id="pstTareas" onclick="progSubTab('tareas',this)">🗂 Tareas / Hábitos</button>
          <button class="prog-stab" id="pstRutina" onclick="progSubTab('rutina',this)">💪 Rutina</button>
        </div>

        <!-- Tareas / Habitos tab -->
        <div id="progTabTareas">
          <div class="prog-detail-section">
            <div class="prog-detail-label">📋 Tareas del día</div>
            <div id="progTasksList" class="prog-items-list"></div>
          </div>
          <div class="prog-detail-section">
            <div class="prog-detail-label">🌿 Hábitos del día</div>
            <div id="progHabitsList" class="prog-items-list"></div>
          </div>
        </div>

        <!-- Rutina tab -->
        <div id="progTabRutina" style="display:none;">
          <div class="prog-detail-section">
            <div class="prog-detail-label" id="progRutinaLabel">💪 Rutina del día</div>
            <div id="progRutinaList" class="prog-items-list"></div>
          </div>
        </div>
      </div>

      <!-- old xp-stat hook preserved invisible -->
      <span id="xp-stat" style="display:none;">0 puntos</span>
      <span id="tasksCompletedStat" style="display:none;">0 esta semana</span>
      <span id="statStreak" style="display:none;">1 día</span>
    </div>
  </div>

  <div class="panel" id="panel-metas">
    <div class="panel-header"><div class="back-btn" onclick="closePanel('metas')">←</div><div class="panel-title">🎯 Metas</div></div>
    <div class="panel-content">
      <div class="panel-item c5"><div class="panel-item-icon">🏆</div><div class="panel-item-text"><strong>Meta mensual</strong><span>0 / 10 completadas</span></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item c4"><div class="panel-item-icon">🌟</div><div class="panel-item-text"><strong>Objetivo anual</strong><span>En progreso</span></div><div class="panel-item-arrow">›</div></div>
    </div>
  </div>

  <!-- ══ PANEL: Social ══ -->
  <div class="panel" id="panel-social">
    <div class="panel-header"><div class="back-btn" onclick="closePanel('social')">←</div><div class="panel-title">💬 Social</div></div>
    <div class="panel-content">

      <!-- Mi código de jugador -->
      <div class="soc-player-card" id="socPlayerCard">
        <div class="soc-player-avatar" id="socMyAvatar">🧑</div>
        <div class="soc-player-info">
          <div class="soc-player-name" id="socMyName">—</div>
          <div class="soc-player-tag" id="socMyTag">Cargando código...</div>
        </div>
        <button class="soc-copy-btn" onclick="copyMyTag()" title="Copiar código">📋</button>
      </div>

      <!-- Agregar amigo -->
      <div class="soc-add-section">
        <div class="soc-add-label">➕ Agregar amigo por código</div>
        <div class="soc-add-row">
          <input class="soc-add-input" id="socAddInput" placeholder="Ej: Leo#4821" oninput="socSearchDebounce()" onkeydown="if(event.key==='Enter')socDoSearch()" maxlength="40" />
          <button class="soc-add-search-btn" onclick="socDoSearch()">Buscar</button>
        </div>
        <div id="socSearchResult" class="soc-search-result-wrap"></div>
      </div>

      <!-- Solicitudes recibidas -->
      <div id="socPendingSection" style="display:none;">
        <div class="soc-section-label">
          <span>⏳ Solicitudes recibidas</span>
          <span class="soc-pending-count" id="socPendingCount">0</span>
        </div>
        <div id="socPendingList"></div>
      </div>

      <!-- Mis amigos -->
      <div class="soc-section-label" style="margin-top:8px;">
        <span>👥 Mis amigos</span>
        <span id="socFriendCount" style="color:rgba(255,255,255,.3);font-size:10px;font-weight:700;"></span>
      </div>
      <div id="socFriendsList"><div class="soc-empty">Cargando...</div></div>

      <!-- GymBro Section -->
      <div class="gymbro-section" id="gymBroSection" style="margin-top:10px;">
        <div class="gymbro-label">💪 GymBro</div>
        <div class="gymbro-row">
          <div class="gymbro-avatar">🏋️</div>
          <div class="gymbro-info">
            <div class="gymbro-name" style="color:rgba(255,255,255,.35);">Sin GymBro asignado</div>
            <div class="gymbro-sub">Asigna uno desde el perfil de un amigo</div>
          </div>
        </div>
      </div>

      <!-- Ranking -->
      <div class="panel-item c1" style="margin-top:6px;cursor:pointer;" onclick="openPanel('ranking')"><div class="panel-item-icon">🏅</div><div class="panel-item-text"><strong>Ranking Semanal</strong><span>Top 100 · Esta semana</span></div><div class="panel-item-arrow">›</div></div>
    </div>
  </div>

  <!-- ══ PANEL: Ranking Semanal ══ -->
  <div class="panel" id="panel-ranking">
    <div class="panel-header" style="border-bottom:1px solid rgba(255,255,255,.07);">
      <div class="back-btn" onclick="closePanel('ranking')">←</div>
      <div class="panel-title">🏆 Ranking Semanal</div>
      <button class="rnk-refresh-btn" onclick="loadRanking(true)" id="rnkRefreshBtn" title="Actualizar">↻</button>
    </div>
    <div class="panel-content" style="padding:0;gap:0;">

      <!-- ── Header info strip ── -->
      <div class="rnk-info-strip">
        <div class="rnk-info-item">
          <span class="rnk-info-val" id="rnkWeekLabel">—</span>
          <span class="rnk-info-lbl">Semana</span>
        </div>
        <div class="rnk-info-sep"></div>
        <div class="rnk-info-item">
          <span class="rnk-info-val" id="rnkMyRank">—</span>
          <span class="rnk-info-lbl">Tu posición</span>
        </div>
        <div class="rnk-info-sep"></div>
        <div class="rnk-info-item">
          <span class="rnk-info-val" id="rnkMyWeekXP">—</span>
          <span class="rnk-info-lbl">Tu XP sem.</span>
        </div>
        <div class="rnk-info-sep"></div>
        <div class="rnk-info-item">
          <span class="rnk-info-val" id="rnkTotal">—</span>
          <span class="rnk-info-lbl">Jugadores</span>
        </div>
      </div>

      <!-- ── Top 3 podium ── -->
      <div class="rnk-podium" id="rnkPodium"></div>

      <!-- ── List 4-100 ── -->
      <div class="rnk-list-header">
        <span style="color:rgba(255,255,255,.3);font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">Posición</span>
        <span style="color:rgba(255,255,255,.3);font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">Jugador</span>
        <span style="color:rgba(255,255,255,.3);font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">XP sem.</span>
      </div>
      <div id="rnkList" class="rnk-list"></div>

      <!-- ── Loading / empty ── -->
      <div id="rnkLoading" class="rnk-loading">
        <div class="rnk-spinner"></div>
        <span>Cargando ranking...</span>
      </div>
      <div id="rnkEmpty" class="rnk-empty" style="display:none;">
        <div style="font-size:36px;">🏜️</div>
        <div>No hay jugadores activos esta semana aún.</div>
        <div style="font-size:10px;opacity:.5;margin-top:4px;">¡Sé el primero en aparecer!</div>
      </div>

      <!-- ── My position sticky footer (if not in top 100) ── -->
      <div class="rnk-my-pos-footer" id="rnkMyPosFooter" style="display:none;">
        <div class="rnk-my-pos-row" id="rnkMyPosRow"></div>
      </div>
    </div>
  </div>

  <!-- ══ PANEL: Perfil de Amigo ══ -->
  <div class="panel" id="panel-friend-profile">
    <div class="panel-header">
      <div class="back-btn" onclick="closePanel('friend-profile')">←</div>
      <div class="panel-title" id="fpTitle">Perfil</div>
      <button class="fp-chat-btn" id="fpChatBtn" onclick="fpOpenChat()">💬 Chat</button>
    </div>
    <div class="panel-content" id="fpContent" style="gap:12px;">
      <div class="fp-loading">Cargando perfil...</div>
    </div>
  </div>
  <div class="panel" id="panel-chat">
    <div class="panel-header">
      <div class="back-btn" onclick="closeChat()">←</div>
      <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0;">
        <div id="chatFriendAvatar" style="font-size:24px;flex-shrink:0;">🧑</div>
        <div style="min-width:0;">
          <div class="panel-title" id="chatFriendName" style="font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Amigo</div>
          <div id="chatFriendXP" style="color:rgba(255,255,255,.35);font-size:10px;"></div>
        </div>
      </div>
      <div class="chat-xp-compare-btn" onclick="openXPCompare()">📊 VS</div>
    </div>

    <!-- XP Compare (togglable) -->
    <div id="xpCompareSection" style="display:none;">
      <div class="xp-compare-card">
        <div class="xp-compare-title">⚡ XP Semanal — cara a cara</div>
        <div class="xp-compare-row" id="xpCompareMe"></div>
        <div class="xp-compare-row" id="xpCompareFriend"></div>
        <div class="xp-compare-result" id="xpCompareResult"></div>
      </div>
    </div>

    <!-- Messages -->
    <div id="chatGymBroBanner" class="chat-gymbro-banner" style="display:none;">
      💪 <span id="chatGymBroText">GymBros</span> 💪
    </div>
    <div id="chatMessages" class="chat-messages-wrap"></div>

    <!-- Emoji Picker Panel -->
    <div class="chat-emoji-panel" id="chatEmojiPanel">
      <div class="chat-emoji-grid" id="chatEmojiGrid"></div>
    </div>

    <!-- Input -->
    <div class="chat-input-row">
      <button class="chat-emoji-btn" id="chatEmojiBtn" onclick="toggleChatEmojiPanel()" title="Emojis">😊</button>
      <input class="chat-input" id="chatInput" placeholder="Escribe un mensaje..." onkeydown="if(event.key==='Enter'){sendChatMessage();closeChatEmojiPanel();}" maxlength="300" />
      <button class="chat-send-btn" onclick="sendChatMessage()">➤</button>
    </div>
  </div>

  <div class="panel" id="panel-perfil">
    <div class="panel-header"><div class="back-btn" onclick="closePanel('perfil')">←</div><div class="panel-title">👤 Perfil</div></div>
    <div class="panel-content">

      <!-- ══ HERO DE PERFIL ══ -->
      <div class="profile-hero">

        <!-- Badge de nivel arriba a la derecha -->
        <div class="profile-hero-badge" id="profileHeroBadge">Nv. 1</div>

        <!-- Anillos giratorios -->
        <div class="avatar-ring-outer"></div>
        <div class="avatar-ring-mid"></div>

        <!-- Avatar clickeable -->
        <div class="avatar-wrapper" onclick="triggerPhotoPicker()">
          <div class="avatar-emoji" id="profileAvatarPanel">🧑‍🌾</div>
          <img id="profileImgPanel" src="" alt="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%;position:absolute;top:0;left:0;">
          <div class="avatar-overlay">📷<span>Cambiar</span></div>
        </div>

        <!-- Nombre y nivel -->
        <div class="profile-hero-name" id="profileName">Nombre de Usuario</div>
        <div class="profile-hero-level" id="profileXPLabel">Nivel 1 · 0 XP</div>

        <!-- Stats chips -->
        <div class="profile-hero-stats">
          <div class="profile-stat-chip">
            <span>⭐</span>
            <span class="psc-val" id="profileStatXP">0</span>
            <span class="psc-lbl">XP</span>
          </div>
          <div class="profile-stat-chip">
            <span>🔥</span>
            <span class="psc-val" id="profileStatStreak">0</span>
            <span class="psc-lbl">días</span>
          </div>
          <div class="profile-stat-chip">
            <span>🪙</span>
            <span class="psc-val" id="profileStatCoins">0</span>
            <span class="psc-lbl">monedas</span>
          </div>
        </div>

        <!-- Botones -->
        <div style="display:flex;gap:8px;margin-top:14px;z-index:2;">
          <button class="photo-btn" onclick="triggerPhotoPicker()">📷 Cambiar foto</button>
          <button class="photo-remove-btn" id="removePhotoBtn" onclick="removePhoto()" style="display:none;">✕ Quitar</button>
        </div>

        <input type="file" id="photoInput" accept="image/*" style="display:none;" onchange="loadPhoto(event)">
      </div>

      <!-- Opciones del perfil -->
      <div class="panel-item c1" onclick="openPanel('config')"><div class="panel-item-icon">⚙️</div><div class="panel-item-text"><strong>Configuración</strong><span>Sonido, notificaciones, focus</span></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item c4" onclick="openPanel('apariencia')"><div class="panel-item-icon">🎨</div><div class="panel-item-text"><strong>Apariencia</strong><span>Colores y temas</span></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item c3" onclick="openPanel('inventario')"><div class="panel-item-icon">🎒</div><div class="panel-item-text"><strong>Inventario</strong><span>Poderes, badges y más</span></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item" style="background:rgba(94,220,138,.08);border:1.5px solid rgba(94,220,138,.2);border-radius:12px;" onclick="saveAccount().then(()=>showToast('✓ Progreso guardado'))">
        <div class="panel-item-icon">💾</div>
        <div class="panel-item-text"><strong style="color:var(--green);">Guardar progreso</strong><span id="lastSavedLabel">Toca para guardar</span></div>
        <div class="panel-item-arrow" style="color:var(--green);">›</div>
      </div>
      <div class="panel-item" style="background:rgba(232,82,122,.07);border:1.5px solid rgba(232,82,122,.2);border-radius:12px;" onclick="confirmLogout()">
        <div class="panel-item-icon">🚪</div>
        <div class="panel-item-text"><strong style="color:var(--pink);">Cerrar sesión</strong><span id="loggedEmailLabel">—</span></div>
        <div class="panel-item-arrow" style="color:var(--pink);">›</div>
      </div>
    </div>
  </div>

  <!-- ══ PANEL: Configuración ══ -->
  <div class="panel" id="panel-config">
    <div class="panel-header">
      <div class="back-btn" onclick="closePanel('config')">←</div>
      <div class="panel-title">⚙️ Configuración</div>
    </div>
    <div class="panel-content">

      <!-- Profile preview card -->
      <div class="cfg-profile-card">
        <div class="cfg-avatar-wrap" onclick="triggerPhotoPicker()">
          <div class="cfg-avatar-emoji" id="cfgAvatarEmoji">🧑‍🌾</div>
          <img id="cfgAvatarImg" src="" alt="" style="display:none;position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:50%;">
          <div class="cfg-avatar-overlay">📷</div>
        </div>
        <div class="cfg-profile-info">
          <div class="cfg-profile-name" id="cfgProfileName">Nombre de Usuario</div>
          <div class="cfg-profile-sub" id="cfgProfileSub">Nivel 1 · 0 XP</div>
        </div>
        <div class="cfg-edit-btn" onclick="openPanel('perfil')" title="Editar perfil">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </div>
      </div>

      <div class="cfg-section-label">Sonido y notificaciones</div>

      <!-- Volumen row -->
      <div class="cfg-row">
        <div class="cfg-row-left">
          <div class="cfg-icon-box" style="background:linear-gradient(135deg,#c07a10,#f0c040);">🔊</div>
          <div class="cfg-row-text">
            <strong>Volumen</strong>
            <span id="volLabel">100%</span>
          </div>
        </div>
        <label class="cfg-toggle">
          <input type="checkbox" id="volToggle" checked onchange="toggleVolume(this)">
          <span class="cfg-toggle-track"><span class="cfg-toggle-thumb"></span></span>
        </label>
      </div>
      <!-- Volume slider (shows when on) -->
      <div class="cfg-slider-wrap" id="volSliderWrap">
        <span class="cfg-slider-icon">🔇</span>
        <input type="range" class="cfg-slider" id="volSlider" min="0" max="100" value="100" oninput="updateVolLabel(this.value)">
        <span class="cfg-slider-icon">🔊</span>
      </div>

      <!-- Notificaciones row -->
      <div class="cfg-row">
        <div class="cfg-row-left">
          <div class="cfg-icon-box" style="background:linear-gradient(135deg,#b83060,#e8527a);">🔔</div>
          <div class="cfg-row-text">
            <strong>Notificaciones</strong>
            <span id="notifLabel">Activas</span>
          </div>
        </div>
        <label class="cfg-toggle">
          <input type="checkbox" id="notifToggle" checked onchange="toggleNotif(this)">
          <span class="cfg-toggle-track" style="--track-on:var(--purple);"><span class="cfg-toggle-thumb"></span></span>
        </label>
      </div>
      <!-- Notif sub-options -->
      <div class="cfg-sub-opts" id="notifSubOpts">
        <div class="cfg-chip-row">
          <div class="cfg-chip active" onclick="toggleChip(this)">📱 Push</div>
          <div class="cfg-chip active" onclick="toggleChip(this)">📧 Email</div>
          <div class="cfg-chip" onclick="toggleChip(this)">📳 Vibrar</div>
        </div>
      </div>

      <div class="cfg-section-label" style="margin-top:4px;">Productividad</div>

      <!-- Focus time row -->
      <div class="cfg-row">
        <div class="cfg-row-left">
          <div class="cfg-icon-box" style="background:linear-gradient(135deg,#2e7d4f,#5edc8a);">🎯</div>
          <div class="cfg-row-text">
            <strong>Tiempo de Focus</strong>
            <span id="focusLabel">25 min</span>
          </div>
        </div>
        <div class="cfg-stepper">
          <div class="cfg-stepper-btn" onclick="changeFocus(-5)">−</div>
          <div class="cfg-stepper-val" id="focusVal">25</div>
          <div class="cfg-stepper-unit">min</div>
          <div class="cfg-stepper-btn" onclick="changeFocus(5)">+</div>
        </div>
      </div>
      <!-- Focus presets -->
      <div class="cfg-sub-opts" id="focusPresetsWrap">
        <div class="cfg-chip-row">
          <div class="cfg-chip" onclick="setFocus(15,this)">15 min</div>
          <div class="cfg-chip active" onclick="setFocus(25,this)">25 min</div>
          <div class="cfg-chip" onclick="setFocus(45,this)">45 min</div>
          <div class="cfg-chip" onclick="setFocus(60,this)">1 hora</div>
        </div>
        <button class="cfg-focus-start-btn" onclick="startFocusSession()">
          <span id="focusStartIcon">▶</span> <span id="focusStartText">Iniciar sesión</span>
        </button>
      </div>

      <!-- Silenciar chats row -->
      <div class="cfg-row">
        <div class="cfg-row-left">
          <div class="cfg-icon-box" style="background:linear-gradient(135deg,#4a20c8,#8b62e0);">💬</div>
          <div class="cfg-row-text">
            <strong>Silenciar Chats</strong>
            <span id="muteLabel">Desactivado</span>
          </div>
        </div>
        <label class="cfg-toggle">
          <input type="checkbox" id="muteToggle" onchange="toggleMute(this)">
          <span class="cfg-toggle-track" style="--track-on:#8b62e0;"><span class="cfg-toggle-thumb"></span></span>
        </label>
      </div>
      <!-- Mute duration options -->
      <div class="cfg-sub-opts" id="muteDurationWrap" style="display:none;">
        <div class="cfg-chip-row">
          <div class="cfg-chip" onclick="setMuteDuration('1h',this)">1 hora</div>
          <div class="cfg-chip active" onclick="setMuteDuration('8h',this)">8 horas</div>
          <div class="cfg-chip" onclick="setMuteDuration('24h',this)">1 día</div>
          <div class="cfg-chip" onclick="setMuteDuration('∞',this)">Siempre</div>
        </div>
        <div class="cfg-mute-countdown" id="muteCountdown">
          <span>🔕</span> Chats silenciados por <strong id="muteDurText">8 horas</strong>
        </div>
      </div>

      <!-- Save button -->
      <button class="cfg-save-btn" onclick="saveConfig()">
        Guardar configuración ✓
      </button>

    </div>
  </div>

  <div class="panel" id="panel-apariencia">
    <div class="panel-header"><div class="back-btn" onclick="closePanel('apariencia')">←</div><div class="panel-title">🎨 Apariencia</div></div>
    <div class="panel-content">
      <!-- CEO Exclusive Theme (VIP only) -->
      <div id="vipThemeSection" style="display:none;">
        <div class="appear-section-label" style="color:rgba(180,140,40,.6);font-size:8px;letter-spacing:2px;">✦ EXCLUSIVO CEO</div>
        <div style="
          background: linear-gradient(135deg, #0a0a0f, #16120a, #0a0a0f);
          border: 1.5px solid #5a4210;
          border-radius: 14px; padding: 12px 14px;
          display: flex; align-items: center; gap: 12px;
          margin-bottom: 14px; position: relative; overflow: hidden;
        ">
          <!-- Esquinas decorativas -->
          <div style="position:absolute;top:4px;left:4px;width:8px;height:8px;border-top:1.5px solid #c8a032;border-left:1.5px solid #c8a032;opacity:.6;"></div>
          <div style="position:absolute;top:4px;right:4px;width:8px;height:8px;border-top:1.5px solid #c8a032;border-right:1.5px solid #c8a032;opacity:.6;"></div>
          <div style="position:absolute;bottom:4px;left:4px;width:8px;height:8px;border-bottom:1.5px solid #c8a032;border-left:1.5px solid #c8a032;opacity:.6;"></div>
          <div style="position:absolute;bottom:4px;right:4px;width:8px;height:8px;border-bottom:1.5px solid #c8a032;border-right:1.5px solid #c8a032;opacity:.6;"></div>
          <div style="font-size:18px;filter:drop-shadow(0 0 5px rgba(200,160,50,.4));">👑</div>
          <div style="flex:1;">
            <div style="
              background: linear-gradient(90deg, #8a6a1a, #d4aa50, #c8a032);
              -webkit-background-clip: text; -webkit-text-fill-color: transparent;
              background-clip: text; font-size:12px; font-weight:800;
              font-family:'Special Elite',cursive; letter-spacing:1px;
            ">CEO MODE</div>
            <div style="color:rgba(180,140,40,.4);font-size:9px;margin-top:2px;letter-spacing:.5px;">Tema oscuro de prestigio exclusivo</div>
          </div>
          <button id="vipThemeToggleBtn" onclick="toggleVIPTheme()" style="
            padding:6px 12px; border-radius:6px; font-size:10px; font-weight:700;
            background: linear-gradient(135deg,#1a1408,#2a1e0a);
            color: rgba(200,160,50,.7);
            border: 1px solid rgba(200,160,50,.25);
            cursor:pointer; white-space:nowrap;
            font-family:'Nunito',sans-serif;
            transition:all .2s; letter-spacing:.5px;
          ">Equipar</button>
        </div>
      </div>

      <div class="appear-section-label">Color de fondo</div>
      <div class="theme-grid" id="themeGrid"></div>
      <div class="appear-section-label" style="margin-top:6px;">Color personalizado</div>
      <div class="custom-color-row">
        <div class="color-preview-box" id="customPreviewBox"></div>
        <label class="color-pick-btn" for="bgColorPicker">
          <span>🎨</span> Elegir color
          <input type="color" id="bgColorPicker" value="#0d1b3e" oninput="applyCustomColor(this.value)" onchange="applyCustomColor(this.value)">
        </label>
        <button class="reset-color-btn" onclick="resetTheme()">↺ Reset</button>
      </div>
      <div class="appear-section-label" style="margin-top:6px;">Vista previa</div>
      <div class="theme-preview-strip" id="themePreviewStrip">
        <div class="tps-header">
          <div class="tps-circle" id="tpsAccent"></div>
          <div class="tps-line" style="width:60%"></div>
        </div>
        <div class="tps-row">
          <div class="tps-block" id="tpsBlock1"></div>
          <div class="tps-block" id="tpsBlock2"></div>
          <div class="tps-block" id="tpsBlock3"></div>
        </div>
        <div class="tps-bar" id="tpsBar"></div>
      </div>
    </div>
  </div>

  <div class="panel" id="panel-nuevo">
    <div class="panel-header"><div class="back-btn" onclick="closePanel('nuevo')">←</div><div class="panel-title">+ Crear nuevo</div></div>
    <div class="panel-content">
      <div class="panel-item c1" onclick="showToast('Tarea creada ✓');closePanel('nuevo')"><div class="panel-item-icon">📋</div><div class="panel-item-text"><strong>Nueva Tarea</strong></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item c2" onclick="showToast('Nota creada ✓');closePanel('nuevo')"><div class="panel-item-icon">📝</div><div class="panel-item-text"><strong>Nueva Nota</strong></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item c4" onclick="showToast('Hábito añadido ✓');closePanel('nuevo')"><div class="panel-item-icon">🌿</div><div class="panel-item-text"><strong>Nuevo Hábito</strong></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item c3" onclick="showToast('Meta creada ✓');closePanel('nuevo')"><div class="panel-item-icon">🎯</div><div class="panel-item-text"><strong>Nueva Meta</strong></div><div class="panel-item-arrow">›</div></div>
    </div>
  </div>

  <div class="panel" id="panel-menu">
    <div class="panel-header"><div class="back-btn" onclick="closePanel('menu')">←</div><div class="panel-title">☰ Menú</div></div>
    <div class="panel-content">
      <div class="panel-item c1" onclick="openPanel('tareas')"><div class="panel-item-icon">📋</div><div class="panel-item-text"><strong>Tareas</strong></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item c2" onclick="openPanel('notas')"><div class="panel-item-icon">📝</div><div class="panel-item-text"><strong>Notas</strong></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item c4" onclick="openPanel('habitos')"><div class="panel-item-icon">🌿</div><div class="panel-item-text"><strong>Hábitos</strong></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item c3" onclick="openPanel('stats')"><div class="panel-item-icon">📊</div><div class="panel-item-text"><strong>Estadísticas</strong></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item c4" onclick="openPanel('metas')"><div class="panel-item-icon">🎯</div><div class="panel-item-text"><strong>Metas</strong></div><div class="panel-item-arrow">›</div></div>
      <div class="panel-item c5" onclick="openPanel('perfil')"><div class="panel-item-icon">👤</div><div class="panel-item-text"><strong>Perfil</strong></div><div class="panel-item-arrow">›</div></div>
    </div>
  </div>

  <!-- ══ PANEL: Tienda ══ -->
  <div class="panel" id="panel-tienda">
    <div class="panel-header">
      <div class="back-btn" onclick="closeTienda()">←</div>
      <div class="panel-title">🛒 Tienda</div>
      <div style="display:flex;align-items:center;gap:8px;margin-left:auto;">
        <div id="rouletteShopBtn" onclick="openPanel('ruleta')" style="
          width:36px;height:36px;border-radius:50%;
          background:linear-gradient(135deg,#2d8a4e,#1a5c30);
          border:2px solid rgba(94,220,138,.4);
          display:flex;align-items:center;justify-content:center;
          font-size:18px;cursor:pointer;
          box-shadow:0 0 10px rgba(94,220,138,.3);
          animation:roulettePulse 2s ease-in-out infinite;
          touch-action:manipulation;
        ">🍀</div>
        <div class="coin-badge" onclick="showToast('¡Gana más monedas completando tareas!')">
          <span class="coin-icon">🪙</span>
          <span class="coin-count" id="shopCoinDisplay">0</span>
        </div>
      </div>
    </div>
    <div class="panel-content" style="gap:12px;">

      <!-- Coin header -->
      <div class="shop-coin-header">
        <div class="shop-coin-left">
          <div class="shop-coin-big">🪙</div>
          <div class="shop-coin-info">
            <strong id="shopCoinBig">0</strong>
            <span>monedas disponibles</span>
          </div>
        </div>
        <button class="shop-earn-btn" onclick="showEarnInfo()">¿Cómo ganar?</button>
      </div>

      <!-- Tabs -->
      <div class="shop-tabs" id="shopTabs">
        <div class="shop-tab active" onclick="switchShopTab(0,this)"><span class="st-icon">🎨</span>Temas</div>
        <div class="shop-tab" onclick="switchShopTab(1,this)"><span class="st-icon">🧑‍🎤</span>Avatares</div>
        <div class="shop-tab" onclick="switchShopTab(2,this)"><span class="st-icon">⚡</span>Poderes</div>
        <div class="shop-tab" onclick="switchShopTab(3,this)"><span class="st-icon">🏅</span>Badges</div>
      </div>

      <!-- Tab content -->
      <div id="shopTabContent"></div>

    </div>
  </div>

  <!-- ══ PANEL: Ruleta ══ -->
  <div class="panel" id="panel-ruleta">
    <div class="panel-header">
      <div class="back-btn" onclick="closePanel('ruleta')">←</div>
      <div class="panel-title">🍀 Ruleta de la Suerte</div>
    </div>
    <div class="panel-content" style="align-items:center;gap:16px;padding-bottom:30px;">

      <!-- Ad notice -->
      <div id="rouletteAdNotice" style="
        background:rgba(94,220,138,.08);border:1.5px solid rgba(94,220,138,.2);
        border-radius:14px;padding:12px 16px;width:100%;text-align:center;
      ">
        <div style="font-size:13px;font-weight:800;color:var(--green);">🪙 Giro = 10🪙 c/u &nbsp;|&nbsp; 📺 Ad spin = gratis</div>
        <div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:4px;">El Ad spin requiere ver 2 anuncios</div>
        <div id="rouletteSpinsLeft" style="font-size:12px;color:rgba(255,255,255,.5);margin-top:6px;">Giros disponibles: <strong id="rouletteSpinCount" style="color:var(--green);">0</strong></div>
      </div>

      <!-- Wheel canvas -->
      <div style="position:relative;width:300px;height:300px;margin:0 auto;" id="rouletteCanvasWrap">
        <canvas id="rouletteCanvas" width="300" height="300" style="border-radius:50%;display:block;"></canvas>
        <!-- Pointer -->
        <div style="position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:28px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.5));">▼</div>
        <!-- Skip button overlay -->
        <button id="rouletteSkipBtn" onclick="skipRouletteAnimation()" style="
          display:none;
          position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
          padding:7px 20px;border-radius:20px;border:1.5px solid rgba(255,255,255,.3);
          background:rgba(0,0,0,.55);backdrop-filter:blur(6px);
          color:rgba(255,255,255,.85);font-size:12px;font-weight:800;cursor:pointer;
          font-family:'Nunito',sans-serif;letter-spacing:.5px;
          touch-action:manipulation;white-space:nowrap;
          box-shadow:0 2px 12px rgba(0,0,0,.4);
        ">⏭ Skip</button>
      </div>

      <!-- Multi-spin selector -->
      <div style="width:100%;max-width:300px;">
        <div style="display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:10px;">
          <div style="color:rgba(255,255,255,.4);font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">Cantidad de giros</div>
        </div>
        <div style="display:flex;gap:6px;justify-content:center;margin-bottom:12px;" id="spinCountBtns">
          <button onclick="setSpinCount(1,this)"  style="flex:1;padding:8px 4px;border-radius:12px;border:2px solid rgba(94,220,138,.5);background:linear-gradient(135deg,#2d8a4e,#1a5c30);color:#fff;font-size:12px;font-weight:900;cursor:pointer;touch-action:manipulation;font-family:'Nunito',sans-serif;" class="spin-count-btn active-spin-btn">×1<br><span style="font-size:9px;opacity:.7;">10🪙</span></button>
          <button onclick="setSpinCount(5,this)"  style="flex:1;padding:8px 4px;border-radius:12px;border:2px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#fff;font-size:12px;font-weight:900;cursor:pointer;touch-action:manipulation;font-family:'Nunito',sans-serif;" class="spin-count-btn">×5<br><span style="font-size:9px;opacity:.7;">50🪙</span></button>
          <button onclick="setSpinCount(10,this)" style="flex:1;padding:8px 4px;border-radius:12px;border:2px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#fff;font-size:12px;font-weight:900;cursor:pointer;touch-action:manipulation;font-family:'Nunito',sans-serif;" class="spin-count-btn">×10<br><span style="font-size:9px;opacity:.7;">100🪙</span></button>
          <button onclick="setSpinCount(25,this)" style="flex:1;padding:8px 4px;border-radius:12px;border:2px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#fff;font-size:12px;font-weight:900;cursor:pointer;touch-action:manipulation;font-family:'Nunito',sans-serif;" class="spin-count-btn">×25<br><span style="font-size:9px;opacity:.7;">250🪙</span></button>
          <button onclick="setSpinCount(50,this)" style="flex:1;padding:8px 4px;border-radius:12px;border:2px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#fff;font-size:12px;font-weight:900;cursor:pointer;touch-action:manipulation;font-family:'Nunito',sans-serif;" class="spin-count-btn">×50<br><span style="font-size:9px;opacity:.7;">500🪙</span></button>
        </div>
        <div style="display:flex;gap:10px;">
          <button id="rouletteSpinBtn" onclick="spinRoulette()" style="
            flex:1;padding:14px 10px;border-radius:18px;border:none;
            background:linear-gradient(135deg,#2d8a4e,#1a5c30);
            color:#fff;font-size:14px;font-weight:800;cursor:pointer;
            font-family:'Nunito',sans-serif;
            box-shadow:0 4px 20px rgba(94,220,138,.3);
            touch-action:manipulation;
            transition:all .2s;
          "><span id="spinCountLabel">🪙 ×1 — 10🪙</span></button>
          <button id="rouletteAdSpinBtn" onclick="spinRouletteAd()" style="
            flex:1;padding:14px 10px;border-radius:18px;border:none;
            background:linear-gradient(135deg,#2a6496,#1a3a5c);
            color:#fff;font-size:14px;font-weight:800;cursor:pointer;
            font-family:'Nunito',sans-serif;
            box-shadow:0 4px 20px rgba(42,100,150,.3);
            touch-action:manipulation;
            transition:all .2s;
          ">📺 Ad spin</button>
        </div>
      </div>

      <!-- Prize display -->
      <div id="roulettePrizeDisplay" style="display:none;
        background:rgba(255,255,255,.05);border-radius:16px;padding:16px;
        width:100%;text-align:center;border:1.5px solid rgba(255,255,255,.1);
      "></div>

      <!-- Prizes legend -->
      <div style="width:100%;background:rgba(255,255,255,.03);border-radius:14px;padding:14px;">
        <div style="color:rgba(255,255,255,.4);font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Premios posibles</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:14px;height:14px;border-radius:3px;background:#3a85c4;flex-shrink:0;"></div>
            <div style="flex:1;font-size:12px;color:rgba(255,255,255,.7);font-weight:700;">⚡ Escudo de Racha</div>
            <div style="font-size:11px;color:rgba(255,255,255,.35);">24%</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:14px;height:14px;border-radius:3px;background:#8b62e0;flex-shrink:0;"></div>
            <div style="flex:1;font-size:12px;color:rgba(255,255,255,.7);font-weight:700;">⚡ Doble XP</div>
            <div style="font-size:11px;color:rgba(255,255,255,.35);">24%</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:14px;height:14px;border-radius:3px;background:#e8527a;flex-shrink:0;"></div>
            <div style="flex:1;font-size:12px;color:rgba(255,255,255,.7);font-weight:700;">⚡ Super Focus</div>
            <div style="font-size:11px;color:rgba(255,255,255,.35);">24%</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:14px;height:14px;border-radius:3px;background:#f0c040;flex-shrink:0;"></div>
            <div style="flex:1;font-size:12px;color:rgba(255,255,255,.7);font-weight:700;">⚡ Boost de Monedas</div>
            <div style="font-size:11px;color:rgba(255,255,255,.35);">24%</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:14px;height:14px;border-radius:3px;background:linear-gradient(135deg,#1a5c30,#2d8a4e);flex-shrink:0;"></div>
            <div style="flex:1;font-size:12px;color:#5edc8a;font-weight:800;">🍀 Badge Luck <span style="font-size:10px;color:rgba(255,255,255,.3);">(exclusivo ruleta)</span></div>
            <div style="font-size:11px;color:#5edc8a;font-weight:800;">2%</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:14px;height:14px;border-radius:3px;background:linear-gradient(135deg,#0d2818,#1a5c30);flex-shrink:0;"></div>
            <div style="flex:1;font-size:12px;color:#5edc8a;font-weight:800;">🍀 Apariencia Luck <span style="font-size:10px;color:rgba(255,255,255,.3);">(exclusivo ruleta)</span></div>
            <div style="font-size:11px;color:#5edc8a;font-weight:800;">2%</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ══ PANEL: Inventario ══ -->
  <div class="panel" id="panel-inventario">
    <div class="panel-header">
      <div class="back-btn" onclick="closePanel('inventario')">←</div>
      <div class="panel-title">🎒 Inventario</div>
    </div>
    <div class="panel-content" style="gap:12px;">
      <div class="shop-tabs" id="invTabs">
        <div class="shop-tab active" onclick="switchInvTab(0,this)"><span class="st-icon">⚡</span>Poderes</div>
        <div class="shop-tab" onclick="switchInvTab(1,this)"><span class="st-icon">🏅</span>Badges</div>
        <div class="shop-tab" onclick="switchInvTab(2,this)"><span class="st-icon">🧑</span>Avatar</div>
      </div>
      <div id="invTabContent"></div>
    </div>
  </div>

  <!-- Purchase modal -->
  <div class="shop-modal-overlay" id="shopModal">
    <div class="shop-modal">
      <div class="shop-modal-emoji" id="modalEmoji">🎨</div>
      <div class="shop-modal-name"  id="modalName">Item</div>
      <div class="shop-modal-price">
        <span class="pc">🪙</span>
        <span id="modalPrice">0</span>
      </div>
      <div class="shop-modal-desc" id="modalDesc">Descripción</div>
      <!-- Multi-buy qty (only for poderes) -->
      <div id="modalQtySection" style="display:none;">
        <div class="poder-qty-row">
          <button class="poder-qty-btn" onclick="modalQtyChange(-1)">−</button>
          <span class="poder-qty-num" id="modalQtyNum">1</span>
          <button class="poder-qty-btn" onclick="modalQtyChange(1)">+</button>
        </div>
        <div class="poder-qty-total" id="modalQtyTotal">Total: 🪙0</div>
      </div>
      <div class="shop-no-coins" id="modalNoCoin" style="display:none;">¡No tienes suficientes monedas!</div>
      <div class="shop-modal-btns">
        <button class="shop-modal-cancel" onclick="closeShopModal()">Cancelar</button>
        <button class="shop-modal-confirm" id="modalConfirmBtn" onclick="confirmPurchase()">Comprar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- ══ PANEL: Rutina ══ -->
  <div class="panel" id="panel-rutina">
    <div class="panel-header">
      <div class="back-btn" onclick="closePanel('rutina')">←</div>
      <div class="panel-title">💪 Mi Rutina</div>
    </div>
    <!-- Rutina top tabs -->
    <div style="display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;" id="rutinaTopTabs">
      <div onclick="switchRutinaMainTab(0)" id="rutinaTabMi" style="
        flex:1;text-align:center;padding:10px;font-size:12px;font-weight:800;
        color:#fff;border-bottom:2px solid #fff;cursor:pointer;
        font-family:'Nunito',sans-serif;letter-spacing:.5px;
        touch-action:manipulation;
      ">💪 Mi Rutina</div>
      <div onclick="switchRutinaMainTab(1)" id="rutinaTabVs" style="
        flex:1;text-align:center;padding:10px;font-size:12px;font-weight:800;
        color:rgba(255,255,255,.35);border-bottom:2px solid transparent;cursor:pointer;
        font-family:'Nunito',sans-serif;letter-spacing:.5px;
        touch-action:manipulation;
      ">🥊 VS GymBro</div>
    </div>
    <div class="panel-content" id="rutinaContent"></div>
    <div class="panel-content" id="rutinaGymbroContent" style="display:none;"></div>
  </div>

<script>
// ══ VIP CEO GOLD THEME ══
let vipThemeActive = false;

function toggleVIPTheme() {
  if (vipThemeActive) {
    deactivateVIPTheme();
    showToast('👑 Tema CEO desactivado');
  } else {
    activateVIPTheme();
    showToast('👑 Tema CEO Gold activado!');
    launchConfetti(window.innerWidth/2, window.innerHeight/2);
  }
}

function syncVIPThemeButton() {
  const btn = document.getElementById('vipThemeToggleBtn');
  if (!btn) return;
  if (vipThemeActive) {
    btn.textContent = '✓ Quitar';
    btn.style.background = 'rgba(245,208,96,.08)';
    btn.style.color = 'rgba(245,208,96,.5)';
    btn.style.border = '1px solid rgba(245,208,96,.15)';
  } else {
    btn.textContent = 'Equipar';
    btn.style.background = 'rgba(245,208,96,.12)';
    btn.style.color = 'rgba(245,208,96,.7)';
    btn.style.border = '1px solid rgba(245,208,96,.25)';
  }
}

function showVIPThemeSection() {
  const sec = document.getElementById('vipThemeSection');
  if (sec) sec.style.display = '';
  syncVIPThemeButton();
}

function activateVIPTheme() {
  vipThemeActive = true;
  document.body.classList.add('vip-mode');

  // CEO badge especial
  if (!document.getElementById('vipCrownLabel')) {
    const badge = document.createElement('div');
    badge.id = 'vipCrownLabel';
    badge.className = 'ceo-badge';
    badge.innerHTML = `
      <div class="ceo-badge-inner">
        <div class="ceo-corner tl"></div>
        <div class="ceo-corner tr"></div>
        <div class="ceo-corner bl"></div>
        <div class="ceo-corner br"></div>
        <span class="ceo-badge-crown">👑</span>
        <div class="ceo-badge-text">
          <span class="ceo-letter">C</span><span class="ceo-letter">E</span><span class="ceo-letter">O</span>
        </div>
        <span class="ceo-sep">|</span>
        <span class="ceo-mode-text">MODE</span>
        <div class="ceo-status-dot"></div>
      </div>
    `;
    document.body.appendChild(badge);
  }

  // Particle container
  if (!document.getElementById('vipParticles')) {
    const pc = document.createElement('div');
    pc.id = 'vipParticles';
    document.body.appendChild(pc);
  }

  // Partículas sutiles — monedas y puntos pequeños, menos frecuentes
  function spawnParticle() {
    const pc = document.getElementById('vipParticles');
    if (!pc) return;
    const emojis = ['·','✦','◆','▪','✧'];
    const p = document.createElement('div');
    p.className = 'vip-particle';
    p.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    p.style.left = Math.random() * 100 + 'vw';
    p.style.bottom = '0px';
    p.style.color = `rgba(${180 + Math.random()*40|0}, ${130 + Math.random()*30|0}, ${30 + Math.random()*20|0}, ${0.3 + Math.random()*0.4})`;
    p.style.setProperty('--tx', (Math.random() * 50 - 25) + 'px');
    p.style.animationDuration = (3 + Math.random() * 2.5) + 's';
    p.style.animationDelay   = Math.random() * 0.8 + 's';
    pc.appendChild(p);
    setTimeout(() => p.remove(), 5500);
  }
  if (!window._vipParticleInterval) {
    window._vipParticleInterval = setInterval(spawnParticle, 900);
  }
  syncVIPThemeButton();
}

function deactivateVIPTheme() {
  vipThemeActive = false;
  document.body.classList.remove('vip-mode');
  document.getElementById('vipCrownLabel')?.remove();
  document.getElementById('vipParticles')?.remove();
  clearInterval(window._vipParticleInterval);
  window._vipParticleInterval = null;
  syncVIPThemeButton();
}

let xp = 0, streakDays = 1, streakGoal = 100, streakEmojiChar = '🔥', streakLastDate = '';
let tasks = [], tasksCompleted = 0;
let calYear, calMonth, selectedWeek = null;
const MONTHS_ES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DAYS_SHORT = ['L','M','M','J','V','S','D'];
const EMOJIS = ['🔥','⚡','🌟','💪','🏆','🎯','🌈','🚀','🦋','🌿'];
const TASK_COLORS = ['var(--teal-light)','var(--green)','var(--pink)','var(--purple)','var(--yellow)'];
const weekData = {};

// ── Registration state ──
let regData = { email:'', pass:'', username:'', displayName:'', avatar:'🧑‍🌾', termsAccepted: false };
const AVATARS = ['🧑‍🌾','🧑‍💻','🧑‍🎨','🧑‍🚀','🦊','🐺','🐉','🦁','🐙','🎭','🤖','👾','🦸','🧙','🧝','🧜'];
let avatarIdx = 0;

// ──────────────────────────
// SPLASH — Mode switching
// ──────────────────────────
let currentMode = 'login'; // 'login' | 'register'
let currentRegStep = 1;

function switchMode(mode) {
  currentMode = mode;
  const pages = document.querySelectorAll('.splash-page');
  pages.forEach(p => p.classList.remove('active','exit-left'));
  
  const tabLogin = document.getElementById('tabLogin');
  const tabRegister = document.getElementById('tabRegister');
  const dots = document.getElementById('splashStepDots');
  const footer = document.getElementById('splashFooterMain');
  const title = document.getElementById('splashTitle');

  if (mode === 'login') {
    tabLogin.classList.add('active');
    tabRegister.classList.remove('active');
    dots.style.display = 'none';
    footer.style.display = 'none';
    title.textContent = 'Bienvenido';
    showSplashPage('pageLogin');
  } else {
    tabLogin.classList.remove('active');
    tabRegister.classList.add('active');
    dots.style.display = 'flex';
    footer.style.display = 'none';
    currentRegStep = 1;
    updateStepDots(1);
    title.textContent = 'Crea tu cuenta';
    showSplashPage('pageReg1');
    buildAvatarGrid();
  }
}

function showSplashPage(pageId) {
  document.querySelectorAll('.splash-page').forEach(p => p.classList.remove('active','exit-left'));
  const target = document.getElementById(pageId);
  if (target) target.classList.add('active');
}

function updateStepDots(step) {
  for (let i = 0; i < 3; i++) {
    const dot = document.getElementById('dot' + i);
    dot.classList.remove('active','done');
    if (i + 1 < step)      dot.classList.add('done');
    else if (i + 1 === step) dot.classList.add('active');
  }
}

// ──────────────────────────
// VALIDATION HELPERS
// ──────────────────────────
function setFieldState(wrapId, state, iconId, iconChar) {
  const wrap = document.getElementById(wrapId);
  wrap.classList.remove('error','success');
  if (state) wrap.classList.add(state);
  if (iconId) {
    const icon = document.getElementById(iconId);
    if (icon) { icon.textContent = iconChar || ''; icon.classList.toggle('show', !!iconChar); }
  }
}
function setHelper(id, msg, type) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.className = 'splash-helper' + (type ? ' ' + type : '');
}
function clearFieldError(wrapId) {
  document.getElementById(wrapId)?.classList.remove('error');
}

function validateEmail() {
  const val = document.getElementById('regEmail').value.trim();
  const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
  if (!val) { setFieldState('regEmailWrap','','regEmailIcon',''); setHelper('regEmailHelper',''); return false; }
  if (ok) { setFieldState('regEmailWrap','success','regEmailIcon','✅'); setHelper('regEmailHelper','Correo válido','ok'); return true; }
  else     { setFieldState('regEmailWrap','error','regEmailIcon','❌'); setHelper('regEmailHelper','Formato de correo inválido','error'); return false; }
}

function checkPasswordStrength() {
  const val = document.getElementById('regPass').value;
  const wrap = document.getElementById('pwStrengthWrap');
  const bar  = document.getElementById('pwBar');
  const lbl  = document.getElementById('pwLabel');
  if (!val) { wrap.classList.remove('visible'); return; }
  wrap.classList.add('visible');
  let score = 0;
  if (val.length >= 6)  score++;
  if (val.length >= 10) score++;
  if (/[A-Z]/.test(val)) score++;
  if (/[0-9]/.test(val)) score++;
  if (/[^A-Za-z0-9]/.test(val)) score++;
  const levels = [
    { w:'20%', bg:'var(--pink)',   txt:'Muy débil 🔴' },
    { w:'40%', bg:'var(--pink)',   txt:'Débil 🟠' },
    { w:'60%', bg:'var(--yellow)', txt:'Moderada 🟡' },
    { w:'80%', bg:'var(--teal)',   txt:'Fuerte 🟢' },
    { w:'100%',bg:'var(--green)',  txt:'Muy fuerte 💪' },
  ];
  const lvl = levels[Math.min(score, 4)];
  bar.style.width = lvl.w; bar.style.background = lvl.bg;
  lbl.textContent = lvl.txt; lbl.style.color = lvl.bg;
}

function validateRegPass() {
  const val = document.getElementById('regPass').value;
  if (val.length < 6) { setFieldState('regPassWrap','error','',''); setHelper('regPassHelper','Mínimo 6 caracteres','error'); return false; }
  setFieldState('regPassWrap','success','',''); setHelper('regPassHelper',''); return true;
}

function validateConfirmPass() {
  const p1 = document.getElementById('regPass').value;
  const p2 = document.getElementById('regPass2').value;
  if (!p2) { setFieldState('regPass2Wrap','','regPass2Icon',''); return false; }
  if (p1 === p2) { setFieldState('regPass2Wrap','success','regPass2Icon','✅'); setHelper('regPassHelper','Las contraseñas coinciden','ok'); return true; }
  else           { setFieldState('regPass2Wrap','error','regPass2Icon','❌'); setHelper('regPassHelper','Las contraseñas no coinciden','error'); return false; }
}

function validateUsername() {
  const val = document.getElementById('regUser').value.trim();
  if (!val) { setFieldState('regUserWrap','','regUserIcon',''); setHelper('regUserHelper',''); return false; }
  if (val.length < 3) { setFieldState('regUserWrap','error','regUserIcon','❌'); setHelper('regUserHelper','Mínimo 3 caracteres','error'); return false; }
  if (/\s/.test(val)) { setFieldState('regUserWrap','error','regUserIcon','❌'); setHelper('regUserHelper','Sin espacios','error'); return false; }
  setFieldState('regUserWrap','success','regUserIcon','✅'); setHelper('regUserHelper','¡Disponible!','ok'); return true;
}

function togglePw(inputId, btn) {
  const inp = document.getElementById(inputId);
  if (inp.type === 'password') { inp.type = 'text'; btn.textContent = '🙈'; }
  else { inp.type = 'password'; btn.textContent = '👁'; }
}

// ──────────────────────────
// REGISTRATION STEPS
// ──────────────────────────
function goRegStep2() {
  const emailOk = validateEmail();
  const passOk  = validateRegPass();
  const confOk  = validateConfirmPass();
  if (!emailOk) { shakeEl('pageReg1'); showToast('Ingresa un email válido'); return; }
  if (!passOk)  { shakeEl('pageReg1'); showToast('Contraseña demasiado corta'); return; }
  if (!confOk)  { shakeEl('pageReg1'); showToast('Las contraseñas no coinciden'); return; }
  regData.email = document.getElementById('regEmail').value.trim();
  regData.pass  = document.getElementById('regPass').value;
  currentRegStep = 2;
  updateStepDots(2);
  document.getElementById('splashTitle').textContent = 'Cuéntanos de ti';
  showSplashPage('pageReg2');
}

function goRegStep3() {
  const usernameOk = validateUsername();
  const name = document.getElementById('regName').value.trim();
  if (!usernameOk) { shakeEl('pageReg2'); showToast('Usuario inválido'); return; }
  if (!name) { setFieldState('regNameWrap','error'); shakeEl('pageReg2'); showToast('Ingresa tu nombre'); return; }
  regData.username    = document.getElementById('regUser').value.trim();
  regData.displayName = name;
  currentRegStep = 3;
  updateStepDots(3);
  document.getElementById('splashTitle').textContent = 'Último paso ✨';
  showSplashPage('pageReg3');
}

function buildAvatarGrid() {
  const grid = document.getElementById('avatarGrid');
  grid.innerHTML = '';
  AVATARS.forEach((a, i) => {
    const btn = document.createElement('div');
    btn.style.cssText = 'width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;background:rgba(255,255,255,.07);border:1.5px solid transparent;transition:all .2s;';
    btn.textContent = a;
    btn.onclick = () => {
      avatarIdx = i;
      document.getElementById('regAvatarDisplay').textContent = a;
      regData.avatar = a;
      grid.querySelectorAll('div').forEach(d => d.style.borderColor = 'transparent');
      btn.style.borderColor = 'var(--teal-light)';
      btn.style.background = 'rgba(58,133,196,.2)';
    };
    if (i === avatarIdx) { btn.style.borderColor = 'var(--teal-light)'; btn.style.background = 'rgba(58,133,196,.2)'; }
    grid.appendChild(btn);
  });
}

function cycleAvatar() {
  avatarIdx = (avatarIdx + 1) % AVATARS.length;
  regData.avatar = AVATARS[avatarIdx];
  document.getElementById('regAvatarDisplay').textContent = regData.avatar;
  const grid = document.getElementById('avatarGrid');
  grid.querySelectorAll('div').forEach((d, i) => {
    d.style.borderColor = i === avatarIdx ? 'var(--teal-light)' : 'transparent';
    d.style.background  = i === avatarIdx ? 'rgba(58,133,196,.2)' : 'rgba(255,255,255,.07)';
  });
}

let termsAccepted = false;
function toggleTerms() {
  termsAccepted = !termsAccepted;
  const box = document.getElementById('termsCheck');
  box.textContent = termsAccepted ? '✓' : '';
  box.style.background = termsAccepted ? 'var(--teal)' : 'transparent';
  box.style.borderColor = termsAccepted ? 'var(--teal)' : 'rgba(255,255,255,.3)';
  setHelper('termsHelper', '');
}

// ──────────────────────────
// PERSISTENT ACCOUNTS
// ──────────────────────────
// Storage keys:
//   accounts:{email}  → { email, passHash, displayName, avatar, xp, coins, streakDays, ... }
//   session:current   → email of logged-in user (personal)

const CURRENT_SESSION_KEY = 'session:current';

// Simple hash (not cryptographic — just for demo persistence)
function simpleHash(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) {
    h = (Math.imul(31, h) + str.charCodeAt(i)) | 0;
  }
  return 'h' + Math.abs(h).toString(36);
}

function accountKey(email) {
  return 'account:' + email.toLowerCase().trim();
}

// Build a save object from current app state
function buildSaveData() {
  const dn = document.getElementById('usernameLabel')?.textContent || regData.displayName;
  return {
    email:            regData.email,
    passHash:         simpleHash(regData.pass || ''),
    displayName:      dn,
    displayNameLower: (dn || '').toLowerCase(),
    avatar:           document.getElementById('profileAvatarHome')?.textContent || regData.avatar,
    xp, coins, streakDays, streakGoal, streakLastDate,
    petName, petTypeIdx, petColorIdx, petHat, petCollar, petWand, petHp,
    equippedBadgeIds,
    ownedBadgeIds:  SHOP_ITEMS.badges.filter(b => b.owned).map(b => b.id),
    ownedThemeIds:  SHOP_ITEMS.temas.filter(t => t.owned).map(t => t.id),
    equippedThemeId: SHOP_ITEMS.temas.find(t => t.equipped)?.id || 't1',
    ownedAvatarIds: SHOP_ITEMS.avatares.filter(a => a.owned).map(a => a.id),
    powerQtys:      Object.fromEntries(SHOP_ITEMS.poderes.map(p => [p.id, p.qty])),
    gymBroUid:      myGymBroUid || null,
    tskData:        typeof tskGetSaveData === 'function' ? tskGetSaveData() : [],
    habitData:      typeof habitGetSaveData === 'function' ? habitGetSaveData() : [],
    savedAt:        Date.now(),
  };
}

// Restore app state from a save object
function restoreSaveData(data) {
  xp          = data.xp          ?? 0;
  coins       = data.coins       ?? 0;
  streakDays  = data.streakDays  ?? 0;
  streakGoal  = data.streakGoal  ?? 100;
  streakLastDate = data.streakLastDate ?? '';
  petName     = data.petName     ?? 'Chispa';
  petTypeIdx  = data.petTypeIdx  ?? 0;
  petColorIdx = data.petColorIdx ?? 0;
  petHat      = data.petHat      ?? null;
  petCollar   = data.petCollar   ?? null;
  petWand     = data.petWand     ?? null;
  petHp       = data.petHp       ?? 60;
  equippedBadgeIds = data.equippedBadgeIds ?? (data.equippedBadgeId ? [data.equippedBadgeId] : []);

  // Restore badge ownership
  if (data.ownedBadgeIds) {
    SHOP_ITEMS.badges.forEach(b => { b.owned = data.ownedBadgeIds.includes(b.id); });
  }
  // Restore theme ownership + equipped
  if (data.ownedThemeIds) {
    SHOP_ITEMS.temas.forEach(t => {
      t.owned    = data.ownedThemeIds.includes(t.id);
      t.equipped = t.id === data.equippedThemeId;
    });
    const themeIdx = SHOP_ITEMS.temas.findIndex(t => t.id === data.equippedThemeId);
    const themeMap = { t1:0, t2:1, t3:2, t4:3, t5:4, t6:6, t7:8, t8:9, t9:10, t10:11, t11:12, t12:13, t13:5, t14:7 };
    const tIdx = themeMap[data.equippedThemeId] ?? 0;
    THEMES.forEach((t, i) => { t.unlocked = i === 0 || (data.ownedThemeIds.includes(Object.keys(themeMap).find(k => themeMap[k] === i))); });
    setTimeout(() => applyTheme(tIdx), 100);
  }
  // Restore avatar ownership
  if (data.ownedAvatarIds) {
    SHOP_ITEMS.avatares.forEach(a => { a.owned = data.ownedAvatarIds.includes(a.id); });
  }
  // Restore power quantities
  if (data.powerQtys) {
    SHOP_ITEMS.poderes.forEach(p => { p.qty = data.powerQtys[p.id] ?? 0; });
  }
  // Restore GymBro
  if (data.gymBroUid) {
    myGymBroUid = data.gymBroUid;
  }
  // Restore task data
  if (data.tskData && typeof tskLoadFromData === 'function') {
    tskLoadFromData(data.tskData);
    renderTasks();
  }
  if (data.habitData && typeof habitLoadFromData === 'function') {
    habitLoadFromData(data.habitData);
  }

  // Update UI
  const name = data.displayName || 'Usuario';
  const avatar = data.avatar || '🧑‍🌾';
  ['usernameLabel','profileName'].forEach(id => {
    const el = document.getElementById(id); if (el) el.textContent = name;
  });
  ['profileAvatarHome','profileAvatarPanel','cfgAvatarEmoji'].forEach(id => {
    const el = document.getElementById(id); if (el) el.textContent = avatar;
  });

  updateXP();
  updateCoinDisplay();
  renderStreakDots();
  renderTasks();
  syncHomePet();
  updateEquippedBadgeDisplay();
  // Check if streak should reset due to missed days
  setTimeout(checkStreakReset, 300);

  // Store current session email in regData for future saves
  regData.email = data.email || '';
  regData.displayName = name;
  regData.avatar = avatar;

  // ── VIP: auto-assign CEO badge ──
  if ((data.email || '').toLowerCase().trim() === 'carretoleonardo2312@gmail.com') {
    const ceoBadge = SHOP_ITEMS.badges.find(b => b.ceo);
    if (ceoBadge) {
      ceoBadge.owned = true;
      ceoBadge.ceo   = true;
      if (!equippedBadgeIds.includes(ceoBadge.id)) equippedBadgeIds = [ceoBadge.id, ...equippedBadgeIds].slice(0,3);
      updateEquippedBadgeDisplay();
      setTimeout(() => showToast('👑 Badge CEO activado'), 800);
    }
    // ── CEO: grant 100,000 coins if not already at that level ──
    if (coins < 100000) {
      coins = 100000;
      updateCoinDisplay();
      setTimeout(() => showToast('🪙 ¡100,000 monedas CEO desbloqueadas!'), 1200);
    }
    setTimeout(() => { activateVIPTheme(); showVIPThemeSection(); }, 300);
  } else {
    deactivateVIPTheme();
    const sec = document.getElementById('vipThemeSection');
    if (sec) sec.style.display = 'none';
  }
}

// Save current user data to Firestore
async function saveAccount() {
  try {
    const user = window._fbAuth?.currentUser;
    if (!user) return;
    const data = buildSaveData();
    await window._fbDb.collection('users').doc(user.uid).set(
      { ...data, savedAt: firebase.firestore.FieldValue.serverTimestamp() },
      { merge: true }
    );
    const now = new Date();
    const timeStr = now.toLocaleTimeString('es-MX', { hour:'2-digit', minute:'2-digit' });
    const lbl = document.getElementById('lastSavedLabel');
    if (lbl) lbl.textContent = 'Guardado a las ' + timeStr;
    const emailLbl = document.getElementById('loggedEmailLabel');
    if (emailLbl) emailLbl.textContent = data.email || '—';
  } catch(e) { console.warn('Save failed:', e); }
}

function confirmLogout() {
  // Simple confirm via toast+timeout pattern
  showToast('Toca de nuevo para cerrar sesión 🚪');
  const btn = document.querySelector('[onclick="confirmLogout()"]');
  if (btn) {
    btn.onclick = () => { logoutUser(); btn.onclick = () => confirmLogout(); };
    setTimeout(() => { btn.onclick = () => confirmLogout(); }, 3000);
  }
}

// Auto-save every 30 seconds (only if logged in via Firebase)
setInterval(() => {
  if (window._fbAuth?.currentUser && regData.email) saveAccount();
}, 30000);

// Auto-login is handled by Firebase onAuthStateChanged above
async function tryAutoLogin() {
  // Wait briefly to let Firebase restore session
  return new Promise(resolve => {
    const unsubscribe = window._fbAuth?.onAuthStateChanged
      ? window._fbAuth.onAuthStateChanged(user => {
          unsubscribe?.();
          resolve(!!user);
        })
      : (() => { resolve(false); return () => {}; })();
    setTimeout(() => resolve(false), 3000); // timeout fallback
  });
}

async function createAccount() {
  if (!termsAccepted) {
    setHelper('termsHelper', 'Debes aceptar los términos', 'error');
    shakeEl('pageReg3');
    return;
  }
  regData.avatar = document.getElementById('regAvatarDisplay').textContent;

  try {
    const auth = window._fbAuth;
    const db   = window._fbDb;

    const cred = await auth.createUserWithEmailAndPassword(regData.email, regData.pass);
    const user = cred.user;
    window._fbCurrentUser = user;

    const initData = {
      email: regData.email,
      displayName: regData.displayName,
      displayNameLower: (regData.displayName || '').toLowerCase(),
      avatar: regData.avatar,
      xp: 0, coins: 0, streakDays: 1, streakGoal: 100,
      petName: 'Chispa', petTypeIdx: 0, petColorIdx: 0,
      petHat: null, petCollar: null, petWand: null, petHp: 60,
      equippedBadgeIds: [],
      ownedBadgeIds: [], ownedThemeIds: ['t1'], equippedThemeId: 't1',
      ownedAvatarIds: [], powerQtys: {},
      savedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection('users').doc(user.uid).set(initData);

    // Show success screen
    document.getElementById('successAvatar').textContent = regData.avatar;
    document.getElementById('successName').textContent   = '¡Hola, ' + regData.displayName + '!';
    document.getElementById('splashStepDots').style.display = 'none';
    document.getElementById('splashTitle').textContent   = '¡Cuenta creada! 🎉';
    showSplashPage('pageRegSuccess');

    // Pre-fill app data
    ['usernameLabel','profileName'].forEach(id => {
      const el = document.getElementById(id); if(el) el.textContent = regData.displayName;
    });
    ['profileAvatarHome','profileAvatarPanel','cfgAvatarEmoji'].forEach(id => {
      const el = document.getElementById(id); if(el) el.textContent = regData.avatar;
    });

    launchConfetti(window.innerWidth/2, window.innerHeight/2);
    showToast('¡Bienvenido, ' + regData.displayName + '! 🎉');

    // ── VIP: auto-assign CEO badge on register ──
    if (regData.email.toLowerCase().trim() === 'carretoleonardo2312@gmail.com') {
      const ceoBadge = SHOP_ITEMS.badges.find(b => b.ceo);
      if (ceoBadge) {
        ceoBadge.owned = true;
        if (!equippedBadgeIds.includes(ceoBadge.id)) equippedBadgeIds = [ceoBadge.id, ...equippedBadgeIds].slice(0,3);
        updateEquippedBadgeDisplay();
        setTimeout(() => showToast('👑 Badge CEO desbloqueado — eres VIP!'), 1500);
      }
      coins = 100000;
      updateCoinDisplay();
      setTimeout(() => showToast('🪙 ¡100,000 monedas CEO!'), 2000);
      setTimeout(() => { activateVIPTheme(); showVIPThemeSection(); }, 500);
    }
  } catch(e) {
    let msg = 'Error al crear cuenta';
    if (e.code === 'auth/email-already-in-use') msg = 'Este correo ya está registrado';
    if (e.code === 'auth/invalid-email')        msg = 'Correo inválido';
    if (e.code === 'auth/weak-password')        msg = 'Contraseña muy débil';
    setHelper('termsHelper', msg, 'error');
    shakeEl('pageReg3');
    showToast('❌ ' + msg);
  }
}

// ──────────────────────────
// LOGIN
// ──────────────────────────
async function doSplashLogin() {
  const email = document.getElementById('splashUser').value.trim();
  const pass  = document.getElementById('splashPass').value;

  if (!email) { setFieldState('loginUserWrap','error','loginUserIcon','❌'); setHelper('loginHelper','Ingresa tu email','error'); shakeEl('pageLogin'); return; }
  if (!pass)  { setFieldState('loginPassWrap','error'); setHelper('loginHelper','Ingresa tu contraseña','error'); shakeEl('pageLogin'); return; }

  setHelper('loginHelper', 'Verificando...', 'ok');

  try {
    const auth = window._fbAuth;
    const db   = window._fbDb;

    const cred   = await auth.signInWithEmailAndPassword(email, pass);
    const fbUser = cred.user;
    window._fbCurrentUser = fbUser;

    const snap = await db.collection('users').doc(fbUser.uid).get();
    if (snap.exists) {
      regData.email = fbUser.email;
      regData.pass  = pass;
      restoreSaveData(snap.data());
    }

    setHelper('loginHelper', '¡Bienvenido de vuelta! ✓', 'ok');
    showToast('¡Hola de nuevo! 👋');
    setTimeout(() => enterAppFromSplash(), 900);
  } catch(e) {
    let msg = 'Error al iniciar sesión';
    if (e.code === 'auth/user-not-found' || e.code === 'auth/invalid-credential') msg = 'Cuenta no encontrada o contraseña incorrecta';
    if (e.code === 'auth/wrong-password')   msg = 'Contraseña incorrecta';
    if (e.code === 'auth/invalid-email')    msg = 'Email inválido';
    if (e.code === 'auth/too-many-requests') msg = 'Demasiados intentos. Intenta más tarde';
    setFieldState('loginPassWrap','error');
    setHelper('loginHelper', msg, 'error');
    shakeEl('pageLogin');
  }
}

function doGoogleSignIn() {
  showToast('Google Sign-In próximamente 🚀');
}

function showForgotPassword() {
  document.getElementById('splashTitle').textContent = 'Recuperar contraseña';
  showSplashPage('pageForgot');
}
async function sendForgotPassword() {
  const email = document.getElementById('forgotEmail').value.trim();
  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    setFieldState('forgotEmailWrap','error'); setHelper('forgotHelper','Email inválido','error'); return;
  }
  try {
    await window._fbFns.sendPasswordResetEmail(window._fbAuth, email);
    setHelper('forgotHelper','¡Instrucciones enviadas! Revisa tu correo 📧','ok');
    showToast('Email de recuperación enviado ✓');
    setTimeout(() => switchMode('login'), 2000);
  } catch(e) {
    setHelper('forgotHelper','No se encontró esa cuenta','error');
  }
}

function shakeEl(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.animation = 'none';
  el.offsetHeight;
  if (!document.getElementById('splash-shake-style')) {
    const s = document.createElement('style'); s.id = 'splash-shake-style';
    s.textContent = '@keyframes splashShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}}';
    document.head.appendChild(s);
  }
  el.style.animation = 'splashShake .4s ease';
}

function enterAppFromSplash() {
  const splash = document.getElementById('splash-screen');
  splash.classList.add('hiding');
  setTimeout(() => {
    splash.classList.add('hidden');
    launchConfetti(window.innerWidth/2, window.innerHeight/2);
    // Save session after entering app
    if (regData.email) saveAccount();
  }, 650);
}

// Add logout function
async function logoutUser() {
  if (regData.email) await saveAccount();
  try {
    await window._fbFns.signOut(window._fbAuth);
  } catch(e) {}
  regData = { email:'', pass:'', username:'', displayName:'', avatar:'🧑‍🌾', termsAccepted: false };
  window._fbCurrentUser = null;
  // Reload splash
  const splash = document.getElementById('splash-screen');
  splash.classList.remove('hiding','hidden');
  switchMode('login');
  showToast('Sesión cerrada ✓');
}

// ──────────────────────────
// CALENDAR
// ──────────────────────────
function weekKey(y,m,w){ return `${y}-${m}-${w}`; }
function getOrCreateWeekData(y, m, w) {
  const k = weekKey(y,m,w);
  if (!weekData[k]) {
    const seed = y*10000+m*100+w;
    const rng = n => { let x=Math.sin(seed+n)*10000; return Math.floor((x-Math.floor(x))*7); };
    weekData[k] = { tasks:DAYS_SHORT.map((_,i)=>rng(i)), habits:DAYS_SHORT.map((_,i)=>rng(i+10)) };
  }
  return weekData[k];
}
function initCalendar(){ const now=new Date(); calYear=now.getFullYear(); calMonth=now.getMonth(); renderCalendar(); }
function changeMonth(dir){ calMonth+=dir; if(calMonth>11){calMonth=0;calYear++;} if(calMonth<0){calMonth=11;calYear--;} selectedWeek=null; renderCalendar(); }
function renderCalendar(){
  const grid=document.getElementById('calGrid'); grid.innerHTML='';
  document.getElementById('calMonthLabel').textContent=`${MONTHS_ES[calMonth]} ${calYear}`;
  ['Lu','Ma','Mi','Ju','Vi','Sa','Do'].forEach(d=>{const h=document.createElement('div');h.className='cal-header';h.textContent=d;grid.appendChild(h);});
  const dim=new Date(calYear,calMonth+1,0).getDate(), now=new Date();
  const todayD=now.getDate(),todayM=now.getMonth(),todayY=now.getFullYear();
  const rawFirst=new Date(calYear,calMonth,1).getDay();
  const offset=(rawFirst===0)?6:rawFirst-1;
  let weekIdx=0; const dayWeekMap={};
  for(let i=0;i<offset;i++){const e=document.createElement('div');e.className='cal-day empty';grid.appendChild(e);}
  for(let d=1;d<=dim;d++){
    const col=(offset+d-1)%7;
    if(col===0&&d>1) weekIdx++;
    dayWeekMap[d]=weekIdx;
    const el=document.createElement('div');
    const isToday=d===todayD&&calMonth===todayM&&calYear===todayY;
    let cls='cal-day';
    if(isToday) cls+=' today';
    if(selectedWeek!==null&&dayWeekMap[d]===selectedWeek) cls+=' in-selected-week';
    el.className=cls; el.textContent=d; el.dataset.week=weekIdx;
    el.onclick=()=>{const w=parseInt(el.dataset.week);selectedWeek=(selectedWeek===w)?null:w;renderCalendar();updateChart();showToast(selectedWeek!==null?`Semana ${selectedWeek+1} seleccionada`:'Semana deseleccionada');};
    grid.appendChild(el);
  }
  if(selectedWeek===null&&calMonth===now.getMonth()&&calYear===now.getFullYear()){selectedWeek=dayWeekMap[now.getDate()]??0;renderCalendar();return;}
  updateChart();
}
function updateChart(){
  const container=document.getElementById('chartBars'); container.innerHTML='';
  const wIdx=selectedWeek!==null?selectedWeek:0;
  const data=getOrCreateWeekData(calYear,calMonth,wIdx);
  const td=data.tasks,hd=data.habits;
  const maxVal=Math.max(...td,...hd,1);
  const total=td.reduce((a,b)=>a+b,0)+hd.reduce((a,b)=>a+b,0);
  document.getElementById('chartWeekLabel').textContent=`Sem ${wIdx+1}`;
  document.getElementById('chartTotalNum').textContent=total;
  // Use CSS vars for bar colors so they update with theme
  const green=getComputedStyle(document.documentElement).getPropertyValue('--green').trim()||'#5edc8a';
  const purple=getComputedStyle(document.documentElement).getPropertyValue('--purple').trim()||'#8b62e0';
  const teal=getComputedStyle(document.documentElement).getPropertyValue('--teal').trim()||'#2a6496';
  DAYS_SHORT.forEach((day,i)=>{
    const wrap=document.createElement('div'); wrap.className='chart-bar-wrap';
    const inner=document.createElement('div'); inner.style.cssText='display:flex;align-items:flex-end;gap:2px;height:68px;';
    const b1=document.createElement('div'); b1.className='chart-bar';
    b1.style.cssText=`background:linear-gradient(to top,${green}cc,${teal}88);height:${Math.max((td[i]/maxVal)*62,td[i]>0?4:0)}px;flex:1;box-shadow:${td[i]>0?'0 0 6px '+green+'66':''};`;
    const b2=document.createElement('div'); b2.className='chart-bar';
    b2.style.cssText=`background:linear-gradient(to top,${purple}cc,${purple}55);height:${Math.max((hd[i]/maxVal)*62,hd[i]>0?4:0)}px;flex:1;box-shadow:${hd[i]>0?'0 0 6px '+purple+'66':''};`;
    inner.appendChild(b1); inner.appendChild(b2);
    const label=document.createElement('div'); label.className='chart-bar-label'; label.textContent=day;
    wrap.appendChild(inner); wrap.appendChild(label); container.appendChild(wrap);
  });
}

// ──────────────────────────
// STREAK
// ──────────────────────────
function renderStreakDots(){
  const c=document.getElementById('streakDots'); c.innerHTML='';
  for(let i=0;i<Math.min(streakGoal,14);i++){const d=document.createElement('div');d.className='streak-dot';if(i<streakDays-1)d.classList.add('done');else if(i===streakDays-1)d.classList.add('today-dot');c.appendChild(d);}
  
  const isLegendary = streakDays >= 30;
  const streakSection = document.querySelector('.streak-section');
  const badge = document.getElementById('legendaryBadge');
  
  if (isLegendary) {
    streakSection.classList.add('legendary');
    document.getElementById('streakEmoji').textContent = '🔮';
    if (badge) badge.classList.add('show');
  } else {
    streakSection.classList.remove('legendary');
    document.getElementById('streakEmoji').textContent = streakEmojiChar;
    if (badge) badge.classList.remove('show');
  }

  document.getElementById('streakCount').textContent=streakDays;
  document.getElementById('streakGoalLabel').textContent=`Meta: ${streakGoal} días`;
  // Sync pet happiness with streak
  updatePetFromStreak();
}
function buildStreakPanel(){
  const isLegendary = streakDays >= 30;
  const panelEmoji = isLegendary ? '🔮' : streakEmojiChar;
  
  document.getElementById('panelStreakEmoji').textContent = panelEmoji;
  document.getElementById('panelStreakNum').textContent = streakDays;
  document.getElementById('streakGoalInput').value = streakGoal;

  // Legendary num color
  const numEl = document.getElementById('panelStreakNum');
  if (isLegendary) numEl.classList.add('legendary');
  else             numEl.classList.remove('legendary');

  // Legendary badge in panel
  const pBadge = document.getElementById('panelLegendaryBadge');
  if (pBadge) { if (isLegendary) pBadge.classList.add('show'); else pBadge.classList.remove('show'); }

  const wr=document.getElementById('streakWeekRow'); wr.innerHTML='';
  DAYS_SHORT.forEach((day,i)=>{
    const box=document.createElement('div');
    box.className='streak-day-box'+(i<streakDays?' active':'')+(isLegendary?' legendary-box':'');
    const emoji = isLegendary ? '🔮' : streakEmojiChar;
    box.innerHTML=`<div class="sdb-emoji">${i<streakDays?emoji:'⬜'}</div><div class="sdb-day">${day}</div><div class="sdb-done">${i<streakDays?'✓':''}</div>`;
    // No manual editing — streak is earned automatically
    wr.appendChild(box);
  });
  // (emoji picker removed)
}
function saveStreakSettings(){ saveStreakGoalOnly(); }
function saveStreakGoalOnly(){ const val=parseInt(document.getElementById('streakGoalInput').value)||7; streakGoal=Math.max(1,Math.min(val,365)); renderStreakDots(); showToast('Meta guardada ✓'); if(regData.email) saveAccount(); }

// ──────────────────────────
// TASKS
// ──────────────────────────
function toggleTaskInput(){ const row=document.getElementById('taskInputRow'); row.classList.toggle('open'); if(row.classList.contains('open'))document.getElementById('taskField').focus(); }
function addTask(){
  const input=document.getElementById('taskField'), name=input.value.trim();
  if(!name) return;
  // Add as 'once' task via new system
  tskAddTask({ name, type:'once', emoji:'📋', days:[] });
  input.value='';
  document.getElementById('taskInputRow').classList.remove('open');
  showToast('Tarea añadida ✓');
}
function renderTasks(){
  // Render home quick-tasks list
  const list=document.getElementById('tasksList'), empty=document.getElementById('tasksEmpty');
  list.innerHTML='';
  const todayTasks = tskGetTodayTasks();
  if(todayTasks.length===0){list.appendChild(empty);return;}

  // Group by type for home view
  const daily  = todayTasks.filter(t=>t.type==='daily');
  const weekly = todayTasks.filter(t=>t.type==='weekly');
  const once   = todayTasks.filter(t=>t.type==='once');

  const renderGroup = (group, label) => {
    if(group.length === 0) return;
    const sec = document.createElement('div'); sec.className='home-tsk-section'; sec.textContent=label; list.appendChild(sec);
    group.forEach(t => {
      const item=document.createElement('div');
      item.className='task-item'+(t.doneToday?' done-task':'');
      item.style.borderLeftColor=t.type==='daily'?'var(--teal-light)':t.type==='weekly'?'var(--purple)':'var(--green)';
      item.innerHTML=`<div class="task-check">${t.doneToday?'✓':''}</div><div class="task-name">${t.emoji} ${t.name}</div><div class="task-del" onclick="tskToggleHome(${t.id},event)">○</div>`;
      item.onclick=()=>tskToggleHome(t.id);
      list.appendChild(item);
    });
  };
  renderGroup(daily, '📅 Diarias');
  renderGroup(weekly, '📆 Semanales');
  renderGroup(once, '✅ Únicas');
}
function toggleTask(id){
  // legacy compat
  tskToggleHome(id);
}
function deleteTask(id,e){ e.stopPropagation(); tskDeleteTask(id); }

// ══════════════════════════════════════════════
// TASK MANAGEMENT SYSTEM — Full Implementation
// ══════════════════════════════════════════════

// Task data structure:
// { id, name, type:'once'|'daily'|'weekly', emoji, days:[0-6 for weekly], doneToday:bool, doneDates:[], streak:0, createdAt }

let tskData = []; // all tasks for current user
let tskActiveTab = 'daily';
let tskEditId = null; // null = new, number = editing
let tskModalType = 'once';
let tskModalDays = [];
let tskModalEmoji = '📋';

const TSK_DAYS_SHORT = ['Lu','Ma','Mi','Ju','Vi','Sá','Do'];

// ── Today helpers ──
function tskTodayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function tskTodayDow() {
  const d = new Date().getDay(); return d === 0 ? 6 : d - 1; // Mon=0..Sun=6
}

// Check if a task is relevant today
function tskIsToday(task) {
  if (task.type === 'once') return true;
  if (task.type === 'daily') return true;
  if (task.type === 'weekly') return task.days.includes(tskTodayDow());
  return false;
}

// Check if task is done today
function tskIsDoneToday(task) {
  return (task.doneDates || []).includes(tskTodayKey());
}

// Get today's relevant tasks
function tskGetTodayTasks() {
  return tskData.filter(t => tskIsToday(t)).map(t => ({
    ...t, doneToday: tskIsDoneToday(t)
  }));
}

// ── CRUD ──
function tskAddTask({ name, type, emoji, days }) {
  const task = {
    id: Date.now(),
    name, type, emoji,
    days: type === 'weekly' ? days : [],
    doneDates: [],
    streak: 0,
    createdAt: Date.now(),
  };
  tskData.push(task);
  tskSaveAndRender();
  if (type === 'daily' || (type === 'weekly' && days.includes(tskTodayDow())) || type === 'once') {
    if (selectedWeek !== null) {
      const data = getOrCreateWeekData(calYear, calMonth, selectedWeek);
      const col = tskTodayDow();
      data.tasks[col] = Math.min(data.tasks[col] + 1, 9);
      updateChart();
    }
  }
}

function tskDeleteTask(id) {
  tskData = tskData.filter(t => t.id !== id);
  tskSaveAndRender();
}

function tskToggleTask(id) {
  const t = tskData.find(t => t.id === id);
  if (!t) return;
  const today = tskTodayKey();
  const wasDone = (t.doneDates || []).includes(today);
  if (wasDone) {
    t.doneDates = t.doneDates.filter(d => d !== today);
    if (t.streak > 0) t.streak--;
  } else {
    t.doneDates = [...(t.doneDates || []), today];
    t.streak = (t.streak || 0) + 1;
    tasksCompleted++;
    xp += 5; coins += 2;
    updateXP(); updateCoinDisplay();
    showToast(`+5 XP · +2🪙 ✅ ${t.name}`);
    // Confetti
    setTimeout(() => launchConfetti(window.innerWidth/2, window.innerHeight/3), 50);
    if (regData.email) saveAccount();
    // Update chart
    if (selectedWeek !== null) {
      const data = getOrCreateWeekData(calYear, calMonth, selectedWeek);
      data.tasks[tskTodayDow()] = Math.min(data.tasks[tskTodayDow()] + 1, 9);
      updateChart();
    }
  }
  tskSaveAndRender();
  document.getElementById('tasksCompletedStat').textContent = tasksCompleted + ' esta semana';
  // ── Auto streak: check if ALL today's tasks are now done ──
  checkAutoStreak();
  // ── Save daily progress snapshot ──
  if (typeof triggerDailyProgressSave === 'function') triggerDailyProgressSave();
}

// ── Automatic streak logic ──
// streakLastDate: the last date all tasks were completed (saved in account)
function checkAutoStreak() {
  const today = tskTodayKey();
  const todayTasks = tskData.filter(t => tskIsToday(t));
  if (todayTasks.length === 0) return; // no tasks = no streak change

  const allDone = todayTasks.every(t => (t.doneDates || []).includes(today));

  if (allDone) {
    // Check if we already counted today
    if (streakLastDate === today) return; // already awarded today

    // Check if yesterday was also completed (consecutive)
    const yesterday = tskDateOffset(-1);
    if (streakLastDate === yesterday || streakDays === 0) {
      streakDays++;
    } else if (streakLastDate !== today) {
      // Missed day(s) — reset
      streakDays = 1;
    }
    streakLastDate = today;
    renderStreakDots();
    buildStreakPanel();
    showToast(`🔥 ¡Racha: ${streakDays} días! Todas las tareas completadas`);
    setTimeout(() => launchConfetti(window.innerWidth/2, window.innerHeight/4), 100);
    if (regData.email) saveAccount();
  }
}

function tskDateOffset(offset) {
  const d = new Date();
  d.setDate(d.getDate() + offset);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// Called on app load: check if streak should reset due to missed day
function checkStreakReset() {
  if (!streakLastDate || streakDays === 0) return;
  const yesterday = tskDateOffset(-1);
  const today = tskTodayKey();
  if (streakLastDate !== today && streakLastDate !== yesterday) {
    // Missed at least one day → reset
    streakDays = 0;
    renderStreakDots();
    if (regData.email) saveAccount();
  }
}

function tskToggleHome(id, e) {
  e?.stopPropagation?.();
  tskToggleTask(id);
}

// ── Render panel ──
function tskRenderPanel() {
  const list = document.getElementById('tskList');
  const empty = document.getElementById('tskEmpty');
  if (!list) return;
  list.innerHTML = '';

  let items;
  const today = tskTodayKey();
  const todayDow = tskTodayDow();

  if (tskActiveTab === 'daily') {
    items = tskData.filter(t => t.type === 'daily');
  } else if (tskActiveTab === 'weekly') {
    items = tskData.filter(t => t.type === 'weekly');
  } else {
    items = tskData.filter(t => t.type === 'once');
  }

  // Progress bar
  const todayItems = items.filter(t => tskIsToday(t));
  const doneItems = todayItems.filter(t => tskIsDoneToday(t));
  const prog = document.getElementById('tskProgressBar');
  const progLbl = document.getElementById('tskProgressLabel');
  if (prog) {
    const pct = todayItems.length > 0 ? Math.round((doneItems.length / todayItems.length) * 100) : 0;
    prog.style.width = pct + '%';
  }
  if (progLbl) {
    if (tskActiveTab === 'daily') progLbl.textContent = `${doneItems.length} / ${todayItems.length} completadas hoy`;
    else if (tskActiveTab === 'weekly') progLbl.textContent = `${doneItems.length} / ${todayItems.length} completadas hoy (esta semana)`;
    else progLbl.textContent = `${items.filter(t => tskIsDoneToday(t)).length} / ${items.length} completadas`;
  }

  if (items.length === 0) {
    empty.style.display = 'flex';
    return;
  }
  empty.style.display = 'none';

  // For weekly, group by whether active today
  if (tskActiveTab === 'weekly') {
    const todayGroup = items.filter(t => t.days.includes(todayDow));
    const otherGroup = items.filter(t => !t.days.includes(todayDow));
    if (todayGroup.length > 0) {
      list.appendChild(tskMakeSectionLabel('Hoy'));
      todayGroup.forEach(t => list.appendChild(tskMakeRow(t, today)));
    }
    if (otherGroup.length > 0) {
      list.appendChild(tskMakeSectionLabel('Otros días'));
      otherGroup.forEach(t => list.appendChild(tskMakeRow(t, today)));
    }
  } else {
    items.forEach(t => list.appendChild(tskMakeRow(t, today)));
  }
}

function tskMakeSectionLabel(text) {
  const el = document.createElement('div');
  el.className = 'tsk-section-label';
  el.textContent = text;
  return el;
}

function tskMakeRow(task, today) {
  const isDone = (task.doneDates || []).includes(today);
  const isToday = tskIsToday(task);
  const row = document.createElement('div');
  row.className = 'tsk-item' + (isDone ? ' tsk-done' : '');

  // Color accent based on type
  const accentColor = task.type==='daily' ? 'var(--teal-light)' : task.type==='weekly' ? 'var(--purple)' : 'var(--green)';
  row.style.setProperty('--tsk-accent', accentColor);
  row.querySelector?.('.tsk-item')?.style?.setProperty('--tsk-accent', accentColor);

  // Days string for weekly
  let daysStr = '';
  if (task.type === 'weekly' && task.days?.length) {
    daysStr = task.days.map(d => TSK_DAYS_SHORT[d]).join(' · ');
  }
  const badgeClass = `tsk-badge-${task.type}`;
  const badgeLabel = task.type === 'daily' ? 'Diaria' : task.type === 'weekly' ? 'Semanal' : 'Única';
  const streakHtml = task.streak > 1 ? `<span class="tsk-streak-badge">🔥 ${task.streak}</span>` : '';

  row.innerHTML = `
    <div class="tsk-item-check" style="border-color:${isDone ? accentColor : 'rgba(255,255,255,.2)'};">${isDone ? '✓' : ''}</div>
    <div class="tsk-item-emoji">${task.emoji}</div>
    <div class="tsk-item-body">
      <div class="tsk-item-name">${typeof escapeHtml === 'function' ? escapeHtml(task.name) : task.name}</div>
      <div class="tsk-item-meta">
        <span class="tsk-item-badge ${badgeClass}">${badgeLabel}</span>
        ${daysStr ? `<span class="tsk-item-days">${daysStr}</span>` : ''}
        ${streakHtml}
      </div>
    </div>
    <div class="tsk-item-del" onclick="tskDeleteTask(${task.id}); event.stopPropagation();">✕</div>`;

  // Accent line via pseudo
  row.style.cssText += `; border-left: 3px solid ${accentColor};`;
  row.onclick = () => { if (isToday) tskToggleTask(task.id); else showToast('Esta tarea no es para hoy'); };
  return row;
}

function tskSwitchTab(tab, el) {
  tskActiveTab = tab;
  document.querySelectorAll('.tsk-tab').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  tskRenderPanel();
}

// ── Modal ──
function openAddTaskModal(editId = null) {
  tskEditId = editId;
  tskModalType = 'once';
  tskModalDays = [];
  tskModalEmoji = '📋';

  if (editId) {
    const t = tskData.find(t => t.id === editId);
    if (t) {
      tskModalType = t.type;
      tskModalDays = [...(t.days || [])];
      tskModalEmoji = t.emoji;
      document.getElementById('tskModalName').value = t.name;
      document.getElementById('tskModalTitle').textContent = 'Editar Tarea';
      document.getElementById('tskModalOkBtn').textContent = 'Guardar';
    }
  } else {
    document.getElementById('tskModalName').value = '';
    document.getElementById('tskModalTitle').textContent = 'Nueva Tarea';
    document.getElementById('tskModalOkBtn').textContent = 'Agregar';
    // Pre-select tab type
    if (tskActiveTab !== 'daily' && tskActiveTab !== 'weekly') tskModalType = 'once';
    else tskModalType = tskActiveTab;
  }

  // Reset UI
  document.querySelectorAll('.tsk-type-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`tskType${tskModalType.charAt(0).toUpperCase()+tskModalType.slice(1)}`)?.classList.add('active');
  document.getElementById('tskDaysWrap').style.display = tskModalType === 'weekly' ? 'flex' : 'none';

  // Days buttons
  document.querySelectorAll('.tsk-day-btn').forEach(b => {
    b.classList.toggle('active', tskModalDays.includes(parseInt(b.dataset.day)));
    b.onclick = () => {
      const d = parseInt(b.dataset.day);
      if (tskModalDays.includes(d)) { tskModalDays = tskModalDays.filter(x => x !== d); b.classList.remove('active'); }
      else { tskModalDays.push(d); b.classList.add('active'); }
    };
  });

  // Emoji
  document.querySelectorAll('.tsk-emoji-opt').forEach(b => {
    b.classList.toggle('active', b.dataset.emoji === tskModalEmoji);
    b.onclick = () => {
      tskModalEmoji = b.dataset.emoji;
      document.querySelectorAll('.tsk-emoji-opt').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
    };
  });

  document.getElementById('tskModalOverlay').classList.add('open');
  document.getElementById('tskModal').classList.add('open');
  setTimeout(() => document.getElementById('tskModalName').focus(), 200);
}

function openAddTaskModalFromHome() {
  openAddTaskModal();
}

function closeAddTaskModal() {
  document.getElementById('tskModalOverlay').classList.remove('open');
  document.getElementById('tskModal').classList.remove('open');
  tskEditId = null;
}

function tskSelectType(type, el) {
  tskModalType = type;
  document.querySelectorAll('.tsk-type-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tskDaysWrap').style.display = type === 'weekly' ? 'flex' : 'none';
}

function tskModalConfirm() {
  const name = document.getElementById('tskModalName').value.trim();
  if (!name) { document.getElementById('tskModalName').style.borderColor = 'var(--pink)'; return; }
  document.getElementById('tskModalName').style.borderColor = '';
  if (tskModalType === 'weekly' && tskModalDays.length === 0) {
    showToast('Selecciona al menos un día 📅'); return;
  }
  if (tskEditId) {
    const t = tskData.find(t => t.id === tskEditId);
    if (t) { t.name = name; t.type = tskModalType; t.emoji = tskModalEmoji; t.days = tskModalDays; }
  } else {
    tskAddTask({ name, type: tskModalType, emoji: tskModalEmoji, days: tskModalDays });
    showToast(`${tskModalEmoji} Tarea creada ✓`);
  }
  closeAddTaskModal();
  tskSaveAndRender();
}

// ── Save / Load ──
function tskSaveAndRender() {
  tskRenderPanel();
  renderTasks(); // refresh home list
  if (regData.email) saveAccount();
}

function tskGetSaveData() {
  return tskData.map(t => ({
    id: t.id, name: t.name, type: t.type, emoji: t.emoji,
    days: t.days, doneDates: t.doneDates, streak: t.streak, createdAt: t.createdAt,
  }));
}

function tskLoadFromData(arr) {
  if (!Array.isArray(arr)) return;
  tskData = arr.map(t => ({
    id: t.id || Date.now(), name: t.name || '', type: t.type || 'once',
    emoji: t.emoji || '📋', days: t.days || [], doneDates: t.doneDates || [],
    streak: t.streak || 0, createdAt: t.createdAt || Date.now(),
  }));
}

// ── Open panel hook ──
const _origOpenPanelTsk = window.openPanel;
window.openPanel = function(name) {
  _origOpenPanelTsk(name);
  if (name === 'tareas') {
    tskActiveTab = 'daily';
    document.querySelectorAll('.tsk-tab').forEach(b => b.classList.remove('active'));
    document.getElementById('tskTabDaily')?.classList.add('active');
    setTimeout(tskRenderPanel, 60);
  }
};
// ══ TASK SYSTEM END ══

// ══════════════════════════════════════════════
// NOTAS SYSTEM
// ══════════════════════════════════════════════

const DISCIPLINE_QUOTES = [
  "La disciplina es elegir entre lo que quieres ahora y lo que más quieres.",
  "El dolor de la disciplina pesa onzas. El dolor del arrepentimiento pesa toneladas.",
  "No te detengas cuando estés cansado. Detente cuando hayas terminado.",
  "La motivación te pone en marcha. La disciplina te mantiene en movimiento.",
  "Cada repetición es un voto a favor de la persona que quieres ser.",
  "El éxito no es accidental. Es trabajo duro, perseverancia y disciplina.",
  "La fuerza no viene del cuerpo. Viene de una voluntad indomable.",
  "Entrena como si nunca hubieras ganado. Actúa como si nunca hubieras perdido.",
  "Un día o el día uno. Tú decides.",
  "La constancia supera al talento cuando el talento no es constante.",
  "El cuerpo logra lo que la mente cree.",
  "No busques el día en que te sientas motivado. Sé disciplinado aunque no lo estés.",
  "Los campeones no se hacen en el gimnasio. Se hacen con lo que tienen dentro.",
  "Pequeños progresos cada día dan grandes resultados.",
  "La disciplina es el puente entre metas y logros.",
];

let notasRoutineData = []; // [{ id, exercise, weight, series, date }]
let notasGeneralText = '';
let notasActiveTab = 'rutina';
let notasAutoSaveTimer = null;

function notasGetQuote() {
  const today = new Date();
  const idx = (today.getDate() + today.getMonth() * 31) % DISCIPLINE_QUOTES.length;
  return DISCIPLINE_QUOTES[idx];
}

function notasSwitchTab(tab, el) {
  notasActiveTab = tab;
  document.querySelectorAll('.notas-tab').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('notasTabRutinaContent').style.display  = tab === 'rutina'  ? 'block' : 'none';
  document.getElementById('notasTabGeneralContent').style.display = tab === 'general' ? 'block' : 'none';
}

function notasAddRoutineEntry() {
  const exSel = document.getElementById('notasExSelect');
  const customEx = document.getElementById('notasCustomEx');
  let exercise = exSel.value === '_custom' ? customEx.value.trim() : exSel.value;
  const weightRaw = document.getElementById('notasWeight').value.trim();
  const series = document.getElementById('notasSeries').value.trim();

  if (!exercise) { showToast('Selecciona un ejercicio'); return; }
  if (!weightRaw && !series) { showToast('Ingresa el peso o series'); return; }

  const entry = {
    id: Date.now(),
    exercise,
    weight: weightRaw ? parseFloat(weightRaw) : null,
    series: series || '',
    date: new Date().toLocaleDateString('es-MX', { day:'numeric', month:'short' }),
    ts: Date.now(),
  };
  notasRoutineData.unshift(entry);

  // Reset inputs
  exSel.value = '';
  customEx.value = ''; customEx.style.display = 'none';
  document.getElementById('notasWeight').value = '';
  document.getElementById('notasSeries').value = '';

  notasRenderRoutine();
  notasSaveData();
  showToast(`💪 Nota guardada: ${exercise}`);
}

function notasRenderRoutine() {
  const list = document.getElementById('notasRoutineList');
  const empty = document.getElementById('notasRoutineEmpty');
  if (!list) return;
  list.innerHTML = '';

  if (notasRoutineData.length === 0) {
    if (empty) empty.style.display = 'flex';
    return;
  }
  if (empty) empty.style.display = 'none';

  // Group by exercise
  const grouped = {};
  notasRoutineData.forEach(e => {
    if (!grouped[e.exercise]) grouped[e.exercise] = [];
    grouped[e.exercise].push(e);
  });

  Object.entries(grouped).forEach(([exName, entries]) => {
    const group = document.createElement('div');
    group.className = 'notas-ex-group';

    // Calculate trend (compare last 2 weights)
    const withWeight = entries.filter(e => e.weight !== null);
    let trendHtml = '';
    if (withWeight.length >= 2) {
      const diff = withWeight[0].weight - withWeight[1].weight;
      if (diff > 0) trendHtml = `<span class="notas-ex-trend notas-trend-up">↑ +${diff}kg</span>`;
      else if (diff < 0) trendHtml = `<span class="notas-ex-trend notas-trend-down">↓ ${diff}kg</span>`;
      else trendHtml = `<span class="notas-ex-trend notas-trend-eq">= igual</span>`;
    }

    group.innerHTML = `<div class="notas-ex-name"><span>🏋️ ${typeof escapeHtml === 'function' ? escapeHtml(exName) : exName}</span>${trendHtml}</div>`;

    entries.forEach(entry => {
      const row = document.createElement('div');
      row.className = 'notas-entry';
      const weightStr = entry.weight !== null ? `<span class="notas-entry-weight">${entry.weight}</span><span class="notas-entry-unit">kg</span>` : '';
      row.innerHTML = `
        <span class="notas-entry-date">${entry.date}</span>
        ${weightStr}
        <span class="notas-entry-series">${typeof escapeHtml === 'function' ? escapeHtml(entry.series) : entry.series}</span>
        <div class="notas-entry-del" onclick="notasDeleteEntry(${entry.id})">✕</div>`;
      group.appendChild(row);
    });

    list.appendChild(group);
  });
}

function notasDeleteEntry(id) {
  notasRoutineData = notasRoutineData.filter(e => e.id !== id);
  notasRenderRoutine();
  notasSaveData();
}

function notasAutoSave() {
  const area = document.getElementById('notasGeneralArea');
  if (!area) return;
  notasGeneralText = area.value;

  // Update char count
  const chars = document.getElementById('notasGenChars');
  const saved = document.getElementById('notasGenSaved');
  if (chars) chars.textContent = `${notasGeneralText.length} caracteres`;
  if (saved) { saved.textContent = '● Guardando...'; saved.classList.add('unsaved'); }

  clearTimeout(notasAutoSaveTimer);
  notasAutoSaveTimer = setTimeout(() => {
    notasSaveData();
    if (saved) { saved.textContent = '● Guardado'; saved.classList.remove('unsaved'); }
  }, 800);
}

function notasSaveData() {
  try {
    localStorage.setItem('notas_routine', JSON.stringify(notasRoutineData));
    localStorage.setItem('notas_general', notasGeneralText);
  } catch(e) {}
  if (window.regData?.email && typeof saveAccount === 'function') saveAccount();
}

function notasLoadData() {
  try {
    const r = localStorage.getItem('notas_routine');
    if (r) notasRoutineData = JSON.parse(r);
  } catch(e) { notasRoutineData = []; }
  try {
    notasGeneralText = localStorage.getItem('notas_general') || '';
  } catch(e) { notasGeneralText = ''; }
}

function initNotasPanel() {
  // Set quote
  const quoteEl = document.getElementById('notasQuoteText');
  if (quoteEl) quoteEl.textContent = notasGetQuote();

  // Custom exercise toggle
  const exSel = document.getElementById('notasExSelect');
  const customEx = document.getElementById('notasCustomEx');
  if (exSel && !exSel._listenerAdded) {
    exSel._listenerAdded = true;
    exSel.addEventListener('change', () => {
      customEx.style.display = exSel.value === '_custom' ? 'block' : 'none';
      if (exSel.value === '_custom') setTimeout(() => customEx.focus(), 50);
    });
  }

  // Load general text
  const area = document.getElementById('notasGeneralArea');
  if (area) {
    area.value = notasGeneralText;
    const chars = document.getElementById('notasGenChars');
    if (chars) chars.textContent = `${notasGeneralText.length} caracteres`;
  }

  // Reset to rutina tab
  notasActiveTab = 'rutina';
  document.querySelectorAll('.notas-tab').forEach(b => b.classList.remove('active'));
  document.getElementById('notasTabRutina')?.classList.add('active');
  document.getElementById('notasTabRutinaContent').style.display = 'block';
  document.getElementById('notasTabGeneralContent').style.display = 'none';

  notasRenderRoutine();
}

// Hook openPanel for notas
const _origOpenPanelNotas = window.openPanel;
window.openPanel = function(name) {
  _origOpenPanelNotas(name);
  if (name === 'notas') setTimeout(initNotasPanel, 60);
};

// Load data on startup
notasLoadData();

// ══ NOTAS SYSTEM END ══
function updateXP(){
  document.getElementById('xp').textContent=xp;
  document.getElementById('xp-stat').textContent=xp+' puntos';
  const lvl=Math.floor(xp/50)+1;
  document.getElementById('profileXPLabel').textContent=`Nivel ${lvl} · ${xp} XP`;
  document.getElementById('statStreak').textContent=streakDays+' día'+(streakDays>1?'s':'');
  // Sync hero stat chips
  const statXP=document.getElementById('profileStatXP'); if(statXP) statXP.textContent=xp;
  const statStr=document.getElementById('profileStatStreak'); if(statStr) statStr.textContent=streakDays;
  const statC=document.getElementById('profileStatCoins'); if(statC) statC.textContent=coins;
  const badge=document.getElementById('profileHeroBadge'); if(badge) badge.textContent='Nv. '+lvl;
  // ── Auto-unlock streak badge 🦉 Duo? at 100 days ──
  checkStreakBadges();
}
function addXP(){ xp+=10; coins+=5; updateXP(); updateCoinDisplay(); showToast('+10 XP · +5🪙 ganado ⭐'); }

// ── Badge auto-unlock checks ──
function checkStreakBadges() {
  const duoBadge = SHOP_ITEMS.badges.find(b => b.id === 'b15');
  if (duoBadge && !duoBadge.owned && streakDays >= 100) {
    duoBadge.owned = true;
    showToast('🦉 ¡Badge "Duo?" desbloqueado! 100 días de racha.');
    launchConfetti(window.innerWidth/2, window.innerHeight/2);
    if (regData.email) saveAccount();
  }
}

// ── GymBro system ──
function setGymBro(friendUid, friendName, friendAvatar) {
  myGymBroUid = friendUid;
  // Unlock GymBros badge
  const gBadge = SHOP_ITEMS.badges.find(b => b.id === 'b16');
  if (gBadge && !gBadge.owned) {
    gBadge.owned = true;
    showToast(`💪 ¡${friendName} es tu GymBro! Badge "GymBros" desbloqueado.`);
    launchConfetti(window.innerWidth/2, window.innerHeight/2);
  } else {
    showToast(`💪 ¡${friendName} es ahora tu GymBro!`);
  }
  if (regData.email) saveAccount();
  renderGymBroSection();
}

function removeGymBro() {
  myGymBroUid = null;
  showToast('GymBro eliminado.');
  if (regData.email) saveAccount();
  renderGymBroSection();
}

function renderGymBroSection() {
  const section = document.getElementById('gymBroSection');
  if (!section) return;
  const gBadge = SHOP_ITEMS.badges.find(b => b.id === 'b16');
  const hasGymBro = !!myGymBroUid;
  const friend = hasGymBro ? myFriends.find(f => f.uid === myGymBroUid) : null;

  if (!hasGymBro) {
    section.innerHTML = `
      <div class="gymbro-label">💪 GymBro</div>
      <div class="gymbro-row">
        <div class="gymbro-avatar">🏋️</div>
        <div class="gymbro-info">
          <div class="gymbro-name" style="color:rgba(255,255,255,.35);">Sin GymBro asignado</div>
          <div class="gymbro-sub">Asigna uno desde el perfil de un amigo</div>
        </div>
      </div>`;
  } else {
    const av   = friend?.avatar || '🧑';
    const nm   = friend?.displayName || 'GymBro';
    const xpv  = friend?.xp || 0;
    const badgeEquipped = gBadge?.owned && equippedBadgeIds.includes('b16');
    section.innerHTML = `
      <div class="gymbro-label">💪 Mi GymBro</div>
      <div class="gymbro-row">
        <div class="gymbro-avatar">${av}</div>
        <div class="gymbro-info">
          <div class="gymbro-name">${escapeHtml(nm)}</div>
          <div class="gymbro-sub">🔥 ${friend?.streakDays||0}d · ⭐ ${xpv} XP</div>
        </div>
        <button class="gymbro-btn" onclick="removeGymBro()">✕ Quitar</button>
      </div>
      ${gBadge?.owned ? `<div class="gymbro-badge-strip">
        <span style="font-size:14px;">💪</span>
        <span>Badge GymBros desbloqueado</span>
        ${badgeEquipped ? '<span style="color:#ff6b35;font-weight:900;">● Equipado</span>' : `<button class="gymbro-btn" onclick="toggleBadge('b16');renderGymBroSection();" style="padding:3px 8px;font-size:10px;">Equipar</button>`}
      </div>` : ''}`;
  }
}


// ──────────────────────────
// PANELS
// ──────────────────────────
const PANEL_ANIM={racha:'slide-up',tareas:'slide-left',notas:'slide-left',habitos:'slide-left',stats:'slide-left',metas:'slide-left',social:'slide-left',chat:'slide-left',perfil:'zoom',nuevo:'slide-up',menu:'slide-right',login:'zoom',apariencia:'slide-left',config:'slide-left',tienda:'slide-up',inventario:'slide-left',ranking:'slide-left',ruleta:'slide-up'};
let currentPanel=null;
function openPanel(name){if(currentPanel&&currentPanel!==name)exitPanel(currentPanel,()=>enterPanel(name));else enterPanel(name); if(name==='rutina') setTimeout(renderRutina,50);}
function enterPanel(name){
  document.querySelectorAll('.panel').forEach(p=>{p.classList.remove('open','anim-slide-up','anim-slide-down','anim-slide-left','anim-slide-right','anim-zoom','anim-flip');p.style.transition='';});
  const p=document.getElementById('panel-'+name); if(!p) return;
  currentPanel=name;
  const anim=PANEL_ANIM[name]||'slide-up';
  p.classList.add('anim-'+anim); p.style.transition='none'; p.offsetHeight;
  p.style.transition='transform .38s cubic-bezier(.34,1.26,.64,1), opacity .3s ease';
  p.classList.add('open'); p.classList.remove('anim-'+anim);
  if(name==='racha')     { buildStreakPanel(); }
  if(name==='perfil')    { const el=document.getElementById('loggedEmailLabel'); if(el) el.textContent=regData.email||'—'; }
  const children=p.querySelectorAll('.panel-item,.panel-header,.streak-big,.streak-week-row,.login-form');
  children.forEach((el,i)=>{el.style.opacity='0';el.style.transform='translateY(16px)';el.style.transition='none';setTimeout(()=>{el.style.transition='opacity .3s ease,transform .35s cubic-bezier(.34,1.3,.64,1)';el.style.opacity='1';el.style.transform='translateY(0)';},60+i*55);});
}
function exitPanel(name,callback){
  const p=document.getElementById('panel-'+name); if(!p){if(callback)callback();return;}
  const anim=PANEL_ANIM[name]||'slide-up';
  const exitAnim=anim==='slide-left'?'slide-right':anim==='slide-right'?'slide-left':anim==='slide-up'?'slide-down':'zoom';
  p.style.transition='transform .25s ease-in,opacity .2s ease';
  p.classList.add('anim-'+exitAnim); p.style.opacity='0';
  setTimeout(()=>{p.classList.remove('open','anim-'+exitAnim);p.style.opacity='';p.style.transition='';currentPanel=null;if(callback)callback();},260);
}
function closePanel(name){ exitPanel(name,()=>{currentPanel=null;}); }
function goHome(){ if(currentPanel)exitPanel(currentPanel,()=>{currentPanel=null;});else document.querySelectorAll('.panel').forEach(p=>{p.classList.remove('open');p.style.transition='';}); }

// ──────────────────────────
// USERNAME
// ──────────────────────────
function editUsername(){
  document.getElementById('usernameLabel').style.display='none';
  const input=document.getElementById('usernameInput');
  input.style.display='block';
  input.value=document.getElementById('usernameLabel').textContent==='Nombre de Usuario'?'':document.getElementById('usernameLabel').textContent;
  input.focus();
}
function saveUsername(){
  const input=document.getElementById('usernameInput'),label=document.getElementById('usernameLabel');
  const val=input.value.trim()||'Nombre de Usuario';
  label.textContent=val; document.getElementById('profileName').textContent=val;
  input.style.display='none'; label.style.display='block'; showToast('Nombre guardado ✓');
}

// ──────────────────────────
// TOAST
// ──────────────────────────
let toastTimer;
function showToast(msg){
  const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),2200);
}

// ──────────────────────────
// PARTICLES
// ──────────────────────────
(function(){
  const canvas=document.getElementById('particles-canvas');
  const ctx=canvas.getContext('2d');
  let W,H;
  function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;}
  window.addEventListener('resize',resize);resize();
  const COLORS=['rgba(42,100,150,','rgba(94,220,138,','rgba(139,98,224,','rgba(240,192,64,','rgba(58,133,196,'];
  const particles=[];
  for(let i=0;i<55;i++) particles.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,r:Math.random()*1.8+0.4,dx:(Math.random()-.5)*.4,dy:(Math.random()-.5)*.3,color:COLORS[Math.floor(Math.random()*COLORS.length)],alpha:Math.random()*.5+.2,pulse:Math.random()*Math.PI*2});
  function draw(){
    ctx.clearRect(0,0,W,H);
    particles.forEach(p=>{p.pulse+=.02;p.x+=p.dx;p.y+=p.dy;if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;const a=p.alpha*(.7+.3*Math.sin(p.pulse));ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle=p.color+a+')';ctx.fill();});
    for(let i=0;i<particles.length;i++){for(let j=i+1;j<particles.length;j++){const dx=particles[i].x-particles[j].x,dy=particles[i].y-particles[j].y,dist=Math.sqrt(dx*dx+dy*dy);if(dist<100){ctx.beginPath();ctx.moveTo(particles[i].x,particles[i].y);ctx.lineTo(particles[j].x,particles[j].y);ctx.strokeStyle=`rgba(42,100,150,${.12*(1-dist/100)})`;ctx.lineWidth=.5;ctx.stroke();}}}
    requestAnimationFrame(draw);
  }
  draw();
})();

// ──────────────────────────
// CONFETTI
// ──────────────────────────
function launchConfetti(x,y,opts={}){
  const colors=opts.colors||['#f0c040','#5edc8a','#e8527a','#8b62e0','#3a85c4','#fff','#ff8800','#00c8ff'];
  const count=opts.count||32;
  const maxDist=opts.dist||200;
  const dur=opts.dur||2.2;
  for(let i=0;i<count;i++){
    const el=document.createElement('div');
    el.className='confetti-piece';
    const angle=(Math.random()*360)*Math.PI/180;
    const dist=60+Math.random()*maxDist;
    const size=5+Math.random()*10;
    const d=dur*(.7+Math.random()*.6);
    el.style.cssText=`left:${x}px;top:${y}px;background:${colors[Math.floor(Math.random()*colors.length)]};--fx:${Math.cos(angle)*dist}px;--fy:${Math.sin(angle)*dist+60}px;--dur:${d}s;border-radius:${Math.random()>.5?'50%':'3px'};width:${size}px;height:${size}px;opacity:1;`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),d*1000+200);
  }
}
function launchConfettiBurst(x,y,opts={}) {
  // Big multi-wave burst for special events
  launchConfetti(x, y, {count:40, dist:250, dur:2.8, ...opts});
  setTimeout(()=>launchConfetti(x-60, y+20, {count:20, dist:180, dur:2.2, ...opts}), 150);
  setTimeout(()=>launchConfetti(x+60, y+20, {count:20, dist:180, dur:2.2, ...opts}), 300);
  setTimeout(()=>launchConfetti(x, y-30, {count:25, dist:200, dur:2.5, ...opts}), 450);
}

// ──────────────────────────
// RIPPLE
// ──────────────────────────
document.addEventListener('click',function(e){
  const target=e.target.closest('.block,.nav-btn,.panel-item,.streak-section');
  if(!target) return;
  const rect=target.getBoundingClientRect(),ripple=document.createElement('span');
  ripple.style.cssText=`position:absolute;border-radius:50%;width:8px;height:8px;margin-top:-4px;margin-left:-4px;background:rgba(255,255,255,.4);left:${e.clientX-rect.left}px;top:${e.clientY-rect.top}px;transform:scale(0);animation:rippleAnim .5s ease forwards;pointer-events:none;z-index:10;`;
  if(!document.getElementById('ripple-style')){const s=document.createElement('style');s.id='ripple-style';s.textContent='@keyframes rippleAnim{to{transform:scale(25);opacity:0}}';document.head.appendChild(s);}
  target.style.position='relative';target.style.overflow='hidden';target.appendChild(ripple);setTimeout(()=>ripple.remove(),600);
});

// ──────────────────────────
// CONFETTI on task done
// ──────────────────────────
const _origToggleTask=toggleTask;
window.toggleTask=function(id){
  const t=tasks.find(t=>t.id===id),wasDone=t?t.done:true;
  _origToggleTask(id);
  if(t&&!wasDone){const items=document.querySelectorAll('.task-item');items.forEach(el=>{if(el.querySelector('.task-name')&&el.querySelector('.task-name').textContent===t.name){const r=el.getBoundingClientRect();launchConfetti(r.left+r.width/2,r.top+r.height/2);}});}
};

// ──────────────────────────
// FLAMES
// ──────────────────────────
const FLAME_COLORS=[['#ff9a00','#ffcc00'],['#ff5500','#ff8800'],['#ff3300','#ff6600'],['#ffee00','#fffb80'],['#ff7700','#ffaa00']];
const FLAME_COLORS_LEGENDARY=[['#8b62e0','#c49eff'],['#6a30c8','#b48fff'],['#9b30d8','#d4a8ff'],['#7040e0','#c0a0ff'],['#a050e8','#e0c0ff']];
function spawnFlames(e){
  e.stopPropagation&&e.stopPropagation();
  const container=document.getElementById('flame-container'); if(!container) return;
  const rect=container.getBoundingClientRect();
  const clientX=e.touches?e.touches[0].clientX:e.clientX,clientY=e.touches?e.touches[0].clientY:e.clientY;
  const x=clientX-rect.left,y=clientY-rect.top;
  const palette = streakDays >= 30 ? FLAME_COLORS_LEGENDARY : FLAME_COLORS;
  for(let i=0;i<6;i++){setTimeout(()=>{const el=document.createElement('div');el.className='flame-particle';const pair=palette[Math.floor(Math.random()*palette.length)],size=10+Math.random()*22,spreadX=(Math.random()-.5)*80,riseY=-(40+Math.random()*80),dur=.5+Math.random()*.7,rot=(Math.random()-.5)*40,rot2=(Math.random()-.5)*60;el.style.cssText=`width:${size}px;height:${size*1.4}px;left:${x-size/2+(Math.random()-.5)*30}px;top:${y-size/2}px;background:radial-gradient(ellipse at 50% 80%,${pair[0]},${pair[1]} 60%,transparent 100%);box-shadow:0 0 ${size/2}px ${pair[0]},0 0 ${size}px ${pair[1]}40;--fx:${spreadX}px;--fy:${riseY}px;--dur:${dur}s;--rot:${rot}deg;--rot2:${rot2}deg;opacity:0.95;`;container.appendChild(el);setTimeout(()=>el.remove(),dur*1000+100);},i*8);}
}
const streakEl=document.querySelector('.streak-section');
if(streakEl){streakEl.addEventListener('mousemove',e=>spawnFlames(e));streakEl.addEventListener('touchmove',e=>{e.preventDefault();spawnFlames(e);},{passive:false});}

// ──────────────────────────
// PHOTO
// ──────────────────────────
function triggerPhotoPicker(){document.getElementById('photoInput').click();}
function loadPhoto(event){
  const file=event.target.files[0]; if(!file) return;
  if(!file.type.startsWith('image/')){showToast('Por favor selecciona una imagen');return;}
  const reader=new FileReader();
  reader.onload=function(e){
    const src=e.target.result;
    const panelImg=document.getElementById('profileImgPanel'),panelEmoji=document.getElementById('profileAvatarPanel');
    panelImg.src=src;panelImg.style.display='block';panelImg.style.animation='none';panelImg.offsetHeight;panelImg.style.animation='';panelEmoji.style.display='none';
    const homeImg=document.getElementById('profileImgHome'),homeEmoji=document.getElementById('profileAvatarHome');
    homeImg.src=src;homeImg.style.display='block';homeImg.style.animation='none';homeImg.offsetHeight;homeImg.style.animation='';homeEmoji.style.display='none';
    document.getElementById('removePhotoBtn').style.display='block';
    // Persist photo across sessions
    try { localStorage.setItem('profilePhoto', src); } catch(e) {}
    showToast('¡Foto de perfil actualizada! 📷');
    launchConfetti(window.innerWidth/2,window.innerHeight/3);
    // Sync cfg panel
    const cfgImg=document.getElementById('cfgAvatarImg'),cfgEmoji=document.getElementById('cfgAvatarEmoji');
    if(cfgImg){cfgImg.src=src;cfgImg.style.display='block';}
    if(cfgEmoji) cfgEmoji.style.display='none';
    // Sync inv avatar preview if open
    const invPrev=document.getElementById('invAvatarPreviewImg');
    if(invPrev){invPrev.src=src;invPrev.style.display='block';}
    const invPrevEmoji=document.getElementById('invAvatarPreviewEmoji');
    if(invPrevEmoji) invPrevEmoji.style.display='none';
    const invPrevName=document.getElementById('invAvatarPreviewName');
    if(invPrevName) invPrevName.textContent='Foto personalizada';
    const invRemoveBtn=document.getElementById('invPhotoRemoveBtn');
    if(invRemoveBtn) invRemoveBtn.style.display='block';
  };
  reader.readAsDataURL(file); event.target.value='';
}
function removePhoto(){
  document.getElementById('profileImgPanel').style.display='none'; document.getElementById('profileAvatarPanel').style.display='';
  document.getElementById('profileImgHome').style.display='none'; document.getElementById('profileAvatarHome').style.display='';
  document.getElementById('removePhotoBtn').style.display='none';
  const cfgImg=document.getElementById('cfgAvatarImg'),cfgEmoji=document.getElementById('cfgAvatarEmoji');
  if(cfgImg) cfgImg.style.display='none'; if(cfgEmoji) cfgEmoji.style.display='';
  try { localStorage.removeItem('profilePhoto'); } catch(e) {}
  showToast('Foto eliminada');
}
// Apply persisted profile photo
function restoreProfilePhoto() {
  try {
    const src = localStorage.getItem('profilePhoto');
    if (!src) return;
    const applyToEl = (imgId, emojiId) => {
      const img = document.getElementById(imgId), emoji = document.getElementById(emojiId);
      if (img) { img.src = src; img.style.display = 'block'; }
      if (emoji) emoji.style.display = 'none';
    };
    applyToEl('profileImgHome','profileAvatarHome');
    applyToEl('profileImgPanel','profileAvatarPanel');
    applyToEl('cfgAvatarImg','cfgAvatarEmoji');
    const removeBtn = document.getElementById('removePhotoBtn');
    if (removeBtn) removeBtn.style.display = 'block';
  } catch(e) {}
}

// ──────────────────────────
// THEMES
// ──────────────────────────
const THEMES=[
  {name:'Noche',    bg:'#0d1b3e',bg2:'#122050',accent:'#2a6496',mid:'#0f1e3a',  unlocked:true },
  {name:'Bosque',   bg:'#0d2818',bg2:'#0f3320',accent:'#2e7d4f',mid:'#0b2214',  unlocked:false},
  {name:'Volcán',   bg:'#1a0a00',bg2:'#2a1000',accent:'#c0440a',mid:'#150800',  unlocked:false},
  {name:'Galaxia',  bg:'#0e0a1e',bg2:'#1a1035',accent:'#6a30c8',mid:'#0a081a',  unlocked:false},
  {name:'Coral',    bg:'#1a0a12',bg2:'#2a1020',accent:'#b8305a',mid:'#160810',  unlocked:false},
  {name:'Océano',   bg:'#021825',bg2:'#042535',accent:'#0e7490',mid:'#011520',  unlocked:false},
  {name:'Aurora',   bg:'#071a14',bg2:'#0d2b20',accent:'#0fba81',mid:'#051410',  unlocked:false},
  {name:'Carbón',   bg:'#111111',bg2:'#1e1e1e',accent:'#555555',mid:'#0a0a0a',  unlocked:false},
  {name:'Sakura',   bg:'#1e0a18',bg2:'#2e1028',accent:'#d4688a',mid:'#180810',  unlocked:false},
  {name:'Tormenta', bg:'#0a0e1a',bg2:'#101828',accent:'#4a6fa0',mid:'#080c14',  unlocked:false},
  {name:'Desierto', bg:'#1c1008',bg2:'#2c1c0e',accent:'#c8801a',mid:'#160c06',  unlocked:false},
  {name:'Ciberpunk',bg:'#080818',bg2:'#0e0e28',accent:'#e040fb',mid:'#060610',  unlocked:false},
  {name:'Sangre',   bg:'#1a0808',bg2:'#280e0e',accent:'#cc2222',mid:'#140606',  unlocked:false},
  {name:'Hielo',    bg:'#0a1828',bg2:'#102038',accent:'#60c0e8',mid:'#081420',  unlocked:false},
  {name:'Luck',     bg:'#041208',bg2:'#071a10',accent:'#2d8a4e',mid:'#030e06',  unlocked:false, luck:true, desc:'Obtenido de la ruleta'},
];
let activeThemeIdx=0;
function buildThemeGrid(){
  const grid=document.getElementById('themeGrid');
  if(!grid)return;
  grid.innerHTML='';
  THEMES.forEach((t,i)=>{
    const sw=document.createElement('div');
    const isLocked = t.luck ? !window._luckSkinOwned : !t.unlocked;
    sw.className='theme-swatch'+(i===activeThemeIdx?' active':'')+(isLocked?' locked':'');
    sw.dataset.name=t.name;
    if (t.desc) sw.dataset.desc=t.desc;
    sw.style.background=`linear-gradient(135deg,${t.bg},${t.bg2},${t.accent})`;
    sw.innerHTML = t.luck
      ? '<div class="check-mark">✓</div><div style="position:absolute;bottom:4px;left:0;right:0;text-align:center;font-size:7px;color:rgba(94,220,138,.7);font-weight:700;letter-spacing:.5px;">RULETA</div>'
      : '<div class="check-mark">✓</div>';
    if (t.luck) {
      sw.style.background = 'linear-gradient(135deg,#041208,#071a10,#2d8a4e,#0d4020)';
      sw.dataset.lucktheme = '1';
      if (!window._luckSkinOwned) {
        sw.style.border = '1.5px solid rgba(94,220,138,.3)';
        sw.style.opacity = '.6';
      } else {
        sw.style.border = '2px solid rgba(94,220,138,.7)';
        sw.style.boxShadow = '0 0 10px rgba(94,220,138,.4)';
      }
    }
    const isLuckLocked = t.luck && !window._luckSkinOwned;
    sw.onclick = isLuckLocked ? () => showToast('🍀 ¡Gira la Ruleta de la Suerte para obtenerla!') : isLocked ? () => showToast(`🔒 "${t.name}" — cómpralo en la Tienda`) : () => applyTheme(i);
    grid.appendChild(sw);
  });
  if(THEMES[activeThemeIdx])updatePreviewStrip(THEMES[activeThemeIdx]);
}
function applyTheme(idx){
  activeThemeIdx=idx;
  const t=THEMES[idx];
  setAppColors(t.bg,t.bg2,t.accent,t.mid);
  document.getElementById('bgColorPicker').value=t.bg;
  updatePreviewStrip(t);
  buildThemeGrid();
  if (t.luck) {
    document.body.style.background = 'linear-gradient(-45deg,#041208,#071a10,#0d2818,#051510)';
    document.body.style.backgroundSize = '400% 400%';
    document.body.style.animation = 'luckBgFlow 8s ease infinite';
    launchLuckParticles();
    launchConfettiBurst(window.innerWidth/2, window.innerHeight/2, {colors:['#5edc8a','#2d8a4e','#a8f0c0','#fff','#00ff88']});
    showToast('🍀 ¡Apariencia Luck activada!');
  } else {
    document.body.style.animation = '';
    showToast(`Tema "${t.name}" aplicado ✓`);
  }
  setTimeout(()=>{ if(typeof updateChart==='function') updateChart(); },50);
}
function applyCustomColor(hex){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);const bg2=shiftColor(r,g,b,20),accent=shiftColor(r,g,b,60),mid=shiftColor(r,g,b,-10);setAppColors(hex,bg2,accent,mid);document.getElementById('customPreviewBox').style.background=hex;updatePreviewStrip({bg:hex,bg2,accent,mid});document.querySelectorAll('.theme-swatch').forEach(s=>s.classList.remove('active'));activeThemeIdx=-1;}
function shiftColor(r,g,b,a){const nr=Math.min(255,Math.max(0,r+a)),ng=Math.min(255,Math.max(0,g+a)),nb=Math.min(255,Math.max(0,b+a));return '#'+[nr,ng,nb].map(v=>v.toString(16).padStart(2,'0')).join('');}
function hexToRgb(hex){return[parseInt(hex.slice(1,3),16),parseInt(hex.slice(3,5),16),parseInt(hex.slice(5,7),16)];}
function generatePalette(accent,bg){const[ar,ag,ab]=hexToRgb(accent);function variantHex(rS,gS,bS,l=0){return shiftColor(Math.min(255,Math.max(30,ar+rS+l)),Math.min(255,Math.max(30,ag+gS+l)),Math.min(255,Math.max(30,ab+bS+l)),0);}return{col1:variantHex(0,0,0,60),col2:variantHex(80,60,-80,40),col3:variantHex(60,120,20,30),col4:variantHex(-30,-60,100,40),col5:variantHex(100,-40,-30,30)};}
function setAppColors(bg,bg2,accent,mid){const root=document.documentElement;root.style.setProperty('--navy',bg);root.style.setProperty('--navy-mid',bg2);root.style.setProperty('--teal',accent);const[ar,ag,ab]=hexToRgb(accent);root.style.setProperty('--teal-light',shiftColor(ar,ag,ab,30));root.style.setProperty('--blue-block',shiftColor(ar,ag,ab,20));const pal=generatePalette(accent,bg);root.style.setProperty('--yellow',pal.col2);root.style.setProperty('--green',pal.col3);root.style.setProperty('--purple',pal.col4);root.style.setProperty('--pink',pal.col5);const blocks=['b1','b2','b3','b4','b5','b6'],blockColors=[pal.col1,pal.col2,pal.col1,pal.col3,pal.col4,pal.col5];blocks.forEach((cls,i)=>{document.querySelectorAll('.'+cls).forEach(el=>el.style.background=blockColors[i]);});const ss=document.querySelector('.streak-section');if(ss){ss.style.background=`linear-gradient(135deg,${bg2},${bg})`;ss.style.borderColor=pal.col2+'66';}document.querySelectorAll('.streak-count,.streak-big-num').forEach(el=>el.style.color=pal.col2);document.querySelectorAll('.streak-dot.done').forEach(el=>el.style.background=pal.col2);document.querySelectorAll('.xp-badge').forEach(el=>{el.style.borderColor=pal.col2;el.style.color=pal.col2;});document.querySelector('.bottom-nav').style.background=accent;document.body.style.background=`linear-gradient(-45deg,${bg},${mid},${bg2},${shiftColor(ar,ag,ab,10)})`;document.body.style.backgroundSize='400% 400%';document.getElementById('phone').style.background=bg;root.style.setProperty('--green',pal.col3);root.style.setProperty('--yellow',pal.col2);root.style.setProperty('--pink',pal.col5);root.style.setProperty('--purple',pal.col4);const strip=document.getElementById('themePreviewStrip');if(strip)strip.style.setProperty('--preview-bg',bg);updateBlockGlows(blockColors);
// ── Calendar & Chart theme sync ──
const calBg=`linear-gradient(135deg,${shiftColor(ar,ag,ab,-40)}33,${bg2}cc)`;
root.style.setProperty('--cal-bg', calBg);
root.style.setProperty('--cal-border', accent+'55');
root.style.setProperty('--cal-text', '#fff');
root.style.setProperty('--cal-arrow-bg', accent+'33');
root.style.setProperty('--cal-arrow-hover', accent+'66');
root.style.setProperty('--cal-header-color', accent+'aa');
root.style.setProperty('--cal-day-color', 'rgba(255,255,255,.85)');
root.style.setProperty('--cal-hover', accent+'33');
root.style.setProperty('--cal-week-bg', accent+'22');
const calEl=document.querySelector('.calendar-section');
if(calEl){calEl.style.background=calBg;calEl.style.borderColor=accent+'55';}
const chartEl=document.querySelector('.chart-section');
if(chartEl){chartEl.style.background=`linear-gradient(145deg,${bg2},${shiftColor(ar,ag,ab,-50)}cc)`;chartEl.style.borderLeft=`2px solid ${accent}44`;}
}
function updateBlockGlows(colors){let style=document.getElementById('dynamic-glow-style');if(!style){style=document.createElement('style');style.id='dynamic-glow-style';document.head.appendChild(style);}style.textContent=`.b1:hover,.b3:hover{box-shadow:0 0 16px ${colors[0]}99}.b2:hover{box-shadow:0 0 16px ${colors[1]}99}.b4:hover{box-shadow:0 0 16px ${colors[3]}99}.b5:hover{box-shadow:0 0 16px ${colors[4]}99}.b6:hover{box-shadow:0 0 16px ${colors[5]}99}`;}
function updatePreviewStrip(t){const strip=document.getElementById('themePreviewStrip');if(!strip)return;strip.style.background=t.bg;document.getElementById('tpsAccent').style.background=t.accent;document.getElementById('tpsBlock1').style.background=t.accent;document.getElementById('tpsBlock2').style.background=t.bg2;document.getElementById('tpsBlock3').style.background=t.mid||t.bg;document.getElementById('tpsBar').style.background=`linear-gradient(90deg,${t.accent},${t.bg2})`;document.getElementById('customPreviewBox').style.background=t.bg;}
function resetTheme(){applyTheme(0);showToast('Tema restablecido ✓');}
const _origEnterPanel=enterPanel;
window.enterPanel=function(name){
  _origEnterPanel(name);
  if(name==='apariencia') setTimeout(buildThemeGrid,120);
  if(name==='config')     setTimeout(syncConfigPanel,80);
  if(name==='tienda')     { setTimeout(()=>{ updateCoinDisplay(); renderShopTab(currentShopTab); },80); }
  if(name==='inventario') { setTimeout(()=>renderInvTab(currentInvTab), 80); }
  if(name==='racha')      { setTimeout(buildMascotaPanel, 50); }
  if(name==='habitos')    { setTimeout(renderHabitsPanel, 50); }
  // Update nav active state
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  if(name==='tienda') document.getElementById('navTienda')?.classList.add('active');
  else if(name==='nuevo') document.getElementById('navNuevo')?.classList.add('active');
  else if(name==='menu')  document.getElementById('navMenu')?.classList.add('active');
};

// ──────────────────────────
// SPLASH STARS
// ──────────────────────────
(function(){
  const canvas=document.getElementById('splash-stars'); if(!canvas)return;
  const ctx=canvas.getContext('2d');
  let W,H;
  function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;}
  window.addEventListener('resize',resize);resize();
  const stars=[];
  for(let i=0;i<38;i++) stars.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,size:4+Math.random()*10,speed:.15+Math.random()*.35,drift:(Math.random()-.5)*.3,alpha:.5+Math.random()*.5,twinkle:Math.random()*Math.PI*2,pulseSpeed:.02+Math.random()*.03});
  function drawStar(x,y,size,alpha){ctx.save();ctx.globalAlpha=alpha;ctx.fillStyle='#ffffff';ctx.translate(x,y);ctx.beginPath();for(let i=0;i<4;i++){const angle=(i/4)*Math.PI*2,outerX=Math.cos(angle)*size,outerY=Math.sin(angle)*size,innerAngle=angle+Math.PI/4,innerX=Math.cos(innerAngle)*size*.25,innerY=Math.sin(innerAngle)*size*.25;if(i===0)ctx.moveTo(outerX,outerY);else ctx.lineTo(outerX,outerY);ctx.lineTo(innerX,innerY);}ctx.closePath();ctx.fill();ctx.restore();}
  function animateStars(){if(!document.getElementById('splash-stars'))return;ctx.clearRect(0,0,W,H);stars.forEach(s=>{s.y-=s.speed;s.x+=s.drift;s.twinkle+=s.pulseSpeed;if(s.y<-20){s.y=H+20;s.x=Math.random()*W;}if(s.x<-20)s.x=W+20;if(s.x>W+20)s.x=-20;const a=s.alpha*(.6+.4*Math.sin(s.twinkle)),sz=s.size*(.85+.15*Math.sin(s.twinkle*1.3));drawStar(s.x,s.y,sz,a);});requestAnimationFrame(animateStars);}
  animateStars();
})();

// ──────────────────────────
// MASCOTA DE RACHA
// ──────────────────────────
const PET_TYPES = [
  { emoji:'🐱', name:'Gato',      evo:['🐱','😺','🦁'] },
  { emoji:'🐶', name:'Perro',     evo:['🐶','🐕','🐺'] },
  { emoji:'🐲', name:'Dragón',    evo:['🐲','🐉','🔥🐉'] },
  { emoji:'🦊', name:'Zorro',     evo:['🦊','🦊','⚡🦊'] },
  { emoji:'🐸', name:'Rana',      evo:['🐸','🐸','✨🐸'] },
  { emoji:'🐧', name:'Pingüino',  evo:['🐧','🐧','❄️🐧'] },
  { emoji:'🦋', name:'Mariposa',  evo:['🦋','🦋','🌈🦋'] },
  { emoji:'🐨', name:'Koala',     evo:['🐨','🐨','💜🐨'] },
  { emoji:'🐻', name:'Oso',       evo:['🐻','🐻','🌟🐻'] },
  { emoji:'🦄', name:'Unicornio', evo:['🦄','🦄','🌈🦄'] },
  { emoji:'🐯', name:'Tigre',     evo:['🐯','🐯','🔥🐯'] },
  { emoji:'🦅', name:'Águila',    evo:['🦅','🦅','⚡🦅'] },
  { emoji:'🐺', name:'Lobo',      evo:['🐺','🐺','🌙🐺'] },
  { emoji:'🦖', name:'Dino',      evo:['🦖','🦕','🔥🦖'] },
  { emoji:'🐙', name:'Pulpo',     evo:['🐙','🐙','💜🐙'] },
  { emoji:'🦊', name:'Zorro Arco',evo:['🦊','🦊','🌈🦊'] },
];

const PET_COLORS = [
  { name:'Teal',     hex:'#2a90c8', filter:'drop-shadow(0 0 8px #2a90c8)' },
  { name:'Verde',    hex:'#5edc8a', filter:'drop-shadow(0 0 8px #5edc8a)' },
  { name:'Morado',   hex:'#8b62e0', filter:'drop-shadow(0 0 8px #8b62e0)' },
  { name:'Dorado',   hex:'#f0c040', filter:'drop-shadow(0 0 8px #f0c040)' },
  { name:'Rosa',     hex:'#e8527a', filter:'drop-shadow(0 0 8px #e8527a)' },
  { name:'Blanco',   hex:'#ffffff', filter:'drop-shadow(0 0 6px #fff)' },
  { name:'Naranja',  hex:'#ff7c20', filter:'drop-shadow(0 0 8px #ff7c20)' },
  { name:'Cian',     hex:'#00d4ff', filter:'drop-shadow(0 0 8px #00d4ff)' },
  { name:'Rojo',     hex:'#ff3355', filter:'drop-shadow(0 0 8px #ff3355)' },
  { name:'Lima',     hex:'#b4ff40', filter:'drop-shadow(0 0 8px #b4ff40)' },
  { name:'Fucsia',   hex:'#ff40cc', filter:'drop-shadow(0 0 8px #ff40cc)' },
  { name:'Arcoíris', hex:'linear-gradient(135deg,#ff4444,#ff8c00,#ffe000,#5edc8a,#2a90c8,#8b62e0)', filter:'drop-shadow(0 0 10px #8b62e0) saturate(1.5)' },
];

const PET_ACCS = [
  // Sombreros
  { id:'hat-1',    slot:'hat',    emoji:'🎩', name:'Sombrero' },
  { id:'hat-2',    slot:'hat',    emoji:'👑', name:'Corona' },
  { id:'hat-3',    slot:'hat',    emoji:'🎓', name:'Birrete' },
  { id:'hat-4',    slot:'hat',    emoji:'🌸', name:'Flor' },
  { id:'hat-5',    slot:'hat',    emoji:'⛑️', name:'Casco' },
  { id:'hat-6',    slot:'hat',    emoji:'🎭', name:'Máscara' },
  { id:'hat-7',    slot:'hat',    emoji:'🪖', name:'Militar' },
  { id:'hat-8',    slot:'hat',    emoji:'🧢', name:'Gorra' },
  // Collares
  { id:'collar-1', slot:'collar', emoji:'📿', name:'Collar' },
  { id:'collar-2', slot:'collar', emoji:'🎀', name:'Moño' },
  { id:'collar-3', slot:'collar', emoji:'❤️', name:'Corazón' },
  { id:'collar-4', slot:'collar', emoji:'⭐', name:'Estrella' },
  { id:'collar-5', slot:'collar', emoji:'💎', name:'Diamante' },
  { id:'collar-6', slot:'collar', emoji:'🌙', name:'Luna' },
  // Varitas / mano
  { id:'wand-1',   slot:'wand',   emoji:'⚡', name:'Rayo' },
  { id:'wand-2',   slot:'wand',   emoji:'🌟', name:'Varita' },
  { id:'wand-3',   slot:'wand',   emoji:'🔥', name:'Llama' },
  { id:'wand-4',   slot:'wand',   emoji:'🗡️', name:'Espada' },
  { id:'wand-5',   slot:'wand',   emoji:'🪄', name:'Magia' },
  { id:'wand-6',   slot:'wand',   emoji:'🌈', name:'Arcoíris' },
];

// Pet state
let petTypeIdx   = 0;
let petColorIdx  = 0;
let petName      = 'Chispa';
let petHat       = null;    // acc id
let petCollar    = null;
let petWand      = null;
let petHp        = 60;      // 0-100
let petTapCount  = 0;

// Evolution thresholds: [0,30,70,100] days → evo stage 0,1,2,3
function getPetEvoStage() {
  if (streakDays >= 100) return 3;
  if (streakDays >= 70)  return 2;
  if (streakDays >= 30)  return 1;
  return 0;
}
function getPetEmoji() {
  const type = PET_TYPES[petTypeIdx];
  const stage = getPetEvoStage();
  return type.evo[Math.min(stage, type.evo.length-1)];
}
function getPetLevel() {
  return Math.floor(streakDays / 10) + 1;
}
function getPetMood() {
  if (petHp >= 80) return { icon:'🤩', label:'¡Feliz!',  color:'#5edc8a' };
  if (petHp >= 55) return { icon:'😊', label:'Contento', color:'#5edc8a' };
  if (petHp >= 30) return { icon:'😐', label:'Normal',   color:'#f0c040' };
  return               { icon:'😢', label:'Triste',   color:'#e8527a' };
}
function getMoodClass() {
  if (petHp >= 55 && streakDays >= 30) return 'legendary-pet';
  if (petHp >= 55) return 'happy';
  return 'sad';
}

function buildMascotaPanel() {
  // Type buttons
  const typeRow = document.getElementById('mascotaTypeRow');
  const colorRow = document.getElementById('mascotaColorRow');
  const accRow = document.getElementById('mascotaAccRow');

  // If elements not found, retry once more
  if (!typeRow || !colorRow || !accRow) {
    setTimeout(buildMascotaPanel, 150);
    return;
  }

  typeRow.innerHTML = '';
    PET_TYPES.forEach((t, i) => {
      const btn = document.createElement('div');
      btn.className = 'mascota-type-btn' + (i === petTypeIdx ? ' active' : '');
      btn.innerHTML = `<span style="font-size:22px">${t.emoji}</span><span style="font-size:9px;display:block;color:rgba(255,255,255,.5);margin-top:2px">${t.name}</span>`;
      btn.title = t.name;
      btn.onclick = () => { petTypeIdx = i; buildMascotaPanel(); syncMascotaDisplay(); if(regData.email) saveAccount(); };
      typeRow.appendChild(btn);
    });

  colorRow.innerHTML = '';
    PET_COLORS.forEach((c, i) => {
      const dot = document.createElement('div');
      dot.className = 'mascota-color-dot' + (i === petColorIdx ? ' active' : '');
      dot.style.background = c.hex;
      dot.title = c.name;
      dot.onclick = () => { petColorIdx = i; buildMascotaPanel(); syncMascotaDisplay(); if(regData.email) saveAccount(); };
      colorRow.appendChild(dot);
    });

  accRow.innerHTML = '';
    const slots = [
      { key:'hat',    label:'🎩 Sombrero', cur: petHat },
      { key:'collar', label:'📿 Collar',   cur: petCollar },
      { key:'wand',   label:'✨ Mano',     cur: petWand },
    ];
    slots.forEach(slot => {
      const lbl = document.createElement('div');
      lbl.style.cssText = 'width:100%;font-size:10px;font-weight:800;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px;margin:8px 0 4px;';
      lbl.textContent = slot.label;
      accRow.appendChild(lbl);
      const rowWrap = document.createElement('div');
      rowWrap.style.cssText = 'display:flex;gap:6px;flex-wrap:wrap;width:100%;';
      const none = document.createElement('div');
      none.className = 'mascota-acc-btn' + (!slot.cur ? ' active' : '');
      none.innerHTML = `<span style="font-size:16px">🚫</span><span>Ninguno</span>`;
      none.onclick = () => {
        if (slot.key === 'hat') petHat = null;
        else if (slot.key === 'collar') petCollar = null;
        else petWand = null;
        buildMascotaPanel(); syncMascotaDisplay(); if(regData.email) saveAccount();
      };
      rowWrap.appendChild(none);
      PET_ACCS.filter(a => a.slot === slot.key).forEach(acc => {
        const btn = document.createElement('div');
        btn.className = 'mascota-acc-btn' + (slot.cur === acc.id ? ' active' : '');
        btn.innerHTML = `<span style="font-size:16px">${acc.emoji}</span><span>${acc.name}</span>`;
        btn.onclick = () => {
          if (acc.slot === 'hat')    petHat    = acc.id;
          if (acc.slot === 'collar') petCollar = acc.id;
          if (acc.slot === 'wand')   petWand   = acc.id;
          buildMascotaPanel(); syncMascotaDisplay(); if(regData.email) saveAccount();
        };
        rowWrap.appendChild(btn);
      });
      accRow.appendChild(rowWrap);
    });

  syncMascotaDisplay();
}

function syncHomePet() {
  const emojiEl  = document.getElementById('homePetEmoji');
  const glowEl   = document.getElementById('homePetGlow');
  const nameEl   = document.getElementById('homePetName');
  const moodEl   = document.getElementById('homePetMood');
  const hpFill   = document.getElementById('homePetHpFill');
  const lvlEl    = document.getElementById('homePetLvl');
  const hatEl    = document.getElementById('homePetHat');
  const collarEl = document.getElementById('homePetCollar');
  const wandEl   = document.getElementById('homePetWand');
  const section  = document.querySelector('.streak-section');

  if (!emojiEl) return;

  // Pet emoji with evo stage
  emojiEl.textContent = getPetEmoji();

  // Color filter + glow
  const color = PET_COLORS[petColorIdx];
  emojiEl.style.filter = color.filter;
  if (glowEl) glowEl.style.background = color.hex;

  // Accessories (small)
  const hatAcc    = PET_ACCS.find(a => a.id === petHat);
  const collarAcc = PET_ACCS.find(a => a.id === petCollar);
  const wandAcc   = PET_ACCS.find(a => a.id === petWand);
  if (hatEl)    hatEl.textContent    = hatAcc    ? hatAcc.emoji    : '';
  if (collarEl) collarEl.textContent = collarAcc ? collarAcc.emoji : '';
  if (wandEl)   wandEl.textContent   = wandAcc   ? wandAcc.emoji   : '';

  // Name
  if (nameEl) nameEl.textContent = petName || 'Chispa';

  // Mood
  const mood = getPetMood();
  if (moodEl)  moodEl.textContent  = `${mood.icon} ${mood.label}`;
  if (hpFill) {
    hpFill.style.width      = petHp + '%';
    hpFill.style.background = mood.color;
  }

  // Level
  if (lvlEl) lvlEl.textContent = `Nv.${getPetLevel()}`;

  // Mood class on the streak section card
  if (section) {
    section.classList.remove('sad-pet');
    if (petHp < 30) section.classList.add('sad-pet');
  }
}

function syncMascotaDisplay() {
  const body    = document.getElementById('mascotaBody');
  const card    = document.getElementById('mascotaCard');
  const glow    = document.getElementById('mascotaGlow');
  const hpFill  = document.getElementById('mascotaHpFill');
  const moodIcon= document.getElementById('mascotaMoodIcon');
  const moodLbl = document.getElementById('mascotaMoodLabel');
  const lvlBadge= document.getElementById('mascotaLvlBadge');
  const nameInp = document.getElementById('mascotaNameInput');
  const statDays= document.getElementById('petStatDays');
  const statHp  = document.getElementById('petStatHp');
  const statLvl = document.getElementById('petStatLvl');
  const evoBanner= document.getElementById('mascotaEvoBanner');

  if (!body) return;

  // Pet emoji (with evo)
  body.textContent = getPetEmoji();

  // Color filter aura
  const color = PET_COLORS[petColorIdx];
  body.style.filter = color.filter;
  if (glow) glow.style.background = color.hex;

  // Accessories
  const hatAcc    = PET_ACCS.find(a => a.id === petHat);
  const collarAcc = PET_ACCS.find(a => a.id === petCollar);
  const wandAcc   = PET_ACCS.find(a => a.id === petWand);
  document.getElementById('mascotaHat').textContent    = hatAcc    ? hatAcc.emoji    : '';
  document.getElementById('mascotaCollar').textContent = collarAcc ? collarAcc.emoji : '';
  document.getElementById('mascotaWand').textContent   = wandAcc   ? wandAcc.emoji   : '';

  // Mood
  const mood = getPetMood();
  if (moodIcon) moodIcon.textContent = mood.icon;
  if (moodLbl)  moodLbl.textContent  = mood.label;
  if (hpFill) {
    hpFill.style.width      = petHp + '%';
    hpFill.style.background = mood.color;
  }

  // Level
  const lvl = getPetLevel();
  if (lvlBadge) lvlBadge.textContent = `Nv.${lvl}`;
  if (nameInp && nameInp.value !== petName) nameInp.value = petName;

  // Stats
  if (statDays) statDays.textContent = streakDays;
  if (statHp)   statHp.textContent   = petHp;
  if (statLvl)  statLvl.textContent  = lvl;

  // Card mood class
  if (card) {
    card.classList.remove('happy','sad','legendary-pet');
    card.classList.add(getMoodClass());
  }

  // Evo banner: show at days 30, 70, 100
  if (evoBanner) {
    const stage = getPetEvoStage();
    const evoTitle = document.getElementById('evoBannerTitle');
    const evoDesc  = document.getElementById('evoBannerDesc');
    const evoIcon  = document.getElementById('evoIcon');
    if (stage === 1 && streakDays === 30) {
      evoBanner.style.display = 'flex';
      if (evoTitle) evoTitle.textContent = '¡Evolución Etapa 1! 🌱';
      if (evoDesc)  evoDesc.textContent  = `${getPetEmoji()} ha crecido con tu racha de 30 días`;
      if (evoIcon)  evoIcon.textContent  = '⬆️';
    } else if (stage === 2 && streakDays === 70) {
      evoBanner.style.display = 'flex';
      if (evoTitle) evoTitle.textContent = '¡Evolución Etapa 2! 🔥';
      if (evoDesc)  evoDesc.textContent  = `${getPetEmoji()} se ha vuelto más poderoso a los 70 días`;
      if (evoIcon)  evoIcon.textContent  = '✨';
    } else if (stage === 3 && streakDays === 100) {
      evoBanner.style.display = 'flex';
      if (evoTitle) evoTitle.textContent = '🌟 ¡Evolución Legendaria! 100 días';
      if (evoDesc)  evoDesc.textContent  = `¡${getPetEmoji()} alcanzó su forma suprema!`;
      if (evoIcon)  evoIcon.textContent  = '👑';
    } else {
      evoBanner.style.display = 'none';
    }
  }

  // Keep home card in sync
  syncHomePet();
}

function tapPet(e) {
  petTapCount++;
  // Increase happiness on tap (max 100, decays with days)
  petHp = Math.min(100, petHp + 5);
  syncMascotaDisplay();

  // Spawn sparkle at tap position
  const display = document.getElementById('mascotaDisplay');
  if (!display) return;
  const rect = display.getBoundingClientRect();
  const cx = (e.clientX || window.innerWidth/2) - rect.left;
  const cy = (e.clientY || rect.top) - rect.top;
  const sparkles = ['✨','⭐','💫','🌟','❤️','🎵'];
  for (let i = 0; i < 3; i++) {
    setTimeout(() => {
      const sp = document.createElement('div');
      sp.className = 'pet-sparkle';
      sp.textContent = sparkles[Math.floor(Math.random() * sparkles.length)];
      const sx = (Math.random() - .5) * 60;
      const sy = -(20 + Math.random() * 40);
      sp.style.cssText = `left:${cx + (Math.random()-.5)*30}px;top:${cy}px;--sx:${sx}px;--sy:${sy}px;`;
      display.appendChild(sp);
      setTimeout(() => sp.remove(), 750);
    }, i * 80);
  }

  // Every 5 taps give a coin
  if (petTapCount % 5 === 0) {
    coins += 1; updateCoinDisplay();
    showToast(`🐾 +1🪙 ¡${petName} te da una moneda!`);
  }
}

// Mascota HP decays if streak resets (called from renderStreakDots)
function updatePetFromStreak() {
  const targetHp = Math.min(100, 20 + streakDays * 10);
  petHp = Math.max(5, Math.min(100, targetHp));
  if (document.getElementById('mascotaBody')) syncMascotaDisplay();
  syncHomePet();
}

// ──────────────────────────
// SHOP / TIENDA
// ──────────────────────────
let coins = 0;
let currentShopTab = 0;
let pendingItem = null;
let modalBuyQty = 1;

function modalQtyChange(delta) {
  if (!pendingItem) return;
  const { item } = pendingItem;
  const maxQty = item.maxQty || 99;
  const maxAffordable = Math.floor(coins / item.price);
  modalBuyQty = Math.max(1, Math.min(modalBuyQty + delta, maxQty, maxAffordable));
  _updateModalQtyDisplay();
}

function _updateModalQtyDisplay() {
  if (!pendingItem) return;
  const { item } = pendingItem;
  const total = item.price * modalBuyQty;
  const canAfford = coins >= total;
  document.getElementById('modalQtyNum').textContent = modalBuyQty;
  document.getElementById('modalQtyTotal').textContent = `Total: 🪙${total}`;
  const confirmBtn = document.getElementById('modalConfirmBtn');
  confirmBtn.textContent = canAfford ? `Comprar ${modalBuyQty > 1 ? 'x'+modalBuyQty+' · ' : ''}🪙${total}` : 'Sin monedas';
  confirmBtn.disabled = !canAfford;
  document.getElementById('modalNoCoin').style.display = canAfford ? 'none' : 'block';
}

const SHOP_ITEMS = {
  temas: [
    { id:'t1',  name:'Noche Estelar', desc:'El tema clásico',           emoji:'🌌', price:0,   preview:'linear-gradient(135deg,#0d1b3e,#2a6496)',  owned:true,  equipped:true  },
    { id:'t2',  name:'Bosque Mágico', desc:'Verde profundo y sereno',    emoji:'🌿', price:80,  preview:'linear-gradient(135deg,#0d2818,#2e7d4f)',  owned:false, equipped:false },
    { id:'t3',  name:'Volcán',        desc:'Rojo ardiente e intenso',    emoji:'🌋', price:120, preview:'linear-gradient(135deg,#1a0a00,#c0440a)',  owned:false, equipped:false },
    { id:'t4',  name:'Galaxia',       desc:'Morado cósmico profundo',    emoji:'🔮', price:150, preview:'linear-gradient(135deg,#0e0a1e,#6a30c8)',  owned:false, equipped:false },
    { id:'t5',  name:'Coral Rosa',    desc:'Cálido y vibrante',          emoji:'🌸', price:100, preview:'linear-gradient(135deg,#1a0a12,#b8305a)',  owned:false, equipped:false },
    { id:'t6',  name:'Aurora',        desc:'Verde menta brillante',      emoji:'🌅', price:130, preview:'linear-gradient(135deg,#071a14,#0fba81)',  owned:false, equipped:false },
    { id:'t7',  name:'Sakura',        desc:'Rosa suave y delicado',      emoji:'🌺', price:110, preview:'linear-gradient(135deg,#1e0a18,#d4688a)',  owned:false, equipped:false },
    { id:'t8',  name:'Tormenta',      desc:'Azul oscuro eléctrico',      emoji:'⛈️', price:90,  preview:'linear-gradient(135deg,#0a0e1a,#4a6fa0)',  owned:false, equipped:false },
    { id:'t9',  name:'Desierto',      desc:'Naranja dorado cálido',      emoji:'🏜️', price:100, preview:'linear-gradient(135deg,#1c1008,#c8801a)',  owned:false, equipped:false },
    { id:'t10', name:'Ciberpunk',     desc:'Magenta neón futurista',     emoji:'🤖', price:200, preview:'linear-gradient(135deg,#080818,#e040fb)',  owned:false, equipped:false },
    { id:'t11', name:'Sangre',        desc:'Rojo oscuro intenso',        emoji:'🩸', price:180, preview:'linear-gradient(135deg,#1a0808,#cc2222)',  owned:false, equipped:false },
    { id:'t12', name:'Hielo',         desc:'Azul glacial cristalino',    emoji:'🧊', price:140, preview:'linear-gradient(135deg,#0a1828,#60c0e8)',  owned:false, equipped:false },
    { id:'t13', name:'Océano',          desc:'Profundidad del mar oscuro',  emoji:'🌊', price:110, preview:'linear-gradient(135deg,#021825,#0e7490)',  owned:false, equipped:false },
    { id:'t14', name:'Carbón',          desc:'Minimalismo oscuro total',    emoji:'🖤', price:90,  preview:'linear-gradient(135deg,#111111,#555555)',  owned:false, equipped:false },
  ],
  avatares: [
    { id:'a1', name:'Granjero',    desc:'El avatar por defecto',     emoji:'🧑‍🌾', price:0,   owned:true  },
    { id:'a2', name:'Programador', desc:'Para los tech lovers',      emoji:'🧑‍💻', price:50,  owned:false },
    { id:'a3', name:'Artista',     desc:'Creatividad sin límites',   emoji:'🧑‍🎨', price:50,  owned:false },
    { id:'a4', name:'Astronauta',  desc:'Conquistando el espacio',   emoji:'🧑‍🚀', price:80,  owned:false },
    { id:'a5', name:'Zorro',       desc:'Astuto y veloz',            emoji:'🦊',   price:60,  owned:false },
    { id:'a6', name:'Dragón',      desc:'Poder legendario',          emoji:'🐉',   price:200, owned:false },
    { id:'a7', name:'Robot',       desc:'Tecnología del futuro',     emoji:'🤖',   price:90,  owned:false },
    { id:'a8', name:'Mago',        desc:'Maestro de la magia',       emoji:'🧙',   price:120, owned:false },
  ],
  poderes: [
    { id:'p1', name:'Escudo de Racha',  desc:'Protege tu racha 1 día si la rompes', emoji:'🛡️', price:100, qty:0, maxQty:5 },
    { id:'p2', name:'Doble XP',         desc:'Duplica el XP por 1 hora',            emoji:'⚡',  price:150, qty:0, maxQty:3 },
    { id:'p3', name:'Super Focus',      desc:'+5 min a tu sesión de focus gratis',   emoji:'🎯', price:80,  qty:0, maxQty:10},
    { id:'p4', name:'Boost de Monedas', desc:'Gana +50% monedas por 24h',           emoji:'💰',  price:200, qty:0, maxQty:3 },
  ],
  badges: [
    { id:'b1',  name:'Principiante', desc:'Da tus primeros pasos',              emoji:'🌱', price:0,   owned:true,  og:false, ceo:false },
    { id:'b2',  name:'Disciplinado', desc:'7 días de racha consecutiva',        emoji:'📐', price:0,   owned:false, og:false, ceo:false },
    { id:'b3',  name:'Constante',    desc:'Completa 20 tareas en total',        emoji:'🔄', price:0,   owned:false, og:false, ceo:false },
    { id:'b4',  name:'Apasionado',   desc:'Usa la app 5 días seguidos',         emoji:'❤️‍🔥', price:0,  owned:false, og:false, ceo:false },
    { id:'b5',  name:'Estrella',     desc:'Alcanza 200 XP',                     emoji:'⭐', price:0,   owned:false, og:false, ceo:false },
    { id:'b6',  name:'Genio',        desc:'Completa todas las secciones',       emoji:'🧠', price:0,   owned:false, og:false, ceo:false },
    { id:'b7',  name:'Prodigio',     desc:'Alcanza el nivel 10',                emoji:'🚀', price:150, owned:false, og:false, ceo:false },
    { id:'b8',  name:'GOAT',         desc:'30 días de racha legendaria',        emoji:'🐐', price:250, owned:false, og:false, ceo:false },
    { id:'b9',  name:'Leyenda',      desc:'500 XP acumulados',                  emoji:'🏆', price:300, owned:false, og:false, ceo:false },
    { id:'b10', name:'Irreal',       desc:'El badge casi imposible de obtener', emoji:'👁️', price:750, owned:false, og:false, ceo:false },
    { id:'b11', name:'OG',           desc:'Exclusivo para los primeros usuarios', emoji:'OG', price:250, owned:false, og:true,  ceo:false, gang:false },
    { id:'b12', name:'CEO',          desc:'Inalcanzable. Solo existe en las leyendas.', emoji:'CEO', price:0, owned:false, og:false, ceo:true, gang:false },
    { id:'b13', name:'GANG',         desc:'Solo para los de la banda.', emoji:'GANG', price:0, owned:false, og:false, ceo:false, gang:true },
    { id:'b14', name:'???',          desc:'Nadie sabe qué hay detrás de esto...', emoji:'❓', price:100000, owned:false, og:false, ceo:false, gang:false, mystery:true },
    { id:'b15', name:'Duo?',         desc:'100 días de racha. ¿Quién te acompaña?', emoji:'🦉', price:0, owned:false, og:false, ceo:false, gang:false, streakRequired:100 },
    { id:'b16', name:'GymBros',      desc:'Asigna a alguien como tu GymBro.', emoji:'💪', price:0, owned:false, og:false, ceo:false, gang:false, gymbro:true },
    { id:'b17', name:'Luck', desc:'Obtenido en la Ruleta de la Suerte.', emoji:'🍀', price:0, owned:false, og:false, ceo:false, gang:false, luck:true, roulette:true },
  ],
};

const SHOP_THEME_MAP = { t2:1, t3:2, t4:3, t5:4, t6:6, t7:8, t8:9, t9:10, t10:11, t11:12, t12:13, t13:5, t14:7 };

function updateCoinDisplay() {
  document.getElementById('coinDisplay').textContent    = coins;
  document.getElementById('shopCoinDisplay').textContent = coins;
  document.getElementById('shopCoinBig').textContent    = coins;
}

function earnCoins(amount, reason) {
  coins += amount;
  updateCoinDisplay();
  showToast(`+${amount} 🪙 ${reason}`);
}

function switchShopTab(idx, el) {
  currentShopTab = idx;
  document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderShopTab(idx);
}

function renderShopTab(idx) {
  const container = document.getElementById('shopTabContent');
  container.innerHTML = '';
  const tabs = ['temas','avatares','poderes','badges'];
  const key  = tabs[idx];
  const items = SHOP_ITEMS[key];

  if (key === 'poderes') {
    // List layout for powers
    const list = document.createElement('div');
    list.className = 'shop-list';
    items.forEach(item => {
      const el = document.createElement('div');
      el.className = 'shop-list-item' + (item.qty > 0 ? ' owned' : '');
      const svgIcon = SHOP_SVGS[item.id];
      el.innerHTML = `
        <div class="sli-icon" style="background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.03));">${svgIcon ? `<div class="shop-svg-icon">${svgIcon}</div>` : item.emoji}</div>
        <div class="sli-info">
          <div class="sli-name">${item.name}</div>
          <div class="sli-desc">${item.desc}${item.qty>0?` · <span style="color:var(--green)">Tienes: ${item.qty}</span>`:''}</div>
        </div>
        <div class="sli-price"><span class="pc">🪙</span><span>${item.price}</span></div>`;
      el.onclick = () => openShopModal(item, key);
      list.appendChild(el);
    });
    container.appendChild(list);
    return;
  }

  // Grid layout for themes, avatars, badges
  const grid = document.createElement('div');
  grid.className = 'shop-grid';
  items.forEach(item => {
    const el = document.createElement('div');
    const isOwned    = item.owned;
    const isEquipped = item.equipped;
    el.className = 'shop-card' + (isEquipped ? ' equipped' : isOwned ? ' owned' : '');

    let previewStyle = '';
    if (key === 'temas')    previewStyle = `background:${item.preview};border-radius:14px;`;
    if (key === 'avatares') previewStyle = `background:linear-gradient(135deg,var(--teal),var(--navy-mid));border-radius:50%;`;
    if (key === 'badges')   previewStyle = `background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.03));border-radius:50%;`;

    // CEO badge is not sold in the shop — skip it
    if (item.ceo) return;
    // GymBros, streak badges and luck badges are not sold — they're earned/won
    if (item.gymbro || item.streakRequired || item.luck) return;

    // Use SVG icon if available, else fall back to emoji
    const svgAvatar = SHOP_SVGS[item.id];
    const previewContent = item.og
      ? `<div style="position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:14px;">
           <div class="og-badge-glow"></div>
           <span class="og-badge-text">OG</span>
         </div>`
      : item.mystery
        ? `<div style="position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:14px;">
             <div class="mystery-badge-glow"></div>
             <span class="mystery-badge-text">???</span>
           </div>`
        : (key === 'avatares' && svgAvatar)
          ? `<div class="shop-svg-icon">${svgAvatar}</div>`
          : item.emoji;

    el.innerHTML = `
      <div class="shop-card-preview" style="${previewStyle}">${previewContent}</div>
      <div class="shop-card-name">${item.name}</div>
      <div class="shop-card-desc">${item.desc}</div>
      <div class="shop-card-price${item.price===0?' free':''}">
        <span class="pc">${item.price===0?'✓':'🪙'}</span>
        <span>${item.price===0?(isOwned?'Gratis':'Gratis'):`${item.price}`}</span>
      </div>`;
    el.onclick = () => openShopModal(item, key);
    grid.appendChild(el);
  });
  container.appendChild(grid);
}

function openShopModal(item, category) {
  pendingItem = { item, category };
  modalBuyQty = 1;
  const modalEmojiEl = document.getElementById('modalEmoji');
  if (item.ceo) {
    modalEmojiEl.innerHTML = `<div style="position:relative;display:inline-flex;align-items:center;justify-content:center;width:64px;height:64px;"><div class="ceo-badge-glow"></div><span class="ceo-badge-text" style="font-size:36px;">CEO</span></div>`;
  } else if (item.og) {
    modalEmojiEl.innerHTML = `<div style="position:relative;display:inline-flex;align-items:center;justify-content:center;width:64px;height:64px;"><div class="og-badge-glow"></div><span class="og-badge-text" style="font-size:36px;">OG</span></div>`;
  } else if (item.mystery) {
    modalEmojiEl.innerHTML = `<div style="position:relative;display:inline-flex;align-items:center;justify-content:center;width:64px;height:64px;"><div class="mystery-badge-glow"></div><span class="mystery-badge-text" style="font-size:36px;">???</span></div>`;
  } else {
    const svgIcon = SHOP_SVGS[item.id];
    if (svgIcon && (category === 'avatares' || category === 'poderes')) {
      modalEmojiEl.innerHTML = `<div style="width:52px;height:52px;display:flex;align-items:center;justify-content:center;">${svgIcon.replace('width:32px;height:32px','width:48px;height:48px').replace('width:26px;height:26px','width:48px;height:48px')}</div>`;
    } else {
      modalEmojiEl.textContent = item.emoji;
    }
  }
  document.getElementById('modalName').textContent  = item.name;
  document.getElementById('modalPrice').textContent = item.price;
  document.getElementById('modalNoCoin').style.display = 'none';

  // Show multi-buy only for poderes
  const qtySection = document.getElementById('modalQtySection');
  if (category === 'poderes' && !item.owned && item.price > 0) {
    qtySection.style.display = 'block';
    document.getElementById('modalQtyNum').textContent = '1';
    document.getElementById('modalQtyTotal').textContent = `Total: 🪙${item.price}`;
  } else {
    qtySection.style.display = 'none';
  }

  const confirmBtn = document.getElementById('modalConfirmBtn');
  const desc = document.getElementById('modalDesc');

  if (item.owned || item.equipped) {
    if (category === 'temas') {
      desc.textContent = item.equipped ? 'Este tema ya está activo.' : '¿Aplicar este tema?';
      confirmBtn.textContent = item.equipped ? 'Ya activo' : 'Aplicar';
      confirmBtn.disabled = item.equipped;
    } else if (category === 'avatares') {
      desc.textContent = '¿Equipar este avatar?';
      confirmBtn.textContent = 'Equipar'; confirmBtn.disabled = false;
    } else if (category === 'poderes') {
      desc.textContent = item.desc + ` · Tienes: ${item.qty}`;
      confirmBtn.textContent = `Comprar más · 🪙${item.price}`;
      confirmBtn.disabled = coins < item.price;
      if (coins < item.price) document.getElementById('modalNoCoin').style.display = 'block';
      qtySection.style.display = 'block';
      document.getElementById('modalQtyNum').textContent = '1';
      document.getElementById('modalQtyTotal').textContent = `Total: 🪙${item.price}`;
    } else {
      desc.textContent = item.desc; confirmBtn.textContent = 'Cerrar'; confirmBtn.disabled = false;
    }
  } else if (item.price === 0) {
    desc.textContent = item.desc + ' · ¡Es gratis!';
    confirmBtn.textContent = 'Obtener'; confirmBtn.disabled = false;
  } else {
    desc.textContent = item.desc;
    if (category === 'poderes') {
      _updateModalQtyDisplay();
    } else {
      const canAfford = coins >= item.price;
      confirmBtn.textContent = canAfford ? `Comprar · 🪙${item.price}` : 'Sin monedas';
      confirmBtn.disabled = !canAfford;
      if (!canAfford) document.getElementById('modalNoCoin').style.display = 'block';
    }
  }

  document.getElementById('shopModal').classList.add('open');
}

function closeShopModal() {
  document.getElementById('shopModal').classList.remove('open');
  pendingItem = null;
}

function confirmPurchase() {
  if (!pendingItem) return;
  const { item, category } = pendingItem;

  if (item.equipped) { closeShopModal(); return; }

  // For poderes, use modalBuyQty
  const qty = category === 'poderes' ? (modalBuyQty || 1) : 1;
  const totalCost = item.price * qty;

  if (item.price > 0) {
    if (category === 'poderes') {
      if (coins < totalCost) return;
      coins -= totalCost;
    } else if (!item.owned) {
      if (coins < item.price) return;
      coins -= item.price;
    }
    updateCoinDisplay();
  }

  // Apply effects
  if (category === 'temas') {
    SHOP_ITEMS.temas.forEach(t => t.equipped = false);
    item.owned = true; item.equipped = true;
    const themeIdx = SHOP_THEME_MAP[item.id];
    if (themeIdx !== undefined) {
      // Unlock in THEMES array so it shows in Apariencia
      THEMES[themeIdx].unlocked = true;
      applyTheme(themeIdx);
    } else {
      applyTheme(0);
    }
    showToast(`🎨 Tema "${item.name}" aplicado y desbloqueado en Apariencia!`);
  } else if (category === 'avatares') {
    item.owned = true;
    ['profileAvatarHome','profileAvatarPanel','cfgAvatarEmoji'].forEach(id => {
      const el = document.getElementById(id); if (el) el.textContent = item.emoji;
    });
    showToast(`${item.emoji} Avatar equipado!`);
  } else if (category === 'poderes') {
    const bought = modalBuyQty || 1;
    item.qty = (item.qty||0) + bought;
    showToast(`${item.emoji} ${item.name} x${bought} obtenido! (Total: ${item.qty})`);
    launchConfetti(window.innerWidth/2, window.innerHeight/2);
  } else if (category === 'badges') {
    item.owned = true;
    showToast(`🏅 Badge "${item.name}" desbloqueado!`);
    xp += 15; updateXP();
    launchConfetti(window.innerWidth/2, window.innerHeight/2);
  }

  if (item.price > 0) launchConfetti(window.innerWidth/2, window.innerHeight/2);
  closeShopModal();
  renderShopTab(currentShopTab);
}

function showEarnInfo() {
  showToast('✅ Tarea: +2🪙 · 🔥 Racha diaria: +5🪙');
}

function closeTienda() {
  closePanel('tienda');
  // reset nav active state
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('navHome').classList.add('active');
}

// Override goHome to reset nav correctly
const _origGoHome = goHome;
window.goHome = function() {
  _origGoHome();
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('navHome').classList.add('active');
};

// ──────────────────────────
// INVENTARIO
// ──────────────────────────
let currentInvTab = 0;
let equippedBadgeIds = []; // up to 3 badges at once

function switchInvTab(idx, el) {
  currentInvTab = idx;
  document.querySelectorAll('#invTabs .shop-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderInvTab(idx);
}

function renderInvTab(idx) {
  const container = document.getElementById('invTabContent');
  container.innerHTML = '';

  if (idx === 0) renderInvPowers(container);
  else if (idx === 1) renderInvBadges(container);
  else if (idx === 2) renderInvAvatars(container);
}

function renderInvPowers(container) {
  const owned = SHOP_ITEMS.poderes.filter(p => p.qty > 0);

  if (owned.length === 0) {
    container.innerHTML = `
      <div class="inv-empty">
        <div class="inv-empty-icon">⚡</div>
        <div class="inv-empty-text">No tienes poderes aún.<br>¡Visita la tienda para conseguirlos!</div>
        <button class="inv-empty-btn" onclick="openPanel('tienda')">Ir a la tienda 🛒</button>
      </div>`;
    return;
  }

  const list = document.createElement('div');
  list.style.cssText = 'display:flex;flex-direction:column;gap:9px;';

  owned.forEach(item => {
    const card = document.createElement('div');
    card.className = 'inv-power-card';
    card.innerHTML = `
      <div class="inv-power-icon">${item.emoji}</div>
      <div class="inv-power-info">
        <div class="inv-power-name">${item.name}</div>
        <div class="inv-power-desc">${item.desc}</div>
        <div class="inv-power-qty">x${item.qty} disponibles</div>
      </div>
      <button class="inv-use-btn" ${item.qty<=0?'disabled':''} onclick="usePower('${item.id}',this)">
        Usar
      </button>`;
    list.appendChild(card);
  });

  // Also show all powers with qty=0 as greyed out
  const notOwned = SHOP_ITEMS.poderes.filter(p => p.qty === 0);
  if (notOwned.length > 0) {
    const sep = document.createElement('div');
    sep.style.cssText = 'color:rgba(255,255,255,.2);font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;padding:4px 2px;';
    sep.textContent = 'Sin existencias';
    list.appendChild(sep);
    notOwned.forEach(item => {
      const card = document.createElement('div');
      card.className = 'inv-power-card';
      card.style.opacity = '.4';
      card.innerHTML = `
        <div class="inv-power-icon">${item.emoji}</div>
        <div class="inv-power-info">
          <div class="inv-power-name">${item.name}</div>
          <div class="inv-power-desc">${item.desc}</div>
          <div class="inv-power-qty" style="background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.12);color:rgba(255,255,255,.3);">x0</div>
        </div>
        <button class="inv-use-btn" disabled>Usar</button>`;
      list.appendChild(card);
    });
  }

  container.appendChild(list);
}

function renderInvBadges(container) {
  const owned    = SHOP_ITEMS.badges.filter(b => b.owned && !b.ceo && !b.gang && !b.luck);
  const notOwned = SHOP_ITEMS.badges.filter(b => !b.owned && !b.ceo && !b.gang && !b.luck);
  const ceoBadge  = SHOP_ITEMS.badges.find(b => b.ceo);
  const gangBadge = SHOP_ITEMS.badges.find(b => b.gang);
  const isVIP = (regData.email || '').toLowerCase().trim() === 'carretoleonardo2312@gmail.com';

  // Equipped badges header
  if (equippedBadgeIds.length > 0) {
    const header = document.createElement('div');
    header.style.cssText = 'display:flex;align-items:center;gap:6px;background:rgba(240,192,64,.08);border:1.5px solid rgba(240,192,64,.2);border-radius:12px;padding:8px 12px;margin-bottom:6px;flex-wrap:wrap;';
    const label = document.createElement('div');
    label.style.cssText = 'color:var(--yellow);font-size:10px;font-weight:800;width:100%;margin-bottom:2px;';
    label.textContent = `Badges equipados (${equippedBadgeIds.length}/3)`;
    header.appendChild(label);
    equippedBadgeIds.forEach(bid => {
      const b = SHOP_ITEMS.badges.find(x => x.id === bid);
      if (!b) return;
      const chip = document.createElement('div');
      chip.style.cssText = 'display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.06);border-radius:8px;padding:3px 8px;font-size:11px;color:#fff;';
      if (b.ceo) chip.innerHTML = `<span class="ceo-badge-text" style="font-size:10px;">CEO</span>`;
      else if (b.gang) chip.innerHTML = `<span class="gang-badge-text" style="font-size:10px;">GANG</span>`;
      else if (b.luck) chip.innerHTML = `<span style="color:#5edc8a;font-family:'Special Elite',cursive;font-size:10px;font-weight:900;text-shadow:0 0 6px rgba(94,220,138,.5);">🍀 Luck 🍀</span>`;
      else if (b.og) chip.innerHTML = `<span class="og-badge-text" style="font-size:10px;">OG</span>`;
      else chip.innerHTML = `${b.emoji} ${b.name}`;
      header.appendChild(chip);
    });
    container.appendChild(header);
  }

  // Empty state
  if (owned.length === 0) {
    const empty = document.createElement('div');
    empty.innerHTML = `<div class="inv-empty"><div class="inv-empty-icon">🏅</div><div class="inv-empty-text">No tienes badges aún.<br>¡Completa logros o visita la tienda!</div><button class="inv-empty-btn" onclick="openPanel('tienda')">Ir a la tienda 🛒</button></div>`;
    container.appendChild(empty);
  } else {
    const grid = document.createElement('div');
    grid.className = 'inv-badge-grid';
    owned.forEach(item => {
      const isEquipped = equippedBadgeIds.includes(item.id);
      const isOG = item.og === true;
      const isMystery = item.mystery === true;
      const isGymbroBadge = item.gymbro === true;
      const card = document.createElement('div');
      card.className = 'inv-badge-card' + (isEquipped ? ' equipped-badge' : '') + (isOG ? ' og-card' : '') + (isMystery ? ' mystery-card' : '') + (isGymbroBadge ? ' gymbro-card' : '');
      const emojiHtml = isOG
        ? `<div style="position:relative;width:56px;height:56px;display:flex;align-items:center;justify-content:center;"><div class="og-badge-glow"></div><span class="og-badge-text">OG</span></div>`
        : isMystery
          ? `<div style="position:relative;width:56px;height:56px;display:flex;align-items:center;justify-content:center;"><div class="mystery-badge-glow"></div><span class="mystery-badge-text">???</span></div>`
          : isGymbroBadge
            ? `<div style="position:relative;width:56px;height:56px;display:flex;align-items:center;justify-content:center;"><div class="gymbro-badge-glow"></div><span style="font-size:32px;">💪</span></div>`
            : `<div class="inv-badge-emoji">${item.emoji}</div>`;
      card.innerHTML = `
        ${emojiHtml}
        <div class="inv-badge-name">${item.name}</div>
        <div class="inv-badge-desc">${item.desc}</div>
        <button class="inv-badge-equip ${isEquipped ? 'unequip-btn' : 'equip-btn'}" onclick="toggleBadge('${item.id}')">
          ${isEquipped ? '✓ Quitar' : 'Equipar'}
        </button>`;
      grid.appendChild(card);
    });
    container.appendChild(grid);
  }

  // Locked badges
  if (notOwned.length > 0) {
    const sep = document.createElement('div');
    sep.style.cssText = 'color:rgba(255,255,255,.2);font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;padding:4px 2px;margin-top:6px;';
    sep.textContent = 'Por conseguir';
    container.appendChild(sep);
    const lockedGrid = document.createElement('div');
    lockedGrid.className = 'inv-badge-grid';
    notOwned.forEach(item => {
      const isOG = item.og === true;
      const isMystery = item.mystery === true;
      const isGymbroBadge = item.gymbro === true;
      const card = document.createElement('div');
      card.className = 'inv-badge-card' + (isOG ? ' og-card' : '');
      card.style.cssText = 'opacity:.35;cursor:default;';
      const lockedEmoji = isOG
        ? `<div style="position:relative;width:56px;height:56px;display:flex;align-items:center;justify-content:center;filter:grayscale(1);"><div class="og-badge-glow" style="opacity:.15;"></div><span class="og-badge-text" style="filter:grayscale(1);">OG</span></div>`
        : isMystery
          ? `<div style="position:relative;width:56px;height:56px;display:flex;align-items:center;justify-content:center;filter:grayscale(1);"><span style="font-size:28px;filter:grayscale(1);">❓</span></div>`
          : `<div class="inv-badge-emoji" style="filter:grayscale(1);">🔒</div>`;
      const hintText = item.streakRequired
        ? `🔥 ${item.streakRequired} días de racha`
        : isGymbroBadge
          ? '💪 Asigna un GymBro'
          : item.price > 0
            ? `🪙${item.price}`
            : 'Logro';
      card.innerHTML = `${lockedEmoji}<div class="inv-badge-name">${item.name}</div><div class="inv-badge-desc">${item.desc}</div><div style="font-size:9px;color:rgba(255,255,255,.25);font-weight:700;">${hintText}</div>`;
      lockedGrid.appendChild(card);
    });
    container.appendChild(lockedGrid);
  }

  // ── ROULETTE badges section ── (separate from normal badges)
  const rouletteSectionSep = document.createElement('div');
  rouletteSectionSep.style.cssText = 'margin-top:16px;margin-bottom:4px;';
  rouletteSectionSep.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <div style="flex:1;height:1px;background:rgba(94,220,138,.2);"></div>
      <div style="color:rgba(94,220,138,.7);font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:2px;white-space:nowrap;">🍀 Badges de la Ruleta</div>
      <div style="flex:1;height:1px;background:rgba(94,220,138,.2);"></div>
    </div>
    <div style="color:rgba(255,255,255,.25);font-size:10px;text-align:center;margin-bottom:10px;">Solo se obtienen girando la Ruleta de la Suerte · 1% de probabilidad</div>
  `;
  container.appendChild(rouletteSectionSep);

  // ── LUCK badge ── (roulette only)
  const luckBadge = SHOP_ITEMS.badges.find(b => b.luck);
  if (luckBadge) {
    const luckSep = document.createElement('div');
    luckSep.style.cssText = 'display:none;';
    luckSep.innerHTML = '';
    container.appendChild(luckSep);
    const isEquipped = equippedBadgeIds.includes(luckBadge.id);
    const luckCard = document.createElement('div');
    luckCard.className = luckBadge.owned ? 'inv-badge-card luck-card' : 'inv-badge-card';
    if (!luckBadge.owned) luckCard.style.opacity = '.3';
    luckCard.innerHTML = luckBadge.owned
      ? `<div style="position:relative;width:64px;height:64px;display:flex;align-items:center;justify-content:center;">
          <div style="position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle,rgba(94,220,138,.4) 0%,transparent 70%);animation:luckGlowFade 2.5s ease-in-out infinite;"></div>
          <span style="font-size:11px;font-family:'Special Elite',cursive;font-weight:900;color:#5edc8a;letter-spacing:2px;text-align:center;line-height:1.4;text-shadow:0 0 8px rgba(94,220,138,.6);">🍀<br>Luck<br>🍀</span>
        </div>
        <div class="inv-badge-name" style="color:#5edc8a;">Luck</div>
        <div class="inv-badge-desc" style="color:rgba(94,220,138,.5);">Ruleta · 1% de suerte</div>
        <button class="inv-badge-equip ${isEquipped ? 'unequip-btn' : 'equip-btn'}" onclick="toggleBadge('b17')">${isEquipped ? '✓ Quitar' : 'Equipar'}</button>`
      : `<div style="width:56px;height:56px;display:flex;align-items:center;justify-content:center;font-size:28px;filter:grayscale(1);">🔒</div>
         <div class="inv-badge-name">Luck</div>
         <div class="inv-badge-desc">Gira la Ruleta de la Suerte</div>
         <div style="font-size:9px;color:rgba(255,255,255,.2);font-weight:700;">🍀 Ruleta · 1%</div>`;
    const luckGrid = document.createElement('div');
    luckGrid.style.cssText = 'display:grid;grid-template-columns:1fr;';
    luckGrid.appendChild(luckCard);
    container.appendChild(luckGrid);
  }

  // ── GANG badge ── (VIP only, toggleable)
  if (gangBadge) {
    const gangSep = document.createElement('div');
    gangSep.style.cssText = 'color:rgba(150,150,150,.3);font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;padding:4px 2px;margin-top:8px;display:flex;align-items:center;gap:6px;';
    gangSep.innerHTML = isVIP
      ? `<span style="flex:1;height:1px;background:rgba(120,120,120,.15);display:block;"></span>🖤 Exclusivo<span style="flex:1;height:1px;background:rgba(120,120,120,.15);display:block;"></span>`
      : `<span style="flex:1;height:1px;background:rgba(120,120,120,.15);display:block;"></span>Inalcanzable<span style="flex:1;height:1px;background:rgba(120,120,120,.15);display:block;"></span>`;
    container.appendChild(gangSep);

    const isEquipped = equippedBadgeIds.includes(gangBadge.id);
    const gangCard = document.createElement('div');
    gangCard.className = 'inv-badge-card gang-card';
    if (!isVIP) gangCard.style.opacity = '.4';
    gangCard.innerHTML = `
      <div style="position:relative;width:64px;height:64px;display:flex;align-items:center;justify-content:center;">
        <div class="gang-badge-glow"></div>
        <span class="gang-badge-text" style="font-size:18px;letter-spacing:2px;">GANG</span>
      </div>
      <div class="inv-badge-name" style="color:#aaa;">GANG</div>
      <div class="inv-badge-desc">${gangBadge.desc}</div>
      ${isVIP
        ? `<button class="inv-badge-equip ${isEquipped ? 'unequip-btn' : 'equip-btn'}" onclick="toggleBadge('${gangBadge.id}')">${isEquipped ? '✓ Quitar' : 'Equipar'}</button>`
        : `<div class="ceo-locked-label">🚫 Inalcanzable</div>`
      }`;
    const gangGrid = document.createElement('div');
    gangGrid.style.cssText = 'display:grid;grid-template-columns:1fr;';
    gangGrid.appendChild(gangCard);
    container.appendChild(gangGrid);
  }

  // ── CEO badge ── (VIP only, toggleable)
  if (ceoBadge) {
    const ceoSep = document.createElement('div');
    ceoSep.style.cssText = 'color:rgba(245,208,96,.3);font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;padding:4px 2px;margin-top:8px;display:flex;align-items:center;gap:6px;';
    ceoSep.innerHTML = isVIP
      ? `<span style="flex:1;height:1px;background:rgba(245,208,96,.15);display:block;"></span>👑 Exclusivo<span style="flex:1;height:1px;background:rgba(245,208,96,.15);display:block;"></span>`
      : `<span style="flex:1;height:1px;background:rgba(245,208,96,.15);display:block;"></span>Inalcanzable<span style="flex:1;height:1px;background:rgba(245,208,96,.15);display:block;"></span>`;
    container.appendChild(ceoSep);

    const isEquipped = equippedBadgeIds.includes(ceoBadge.id);
    const ceoCard = document.createElement('div');
    ceoCard.className = 'inv-badge-card ceo-card';
    ceoCard.innerHTML = `
      <div style="position:relative;width:64px;height:64px;display:flex;align-items:center;justify-content:center;">
        <div class="ceo-badge-glow"></div>
        <span class="ceo-badge-text">CEO</span>
      </div>
      <div class="inv-badge-name" style="background:linear-gradient(90deg,#f5d060,#fff,#1a1a1a,#f5d060);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:ceoShift 4s ease-in-out infinite;">CEO</div>
      <div class="inv-badge-desc">${ceoBadge.desc}</div>
      ${isVIP
        ? `<button class="inv-badge-equip ${isEquipped ? 'unequip-btn' : 'equip-btn'}" onclick="toggleBadge('${ceoBadge.id}')">${isEquipped ? '✓ Quitar' : 'Equipar'}</button>`
        : `<div class="ceo-locked-label">🚫 Inalcanzable</div>`
      }`;
    const ceoGrid = document.createElement('div');
    ceoGrid.style.cssText = 'display:grid;grid-template-columns:1fr;';
    ceoGrid.appendChild(ceoCard);
    container.appendChild(ceoGrid);
  }
}


// ── All emoji avatars available (same as AVATARS + extra shop ones) ──
const ALL_AVATAR_EMOJIS = [
  '🧑‍🌾','🧑‍💻','🧑‍🎨','🧑‍🚀','🦊','🐺','🐉','🦁','🐙','🎭',
  '🤖','👾','🦸','🧙','🧝','🧜','🐱','🐶','🐸','🐧',
  '🦋','🐨','🦄','🐼','🦊','🐻','🦅','🦉','🐯','🐮',
  '😎','🤓','🥸','😈','👿','💀','☠️','🤡','👽','👻',
  '🧑‍🔬','🧑‍🏫','🧑‍⚕️','🧑‍✈️','🧑‍🎤','🧑‍🍳','🧑‍🎯','🧑‍💼','🥷','🤺',
];

let equippedAvatarEmoji = null; // null means use photo or default

function renderInvAvatars(container) {
  const hasPhoto = !!(localStorage.getItem('profilePhoto'));
  const currentEmoji = document.getElementById('profileAvatarHome')?.textContent || '🧑‍🌾';

  // ── Preview card ──
  const previewCard = document.createElement('div');
  previewCard.className = 'inv-avatar-preview-card';

  const previewWrap = document.createElement('div');
  previewWrap.className = 'inv-avatar-preview-wrap';
  const previewEmoji = document.createElement('div');
  previewEmoji.className = 'inv-avatar-preview-emoji';
  previewEmoji.id = 'invAvatarPreviewEmoji';
  previewEmoji.textContent = currentEmoji;
  const previewImg = document.createElement('img');
  previewImg.className = 'inv-avatar-preview-img';
  previewImg.id = 'invAvatarPreviewImg';
  if (hasPhoto) {
    previewImg.src = localStorage.getItem('profilePhoto');
    previewImg.style.display = 'block';
    previewEmoji.style.display = 'none';
  }
  previewWrap.appendChild(previewEmoji);
  previewWrap.appendChild(previewImg);

  const previewLabel = document.createElement('div');
  previewLabel.className = 'inv-avatar-preview-label';
  previewLabel.textContent = 'Tu avatar actual';
  const previewName = document.createElement('div');
  previewName.className = 'inv-avatar-preview-name';
  previewName.id = 'invAvatarPreviewName';
  previewName.textContent = hasPhoto ? 'Foto personalizada' : currentEmoji;

  // Photo upload button
  const photoBtn = document.createElement('button');
  photoBtn.className = 'inv-avatar-photo-btn';
  photoBtn.innerHTML = '📷 Subir foto desde archivos';
  photoBtn.onclick = () => document.getElementById('photoInput').click();

  // Photo remove button
  const photoRemoveBtn = document.createElement('button');
  photoRemoveBtn.className = 'inv-avatar-photo-remove';
  photoRemoveBtn.id = 'invPhotoRemoveBtn';
  photoRemoveBtn.innerHTML = '✕ Quitar foto';
  if (hasPhoto) photoRemoveBtn.style.display = 'block';
  photoRemoveBtn.onclick = () => {
    removePhoto();
    previewImg.style.display = 'none';
    previewEmoji.style.display = '';
    photoRemoveBtn.style.display = 'none';
    previewName.textContent = previewEmoji.textContent;
    // Re-highlight grid
    document.querySelectorAll('.inv-avatar-btn').forEach(b => {
      b.classList.toggle('equipped', b.dataset.emoji === previewEmoji.textContent);
    });
    showToast('Foto eliminada, usando emoji');
  };

  previewCard.appendChild(previewWrap);
  previewCard.appendChild(previewLabel);
  previewCard.appendChild(previewName);
  previewCard.appendChild(photoBtn);
  previewCard.appendChild(photoRemoveBtn);
  container.appendChild(previewCard);

  // ── Owned avatares from shop ──
  const ownedShop = SHOP_ITEMS.avatares.filter(a => a.owned);
  const lockedShop = SHOP_ITEMS.avatares.filter(a => !a.owned);

  // ── All emojis section label ──
  const secLabel = document.createElement('div');
  secLabel.className = 'inv-avatar-section-label';
  secLabel.textContent = 'Emojis disponibles';
  container.appendChild(secLabel);

  const grid = document.createElement('div');
  grid.className = 'inv-avatar-grid';

  // Combine AVATARS (all free emojis) + ALL_AVATAR_EMOJIS
  const allFree = [...new Set([...ALL_AVATAR_EMOJIS])];
  const currentActive = hasPhoto ? null : currentEmoji;

  allFree.forEach(emoji => {
    const btn = document.createElement('div');
    btn.className = 'inv-avatar-btn' + (currentActive === emoji ? ' equipped' : '');
    btn.dataset.emoji = emoji;
    btn.innerHTML = `${emoji}<div class="av-check">✓</div>`;
    btn.onclick = () => equipAvatarEmoji(emoji, btn, previewEmoji, previewImg, previewName, photoRemoveBtn);
    grid.appendChild(btn);
  });

  container.appendChild(grid);

  // ── Shop avatares (locked) ──
  if (lockedShop.length > 0) {
    const lockedLabel = document.createElement('div');
    lockedLabel.className = 'inv-avatar-section-label';
    lockedLabel.textContent = 'Disponibles en tienda';
    container.appendChild(lockedLabel);

    const lockedGrid = document.createElement('div');
    lockedGrid.className = 'inv-avatar-grid';
    lockedShop.forEach(item => {
      const btn = document.createElement('div');
      btn.className = 'inv-avatar-btn locked';
      btn.dataset.emoji = item.emoji;
      btn.innerHTML = item.emoji;
      btn.title = `${item.name} — 🪙${item.price}`;
      btn.onclick = () => { openPanel('tienda'); showToast(`🛒 "${item.name}" disponible en la tienda`); };
      lockedGrid.appendChild(btn);
    });
    container.appendChild(lockedGrid);
  }
}

function equipAvatarEmoji(emoji, btn, previewEmojiEl, previewImgEl, previewNameEl, photoRemoveBtn) {
  // Remove photo if active
  if (localStorage.getItem('profilePhoto')) {
    removePhoto();
    if (previewImgEl) previewImgEl.style.display = 'none';
    if (photoRemoveBtn) photoRemoveBtn.style.display = 'none';
  }
  // Set emoji as avatar
  const targets = ['profileAvatarHome','profileAvatarPanel','cfgAvatarEmoji'];
  targets.forEach(id => { const el = document.getElementById(id); if (el) el.textContent = emoji; });
  // Hide any active photos
  ['profileImgHome','profileImgPanel','cfgAvatarImg'].forEach(id => {
    const el = document.getElementById(id); if (el) el.style.display = 'none';
  });
  ['profileAvatarHome','profileAvatarPanel','cfgAvatarEmoji'].forEach(id => {
    const el = document.getElementById(id); if (el) el.style.display = '';
  });
  // Update preview
  if (previewEmojiEl) { previewEmojiEl.textContent = emoji; previewEmojiEl.style.display = ''; }
  if (previewNameEl) previewNameEl.textContent = emoji;
  // Update grid highlight
  document.querySelectorAll('.inv-avatar-btn').forEach(b => {
    b.classList.toggle('equipped', b.dataset.emoji === emoji);
  });
  // Update regData
  regData.avatar = emoji;
  equippedAvatarEmoji = emoji;
  // Save
  if (window._fbAuth?.currentUser) saveAccount();
  showToast(`Avatar ${emoji} equipado!`);
  launchConfetti(window.innerWidth/2, window.innerHeight/3);
}

function usePower(id, btn) {
  const item = SHOP_ITEMS.poderes.find(p => p.id === id);
  if (!item || item.qty <= 0) return;

  item.qty--;

  // Apply power effect
  if (id === 'p1') {
    // Streak shield — just a visual + message
    streakDays = Math.max(streakDays, 1);
    renderStreakDots();
    showToast('🛡️ ¡Racha protegida por 1 día!');
  } else if (id === 'p2') {
    xp += 20; updateXP();
    showToast('⚡ ¡Doble XP activado! +20 XP');
  } else if (id === 'p3') {
    focusMinutes = Math.min(120, focusMinutes + 5);
    document.getElementById('focusVal') && (document.getElementById('focusVal').textContent = focusMinutes);
    document.getElementById('focusLabel') && (document.getElementById('focusLabel').textContent = focusMinutes + ' min');
    showToast('🎯 +5 min a tu sesión de focus');
  } else if (id === 'p4') {
    coins += 30; updateCoinDisplay();
    showToast('💰 ¡Boost activo! +30 🪙 bonus');
  }

  launchConfetti(window.innerWidth / 2, window.innerHeight / 2);

  // Animate button
  btn.textContent = '✓ Usado';
  btn.style.background = 'var(--green)';
  setTimeout(() => {
    btn.textContent = item.qty > 0 ? 'Usar' : 'Usar';
    btn.style.background = '';
    btn.disabled = item.qty <= 0;
    renderInvTab(0);
  }, 1200);
}

function toggleBadge(id) {
  const idx = equippedBadgeIds.indexOf(id);
  if (idx !== -1) {
    equippedBadgeIds.splice(idx, 1);
    showToast('Badge desequipado');
  } else {
    if (equippedBadgeIds.length >= 3) {
      showToast('⚠️ Ya tienes 3 badges equipados. Quita uno primero.');
      return;
    }
    equippedBadgeIds.push(id);
    const badge = SHOP_ITEMS.badges.find(b => b.id === id);
    if (badge.ceo) showToast('👑 Badge CEO equipado!');
    else if (badge.gang) showToast('🖤 Badge GANG equipado!');
    else if (badge.luck) showToast('🍀 Badge Luck equipado ✓');
    else showToast(`${badge.emoji} Badge "${badge.name}" equipado!`);
    launchConfetti(window.innerWidth / 2, window.innerHeight / 2, {count:28, dist:180, dur:2});
  }
  updateEquippedBadgeDisplay();
  renderInvTab(1);
}

function updateEquippedBadgeDisplay() {
  // Remove old badge display
  document.getElementById('profileBadgeDisplay')?.remove();
  if (!equippedBadgeIds.length) return;

  const wrap = document.createElement('div');
  wrap.id = 'profileBadgeDisplay';
  wrap.style.cssText = 'display:flex;flex-wrap:wrap;gap:4px;margin-top:2px;';

  equippedBadgeIds.forEach(bid => {
    const badge = SHOP_ITEMS.badges.find(b => b.id === bid);
    if (!badge) return;
    const el = document.createElement('div');
    if (badge.ceo) {
      el.innerHTML = `<span class="ceo-badge-text" style="font-size:11px;letter-spacing:1px;">CEO</span>`;
      el.className = 'profile-active-badge ceo-active';
    } else if (badge.gang) {
      el.innerHTML = `<span class="gang-badge-text" style="font-size:11px;letter-spacing:1px;">GANG</span>`;
      el.className = 'profile-active-badge gang-active';
    } else if (badge.og) {
      el.innerHTML = `<span class="og-badge-text" style="font-size:11px;letter-spacing:1px;">OG</span>`;
      el.className = 'profile-active-badge og-active';
    } else if (badge.luck) {
      el.innerHTML = `<span style="color:#5edc8a;font-family:'Special Elite',cursive;font-size:10px;font-weight:900;text-shadow:0 0 6px rgba(94,220,138,.5);">🍀 Luck 🍀</span>`;
      el.className = 'profile-active-badge luck-active';
    } else {
      el.innerHTML = `${badge.emoji} ${badge.name}`;
      el.className = 'profile-active-badge';
    }
    el.style.display = 'inline-flex';
    wrap.appendChild(el);
  });

  const nameEl = document.getElementById('profileName');
  if (nameEl && nameEl.parentNode) nameEl.parentNode.insertBefore(wrap, nameEl.nextSibling);
}

// ──────────────────────────
// CONFIG PANEL
// ──────────────────────────
let focusMinutes = 25;
let focusTimer = null;
let focusRunning = false;
let focusRemaining = 0;
let muteDuration = '8h';

function syncConfigPanel() {
  // Sync profile name/xp
  const nameEl = document.getElementById('cfgProfileName');
  const subEl  = document.getElementById('cfgProfileSub');
  if (nameEl) nameEl.textContent = document.getElementById('usernameLabel').textContent;
  if (subEl)  subEl.textContent  = document.getElementById('profileXPLabel').textContent;
  // Sync avatar
  const cfgEmoji = document.getElementById('cfgAvatarEmoji');
  const cfgImg   = document.getElementById('cfgAvatarImg');
  const homeImg  = document.getElementById('profileImgHome');
  if (homeImg && homeImg.style.display !== 'none') {
    cfgImg.src = homeImg.src; cfgImg.style.display = 'block';
    cfgEmoji.style.display = 'none';
  } else {
    cfgEmoji.textContent = document.getElementById('profileAvatarHome').textContent;
    cfgEmoji.style.display = ''; cfgImg.style.display = 'none';
  }
  // Sync volume slider fill
  updateVolSliderFill(document.getElementById('volSlider').value);
}

function toggleVolume(cb) {
  const wrap  = document.getElementById('volSliderWrap');
  const label = document.getElementById('volLabel');
  if (cb.checked) {
    wrap.style.display = '';
    label.textContent = document.getElementById('volSlider').value + '%';
  } else {
    wrap.style.display = 'none';
    label.textContent = 'Silenciado';
  }
  showToast(cb.checked ? '🔊 Sonido activado' : '🔇 Sonido silenciado');
}

function updateVolLabel(val) {
  document.getElementById('volLabel').textContent = val + '%';
  updateVolSliderFill(val);
}

function updateVolSliderFill(val) {
  const slider = document.getElementById('volSlider');
  slider.style.setProperty('--fill', val + '%');
}

function toggleNotif(cb) {
  const opts  = document.getElementById('notifSubOpts');
  const label = document.getElementById('notifLabel');
  if (cb.checked) {
    opts.style.display = ''; label.textContent = 'Activas';
    opts.style.animation = 'none'; opts.offsetHeight; opts.style.animation = '';
  } else {
    opts.style.display = 'none'; label.textContent = 'Desactivadas';
  }
  showToast(cb.checked ? '🔔 Notificaciones activadas' : '🔕 Notificaciones desactivadas');
}

function toggleChip(el) {
  el.classList.toggle('active');
}

function changeFocus(delta) {
  if (focusRunning) return;
  focusMinutes = Math.max(5, Math.min(120, focusMinutes + delta));
  document.getElementById('focusVal').textContent = focusMinutes;
  document.getElementById('focusLabel').textContent = focusMinutes + ' min';
  // Pulse animation
  const val = document.getElementById('focusVal');
  val.style.transform = 'scale(1.3)';
  setTimeout(() => val.style.transform = 'scale(1)', 200);
  // Deselect presets
  document.querySelectorAll('#focusPresetsWrap .cfg-chip').forEach(c => {
    c.classList.toggle('active', parseInt(c.textContent) === focusMinutes ||
      (focusMinutes === 60 && c.textContent === '1 hora'));
  });
}

function setFocus(mins, el) {
  if (focusRunning) return;
  focusMinutes = mins;
  document.getElementById('focusVal').textContent = mins;
  document.getElementById('focusLabel').textContent = mins + ' min';
  document.querySelectorAll('#focusPresetsWrap .cfg-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

function startFocusSession() {
  const btn = document.querySelector('.cfg-focus-start-btn');
  if (!focusRunning) {
    focusRunning = true; focusRemaining = focusMinutes * 60;
    btn.classList.add('running');
    document.getElementById('focusStartIcon').textContent = '⏹';
    document.getElementById('focusStartText').textContent = formatFocusTime(focusRemaining);
    showToast(`🎯 Focus iniciado — ${focusMinutes} min`);
    focusTimer = setInterval(() => {
      focusRemaining--;
      if (focusRemaining <= 0) { endFocusSession(); return; }
      document.getElementById('focusStartText').textContent = formatFocusTime(focusRemaining);
    }, 1000);
  } else {
    endFocusSession();
  }
}

function endFocusSession() {
  clearInterval(focusTimer); focusRunning = false;
  const btn = document.querySelector('.cfg-focus-start-btn');
  if (btn) {
    btn.classList.remove('running');
    document.getElementById('focusStartIcon').textContent = '▶';
    document.getElementById('focusStartText').textContent = 'Iniciar sesión';
  }
  showToast('✅ Sesión de Focus completada!');
  launchConfetti(window.innerWidth/2, window.innerHeight/2);
  xp += 20; updateXP();
}

function formatFocusTime(secs) {
  const m = Math.floor(secs/60), s = secs%60;
  return `${m}:${s.toString().padStart(2,'0')} restante`;
}

function toggleMute(cb) {
  const wrap  = document.getElementById('muteDurationWrap');
  const label = document.getElementById('muteLabel');
  if (cb.checked) {
    wrap.style.display = '';
    wrap.style.animation = 'none'; wrap.offsetHeight; wrap.style.animation = '';
    label.textContent = 'Por ' + muteDuration;
    showToast('🔕 Chats silenciados');
  } else {
    wrap.style.display = 'none';
    label.textContent = 'Desactivado';
    showToast('💬 Chats reactivados');
  }
}

function setMuteDuration(dur, el) {
  muteDuration = dur;
  document.getElementById('muteDurText').textContent =
    dur === '1h' ? '1 hora' : dur === '8h' ? '8 horas' : dur === '24h' ? '1 día' : 'siempre';
  document.getElementById('muteLabel').textContent = 'Por ' + dur;
  document.querySelectorAll('#muteDurationWrap .cfg-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

function saveConfig() {
  showToast('✓ Configuración guardada');
  launchConfetti(window.innerWidth/2, window.innerHeight/3);
  setTimeout(() => closePanel('config'), 800);
}

// ══ RUTINA ══
const RUTINA_DAYS = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
const RUTINA_DEFAULT = [
  { day:'Lun', label:'Pecho + Tríceps', rest:false, exercises:[
    { name:'Press de banca',    series:'4×10', icon:'🏋️', color:'#555' },
    { name:'Flexiones',         series:'3×15', icon:'💪', color:'#444' },
    { name:'Extensión tríceps', series:'4×12', icon:'💥', color:'#555' },
  ]},
  { day:'Mar', label:'Espalda + Bíceps', rest:false, exercises:[
    { name:'Jalón al pecho',    series:'4×10', icon:'🎯', color:'#555' },
    { name:'Remo con barra',    series:'4×10', icon:'🚣', color:'#444' },
    { name:'Curl de bíceps',    series:'4×12', icon:'💪', color:'#555' },
  ]},
  { day:'Mié', label:'Descanso activo', rest:true, exercises:[] },
  { day:'Jue', label:'Piernas', rest:false, exercises:[
    { name:'Sentadilla',        series:'4×10', icon:'🦵', color:'#555' },
    { name:'Zancadas',          series:'3×12', icon:'🚶', color:'#444' },
    { name:'Curl femoral',      series:'4×12', icon:'🦿', color:'#555' },
  ]},
  { day:'Vie', label:'Hombros + Core', rest:false, exercises:[
    { name:'Press militar',     series:'4×10', icon:'🎖️', color:'#555' },
    { name:'Plancha',           series:'4×45s',icon:'🧘', color:'#444' },
    { name:'Abdominales',       series:'4×20', icon:'🔥', color:'#555' },
  ]},
  { day:'Sáb', label:'Cardio', rest:false, exercises:[
    { name:'Burpees',           series:'4×10', icon:'💨', color:'#555' },
    { name:'Salto de cuerda',   series:'3×2min',icon:'🪢', color:'#444' },
    { name:'Mountain climbers', series:'4×20', icon:'🧗', color:'#555' },
  ]},
  { day:'Dom', label:'Descanso total', rest:true, exercises:[] },
];

// Load from localStorage as fallback (per-day custom exercises)
function getRutinaData() {
  try {
    const saved = localStorage.getItem('rutina_data');
    return saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(RUTINA_DEFAULT));
  } catch(e) { return JSON.parse(JSON.stringify(RUTINA_DEFAULT)); }
}
function saveRutinaData(data) {
  try { localStorage.setItem('rutina_data', JSON.stringify(data)); } catch(e) {}
}
function getRutinaCompleted() {
  try {
    const saved = localStorage.getItem('rutina_completed');
    return saved ? JSON.parse(saved) : {};
  } catch(e) { return {}; }
}
function saveRutinaCompleted(data) {
  try { localStorage.setItem('rutina_completed', JSON.stringify(data)); } catch(e) {}
}

let rutinaActiveDay = (() => { const d = new Date().getDay(); return d === 0 ? 6 : d - 1; })();
let rutinaRewardedDays = (() => {
  try { return JSON.parse(localStorage.getItem('rutina_rewarded') || '{}'); } catch(e) { return {}; }
})();

function renderRutina() {
  const container = document.getElementById('rutinaContent');
  if (!container) return;
  container.innerHTML = '';

  const rutinaData = getRutinaData();
  const rutinaCompleted = getRutinaCompleted();
  const todayIdx = (() => { const d = new Date().getDay(); return d === 0 ? 6 : d - 1; })();
  const dayData = rutinaData[rutinaActiveDay];

  // ── Gym header ──
  const gymHeader = document.createElement('div');
  gymHeader.className = 'rutina-gym-header';
  gymHeader.innerHTML = `
    <div class="rutina-gym-deco">🏋️</div>
    <div>
      <div class="rutina-gym-title">MI GYM</div>
      <div class="rutina-gym-sub">Construye tu rutina • Gana recompensas</div>
    </div>
  `;
  container.appendChild(gymHeader);

  // ── Stats ──
  const totalDone = rutinaData.filter(d=>!d.rest).reduce((acc,d,di)=>
    acc + d.exercises.filter((_,ei)=>rutinaCompleted[`${di}_${ei}`]).length, 0);
  const totalEx = rutinaData.filter(d=>!d.rest).reduce((a,d)=>a+d.exercises.length, 0);
  const statsRow = document.createElement('div');
  statsRow.className = 'rutina-stats-row';
  statsRow.innerHTML = `
    <div class="rutina-stat-chip"><div class="rutina-stat-num">${totalDone}</div><div class="rutina-stat-label">✓ Hechos</div></div>
    <div class="rutina-stat-chip"><div class="rutina-stat-num">${Math.max(0,totalEx-totalDone)}</div><div class="rutina-stat-label">⏳ Pendientes</div></div>
    <div class="rutina-stat-chip"><div class="rutina-stat-num">${totalEx>0?Math.round(totalDone/totalEx*100):0}%</div><div class="rutina-stat-label">🔥 Total</div></div>
  `;
  container.appendChild(statsRow);

  // ── Day tabs ──
  const tabsWrap = document.createElement('div');
  tabsWrap.className = 'rutina-day-tabs';
  rutinaData.forEach((d, i) => {
    const tab = document.createElement('div');
    tab.className = 'rutina-day-tab' + (i===rutinaActiveDay?' active':'') + (d.rest?' rest':'') + (i===todayIdx?' today-tab':'');
    tab.textContent = d.day + (i===todayIdx?' •':'');
    tab.onclick = () => { rutinaActiveDay = i; renderRutina(); };
    tabsWrap.appendChild(tab);
  });
  container.appendChild(tabsWrap);

  // ── Day label ──
  const dayLabel = document.createElement('div');
  dayLabel.style.cssText = 'color:rgba(255,255,255,.4);font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin:10px 0 6px;display:flex;align-items:center;justify-content:space-between;';
  dayLabel.innerHTML = `<span>${dayData.day} — ${dayData.label}</span>`;

  // Toggle rest day button
  const toggleRestBtn = document.createElement('button');
  toggleRestBtn.style.cssText = 'background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:rgba(255,255,255,.4);font-size:9px;font-weight:700;padding:3px 8px;cursor:pointer;font-family:Nunito,sans-serif;';
  toggleRestBtn.textContent = dayData.rest ? '+ Activar día' : '😴 Marcar descanso';
  toggleRestBtn.onclick = () => {
    const data = getRutinaData();
    data[rutinaActiveDay].rest = !data[rutinaActiveDay].rest;
    if (data[rutinaActiveDay].rest) data[rutinaActiveDay].exercises = [];
    saveRutinaData(data);
    renderRutina();
  };
  dayLabel.appendChild(toggleRestBtn);
  container.appendChild(dayLabel);

  if (dayData.rest) {
    const restDiv = document.createElement('div');
    restDiv.className = 'rutina-rest-day';
    restDiv.innerHTML = `
      <div class="rutina-weights-strip">🏋️ 🏋️ 🏋️</div>
      <div class="rutina-rest-emoji">😴</div>
      <div class="rutina-rest-title">${dayData.label}</div>
      <div class="rutina-rest-sub">Tu cuerpo necesita recuperarse.<br>Descansa, estira o camina ligero.</div>
      <div class="rutina-weights-strip">🏋️ 🏋️ 🏋️</div>
    `;
    container.appendChild(restDiv);
    return;
  }

  // ── Progress bar ──
  const done = dayData.exercises.filter((_,i)=>rutinaCompleted[`${rutinaActiveDay}_${i}`]).length;
  const total = dayData.exercises.length;
  const pct = total > 0 ? Math.round(done/total*100) : 0;
  const isAllDone = total > 0 && done === total;

  // Complete banner + coin reward
  if (isAllDone && !rutinaRewardedDays[rutinaActiveDay+'_'+new Date().toDateString()]) {
    rutinaRewardedDays[rutinaActiveDay+'_'+new Date().toDateString()] = true;
    try { localStorage.setItem('rutina_rewarded', JSON.stringify(rutinaRewardedDays)); } catch(e) {}
    coins += 2; updateCoinDisplay();
    showToast('🏋️ ¡Rutina completa! +2 🪙');
    launchConfetti(window.innerWidth/2, window.innerHeight/2);
  }
  if (isAllDone) {
    const banner = document.createElement('div');
    banner.className = 'rutina-complete-banner';
    banner.innerHTML = `<div style="font-size:24px;">🏆</div><div><div class="rutina-complete-banner-text">¡Rutina del día completada!</div><div class="rutina-complete-banner-sub">+2 🪙 monedas ganadas</div></div>`;
    container.appendChild(banner);
  }

  const progWrap = document.createElement('div');
  progWrap.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;">
      <span style="color:rgba(255,255,255,.3);font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;">Progreso</span>
      <span style="color:${isAllDone?'var(--green)':'rgba(255,255,255,.4)'};font-size:10px;font-weight:800;">${done}/${total}</span>
    </div>
    <div class="rutina-progress-bar"><div class="rutina-progress-fill${isAllDone?' complete':''}" style="width:${pct}%;"></div></div>
  `;
  container.appendChild(progWrap);

  // ── Exercise list ──
  const list = document.createElement('div');
  list.className = 'rutina-exercise-list';
  dayData.exercises.forEach((ex, ei) => {
    const key = `${rutinaActiveDay}_${ei}`;
    const isDone = !!rutinaCompleted[key];
    const card = document.createElement('div');
    card.className = 'rutina-exercise-card' + (isDone?' done':'');
    card.style.setProperty('--ex-color', ex.color || '#555');
    card.innerHTML = `
      <div class="rutina-ex-icon">${ex.icon || '🏋️'}</div>
      <div class="rutina-ex-info">
        <div class="rutina-ex-name${isDone?' crossed':''}">${ex.name}</div>
        <div class="rutina-ex-detail">${ex.series}</div>
      </div>
      <div class="rutina-ex-check">${isDone?'✓':''}</div>
      <div class="rutina-ex-delete" onclick="deleteRutinaEx(${rutinaActiveDay},${ei},event)">✕</div>
    `;
    card.onclick = (e) => {
      if (e.target.classList.contains('rutina-ex-delete')) return;
      const comp = getRutinaCompleted();
      comp[key] = !comp[key];
      saveRutinaCompleted(comp);
      if (comp[key]) { xp += 3; updateXP(); }
      renderRutina();
    };
    list.appendChild(card);
  });
  container.appendChild(list);

  // ── Add exercise form ──
  const addForm = document.createElement('div');
  addForm.className = 'rutina-add-form';
  addForm.innerHTML = `
    <div class="rutina-add-title">🏋️ Agregar ejercicio</div>
    <div class="rutina-add-row">
      <input class="rutina-add-input" id="rutinaExName" placeholder="Nombre del ejercicio..." />
    </div>
    <div class="rutina-add-row">
      <input class="rutina-add-input small" id="rutinaExSeries" placeholder="4×10" />
      <select class="rutina-add-input small" id="rutinaExIcon" style="cursor:pointer;padding:6px 4px;">
        <option value="🏋️">🏋️</option><option value="💪">💪</option><option value="🔥">🔥</option>
        <option value="🦵">🦵</option><option value="🧘">🧘</option><option value="🏃">🏃</option>
        <option value="🚣">🚣</option><option value="🎯">🎯</option><option value="💨">💨</option>
        <option value="⚡">⚡</option>
      </select>
      <button class="rutina-add-btn" onclick="addRutinaEx(${rutinaActiveDay})">+ Añadir</button>
    </div>
  `;
  container.appendChild(addForm);

  // ── Deco weights ──
  const decoBottom = document.createElement('div');
  decoBottom.className = 'rutina-weights-strip';
  decoBottom.textContent = '🏋️ 🏋️ 🏋️ 🏋️ 🏋️';
  container.appendChild(decoBottom);
}

function addRutinaEx(dayIdx) {
  const name = document.getElementById('rutinaExName')?.value.trim();
  const series = document.getElementById('rutinaExSeries')?.value.trim() || '3×10';
  const icon = document.getElementById('rutinaExIcon')?.value || '🏋️';
  if (!name) { showToast('⚠️ Escribe el nombre del ejercicio'); return; }
  const data = getRutinaData();
  data[dayIdx].exercises.push({ name, series, icon, color:'#555' });
  saveRutinaData(data);
  showToast(`💪 "${name}" añadido`);
  renderRutina();
}

function deleteRutinaEx(dayIdx, exIdx, e) {
  e.stopPropagation();
  const data = getRutinaData();
  data[dayIdx].exercises.splice(exIdx, 1);
  saveRutinaData(data);
  // Remove completions for this day and shift keys
  const comp = getRutinaCompleted();
  const newComp = {};
  Object.entries(comp).forEach(([k,v]) => {
    const [d,i] = k.split('_').map(Number);
    if (d === dayIdx) {
      if (i < exIdx) newComp[k] = v;
      else if (i > exIdx) newComp[`${d}_${i-1}`] = v;
    } else { newComp[k] = v; }
  });
  saveRutinaCompleted(newComp);
  renderRutina();
}
// ══ RUTINA END ══

// ══════════════════════════════════════════════
// PROGRESS PANEL SYSTEM
// ══════════════════════════════════════════════
let progCalYear, progCalMonth, progSelectedDay = null, progView = 'week';

const MONTHS_ES_PROG = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DAYS_FULL_PROG = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
const DAYS_SHORT_PROG = ['Lu','Ma','Mi','Ju','Vi','Sa','Do'];

function progGetDayData(y, m, d) {
  const now = new Date();
  const isToday = d === now.getDate() && m === now.getMonth() && y === now.getFullYear();
  const isFuture = new Date(y, m, d) > now;

  // Tasks — use real tskData for today, Firebase history for past days
  let taskItems = [];
  if (isToday && typeof tskData !== 'undefined' && tskData.length > 0) {
    tskData.filter(t => tskIsToday(t)).forEach(t => {
      taskItems.push({ name: t.name, status: tskIsDoneToday(t) ? 'done' : 'pending', icon: t.emoji || '📋' });
    });
  } else if (!isFuture) {
    const dateKey = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cached = window._progDayCache?.[dateKey];
    if (cached?.tasks) {
      cached.tasks.forEach(t => taskItems.push({ name:t.name, status:t.done?'done':'failed', icon:t.icon }));
    }
  }

  // Habits — use real habitData for today, Firebase history for past days
  let habitItems = [];
  if (isToday) {
    habitData.forEach(h => {
      habitItems.push({ name:h.name, status:habitIsDoneToday(h)?'done':'pending', icon:h.icon });
    });
  } else if (!isFuture) {
    // Try to load from Firebase cache (loaded async below)
    const dateKey = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cached = window._progDayCache?.[dateKey];
    if (cached?.habits) {
      cached.habits.forEach(h => habitItems.push({ name:h.name, status:h.done?'done':'failed', icon:h.icon }));
    }
  }

  // Rutina
  const jsDay = new Date(y, m, d).getDay();
  const rutinaIdx = jsDay === 0 ? 6 : jsDay - 1;
  let rutinaData2;
  try { rutinaData2 = getRutinaData(); } catch(e) { rutinaData2 = JSON.parse(JSON.stringify(RUTINA_DEFAULT)); }
  const dayRutina = rutinaData2[rutinaIdx];
  let rutinaItems = [];
  const seed3 = y * 10000 + m * 100 + d + 1000;
  const rng3 = n => { let x = Math.sin(seed3 + n) * 9999; return x - Math.floor(x); };
  if (dayRutina && !dayRutina.rest && !isFuture) {
    let rutinaCompleted2 = {};
    try { rutinaCompleted2 = getRutinaCompleted(); } catch(e) {}
    dayRutina.exercises.forEach((ex, i) => {
      const done = isToday ? !!(rutinaCompleted2[`${rutinaIdx}-${i}`]) : rng3(i + 30) > 0.35;
      rutinaItems.push({ name: ex.name, series: ex.series, icon: ex.icon, status: done ? 'done' : (isToday ? 'pending' : 'failed') });
    });
  }

  const totalDone = taskItems.filter(t => t.status==='done').length + habitItems.filter(h => h.status==='done').length;
  const totalItems = taskItems.length + habitItems.length;
  return { taskItems, habitItems, rutinaItems, rutinaLabel: dayRutina?.label || 'Descanso', isRest: dayRutina?.rest, totalDone, totalItems };
}

function progDayScore(y, m, d) {
  const data = progGetDayData(y, m, d);
  if (data.totalItems === 0) return 0;
  return Math.round((data.totalDone / data.totalItems) * 10);
}

function progBuildChart() {
  const canvas = document.getElementById('progChartCanvas');
  if (!canvas) return;
  canvas.innerHTML = '';
  const cs = getComputedStyle(document.documentElement);
  const green  = cs.getPropertyValue('--green').trim()      || '#5edc8a';
  const purple = cs.getPropertyValue('--purple').trim()     || '#8b62e0';
  const teal   = cs.getPropertyValue('--teal-light').trim() || '#3a85c4';
  const now = new Date();
  let labels = [], taskVals = [], habitVals = [], rutinaVals = [];

  if (progView === 'week') {
    const dow = now.getDay() === 0 ? 6 : now.getDay() - 1;
    for (let i = 0; i < 7; i++) {
      const d = new Date(now); d.setDate(now.getDate() - dow + i);
      const data = progGetDayData(d.getFullYear(), d.getMonth(), d.getDate());
      labels.push(DAYS_SHORT_PROG[i]);
      taskVals.push(data.taskItems.filter(t=>t.status==='done').length);
      habitVals.push(data.habitItems.filter(h=>h.status==='done').length);
      rutinaVals.push(data.rutinaItems.filter(r=>r.status==='done').length);
    }
    document.getElementById('progChartPeriod').textContent = 'Esta semana';
  } else {
    const dim = new Date(progCalYear, progCalMonth + 1, 0).getDate();
    for (let d = 1; d <= dim; d++) {
      const data = progGetDayData(progCalYear, progCalMonth, d);
      labels.push(d % 5 === 1 ? String(d) : '');
      taskVals.push(data.taskItems.filter(t=>t.status==='done').length);
      habitVals.push(data.habitItems.filter(h=>h.status==='done').length);
      rutinaVals.push(data.rutinaItems.filter(r=>r.status==='done').length);
    }
    document.getElementById('progChartPeriod').textContent = MONTHS_ES_PROG[progCalMonth];
  }

  const maxVal = Math.max(...taskVals, ...habitVals, ...rutinaVals, 1);
  const todayDow = now.getDay() === 0 ? 6 : now.getDay() - 1;

  labels.forEach((lbl, i) => {
    const group = document.createElement('div');
    group.className = 'prog-bar-group';
    if (progView === 'week' && i === todayDow) group.classList.add('selected');
    const inner = document.createElement('div');
    inner.className = 'prog-bars-inner';
    [[taskVals[i], green],[habitVals[i], purple],[rutinaVals[i], teal]].forEach(([val, color]) => {
      const bar = document.createElement('div');
      bar.className = 'prog-bar';
      const h = Math.max((val / maxVal) * 68, val > 0 ? 4 : 0);
      bar.style.cssText = `background:linear-gradient(to top,${color}dd,${color}66);height:${h}px;box-shadow:${val>0?`0 0 5px ${color}55`:'none'};`;
      inner.appendChild(bar);
    });
    const barLbl = document.createElement('div');
    barLbl.className = 'prog-bar-lbl';
    barLbl.textContent = lbl;
    group.appendChild(inner);
    group.appendChild(barLbl);
    canvas.appendChild(group);
  });
}

function progRenderCal() {
  const grid = document.getElementById('progCalGrid');
  if (!grid) return;
  grid.innerHTML = '';
  document.getElementById('progCalLabel').textContent = `${MONTHS_ES_PROG[progCalMonth]} ${progCalYear}`;
  ['Lu','Ma','Mi','Ju','Vi','Sa','Do'].forEach(d => {
    const h = document.createElement('div'); h.className = 'prog-cal-dh'; h.textContent = d; grid.appendChild(h);
  });
  const dim = new Date(progCalYear, progCalMonth + 1, 0).getDate();
  const now = new Date();
  const rawFirst = new Date(progCalYear, progCalMonth, 1).getDay();
  const offset = rawFirst === 0 ? 6 : rawFirst - 1;
  for (let i = 0; i < offset; i++) { const e = document.createElement('div'); e.className = 'prog-cal-day empty'; grid.appendChild(e); }
  const cs = getComputedStyle(document.documentElement);
  const green  = cs.getPropertyValue('--green').trim() || '#5edc8a';
  const purple = cs.getPropertyValue('--purple').trim() || '#8b62e0';
  const teal   = cs.getPropertyValue('--teal-light').trim() || '#3a85c4';
  for (let d = 1; d <= dim; d++) {
    const el = document.createElement('div');
    const isToday = d === now.getDate() && progCalMonth === now.getMonth() && progCalYear === now.getFullYear();
    const isFuture = new Date(progCalYear, progCalMonth, d) > now;
    const isSelected = progSelectedDay?.d === d && progSelectedDay?.m === progCalMonth && progSelectedDay?.y === progCalYear;
    const score = isFuture ? 0 : progDayScore(progCalYear, progCalMonth, d);
    let cls = 'prog-cal-day';
    if (isToday) cls += ' today';
    if (isSelected) cls += ' selected';
    if (!isFuture && score > 0) {
      cls += ' has-data';
      if (score >= 8) cls += ' perfect';
      else if (score >= 5) cls += ' great';
      else cls += ' good';
    }
    el.className = cls;
    el.textContent = d;
    if (!isFuture && score > 0) {
      const dots = document.createElement('div'); dots.className = 'prog-cal-dots';
      const data = progGetDayData(progCalYear, progCalMonth, d);
      if (data.taskItems.some(t=>t.status==='done'))   { const dot=document.createElement('div'); dot.className='prog-cal-dot'; dot.style.background=green; dots.appendChild(dot); }
      if (data.habitItems.some(h=>h.status==='done'))  { const dot=document.createElement('div'); dot.className='prog-cal-dot'; dot.style.background=purple; dots.appendChild(dot); }
      if (data.rutinaItems.some(r=>r.status==='done')) { const dot=document.createElement('div'); dot.className='prog-cal-dot'; dot.style.background=teal; dots.appendChild(dot); }
      el.appendChild(dots);
    }
    if (!isFuture) {
      el.onclick = () => {
        progSelectedDay = { d, m: progCalMonth, y: progCalYear };
        progRenderCal();
        progShowDayDetail(progCalYear, progCalMonth, d);
      };
    } else { el.style.opacity = '.3'; el.style.cursor = 'default'; }
    grid.appendChild(el);
  }
}

function progShowDayDetail(y, m, d) {
  const detail = document.getElementById('progDayDetail');
  if (!detail) return;
  detail.style.display = 'block';
  const now = new Date();
  const dateObj = new Date(y, m, d);
  const dayName = DAYS_FULL_PROG[dateObj.getDay()];
  document.getElementById('progDayTitle').textContent = `${dayName} ${d} · ${MONTHS_ES_PROG[m]}`;

  // Comparison
  const prevDate = new Date(y, m, d - 1);
  const prevScore = progDayScore(prevDate.getFullYear(), prevDate.getMonth(), prevDate.getDate());
  const currScore = progDayScore(y, m, d);
  const dow = dateObj.getDay() === 0 ? 6 : dateObj.getDay() - 1;
  let weekTotal = 0, weekCount = 0;
  for (let i = 0; i < 7; i++) {
    const dd = new Date(y, m, d - dow + i);
    if (dd <= now) { weekTotal += progDayScore(dd.getFullYear(), dd.getMonth(), dd.getDate()); weekCount++; }
  }
  const weekAvg = weekCount > 0 ? Math.round((weekTotal / weekCount) * 10) / 10 : 0;
  const diffPrev = currScore - prevScore;
  const cmpEl = document.getElementById('progDayCompare');
  cmpEl.innerHTML = `
    <span class="prog-cmp-chip ${diffPrev > 0 ? 'prog-cmp-up' : diffPrev < 0 ? 'prog-cmp-down' : 'prog-cmp-eq'}">${diffPrev > 0 ? '↑' : diffPrev < 0 ? '↓' : '='} vs ayer</span>
    <span class="prog-cmp-chip prog-cmp-eq">📊 Prom. ${weekAvg}/10</span>`;

  const data = progGetDayData(y, m, d);

  // Tasks
  const tasksList = document.getElementById('progTasksList');
  tasksList.innerHTML = '';
  if (data.taskItems.length === 0) { tasksList.innerHTML = '<div class="prog-empty-hint">Sin tareas registradas este día</div>'; }
  else { data.taskItems.forEach(item => tasksList.appendChild(progMakeItemEl(item))); }

  // Habits
  const habitsList = document.getElementById('progHabitsList');
  habitsList.innerHTML = '';
  if (data.habitItems.length === 0) { habitsList.innerHTML = '<div class="prog-empty-hint">Sin hábitos registrados</div>'; }
  else { data.habitItems.forEach(item => habitsList.appendChild(progMakeItemEl(item))); }

  // Rutina
  document.getElementById('progRutinaLabel').textContent = `💪 ${data.rutinaLabel}`;
  const rutinaList = document.getElementById('progRutinaList');
  rutinaList.innerHTML = '';
  if (data.isRest) { rutinaList.innerHTML = '<div class="prog-empty-hint">🛌 Día de descanso</div>'; }
  else if (data.rutinaItems.length === 0) { rutinaList.innerHTML = '<div class="prog-empty-hint">Sin ejercicios registrados</div>'; }
  else { data.rutinaItems.forEach(item => { const el = progMakeItemEl(item); el.querySelector('.prog-item-text').textContent += ` · ${item.series}`; rutinaList.appendChild(el); }); }

  detail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function progMakeItemEl(item) {
  const el = document.createElement('div');
  el.className = `prog-item ${item.status}`;
  const statusMap = { done: '✓ Hecho', failed: '✗ Fallido', pending: '· Pendiente' };
  el.innerHTML = `<div class="prog-item-icon">${item.icon}</div><div class="prog-item-text">${typeof escapeHtml === 'function' ? escapeHtml(item.name) : item.name}</div><div class="prog-item-status">${statusMap[item.status]||''}</div>`;
  return el;
}

function progChangeMonth(dir) {
  progCalMonth += dir;
  if (progCalMonth > 11) { progCalMonth = 0; progCalYear++; }
  if (progCalMonth < 0) { progCalMonth = 11; progCalYear--; }
  progSelectedDay = null;
  const detail = document.getElementById('progDayDetail');
  if (detail) detail.style.display = 'none';
  progRenderCal();
  if (progView === 'month') progBuildChart();
}

function progSetView(v, el) {
  progView = v;
  document.querySelectorAll('.prog-vtbtn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  progBuildChart();
}

function progSubTab(tab, el) {
  document.querySelectorAll('.prog-stab').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('progTabTareas').style.display = tab === 'tareas' ? 'block' : 'none';
  document.getElementById('progTabRutina').style.display = tab === 'rutina' ? 'block' : 'none';
}

function progUpdateKPIs() {
  const xpEl = document.getElementById('progKpiXP');
  const strEl = document.getElementById('progKpiStreak');
  const tkEl  = document.getElementById('progKpiTasks');
  const hbEl  = document.getElementById('progKpiHabits');
  if (xpEl) xpEl.textContent = xp;
  if (strEl) strEl.textContent = streakDays;
  if (tkEl)  tkEl.textContent = tasksCompleted;
  const now = new Date();
  const todayData = progGetDayData(now.getFullYear(), now.getMonth(), now.getDate());
  if (hbEl) hbEl.textContent = todayData.habitItems.filter(h => h.status === 'done').length;
}

function initProgPanel() {
  const now = new Date();
  if (!progCalYear) { progCalYear = now.getFullYear(); progCalMonth = now.getMonth(); }
  progView = 'week';
  progUpdateKPIs();
  progBuildChart();
  progRenderCal();
  progSelectedDay = { d: now.getDate(), m: now.getMonth(), y: now.getFullYear() };
  progRenderCal();
  progShowDayDetail(now.getFullYear(), now.getMonth(), now.getDate());
  document.getElementById('progTabTareas').style.display = 'block';
  document.getElementById('progTabRutina').style.display = 'none';
  document.querySelectorAll('.prog-stab').forEach(b => b.classList.remove('active'));
  document.getElementById('pstTareas')?.classList.add('active');
  document.querySelectorAll('.prog-vtbtn').forEach(b => b.classList.remove('active'));
  document.getElementById('pvtWeek')?.classList.add('active');
  // Preload this month's Firebase history
  preloadMonthProgress(progCalYear, progCalMonth);
}

async function preloadMonthProgress(year, month) {
  const user = window._fbAuth?.currentUser;
  if (!user) return;
  if (!window._progDayCache) window._progDayCache = {};
  const dim = new Date(year, month + 1, 0).getDate();
  const today = habitTodayKey();
  try {
    const start = `${year}-${String(month+1).padStart(2,'0')}-01`;
    const end   = `${year}-${String(month+1).padStart(2,'0')}-${String(dim).padStart(2,'0')}`;
    const snap = await window._fbDb.collection('users').doc(user.uid)
      .collection('dailyProgress')
      .where('date', '>=', start).where('date', '<=', end)
      .get();
    snap.forEach(doc => { window._progDayCache[doc.id] = doc.data(); });
    progBuildChart();
    progRenderCal();
    if (progSelectedDay) progShowDayDetail(progSelectedDay.y, progSelectedDay.m, progSelectedDay.d);
  } catch(e) { console.warn('preloadMonthProgress failed:', e); }
}

// Hook openPanel for stats
const _origOpenPanelProg = window.openPanel;
window.openPanel = function(name) {
  _origOpenPanelProg(name);
  if (name === 'stats') setTimeout(initProgPanel, 60);
};
// ══ PROGRESS PANEL END ══

// ══════════════════════════════════════════════
// RANKING SEMANAL SYSTEM
// ══════════════════════════════════════════════

let _rankingCache = null;
let _rankingCacheWeek = null;

function getWeekNumber(date = new Date()) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function getWeekLabel(date = new Date()) {
  const mon = new Date(date);
  const day = mon.getDay() || 7;
  mon.setDate(mon.getDate() - day + 1);
  const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
  const fmt = d => `${d.getDate()}/${d.getMonth() + 1}`;
  return `${fmt(mon)} – ${fmt(sun)}`;
}

function getMyWeeklyXPTotal() {
  try {
    const stored = localStorage.getItem('weeklyXP');
    if (!stored) return 0;
    const weekly = JSON.parse(stored);
    // Check if it's this week
    const storedWeek = parseInt(localStorage.getItem('weeklyXPWeek') || '0');
    const currentWeek = Math.floor(Date.now() / (7 * 24 * 60 * 60 * 1000));
    if (storedWeek !== currentWeek) return 0;
    return Object.values(weekly).reduce((a, b) => a + b, 0);
  } catch(e) { return 0; }
}

async function loadRanking(forceRefresh = false) {
  const currentWeek = Math.floor(Date.now() / (7 * 24 * 60 * 60 * 1000));

  // Use cache if available and fresh
  if (!forceRefresh && _rankingCache && _rankingCacheWeek === currentWeek) {
    renderRanking(_rankingCache);
    return;
  }

  // Show loading
  document.getElementById('rnkLoading').style.display = 'flex';
  document.getElementById('rnkList').innerHTML = '';
  document.getElementById('rnkPodium').innerHTML = '';
  document.getElementById('rnkEmpty').style.display = 'none';
  document.getElementById('rnkMyPosFooter').style.display = 'none';

  const btn = document.getElementById('rnkRefreshBtn');
  if (btn) { btn.classList.add('spinning'); setTimeout(() => btn.classList.remove('spinning'), 700); }

  // Update my own weeklyXPTotal in Firestore first
  const myWeekXP = getMyWeeklyXPTotal();
  if (myUid() && window._fbFns?.updateDoc) {
    try {
      await window._fbFns.updateDoc(fbDoc(`users/${myUid()}`), {
        weeklyXPTotal: myWeekXP,
        weeklyXPWeekNum: currentWeek,
      }).catch(() => {});
    } catch(e) {}
  }

  try {
    const fns = window._fbFns;
    if (!fns || !window._fbDb) throw new Error('Firebase not ready');
    const { collection, query, orderBy, limit, getDocs, where } = fns;
    const db = window._fbDb;

    // Query users ordered by weeklyXPTotal (this week)
    // We query top 150 by weeklyXPTotal and filter to current week client-side
    const q = query(
      collection(db, 'users'),
      where('weeklyXPTotal', '>', 0),
      orderBy('weeklyXPTotal', 'desc'),
      limit(150)
    );
    const snap = await getDocs(q);
    let results = [];
    snap.forEach(doc => {
      const d = doc.data();
      // Only include users active this week
      const weekMatch = !d.weeklyXPWeekNum || d.weeklyXPWeekNum === currentWeek;
      if (weekMatch && (d.weeklyXPTotal || 0) > 0) {
        results.push({
          uid: doc.id,
          displayName: d.displayName || 'Usuario',
          avatar: d.avatar || '🧑‍🌾',
          xp: d.xp || 0,
          weeklyXP: d.weeklyXPTotal || 0,
          streakDays: d.streakDays || 0,
          equippedBadgeIds: d.equippedBadgeIds || [],
        });
      }
    });

    // Sort by weekly XP descending
    results.sort((a, b) => b.weeklyXP - a.weeklyXP);

    // Limit to top 100
    results = results.slice(0, 100);

    _rankingCache = results;
    _rankingCacheWeek = currentWeek;
    renderRanking(results);
  } catch(e) {
    console.warn('Ranking load error:', e);
    // Fallback: show friends + self with estimated data
    const fallback = buildFallbackRanking();
    _rankingCache = fallback;
    _rankingCacheWeek = currentWeek;
    renderRanking(fallback);
  }
}

function buildFallbackRanking() {
  // Build a ranking from friends + self with simulated weekly XP
  const currentWeek = Math.floor(Date.now() / (7 * 24 * 60 * 60 * 1000));
  const me = {
    uid: myUid() || 'me',
    displayName: myName() || 'Tú',
    avatar: document.getElementById('profileAvatarHome')?.textContent || '🧑‍🌾',
    xp: xp,
    weeklyXP: getMyWeeklyXPTotal(),
    streakDays: streakDays,
    equippedBadgeIds: equippedBadgeIds || [],
  };
  const results = [me];
  myFriends.forEach(f => {
    // Generate plausible weekly XP from total XP
    const base = Math.floor((f.xp || 0) / 14);
    const seed = (f.uid || '').split('').reduce((a, c) => a + c.charCodeAt(0), 0);
    const rng = n => { let x = Math.sin(seed + n) * 9999; return x - Math.floor(x); };
    const wXP = Math.floor(base * (0.5 + rng(1)));
    results.push({
      uid: f.uid,
      displayName: f.displayName,
      avatar: f.avatar,
      xp: f.xp || 0,
      weeklyXP: wXP,
      streakDays: f.streakDays || 0,
      equippedBadgeIds: f.equippedBadgeIds || [],
    });
  });
  results.sort((a, b) => b.weeklyXP - a.weeklyXP);
  return results.slice(0, 100);
}

function renderRanking(results) {
  document.getElementById('rnkLoading').style.display = 'none';

  // Update header
  document.getElementById('rnkWeekLabel').textContent = getWeekLabel();
  document.getElementById('rnkTotal').textContent = results.length;

  const myId = myUid();
  const myXP = getMyWeeklyXPTotal();
  document.getElementById('rnkMyWeekXP').textContent = myXP + ' XP';

  const myIdx = myId ? results.findIndex(r => r.uid === myId) : -1;
  document.getElementById('rnkMyRank').textContent = myIdx >= 0 ? `#${myIdx + 1}` : '—';

  if (results.length === 0) {
    document.getElementById('rnkEmpty').style.display = 'flex';
    return;
  }

  // Build friend & gymbro sets for quick lookup
  const friendUids = new Set(myFriends.map(f => f.uid));
  const isGymBro = uid => myGymBroUid && myGymBroUid === uid;

  // ── PODIUM (top 3) ──
  const podium = document.getElementById('rnkPodium');
  podium.innerHTML = '';
  const podOrder = results.length >= 3
    ? [results[1], results[0], results[2]]  // 2nd, 1st, 3rd visual order
    : results.slice(0, 3);
  const medals = ['🥇','🥈','🥉'];
  const realOrder = [1, 0, 2]; // mapping: slot 0=2nd, slot 1=1st, slot 2=3rd

  results.slice(0, Math.min(3, results.length)).forEach((user, rank) => {
    // Place in correct visual slot: 1st in middle, 2nd left, 3rd right
    const visualIdx = rank === 0 ? 1 : rank === 1 ? 0 : 2;
    const slot = document.createElement('div');
    slot.className = 'rnk-podium-slot';
    slot.style.order = visualIdx;
    const isMe = user.uid === myId;
    const crown = rank === 0 ? '<div class="rnk-pod-crown">👑</div>' : '';
    const meBadge = isMe ? '<div class="rnk-me-tag">TÚ</div>' : '';
    slot.innerHTML = `
      <div class="rnk-pod-avatar${isMe ? ' me' : ''}" style="background:rgba(255,255,255,.08);">
        ${crown}${user.avatar}
      </div>
      ${meBadge}
      <div class="rnk-pod-name">${escapeHtml(user.displayName)}</div>
      <div class="rnk-pod-xp">⭐ ${user.weeklyXP}</div>
      <div class="rnk-pod-streak">🔥 ${user.streakDays}d</div>
      <div class="rnk-pod-bar">${medals[rank]}</div>`;
    slot.onclick = () => user.uid !== myId && openFriendProfile(user.uid);
    podium.appendChild(slot);
  });

  // ── LIST (rank 4+) ──
  const list = document.getElementById('rnkList');
  list.innerHTML = '';
  results.slice(3).forEach((user, i) => {
    const rank = i + 4;
    const isMe = user.uid === myId;
    const isFriend = friendUids.has(user.uid);
    const isGB = isGymBro(user.uid);

    const row = document.createElement('div');
    row.className = 'rnk-row' + (isMe ? ' me-row' : '');
    row.style.animationDelay = `${Math.min(i * 0.03, 0.6)}s`;

    const friendChip = isFriend ? '<span class="rnk-friend-chip">amigo</span>' : '';
    const gymBroChip = isGB ? '<span class="rnk-gymbro-chip">💪 GymBro</span>' : '';
    const posClass = rank <= 10 ? 'top10' : isFriend ? 'friend-pos' : '';

    row.innerHTML = `
      <div class="rnk-row-pos ${posClass}">${rank}</div>
      <div class="rnk-row-player">
        <div class="rnk-row-avatar">${user.avatar}</div>
        <div class="rnk-row-info">
          <div class="rnk-row-name">${escapeHtml(user.displayName)}${isMe ? ' <span style="color:var(--teal-light);font-size:9px;">(tú)</span>' : ''}${friendChip}${gymBroChip}</div>
          <div class="rnk-row-sub">🔥 ${user.streakDays}d · ⭐ ${user.xp} XP total</div>
        </div>
      </div>
      <div class="rnk-row-xp${isMe ? ' me-xp' : ''}">⭐ ${user.weeklyXP}</div>`;

    if (!isMe) row.onclick = () => openFriendProfile(user.uid);
    list.appendChild(row);
  });

  // ── Sticky footer if user not in top 100 ──
  if (myIdx < 0 && myId) {
    const me = {
      uid: myId,
      displayName: myName(),
      avatar: document.getElementById('profileAvatarHome')?.textContent || '🧑‍🌾',
      weeklyXP: myXP,
      streakDays: streakDays,
      xp: xp,
    };
    const footer = document.getElementById('rnkMyPosFooter');
    const row = document.getElementById('rnkMyPosRow');
    row.innerHTML = `
      <div class="rnk-row-pos" style="color:var(--teal-light);">+100</div>
      <div class="rnk-row-player">
        <div class="rnk-row-avatar">${me.avatar}</div>
        <div class="rnk-row-info">
          <div class="rnk-row-name">${escapeHtml(me.displayName)} <span style="color:var(--teal-light);font-size:9px;">(tú)</span></div>
          <div class="rnk-row-sub">🔥 ${me.streakDays}d · Fuera del top 100</div>
        </div>
      </div>
      <div class="rnk-row-xp me-xp">⭐ ${me.weeklyXP}</div>`;
    footer.style.display = 'block';
  } else {
    document.getElementById('rnkMyPosFooter').style.display = 'none';
  }
}

// Hook openPanel for ranking
const _origOpenPanelRnk = window.openPanel;
window.openPanel = function(name) {
  _origOpenPanelRnk(name);
  if (name === 'ranking') setTimeout(() => loadRanking(false), 80);
};
// ══ RANKING END ══

// ── Firestore helpers ──
function fbDoc(path) {
  const { doc } = window._fbFns;
  return doc(window._fbDb, ...path.split('/'));
}
async function fbGet(path) {
  const { getDoc } = window._fbFns;
  const snap = await getDoc(fbDoc(path));
  return snap.exists() ? { id: snap.id, ...snap.data() } : null;
}
async function fbSet(path, data, merge=true) {
  const { setDoc } = window._fbFns;
  await setDoc(fbDoc(path), data, { merge });
}
function escapeHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ── State ──
let currentChatFriendId = null;
let chatUnsubscribe     = null;
let myFriends           = [];  // [{uid, displayName, avatar, xp, playerTag}]
let myGymBroUid         = null; // UID of current GymBro

// ── Helpers: current user ──
function myUid()   { return window._fbAuth?.currentUser?.uid || null; }
function myName()  { return document.getElementById('usernameLabel')?.textContent || 'Usuario'; }
function myAvatar(){ return document.getElementById('profileAvatarHome')?.textContent || '🧑'; }

// ── Generate a stable player tag from UID ──
// Format: Name#XXXX  (4-digit numeric suffix from uid hash)
function makePlayerTag(displayName, uid) {
  let hash = 0;
  for (let i = 0; i < uid.length; i++) hash = (Math.imul(31, hash) + uid.charCodeAt(i)) | 0;
  const suffix = String(Math.abs(hash) % 10000).padStart(4, '0');
  const base = (displayName || 'Player').replace(/\s+/g,'').substring(0, 12);
  return `${base}#${suffix}`;
}

function getMyTag() {
  const uid = myUid();
  if (!uid) return null;
  return makePlayerTag(myName(), uid);
}

// ── Copy player tag to clipboard ──
function copyMyTag() {
  const tag = getMyTag();
  if (!tag) { showToast('⚠️ Inicia sesión primero'); return; }
  navigator.clipboard?.writeText(tag).catch(() => {});
  showToast(`📋 Código copiado: ${tag}`);
  const btn = document.getElementById('socPlayerCard')?.querySelector('.soc-copy-btn');
  if (btn) {
    btn.textContent = '✓';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = '📋'; btn.classList.remove('copied'); }, 1800);
  }
}

// ── Hook into openPanel to load social when opened ──
const _origOpenPanel = window.openPanel;
window.openPanel = function(name) {
  _origOpenPanel(name);
  if (name === 'social') loadSocialPanel();
};

const _origClosePanel = window.closePanel;
window.closePanel = function(name) {
  if (name === 'chat' && chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; }
  _origClosePanel(name);
};

function closeChat() {
  if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; }
  closePanel('chat');
}

// ── Main loader for the social panel ──
async function loadSocialPanel() {
  // Update my player card
  const uid = myUid();
  const nameEl  = document.getElementById('socMyName');
  const tagEl   = document.getElementById('socMyTag');
  const avatEl  = document.getElementById('socMyAvatar');
  if (nameEl)  nameEl.textContent  = myName();
  if (avatEl)  avatEl.textContent  = myAvatar();
  if (tagEl) {
    if (!uid) {
      tagEl.textContent = 'Inicia sesión para ver tu código';
    } else {
      const tag = getMyTag();
      tagEl.innerHTML = `🎮 ${tag}`;
      tagEl.title = 'Toca para copiar';
      tagEl.onclick = copyMyTag;
    }
  }
  if (!uid) {
    document.getElementById('socFriendsList').innerHTML = '<div class="soc-empty">Inicia sesión para ver tus amigos.</div>';
    return;
  }
  await checkAccepted();   // procesa aceptaciones que llegaron mientras estabas fuera
  await loadSocFriends();
  await loadSocPending();
}

// ── Search by player tag (Name#XXXX) ──
let _socSearchTimer = null;
function socSearchDebounce() {
  clearTimeout(_socSearchTimer);
  const val = document.getElementById('socAddInput')?.value.trim();
  if (!val) { document.getElementById('socSearchResult').innerHTML = ''; return; }
  // Show hint while typing
  if (!val.includes('#')) {
    document.getElementById('socSearchResult').innerHTML =
      `<div class="soc-search-hint"><span>💡</span> Ingresa el código completo, ej: <strong>Leo#4821</strong></div>`;
    return;
  }
  _socSearchTimer = setTimeout(socDoSearch, 400);
}

async function socDoSearch() {
  const rawInput = document.getElementById('socAddInput')?.value.trim();
  const resEl    = document.getElementById('socSearchResult');
  if (!rawInput) { resEl.innerHTML = ''; return; }
  if (!myUid())  { showToast('⚠️ Inicia sesión primero'); return; }

  if (!rawInput.includes('#')) {
    resEl.innerHTML = `<div class="soc-result-msg">💡 Ingresa el código completo: <strong>Nombre#1234</strong></div>`;
    return;
  }

  const btn = document.querySelector('.soc-add-search-btn');
  if (btn) { btn.disabled = true; btn.textContent = '⌛'; }
  resEl.innerHTML = `<div class="soc-result-msg">Buscando <strong>${escapeHtml(rawInput)}</strong>...</div>`;

  try {
    const hashIndex = rawInput.lastIndexOf('#');
    const namePart   = rawInput.slice(0, hashIndex);
    const suffixPart = rawInput.slice(hashIndex + 1);

    if (!namePart || !suffixPart || suffixPart.length !== 4 || !/^\d{4}$/.test(suffixPart)) {
      resEl.innerHTML = `<div class="soc-result-error">❌ Formato inválido. Usa <strong>Nombre#1234</strong> (4 dígitos al final)</div>`;
      return;
    }

    const fns = window._fbFns;
    const db  = window._fbDb;
    const { collection, query: q, where, getDocs, limit } = fns;

    // Helper: checks if a Firestore doc matches the searched tag
    function matchesTag(docData, docId) {
      if (docId === myUid()) return false;
      const tag = makePlayerTag(docData.displayName, docId);
      return tag.toLowerCase() === rawInput.toLowerCase();
    }

    let found = null;

    // ── Estrategia 1: buscar por displayName exacto ──
    if (!found) {
      const s = await getDocs(q(collection(db,'users'), where('displayName','==', namePart), limit(30)));
      for (const d of s.docs) { if (matchesTag(d.data(), d.id)) { found = {id:d.id,...d.data()}; break; } }
    }

    // ── Estrategia 2: buscar por displayNameLower (no distingue mayúsculas) ──
    if (!found) {
      const s = await getDocs(q(collection(db,'users'), where('displayNameLower','==', namePart.toLowerCase()), limit(30)));
      for (const d of s.docs) { if (matchesTag(d.data(), d.id)) { found = {id:d.id,...d.data()}; break; } }
    }

    // ── Estrategia 3: scan de los últimos 200 usuarios (fallback universal) ──
    // No requiere índice — funciona siempre aunque no haya campo displayNameLower
    if (!found) {
      const s = await getDocs(q(collection(db,'users'), limit(200)));
      for (const d of s.docs) { if (matchesTag(d.data(), d.id)) { found = {id:d.id,...d.data()}; break; } }
    }

    if (!found) {
      resEl.innerHTML = `<div class="soc-result-error">😶 No se encontró ningún jugador con el código <strong>${escapeHtml(rawInput)}</strong>.<br><span style="font-size:10px;color:rgba(255,255,255,.3);">Verifica que esté escrito exactamente igual al código de tu amigo.</span></div>`;
      return;
    }

    // Estado de la relación — leer mis amigos y si ya envié solicitud
    const { doc: fbDocFn, getDoc: fbGetDoc } = fns;
    const meData   = await fbGet(`users/${myUid()}`);
    const friends  = meData?.friends || [];
    const isFriend = friends.includes(found.id);

    // Verificar si ya envié solicitud (existe doc en mi subcolección sent)
    let isPending = false;
    try {
      const sentSnap = await fbGetDoc(fbDocFn(db, `friendRequests/${myUid()}/sent/${found.id}`));
      isPending = sentSnap.exists();
    } catch(e) { /* si falla, asumimos no enviado */ }

    const foundTag = makePlayerTag(found.displayName, found.id);

    let actionHTML = '';
    if (isFriend) {
      actionHTML = `<button class="soc-req-btn already">✓ Ya son amigos</button>`;
    } else if (isPending) {
      actionHTML = `<button class="soc-req-btn sent">⏳ Solicitud enviada</button>`;
    } else {
      actionHTML = `<button class="soc-req-btn add" id="socSendBtn"
        onclick="socSendRequest('${found.id}','${escapeHtml(found.displayName||'Usuario')}')">
        ➕ Agregar amigo
      </button>`;
    }

    resEl.innerHTML = '';
    const card = document.createElement('div');
    card.className = 'soc-result-card';
    card.innerHTML = `
      <div class="soc-result-avatar">${found.avatar || '🧑'}</div>
      <div class="soc-result-info">
        <div class="soc-result-name">${escapeHtml(found.displayName || 'Usuario')}</div>
        <div class="soc-result-tag">🎮 ${escapeHtml(foundTag)}</div>
        <div class="soc-result-meta">⭐ ${found.xp || 0} XP · 🔥 ${found.streakDays || 0} días</div>
      </div>
      <div class="soc-result-action-wrap">${actionHTML}</div>
    `;
    resEl.appendChild(card);

  } catch(e) {
    console.error('Search error:', e);
    resEl.innerHTML = `<div class="soc-result-error">❌ ${escapeHtml(e.message || 'Error al buscar. Intenta de nuevo.')}</div>`;
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'Buscar'; }
  }
}

// ── Send friend request ──
// Escribe en friendRequests/{myUid}/sent/{toUid}  (doc que YO controlo)
// Y en friendRequests/{toUid}/inbox/{myUid}       (doc que el otro puede leer)
async function socSendRequest(toUid, toName) {
  const btn = document.getElementById('socSendBtn');
  if (btn) { btn.disabled = true; btn.textContent = '⌛'; }
  try {
    const fns = window._fbFns;
    const db  = window._fbDb;
    const { doc, setDoc, serverTimestamp } = fns;
    const me = myUid();

    // Guarda la solicitud en la bandeja de entrada del destinatario
    await setDoc(doc(db, `friendRequests/${toUid}/inbox/${me}`), {
      uid:         me,
      displayName: myName(),
      avatar:      myAvatar(),
      sentAt:      serverTimestamp()
    });

    // Guarda en mis enviados para saber el estado
    await setDoc(doc(db, `friendRequests/${me}/sent/${toUid}`), {
      uid:    toUid,
      sentAt: serverTimestamp()
    });

    if (btn) { btn.className = 'soc-req-btn sent'; btn.textContent = '⏳ Solicitud enviada'; btn.disabled = true; }
    showToast(`📨 ¡Solicitud enviada a ${toName}!`);
  } catch(e) {
    console.error('sendRequest error:', e);
    if (btn) { btn.disabled = false; btn.textContent = '➕ Agregar amigo'; }
    showToast(`❌ Error: ${e.message || 'No se pudo enviar'}`);
  }
}

// ── Load pending incoming requests (lee mi propia bandeja) ──
async function loadSocPending() {
  if (!myUid()) return;
  try {
    const fns = window._fbFns;
    const { collection, getDocs } = fns;
    const db = window._fbDb;

    const snap = await getDocs(collection(db, `friendRequests/${myUid()}/inbox`));
    const pending = snap.docs.map(d => ({ ...d.data(), uid: d.id }));

    const section = document.getElementById('socPendingSection');
    const list    = document.getElementById('socPendingList');
    const countEl = document.getElementById('socPendingCount');

    if (pending.length === 0) {
      if (section) section.style.display = 'none';
      return;
    }
    if (section) section.style.display = 'block';
    if (countEl) countEl.textContent = pending.length;
    if (!list)   return;

    list.innerHTML = '';
    pending.forEach(req => {
      const card = document.createElement('div');
      card.className = 'soc-pending-card';
      card.id = `spreq-${req.uid}`;
      const tag = makePlayerTag(req.displayName || 'Player', req.uid);
      card.innerHTML = `
        <div class="soc-pending-avatar">${req.avatar || '🧑'}</div>
        <div class="soc-pending-info">
          <div class="soc-pending-name">${escapeHtml(req.displayName || 'Usuario')}</div>
          <div class="soc-pending-sub">🎮 ${escapeHtml(tag)} · quiere ser tu amigo</div>
        </div>
        <div class="soc-pending-btns">
          <button class="soc-pending-accept" title="Aceptar"
            onclick="socAccept('${req.uid}','${escapeHtml(req.displayName||'Usuario')}','${req.avatar||'🧑'}')">✓</button>
          <button class="soc-pending-reject" title="Rechazar"
            onclick="socReject('${req.uid}')">✕</button>
        </div>
      `;
      list.appendChild(card);
    });
  } catch(e) {
    console.error('loadSocPending error:', e);
  }
}

// ── Accept request ──
async function socAccept(fromUid, fromName, fromAvatar) {
  try {
    const fns = window._fbFns;
    const db  = window._fbDb;
    const { doc, deleteDoc, setDoc, serverTimestamp } = fns;

    // Añadirme como amigo en mi propio doc
    await fns.updateDoc(fbDoc(`users/${myUid()}`), {
      friends: fns.arrayUnion(fromUid)
    });
    // Añadir al otro como amigo en su propio doc — pero como no tenemos permiso
    // de escribir en su doc, guardamos en una subcolección que él leerá
    await setDoc(doc(db, `friendRequests/${fromUid}/accepted/${myUid()}`), {
      uid:         myUid(),
      displayName: myName(),
      avatar:      myAvatar(),
      acceptedAt:  serverTimestamp()
    });
    // Borrar la solicitud de mi bandeja
    await deleteDoc(doc(db, `friendRequests/${myUid()}/inbox/${fromUid}`));

    document.getElementById(`spreq-${fromUid}`)?.remove();
    xp += 10; updateXP();
    if (typeof saveAccount === 'function') saveAccount();
    showToast(`🎉 ¡${fromName} y tú ahora son amigos!`);
    launchConfetti(window.innerWidth / 2, 200);
    await loadSocFriends();
    await loadSocPending();

    // Checar si yo también tengo aceptaciones pendientes de otros
    checkAccepted();
  } catch(e) {
    console.error('socAccept error:', e);
    showToast(`❌ Error: ${e.message || 'No se pudo aceptar'}`);
  }
}

// ── Reject request ──
async function socReject(fromUid) {
  try {
    const fns = window._fbFns;
    const { doc, deleteDoc } = fns;
    const db = window._fbDb;
    await deleteDoc(doc(db, `friendRequests/${myUid()}/inbox/${fromUid}`));
    document.getElementById(`spreq-${fromUid}`)?.remove();
    showToast('Solicitud rechazada');
    await loadSocPending();
  } catch(e) {
    console.error('socReject error:', e);
  }
}

// ── Checa si alguien aceptó mi solicitud (leo mi subcolección accepted) ──
async function checkAccepted() {
  if (!myUid()) return;
  try {
    const fns = window._fbFns;
    const { collection, getDocs, doc, deleteDoc } = fns;
    const db = window._fbDb;
    const snap = await getDocs(collection(db, `friendRequests/${myUid()}/accepted`));
    for (const d of snap.docs) {
      const data = { ...d.data(), uid: d.id };
      // Añadirlo a mis amigos
      await fns.updateDoc(fbDoc(`users/${myUid()}`), {
        friends: fns.arrayUnion(data.uid)
      });
      // Borrar de accepted
      await deleteDoc(doc(db, `friendRequests/${myUid()}/accepted/${data.uid}`));
      // Borrar de mis enviados
      await deleteDoc(doc(db, `friendRequests/${myUid()}/sent/${data.uid}`)).catch(()=>{});
    }
    if (snap.docs.length > 0) {
      await loadSocFriends();
    }
  } catch(e) {
    console.error('checkAccepted error:', e);
  }
}

// ── Load friends list ──
async function loadSocFriends() {
  const listEl   = document.getElementById('socFriendsList');
  const countEl  = document.getElementById('socFriendCount');
  if (!listEl) return;

  const meData     = await fbGet(`users/${myUid()}`).catch(() => null);
  const friendUids = meData?.friends || [];

  if (friendUids.length === 0) {
    listEl.innerHTML = `<div class="soc-empty">Aún no tienes amigos.<br>¡Busca su código y agrégalos! ☝️</div>`;
    if (countEl) countEl.textContent = '';
    myFriends = [];
    return;
  }

  if (countEl) countEl.textContent = `${friendUids.length} amigo${friendUids.length !== 1 ? 's' : ''}`;

  const dataArr = await Promise.all(friendUids.map(uid => fbGet(`users/${uid}`).catch(() => null)));
  myFriends = dataArr.filter(Boolean).map(f => ({
    uid: f.id || f.uid,
    displayName: f.displayName || 'Usuario',
    avatar: f.avatar || '🧑',
    xp: f.xp || 0,
    streakDays: f.streakDays || 0,
    // store full data for profile
    coins: f.coins || 0,
    streakGoal: f.streakGoal || 100,
    petName: f.petName || 'Chispa',
    petTypeIdx: f.petTypeIdx ?? 0,
    petColorIdx: f.petColorIdx ?? 0,
    petHp: f.petHp ?? 60,
    petHat: f.petHat || null,
    petCollar: f.petCollar || null,
    petWand: f.petWand || null,
    equippedBadgeIds: f.equippedBadgeIds || [],
    ownedBadgeIds: f.ownedBadgeIds || [],
  }));

  listEl.innerHTML = '';
  myFriends.forEach(friend => {
    const tag  = makePlayerTag(friend.displayName, friend.uid);
    const card = document.createElement('div');
    card.className = 'soc-friend-card';
    card.style.cursor = 'pointer';
    card.innerHTML = `
      <div class="soc-friend-avatar">${friend.avatar}</div>
      <div class="soc-friend-info">
        <div class="soc-friend-name">${escapeHtml(friend.displayName)}</div>
        <div class="soc-friend-chips">
          <span class="soc-chip soc-chip-xp">⭐ ${friend.xp} XP</span>
          <span class="soc-chip soc-chip-str">🔥 ${friend.streakDays}d</span>
        </div>
      </div>
      <div class="soc-friend-actions">
        <button class="soc-btn soc-btn-chat" title="Ver perfil"
          onclick="openFriendProfile('${friend.uid}',event)" style="font-size:12px;font-weight:800;background:rgba(42,100,150,.4);">👤</button>
        <button class="soc-btn soc-btn-chat" title="Chat"
          onclick="openSocChat('${friend.uid}','${escapeHtml(friend.displayName)}','${friend.avatar}',event)">💬</button>
        <button class="soc-btn soc-btn-remove" title="Eliminar"
          onclick="socRemoveFriend('${friend.uid}','${escapeHtml(friend.displayName)}',event)">✕</button>
      </div>
    `;
    // Also tap anywhere on card body opens profile
    card.onclick = (e) => {
      if (!e.target.closest('button')) openFriendProfile(friend.uid, e);
    };
    listEl.appendChild(card);
  });
  // Update GymBro section with fresh friend data
  renderGymBroSection();
}
let _currentFriendProfileData = null;

async function openFriendProfile(friendUid, e) {
  e?.stopPropagation();
  openPanel('friend-profile');
  const content = document.getElementById('fpContent');
  content.innerHTML = '<div class="fp-loading">⏳ Cargando perfil...</div>';
  document.getElementById('fpTitle').textContent = 'Perfil';
  document.getElementById('fpChatBtn').style.display = 'none';

  try {
    // Try to use cached myFriends data first, then refresh from Firestore
    let friend = myFriends.find(f => f.uid === friendUid);
    const freshData = await fbGet(`users/${friendUid}`).catch(() => null);
    if (freshData) {
      friend = {
        uid: friendUid,
        displayName: freshData.displayName || 'Usuario',
        avatar: freshData.avatar || '🧑',
        xp: freshData.xp || 0,
        streakDays: freshData.streakDays || 0,
        coins: freshData.coins || 0,
        streakGoal: freshData.streakGoal || 100,
        petName: freshData.petName || 'Chispa',
        petTypeIdx: freshData.petTypeIdx ?? 0,
        petColorIdx: freshData.petColorIdx ?? 0,
        petHp: freshData.petHp ?? 60,
        petHat: freshData.petHat || null,
        petCollar: freshData.petCollar || null,
        petWand: freshData.petWand || null,
        equippedBadgeIds: freshData.equippedBadgeIds || [],
        ownedBadgeIds: freshData.ownedBadgeIds || [],
      };
    }
    if (!friend) { content.innerHTML = '<div class="fp-loading">❌ No se pudo cargar el perfil.</div>'; return; }
    _currentFriendProfileData = friend;
    document.getElementById('fpTitle').textContent = escapeHtml(friend.displayName);
    document.getElementById('fpChatBtn').style.display = '';
    renderFriendProfile(content, friend);
  } catch(err) {
    console.error('openFriendProfile error:', err);
    content.innerHTML = `<div class="fp-loading">❌ Error: ${escapeHtml(err.message||'Error desconocido')}</div>`;
  }
}

function fpOpenChat() {
  if (!_currentFriendProfileData) return;
  const f = _currentFriendProfileData;
  openSocChat(f.uid, f.displayName, f.avatar, null);
}

function renderFriendProfile(container, f) {
  container.innerHTML = '';

  // ── Calc level from XP ──
  const level = Math.max(1, Math.floor(f.xp / 100) + 1);
  const tag = makePlayerTag(f.displayName, f.uid);

  // ── Pet info ──
  const PET_TYPES_DATA = [
    { evo:['🐱','😺','🦁'] }, { evo:['🐶','🐕','🐺'] }, { evo:['🐲','🐉','🔥🐉'] },
    { evo:['🦊','🦊','⚡🦊'] }, { evo:['🐸','🐸','✨🐸'] }, { evo:['🐧','🐧','❄️🐧'] },
    { evo:['🦋','🦋','🌈🦋'] }, { evo:['🐨','🐨','💜🐨'] },
  ];
  const petType = PET_TYPES_DATA[f.petTypeIdx] || PET_TYPES_DATA[0];
  const evoStage = f.streakDays >= 100 ? 3 : f.streakDays >= 70 ? 2 : f.streakDays >= 30 ? 1 : 0;
  const petEmoji = petType.evo[Math.min(evoStage, petType.evo.length-1)];
  const isLegendary = f.streakDays >= 30;
  const petMood = f.petHp >= 80 ? {icon:'🤩',color:'#5edc8a'} : f.petHp >= 55 ? {icon:'😊',color:'#5edc8a'} : f.petHp >= 30 ? {icon:'😐',color:'#f0c040'} : {icon:'😢',color:'#e8527a'};

  // Accessories
  const PET_ACCS_DATA = [
    {id:'hat-1',slot:'hat',emoji:'🎩'},{id:'hat-2',slot:'hat',emoji:'👑'},{id:'hat-3',slot:'hat',emoji:'🎓'},{id:'hat-4',slot:'hat',emoji:'🌸'},
    {id:'collar-1',slot:'collar',emoji:'📿'},{id:'collar-2',slot:'collar',emoji:'🎀'},
    {id:'wand-1',slot:'wand',emoji:'⚡'},{id:'wand-2',slot:'wand',emoji:'🌟'},
  ];
  const hat    = PET_ACCS_DATA.find(a => a.id === f.petHat);
  const collar = PET_ACCS_DATA.find(a => a.id === f.petCollar);
  const wand   = PET_ACCS_DATA.find(a => a.id === f.petWand);
  const accStr = [hat,collar,wand].filter(Boolean).map(a=>a.emoji).join(' ') || '—';

  // Badges
  const ALL_BADGES = [
    {id:'b1',name:'Principiante',emoji:'🌱'},{id:'b2',name:'Disciplinado',emoji:'📐'},{id:'b3',name:'Constante',emoji:'🔄'},
    {id:'b4',name:'Apasionado',emoji:'❤️‍🔥'},{id:'b5',name:'Estrella',emoji:'⭐'},{id:'b6',name:'Genio',emoji:'🧠'},
    {id:'b7',name:'Prodigio',emoji:'🚀'},{id:'b8',name:'GOAT',emoji:'🐐'},{id:'b9',name:'Leyenda',emoji:'🏆'},
    {id:'b10',name:'Irreal',emoji:'👁️'},{id:'b11',name:'OG',emoji:'OG',og:true},{id:'b12',name:'CEO',emoji:'CEO',ceo:true},{id:'b13',name:'GANG',emoji:'GANG',gang:true},
    {id:'b14',name:'???',emoji:'❓',mystery:true},{id:'b15',name:'Duo?',emoji:'🦉'},{id:'b16',name:'GymBros',emoji:'💪',gymbro:true},
  ];
  const equippedBadges = (f.equippedBadgeIds || []).map(bid => ALL_BADGES.find(b => b.id === bid)).filter(Boolean);

  // ── HERO ──
  const hero = document.createElement('div');
  hero.className = 'fp-hero';
  hero.innerHTML = `
    <div class="fp-avatar-wrap">
      <div class="fp-avatar-emoji">${f.avatar}</div>
    </div>
    <div class="fp-name">${escapeHtml(f.displayName)}</div>
    <div class="fp-tag">🎮 ${escapeHtml(tag)}</div>
    <div class="fp-level-badge">Nivel ${level} · ${f.xp} XP</div>
  `;
  container.appendChild(hero);

  // ── STATS ──
  const statsRow = document.createElement('div');
  statsRow.className = 'fp-stats-row';
  [
    { val: f.xp,         lbl: 'XP Total',  icon:'⭐' },
    { val: f.streakDays, lbl: 'Días racha', icon:'🔥' },
    { val: level,        lbl: 'Nivel',      icon:'🏅' },
    { val: f.coins,      lbl: 'Monedas',    icon:'🪙' },
  ].forEach(s => {
    const chip = document.createElement('div');
    chip.className = 'fp-stat-chip';
    chip.innerHTML = `<div class="fp-stat-val">${s.icon} ${s.val}</div><div class="fp-stat-lbl">${s.lbl}</div>`;
    statsRow.appendChild(chip);
  });
  container.appendChild(statsRow);

  // ── BADGES ──
  const badgesLabel = document.createElement('div');
  badgesLabel.className = 'fp-section-label';
  badgesLabel.textContent = 'Badges equipados';
  container.appendChild(badgesLabel);

  const badgesRow = document.createElement('div');
  badgesRow.className = 'fp-badges-row';
  if (equippedBadges.length === 0) {
    badgesRow.innerHTML = '<div class="fp-no-badges">Sin badges equipados</div>';
  } else {
    equippedBadges.forEach(b => {
      const chip = document.createElement('div');
      chip.className = 'fp-badge-chip';
      if (b.ceo) {
        chip.innerHTML = `<span class="ceo-badge-text" style="font-size:12px;">CEO</span>`;
        chip.style.cssText += 'animation:ceoBadgeBorder 4s ease-in-out infinite;';
      } else if (b.gang) {
        chip.innerHTML = `<span class="gang-badge-text" style="font-size:12px;">GANG</span>`;
      } else if (b.og) {
        chip.innerHTML = `<span class="og-badge-text" style="font-size:12px;">OG</span>`;
      } else {
        chip.innerHTML = `${b.emoji} ${b.name}`;
      }
      badgesRow.appendChild(chip);
    });
  }
  container.appendChild(badgesRow);

  // ── RACHA ──
  const streakLabel = document.createElement('div');
  streakLabel.className = 'fp-section-label';
  streakLabel.textContent = 'Racha de hábitos';
  container.appendChild(streakLabel);

  const streakRow = document.createElement('div');
  streakRow.className = 'fp-streak-row';
  const streakDots = Array.from({length: Math.min(f.streakGoal||7, 14)}, (_, i) =>
    `<div class="fp-streak-dot${i < f.streakDays ? ' done' : ''}"></div>`
  ).join('');
  streakRow.innerHTML = `
    <div style="font-size:${isLegendary?'32':'28'}px;">${isLegendary?'🔮':'🔥'}</div>
    <div class="fp-streak-info">
      <div style="display:flex;align-items:baseline;gap:6px;">
        <span class="fp-streak-num">${f.streakDays}</span>
        <span class="fp-streak-label">días${isLegendary ? ' ✦ LEGENDARIO' : ''}</span>
      </div>
      <div class="fp-streak-dots">${streakDots}</div>
    </div>
  `;
  if (isLegendary) streakRow.style.cssText += 'border-color:rgba(240,192,64,.3);background:linear-gradient(135deg,rgba(240,192,64,.06),var(--navy-mid));';
  container.appendChild(streakRow);

  // ── MASCOTA ──
  const petLabel = document.createElement('div');
  petLabel.className = 'fp-section-label';
  petLabel.textContent = 'Mascota de racha';
  container.appendChild(petLabel);

  const petCard = document.createElement('div');
  petCard.className = 'fp-pet-card';
  const petLevel = Math.floor(f.streakDays / 3) + 1;
  const hpColor = f.petHp >= 55 ? '#5edc8a' : f.petHp >= 30 ? '#f0c040' : '#e8527a';
  const PET_COLORS_DATA = ['#2a90c8','#5edc8a','#8b62e0','#f0c040','#e8527a','#ffffff','#ff7c20','#00d4ff'];
  const petGlowColor = PET_COLORS_DATA[f.petColorIdx] || '#2a90c8';
  petCard.innerHTML = `
    <div class="fp-pet-emoji-wrap${isLegendary?' fp-pet-emoji-legendary':''}"
         style="filter:drop-shadow(0 0 8px ${petGlowColor}66);">${petEmoji}${hat?`<span style="position:absolute;top:-4px;right:-4px;font-size:14px;">${hat.emoji}</span>`:''}${wand?`<span style="position:absolute;bottom:-4px;right:-8px;font-size:13px;">${wand.emoji}</span>`:''}
    </div>
    <div class="fp-pet-info">
      <div class="fp-pet-name">${escapeHtml(f.petName)} ${collar?collar.emoji:''}</div>
      <div class="fp-pet-level">Nivel ${petLevel} · ${petMood.icon} ${petMood.icon==='🤩'?'¡Feliz!':petMood.icon==='😊'?'Contento':petMood.icon==='😐'?'Normal':'Triste'}</div>
      <div class="fp-pet-hp-bar"><div class="fp-pet-hp-fill" style="width:${f.petHp}%;background:${hpColor};box-shadow:0 0 6px ${hpColor}66;"></div></div>
    </div>
    <div class="fp-pet-mood" style="font-size:22px;">${petMood.icon}</div>
  `;
  container.appendChild(petCard);

  // ── ACTIONS ──
  const actions = document.createElement('div');
  actions.className = 'fp-actions';
  const isGymBro = myGymBroUid === f.uid;
  actions.innerHTML = `
    <button class="fp-action-btn fp-action-chat" onclick="fpOpenChat()">💬 Enviar mensaje</button>
    <button class="fp-action-btn" style="background:${isGymBro ? 'rgba(255,107,53,.25)' : 'rgba(255,107,53,.1)'};border:1.5px solid rgba(255,107,53,.4);color:#ff6b35;" onclick="${isGymBro ? `removeGymBro();closePanel('friend-profile')` : `setGymBro('${f.uid}','${escapeHtml(f.displayName)}','${f.avatar}');renderGymBroSection();closePanel('friend-profile')`}">
      💪 ${isGymBro ? 'Quitar GymBro' : 'Hacer GymBro'}
    </button>
    <button class="fp-action-btn fp-action-remove" onclick="socRemoveFriend('${f.uid}','${escapeHtml(f.displayName)}',event);closePanel('friend-profile');">✕ Eliminar</button>
  `;
  container.appendChild(actions);
}


// ── Remove friend ──
async function socRemoveFriend(friendUid, friendName, e) {
  e?.stopPropagation();
  try {
    const fns = window._fbFns;
    await fns.updateDoc(fbDoc(`users/${myUid()}`), { friends: fns.arrayRemove(friendUid) });
    await fns.updateDoc(fbDoc(`users/${friendUid}`), { friends: fns.arrayRemove(myUid()) });
    showToast(`👋 ${friendName} eliminado de amigos`);
    await loadSocFriends();
  } catch(e) { console.error(e); }
}

// ── Open Chat ──
function getChatId(uid1, uid2) { return [uid1, uid2].sort().join('_'); }

function openSocChat(friendUid, friendName, friendAvatar, e) {
  e?.stopPropagation();
  currentChatFriendId = friendUid;
  document.getElementById('chatFriendName').textContent  = friendName;
  document.getElementById('chatFriendAvatar').textContent = friendAvatar;
  const fXP = myFriends.find(f => f.uid === friendUid)?.xp || 0;
  const xpEl = document.getElementById('chatFriendXP');
  if (xpEl) xpEl.textContent = `🎮 ${makePlayerTag(friendName, friendUid)} · ⭐ ${fXP} XP`;
  const xpSec = document.getElementById('xpCompareSection');
  if (xpSec) xpSec.style.display = 'none';
  // Show GymBros banner if chatting with your gymbro and badge equipped
  const banner = document.getElementById('chatGymBroBanner');
  const gBadge = SHOP_ITEMS.badges.find(b => b.id === 'b16');
  if (banner) {
    const isGymBro = myGymBroUid === friendUid;
    const badgeEquipped = gBadge?.owned && equippedBadgeIds.includes('b16');
    if (isGymBro && badgeEquipped) {
      document.getElementById('chatGymBroText').textContent = `GymBros con ${friendName}`;
      banner.style.display = 'flex';
    } else {
      banner.style.display = 'none';
    }
  }
  openPanel('chat');
  loadChatMessages(friendUid);
}

function loadChatMessages(friendUid) {
  if (!myUid()) return;
  if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; }

  const chatId = getChatId(myUid(), friendUid);
  const { collection, query: q, orderBy, onSnapshot, limit } = window._fbFns;
  const db = window._fbDb;

  const ref = collection(db, `chats/${chatId}/messages`);
  chatUnsubscribe = onSnapshot(
    q(ref, orderBy('timestamp', 'asc'), limit(80)),
    snap => renderChatMessages(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
    err  => console.warn('Chat listener error:', err)
  );
}

function renderChatMessages(msgs) {
  const container = document.getElementById('chatMessages');
  if (!container) return;
  container.innerHTML = '';

  if (msgs.length === 0) {
    container.innerHTML = '<div class="chat-loading">Sin mensajes aún. ¡Di hola! 👋</div>';
    return;
  }

  let lastDate = '';
  msgs.forEach(msg => {
    const isMe  = msg.senderUid === myUid();
    const ts    = msg.timestamp?.toDate ? msg.timestamp.toDate() : new Date();
    const dateStr = ts.toLocaleDateString('es-MX', { weekday:'short', day:'numeric', month:'short' });
    const timeStr = ts.toLocaleTimeString('es-MX', { hour:'2-digit', minute:'2-digit' });

    if (dateStr !== lastDate) {
      lastDate = dateStr;
      const sep = document.createElement('div');
      sep.className = 'chat-date-sep';
      sep.textContent = dateStr;
      container.appendChild(sep);
    }

    const wrap = document.createElement('div');
    wrap.className = `chat-bubble-wrap ${isMe ? 'mine' : 'theirs'}`;
    wrap.innerHTML = `
      <div class="chat-bubble">${escapeHtml(msg.text)}</div>
      <div class="chat-time">${timeStr}</div>
    `;
    container.appendChild(wrap);
  });
  container.scrollTop = container.scrollHeight;
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const text  = input?.value.trim();
  if (!text || !myUid() || !currentChatFriendId) return;
  input.value = '';

  const chatId = getChatId(myUid(), currentChatFriendId);
  try {
    const { collection, addDoc, serverTimestamp } = window._fbFns;
    const db = window._fbDb;
    await addDoc(collection(db, `chats/${chatId}/messages`), {
      text, senderUid: myUid(), senderName: myName(), timestamp: serverTimestamp()
    });
    await fbSet(`chats/${chatId}`, {
      participants: [myUid(), currentChatFriendId],
      lastMessage: text, lastAt: serverTimestamp()
    });
  } catch(e) {
    console.error('Send error:', e);
    showToast('❌ Error al enviar');
    if (input) input.value = text;
  }
}

// ── XP Compare (toggle inside chat) ──
async function openXPCompare(friendUidOverride, e) {
  e?.stopPropagation();
  const friendUid = friendUidOverride || currentChatFriendId;
  if (!friendUid) return;

  const sec = document.getElementById('xpCompareSection');
  if (!sec) return;
  if (sec.style.display === 'block') { sec.style.display = 'none'; return; }
  sec.style.display = 'block';

  const meEl  = document.getElementById('xpCompareMe');
  const friEl = document.getElementById('xpCompareFriend');
  const resEl = document.getElementById('xpCompareResult');
  if (meEl) meEl.innerHTML = '<div style="color:rgba(255,255,255,.3);font-size:11px;">Cargando...</div>';

  try {
    const friendData  = await fbGet(`users/${friendUid}`);
    if (!friendData)  { if (meEl) meEl.innerHTML = '<div style="color:var(--pink)">Sin datos</div>'; return; }

    const myXP   = getWeeklyXPData();
    const themXP = (friendData.weeklyXP && typeof friendData.weeklyXP === 'object')
      ? friendData.weeklyXP : generateMockWeeklyXP(friendData.xp || 0);

    const myTotal   = Object.values(myXP).reduce((a,b)=>a+b, 0);
    const themTotal = Object.values(themXP).reduce((a,b)=>a+b, 0);
    const maxVal    = Math.max(myTotal, themTotal, 1);
    const winner    = myTotal > themTotal ? 'yo' : myTotal < themTotal ? 'friend' : 'tie';
    const fName     = friendData.displayName || 'Amigo';

    if (meEl) meEl.innerHTML = `
      <div class="xp-compare-label">
        <span class="xp-compare-user">Tú (${escapeHtml(myName())})</span>
        <span class="xp-compare-val">⭐ ${myTotal}</span>
      </div>
      <div class="xp-compare-bar-track">
        <div class="xp-compare-bar-fill" style="width:${Math.round(myTotal/maxVal*100)}%;background:var(--teal-light);"></div>
      </div>
    `;
    if (friEl) friEl.innerHTML = `
      <div class="xp-compare-label">
        <span class="xp-compare-user">${escapeHtml(fName)}</span>
        <span class="xp-compare-val" style="color:var(--pink);">⭐ ${themTotal}</span>
      </div>
      <div class="xp-compare-bar-track">
        <div class="xp-compare-bar-fill" style="width:${Math.round(themTotal/maxVal*100)}%;background:var(--pink);"></div>
      </div>
    `;
    if (resEl) {
      const icon = winner==='yo'?'🏆':winner==='friend'?'😤':'🤝';
      const msg  = winner==='yo'?'¡Vas ganando esta semana!':winner==='friend'?`${escapeHtml(fName)} va adelante`:'¡Empate perfecto!';
      resEl.innerHTML  = `${icon} ${msg}`;
      resEl.style.color = winner==='yo'?'var(--green)':winner==='friend'?'var(--pink)':'var(--yellow)';
    }
  } catch(e) {
    console.error('XP compare error:', e);
    if (meEl) meEl.innerHTML = '<div style="color:var(--pink);font-size:11px;">Error al cargar</div>';
  }
}

// ── Weekly XP tracking ──
function getWeeklyXPData() {
  try {
    const stored = localStorage.getItem('weeklyXP');
    if (stored) return JSON.parse(stored);
  } catch(e) {}
  return generateMockWeeklyXP(xp);
}

function generateMockWeeklyXP(totalXP) {
  const base = Math.floor(totalXP / 14);
  const res = {};
  for (let i = 0; i < 7; i++) res[i] = Math.max(0, base + Math.floor(Math.random() * base * 0.8));
  return res;
}

function trackDailyXP(amount) {
  try {
    const dayIdx = (new Date().getDay() + 6) % 7;
    const stored = localStorage.getItem('weeklyXP');
    const weekly = stored ? JSON.parse(stored) : {};
    const weekNum = Math.floor(Date.now() / (7 * 24 * 60 * 60 * 1000));
    if (weekNum !== parseInt(localStorage.getItem('weeklyXPWeek') || '0')) {
      for (let i = 0; i < 7; i++) weekly[i] = 0;
      localStorage.setItem('weeklyXPWeek', weekNum);
    }
    weekly[dayIdx] = (weekly[dayIdx] || 0) + amount;
    localStorage.setItem('weeklyXP', JSON.stringify(weekly));
    const total = Object.values(weekly).reduce((a,b) => a+b, 0);
    if (myUid() && window._fbFns?.updateDoc) {
      window._fbFns.updateDoc(fbDoc(`users/${myUid()}`), {
        weeklyXP: weekly,
        weeklyXPTotal: total,
        weeklyXPWeekNum: weekNum,
      }).catch(() => {});
    }
  } catch(e) {}
}

// Patch updateXP to track daily gains
const _origUpdateXP = window.updateXP;
let _lastXP = 0;
window.updateXP = function() {
  const gained = xp - _lastXP;
  if (gained > 0) trackDailyXP(gained);
  _lastXP = xp;
  if (typeof _origUpdateXP === 'function') _origUpdateXP();
};

// Fire event when user logs in
const _origRestoreData = window.restoreSaveData;
window.restoreSaveData = function(data) {
  if (typeof _origRestoreData === 'function') _origRestoreData(data);
  _lastXP = xp;
  // Show pending badge if any
  setTimeout(async () => {
    if (!myUid()) return;
    const me = await fbGet(`users/${myUid()}`).catch(() => null);
    const pendingCount = (me?.pendingRequests || []).length;
    if (pendingCount > 0) showToast(`👥 Tienes ${pendingCount} solicitud${pendingCount > 1 ? 'es' : ''} de amistad pendiente${pendingCount > 1 ? 's' : ''}`);
  }, 1200);
};

// Also update playerTag on save
const _origBuildSaveData = window.buildSaveData;
if (typeof _origBuildSaveData === 'function') {
  window.buildSaveData = function() {
    const data = _origBuildSaveData();
    if (myUid()) data.playerTag = makePlayerTag(data.displayName, myUid());
    return data;
  };
}


// ── SVG SHOP ICONS ──
const SHOP_SVGS = {
  // Powers
  'p1': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#5edc8a"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/></svg>`,
  'p2': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#f0c040"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
  'p3': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#3a85c4"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
  'p4': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#f0c040"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>`,
  // Avatars
  'a1': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#5edc8a"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
  'a2': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#3a85c4"><rect x="2" y="3" width="20" height="14" rx="2"/><polyline points="8 21 12 17 16 21"/><line x1="9" y1="10" x2="9" y2="14"/><line x1="15" y1="10" x2="15" y2="14"/><line x1="12" y1="7" x2="12" y2="14"/></svg>`,
  'a3': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#e8527a"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>`,
  'a4': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#8b62e0"><circle cx="12" cy="12" r="4"/><path d="M12 2a10 10 0 0 1 0 20"/><path d="M2 12h4"/><path d="M18 12h4"/><ellipse cx="12" cy="12" rx="10" ry="5"/></svg>`,
  'a5': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#f0c040"><path d="M17 3a2 2 0 0 1 4 0v1a7 7 0 0 1-4 6.32V12a5 5 0 0 1-5 5H8v3H6v-3a3 3 0 0 1-3-3v-1a3 3 0 0 1 3-3h1V8a5 5 0 0 1 5-5h2.68A7 7 0 0 1 17 4V3z"/></svg>`,
  'a6': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#e8527a"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10"/><path d="M14 2c2.7 1 4 3 4 5"/><path d="M18 2c1.5 2 2 4 1 6"/><path d="M7 20c-1-2-1-4 0-5"/><path d="M5 17c-1-2-.5-4 1-5"/></svg>`,
  'a7': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#3a85c4"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/><line x1="12" y1="15" x2="12" y2="17"/><circle cx="12" cy="7" r="1"/><line x1="8" y1="15" x2="8" y2="17"/><line x1="16" y1="15" x2="16" y2="17"/></svg>`,
  'a8': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="color:#8b62e0"><path d="M12 3L4 9v6a9 9 0 0 0 16 0V9l-8-6z"/><path d="M9 21v-6a3 3 0 0 1 6 0v6"/></svg>`,
  // Themes
  't_default': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`,
};

const CHAT_EMOJIS = [
  '😀','😂','🥹','😍','🥰','😎','🤩','😜','🤪','😏',
  '😢','😭','😤','🤬','😱','🤯','🥳','🤗','🫡','😴',
  '❤️','🧡','💛','💚','💙','💜','🖤','🤍','💔','❤️‍🔥',
  '🔥','⚡','✨','💫','💥','🌟','⭐','💎','🏆','🎯',
  '👍','👎','👌','🤌','✌️','🤙','💪','🙌','👏','🫶',
  '🎉','🥳','🎊','🎁','🎮','🕹️','🏅','🎖️','🥇','🚀',
  '🌈','🌙','☀️','⛅','🌊','🌺','🌸','🍀','🦋','🐱',
  '😈','👿','💀','☠️','👻','🤖','👾','🎭','🗿','🫠',
  '😤','💯','🆗','🆙','🔝','🆒','❗','❓','‼️','🔞',
  '🤝','🫂','💬','💭','🗣️','👁️','👀','🧠','💡','🔑',
];

function buildChatEmojiGrid() {
  const grid = document.getElementById('chatEmojiGrid');
  if (!grid || grid.children.length > 0) return;
  CHAT_EMOJIS.forEach(em => {
    const btn = document.createElement('div');
    btn.className = 'chat-emoji-item';
    btn.textContent = em;
    btn.onclick = () => insertChatEmoji(em);
    grid.appendChild(btn);
  });
}

function toggleChatEmojiPanel() {
  const panel = document.getElementById('chatEmojiPanel');
  const btn   = document.getElementById('chatEmojiBtn');
  if (!panel) return;
  const open = panel.classList.toggle('open');
  btn?.classList.toggle('active', open);
  if (open) { buildChatEmojiGrid(); }
}

function closeChatEmojiPanel() {
  document.getElementById('chatEmojiPanel')?.classList.remove('open');
  document.getElementById('chatEmojiBtn')?.classList.remove('active');
}

function insertChatEmoji(emoji) {
  const input = document.getElementById('chatInput');
  if (!input) return;
  const start = input.selectionStart ?? input.value.length;
  const end   = input.selectionEnd   ?? input.value.length;
  input.value = input.value.slice(0, start) + emoji + input.value.slice(end);
  const pos = start + emoji.length;
  input.setSelectionRange(pos, pos);
  input.focus();
}

// Close emoji panel when clicking outside
document.addEventListener('click', e => {
  const panel = document.getElementById('chatEmojiPanel');
  const btn   = document.getElementById('chatEmojiBtn');
  if (panel?.classList.contains('open') && !panel.contains(e.target) && e.target !== btn) {
    closeChatEmojiPanel();
  }
}, true);

// ── THEME BACKGROUND SYMBOLS ──
const THEME_SYMBOLS = {
  'Noche':     { syms:['⭐','✦','✧','◆','·','✦'], color:'#3a85c4' },
  'Bosque':    { syms:['🌿','🍃','🌱','🌲','🍀','🌳'], color:'#2e7d4f' },
  'Volcán':    { syms:['🔥','💥','✦','▲','♦','△'], color:'#c0440a' },
  'Galaxia':   { syms:['🔮','✨','💫','⭐','◈','✦'], color:'#6a30c8' },
  'Coral':     { syms:['🌸','💗','✦','◇','✿','❀'], color:'#b8305a' },
  'Océano':    { syms:['🌊','◈','〰','∿','≈','~'], color:'#0e7490' },
  'Aurora':    { syms:['✦','✧','◆','◇','▷','△'], color:'#0fba81' },
  'Carbón':    { syms:['◆','▪','◈','▣','■','□'], color:'#555555' },
  'Sakura':    { syms:['🌸','✿','❀','✦','◇','♡'], color:'#d4688a' },
  'Tormenta':  { syms:['⚡','⛈','◈','▷','⊿','∇'], color:'#4a6fa0' },
  'Desierto':  { syms:['☀','◆','△','▷','◇','✦'], color:'#c8801a' },
  'Ciberpunk': { syms:['⬡','◈','▣','⊞','⌬','◆'], color:'#e040fb' },
  'Sangre':    { syms:['◆','▪','■','◈','✦','◇'], color:'#cc2222' },
  'Hielo':     { syms:['❄','✦','◇','△','◈','✧'], color:'#60c0e8' },
};

let _themeBgContainer = null;

function updateThemeBgSymbols(themeName) {
  // Remove old container
  if (_themeBgContainer) { _themeBgContainer.classList.remove('visible'); setTimeout(() => _themeBgContainer?.remove(), 1000); }

  const info = THEME_SYMBOLS[themeName];
  if (!info) return;

  const container = document.createElement('div');
  container.className = 'theme-bg-symbols';
  _themeBgContainer = container;
  document.body.appendChild(container);

  // Create 18 floating symbols
  const symbols = info.syms;
  for (let i = 0; i < 18; i++) {
    const sym = document.createElement('div');
    sym.className = 'theme-sym';
    sym.textContent = symbols[i % symbols.length];
    const size = 20 + Math.random() * 60;
    const x    = Math.random() * 100;
    const y    = Math.random() * 100;
    const dur  = 8 + Math.random() * 12;
    const mx   = (Math.random() - .5) * 40;
    const my   = (Math.random() - .5) * 40;
    const mx2  = (Math.random() - .5) * 30;
    const my2  = (Math.random() - .5) * 30;
    const r0   = (Math.random() - .5) * 10;
    const r1   = (Math.random() - .5) * 20;
    const r2   = (Math.random() - .5) * 15;
    const op   = .04 + Math.random() * .08;
    sym.style.cssText = `
      left:${x}%; top:${y}%;
      --sz:${size}px; --dur:${dur}s; --op:${op};
      --mx:${mx}px; --my:${my}px; --mx2:${mx2}px; --my2:${my2}px;
      --r0:${r0}deg; --r1:${r1}deg; --r2:${r2}deg;
      color:${info.color};
      animation-delay:${-Math.random()*dur}s;
    `;
    container.appendChild(sym);
  }

  setTimeout(() => container.classList.add('visible'), 50);
}

// Patch applyTheme to also update symbols
const _origApplyTheme = applyTheme;
applyTheme = function(idx) {
  _origApplyTheme(idx);
  updateThemeBgSymbols(THEMES[idx]?.name || '');
};

// Init with default theme symbols
setTimeout(() => updateThemeBgSymbols('Noche'), 500);

// ══════════════════════════════════════════════
// SISTEMA DE HÁBITOS REAL
// ══════════════════════════════════════════════

let habitData = [];
const HABIT_EMOJIS = ['💧','🏃','📚','🧘','🥗','😴','🚶','💪','🎯','✍️','🎨','🌿','🧠','🥤','🚴'];
let selectedHabitEmoji = '💧';

function habitTodayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function habitIsDoneToday(h) { return (h.doneDates||[]).includes(habitTodayKey()); }
function habitGetStreak(h) {
  let streak = 0, today = new Date();
  for (let i = 0; i < 365; i++) {
    const d = new Date(today); d.setDate(today.getDate()-i);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    if ((h.doneDates||[]).includes(key)) streak++; else if (i > 0) break;
  }
  return streak;
}
function habitGetSaveData() {
  return habitData.map(h => ({ id:h.id, name:h.name, icon:h.icon, doneDates:(h.doneDates||[]).slice(-90), createdAt:h.createdAt }));
}
function habitLoadFromData(arr) {
  habitData = (arr||[]).map(h => ({ id:h.id||Date.now(), name:h.name||'Hábito', icon:h.icon||'🌿', doneDates:h.doneDates||[], createdAt:h.createdAt||Date.now() }));
}
function renderHabitsPanel() {
  const content = document.getElementById('habitPanelContent');
  if (!content) return;
  content.innerHTML = '';
  if (habitData.length === 0) {
    content.innerHTML = `<div style="text-align:center;padding:40px 20px;color:rgba(255,255,255,.3);"><div style="font-size:48px;margin-bottom:12px;">🌱</div><div style="font-size:14px;font-weight:700;">Sin hábitos todavía</div><div style="font-size:11px;margin-top:4px;">Toca + para agregar tu primer hábito</div></div>`;
    return;
  }
  const todayDone = habitData.filter(h => habitIsDoneToday(h)).length;
  const pct = Math.round((todayDone / habitData.length) * 100);
  const header = document.createElement('div');
  header.style.cssText = 'background:var(--navy-mid);border-radius:14px;padding:12px 14px;margin-bottom:4px;';
  header.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><span style="color:rgba(255,255,255,.5);font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">Hoy</span><span style="color:var(--green);font-size:12px;font-weight:800;">${todayDone}/${habitData.length} completados</span></div><div style="height:6px;background:rgba(255,255,255,.08);border-radius:6px;overflow:hidden;"><div style="height:100%;width:${pct}%;background:var(--green);border-radius:6px;transition:width .4s;"></div></div>`;
  content.appendChild(header);
  habitData.forEach(h => {
    const done = habitIsDoneToday(h), streak = habitGetStreak(h);
    const item = document.createElement('div');
    item.style.cssText = `background:var(--navy-mid);border-radius:14px;padding:14px;display:flex;align-items:center;gap:12px;cursor:pointer;border:1.5px solid ${done?'var(--green)':'rgba(255,255,255,.07)'};transition:all .2s;touch-action:manipulation;`;
    item.innerHTML = `<div style="font-size:28px;flex-shrink:0;">${h.icon}</div><div style="flex:1;min-width:0;"><div style="color:#fff;font-size:14px;font-weight:700;${done?'opacity:.5;':''}">${h.name}</div><div style="color:rgba(255,255,255,.35);font-size:11px;margin-top:2px;">${streak>0?`🔥 ${streak} días seguidos`:'Sin racha aún'}</div></div><div style="display:flex;flex-direction:column;align-items:center;gap:6px;"><div style="width:32px;height:32px;border-radius:50%;border:2px solid ${done?'var(--green)':'rgba(255,255,255,.2)'};background:${done?'var(--green)':'transparent'};display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .2s;">${done?'✓':''}</div><div style="font-size:10px;color:rgba(255,255,255,.2);cursor:pointer;touch-action:manipulation;padding:4px;" onclick="deleteHabit(${h.id},event)">✕</div></div>`;
    item.onclick = () => toggleHabit(h.id);
    content.appendChild(item);
  });
}
function toggleHabit(id) {
  const h = habitData.find(h => h.id === id);
  if (!h) return;
  const today = habitTodayKey();
  if ((h.doneDates||[]).includes(today)) { h.doneDates = h.doneDates.filter(d => d !== today); }
  else {
    h.doneDates = [...(h.doneDates||[]), today];
    xp += 3; coins += 1; updateXP(); updateCoinDisplay();
    showToast(`+3 XP · +1🪙 ✅ ${h.name}`);
    setTimeout(() => launchConfetti(window.innerWidth/2, window.innerHeight/3), 50);
  }
  if (regData.email) saveAccount();
  if (typeof triggerDailyProgressSave === 'function') triggerDailyProgressSave();
  renderHabitsPanel();
  if (currentPanel === 'stats') setTimeout(initProgPanel, 100);
}
function deleteHabit(id, e) {
  e?.stopPropagation?.();
  habitData = habitData.filter(h => h.id !== id);
  if (regData.email) saveAccount();
  renderHabitsPanel();
  showToast('Hábito eliminado');
}
function openAddHabitModal() {
  document.getElementById('habitModal')?.remove();
  selectedHabitEmoji = HABIT_EMOJIS[0];
  const modal = document.createElement('div');
  modal.id = 'habitModal';
  modal.style.cssText = 'position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.7);display:flex;align-items:flex-end;justify-content:center;touch-action:manipulation;';
  modal.innerHTML = `<div style="background:var(--navy-mid);border-radius:24px 24px 0 0;padding:20px;width:100%;max-width:480px;display:flex;flex-direction:column;gap:12px;"><div style="font-family:'Special Elite',cursive;color:#fff;font-size:17px;text-align:center;margin-bottom:4px;">🌿 Nuevo Hábito</div><input id="habitNameInput" placeholder="Nombre del hábito..." maxlength="40" style="background:rgba(255,255,255,.08);border:1.5px solid rgba(255,255,255,.15);border-radius:12px;padding:12px 14px;color:#fff;font-size:15px;font-family:'Nunito',sans-serif;outline:none;width:100%;"><div style="color:rgba(255,255,255,.4);font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">Ícono</div><div id="habitEmojiGrid" style="display:flex;gap:8px;flex-wrap:wrap;">${HABIT_EMOJIS.map((e,i)=>`<div onclick="selectHabitEmoji('${e}',this)" style="width:38px;height:38px;border-radius:10px;background:rgba(255,255,255,.07);border:2px solid ${i===0?'var(--teal)':'transparent'};display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;touch-action:manipulation;">${e}</div>`).join('')}</div><div style="display:flex;gap:8px;margin-top:4px;"><button onclick="closeHabitModal()" style="flex:1;padding:12px;border-radius:14px;border:1.5px solid rgba(255,255,255,.15);background:transparent;color:rgba(255,255,255,.5);font-size:14px;font-weight:700;cursor:pointer;touch-action:manipulation;">Cancelar</button><button onclick="confirmAddHabit()" style="flex:2;padding:12px;border-radius:14px;border:none;background:var(--teal);color:#fff;font-size:14px;font-weight:800;cursor:pointer;touch-action:manipulation;">Agregar ✓</button></div></div>`;
  modal.onclick = e => { if (e.target === modal) closeHabitModal(); };
  document.body.appendChild(modal);
  setTimeout(() => document.getElementById('habitNameInput')?.focus(), 100);
}
function selectHabitEmoji(emoji, el) {
  selectedHabitEmoji = emoji;
  document.querySelectorAll('#habitEmojiGrid div').forEach(d => d.style.borderColor = 'transparent');
  el.style.borderColor = 'var(--teal)';
}
function closeHabitModal() { document.getElementById('habitModal')?.remove(); }
function confirmAddHabit() {
  const name = document.getElementById('habitNameInput')?.value.trim();
  if (!name) { showToast('Escribe un nombre'); return; }
  habitData.push({ id:Date.now(), name, icon:selectedHabitEmoji||'🌿', doneDates:[], createdAt:Date.now() });
  if (regData.email) saveAccount();
  renderHabitsPanel();
  closeHabitModal();
  showToast(`Hábito "${name}" agregado ✓`);
}

// ══════════════════════════════════════════════
// SINCRONIZACIÓN DIARIA EN FIREBASE
// ══════════════════════════════════════════════
function triggerDailyProgressSave() {
  clearTimeout(window._dpSaveTimer);
  window._dpSaveTimer = setTimeout(saveDailyProgress, 1500);
}
async function saveDailyProgress() {
  const user = window._fbAuth?.currentUser;
  if (!user) return;
  const today = habitTodayKey();
  const todayTasks = (typeof tskData !== 'undefined') ? tskData.filter(t => tskIsToday(t)) : [];
  const jsDay = new Date().getDay(), rutinaIdx = jsDay === 0 ? 6 : jsDay - 1;
  let rutinaItems = [];
  try {
    const rd = getRutinaData(), rc = getRutinaCompleted(), dr = rd[rutinaIdx];
    if (dr && !dr.rest) dr.exercises.forEach((ex,i) => rutinaItems.push({ name:ex.name, icon:ex.icon||'💪', done:!!(rc[`${rutinaIdx}-${i}`]) }));
  } catch(e) {}
  try {
    await window._fbDb.collection('users').doc(user.uid)
      .collection('dailyProgress').doc(today).set({
        date:today,
        tasks: todayTasks.map(t=>({ name:t.name, icon:t.emoji||'📋', done:tskIsDoneToday(t) })),
        habits: habitData.map(h=>({ name:h.name, icon:h.icon, done:habitIsDoneToday(h) })),
        rutina: rutinaItems,
        streak:streakDays, xp,
      }, { merge:true });
  } catch(e) { console.warn('dailyProgress save failed:',e); }
}
async function loadDailyProgressForDate(dateKey) {
  const user = window._fbAuth?.currentUser;
  if (!user) return null;
  try {
    const snap = await window._fbDb.collection('users').doc(user.uid)
      .collection('dailyProgress').doc(dateKey).get();
    return snap.exists ? snap.data() : null;
  } catch(e) { return null; }
}

// Hook rutina save to also save daily progress
const _origSaveRutinaCompleted = saveRutinaCompleted;
saveRutinaCompleted = function(data) { _origSaveRutinaCompleted(data); triggerDailyProgressSave(); };

renderStreakDots();
renderTasks();
syncHomePet();
restoreProfilePhoto();
initCalendar();

// ══════════════════════════════════════════════
// RULETA DE LA SUERTE
// ══════════════════════════════════════════════

// Track luck skin ownership separately (it's a theme/appearance)
window._luckSkinOwned = false;
window._luckSkinEquipped = false;
let rouletteSpins = 0;
let rouletteSpinning = false;
let rouletteAdWatched = 0;

// Roulette segments: weights must sum to 100
const ROULETTE_SEGMENTS = [
  { id:'r_shield',  label:'Escudo de Racha', emoji:'🛡️', color:'#3a85c4', type:'power', powerId:'p1', weight:24 },
  { id:'r_xp',      label:'Doble XP',        emoji:'⚡',  color:'#8b62e0', type:'power', powerId:'p2', weight:24 },
  { id:'r_focus',   label:'Super Focus',     emoji:'🎯', color:'#e8527a', type:'power', powerId:'p3', weight:24 },
  { id:'r_coins',   label:'Boost Monedas',   emoji:'💰',  color:'#f0c040', type:'power', powerId:'p4', weight:24 },
  { id:'r_badge',   label:'Badge Luck 🍀',   emoji:'🍀', color:'#1a5c30', type:'badge',  badgeId:'b17', weight:2 },
  { id:'r_skin',    label:'Apariencia Luck', emoji:'🌿', color:'#0d2818', type:'skin',  weight:2 },
];

function initRoulette() {
  drawRouletteWheel();
  updateRouletteUI();
}

function drawRouletteWheel(highlightIdx = -1) {
  const canvas = document.getElementById('rouletteCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const cx = 150, cy = 150, r = 140;
  const total = ROULETTE_SEGMENTS.reduce((a,s) => a + s.weight, 0);
  let startAngle = -Math.PI / 2;

  ctx.clearRect(0, 0, 300, 300);

  // Shadow
  ctx.save();
  ctx.shadowColor = 'rgba(0,0,0,.6)';
  ctx.shadowBlur = 20;
  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fillStyle='#0d1b3e'; ctx.fill();
  ctx.restore();

  ROULETTE_SEGMENTS.forEach((seg, i) => {
    const angle = (seg.weight / total) * Math.PI * 2;
    const endAngle = startAngle + angle;
    const isHighlighted = i === highlightIdx;

    // Slice
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r - 2, startAngle, endAngle);
    ctx.closePath();
    ctx.fillStyle = seg.color;
    ctx.fill();

    // Highlight overlay
    if (isHighlighted) {
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, r - 2, startAngle, endAngle);
      ctx.closePath();
      ctx.fillStyle = 'rgba(255,255,255,.25)';
      ctx.fill();
    }

    // Border
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r - 2, startAngle, endAngle);
    ctx.closePath();
    ctx.strokeStyle = 'rgba(0,0,0,.3)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Label
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(startAngle + angle / 2);
    ctx.textAlign = 'right';
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 11px Nunito, sans-serif';
    ctx.shadowColor = 'rgba(0,0,0,.8)';
    ctx.shadowBlur = 4;
    ctx.fillText(seg.emoji + ' ' + seg.label.split(' ')[0], r - 8, 4);
    ctx.restore();

    startAngle = endAngle;
  });

  // Center circle
  ctx.beginPath();
  ctx.arc(cx, cy, 22, 0, Math.PI * 2);
  ctx.fillStyle = '#0d1b3e';
  ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,.2)';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Center emoji
  ctx.font = '18px serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('🍀', cx, cy);
}

function skipRouletteAnimation() {
  if (!rouletteSpinning) return;
  rouletteSkipRequested = true;
  // Hide skip button immediately
  const skipBtn = document.getElementById('rouletteSkipBtn');
  if (skipBtn) skipBtn.style.display = 'none';
}

function animateRoulette(targetIdx, fast=false) {
  const canvas = document.getElementById('rouletteCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const total = ROULETTE_SEGMENTS.reduce((a,s) => a + s.weight, 0);
  const cx = 150, cy = 150, r = 140;

  // Calculate angle for target segment center
  let cumAngle = -Math.PI / 2;
  let targetCenter = 0;
  ROULETTE_SEGMENTS.forEach((seg, i) => {
    const angle = (seg.weight / total) * Math.PI * 2;
    if (i === targetIdx) targetCenter = cumAngle + angle / 2;
    cumAngle += angle;
  });

  // We want targetCenter to end at top (pointer at -PI/2)
  // Total spins: 5 full rotations + offset
  const extraSpins = (5 + Math.random() * 3) * Math.PI * 2;
  const finalOffset = (-Math.PI / 2) - targetCenter;
  const totalRotation = extraSpins + finalOffset;

  rouletteCurrentTargetIdx = targetIdx;
  let startTime = null;
  const duration = fast ? 1200 : 4000;

  function ease(t) {
    return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2;
  }

  function frame(ts) {
    // Skip requested — jump to end immediately
    if (rouletteSkipRequested) {
      // Collect all remaining prizes silently and show summary
      while (roulettePrizeQueue.length > 0) {
        collectRoulettePrizeSilent(roulettePrizeQueue.shift());
        roulettePendingSpins--;
      }
      roulettePendingSpins = 0;
      rouletteSkipRequested = false;
      rouletteSpinning = false;
      const skipBtn2 = document.getElementById('rouletteSkipBtn');
      if (skipBtn2) skipBtn2.style.display = 'none';
      showRoulettePrize(targetIdx);
      return;
    }
    if (!startTime) startTime = ts;
    const elapsed = ts - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const currentRotation = ease(progress) * totalRotation;

    // Redraw rotated wheel
    ctx.clearRect(0, 0, 300, 300);
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(currentRotation);
    ctx.translate(-cx, -cy);

    // Draw slices
    let angle = -Math.PI / 2;
    ROULETTE_SEGMENTS.forEach(seg => {
      const sliceAngle = (seg.weight / total) * Math.PI * 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, r - 2, angle, angle + sliceAngle);
      ctx.closePath();
      ctx.fillStyle = seg.color;
      ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,.3)';
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle + sliceAngle / 2);
      ctx.textAlign = 'right';
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 11px Nunito,sans-serif';
      ctx.shadowColor = 'rgba(0,0,0,.8)';
      ctx.shadowBlur = 4;
      ctx.fillText(seg.emoji + ' ' + seg.label.split(' ')[0], r - 8, 4);
      ctx.restore();

      angle += sliceAngle;
    });

    ctx.restore();

    // Center
    ctx.beginPath();
    ctx.arc(cx, cy, 22, 0, Math.PI*2);
    ctx.fillStyle = '#0d1b3e'; ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,.2)'; ctx.lineWidth = 2; ctx.stroke();
    ctx.font = '18px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('🍀', cx, cy);

    if (progress < 1) {
      requestAnimationFrame(frame);
    } else {
      roulettePendingSpins--;
      if (roulettePendingSpins > 0) {
        // More spins queued — collect prize silently then spin again
        collectRoulettePrizeSilent(targetIdx);
        setTimeout(runNextSpin, fast ? 300 : 500);
      } else {
        rouletteSpinning = false;
        const skipBtnEnd = document.getElementById('rouletteSkipBtn');
        if (skipBtnEnd) skipBtnEnd.style.display = 'none';
        showRoulettePrize(targetIdx);
      }
    }
  }
  requestAnimationFrame(frame);
}

function pickRouletteResult() {
  const total = ROULETTE_SEGMENTS.reduce((a,s) => a + s.weight, 0);
  let rand = Math.random() * total;
  for (let i = 0; i < ROULETTE_SEGMENTS.length; i++) {
    rand -= ROULETTE_SEGMENTS[i].weight;
    if (rand <= 0) return i;
  }
  return 0;
}

let rouletteSpinCount = 1;
let roulettePendingSpins = 0;
let roulettePrizeQueue = [];
let rouletteCollectedPrizes = []; // tracks all prizes for summary
let rouletteSkipRequested = false;  // set true when user taps Skip
let rouletteCurrentTargetIdx = -1; // target of current spin

function setSpinCount(n, el) {
  rouletteSpinCount = n;
  document.querySelectorAll('.spin-count-btn').forEach(b => {
    b.style.borderColor = 'rgba(255,255,255,.15)';
    b.style.background = 'rgba(255,255,255,.06)';
  });
  el.style.borderColor = 'rgba(94,220,138,.7)';
  el.style.background = 'linear-gradient(135deg,#2d8a4e,#1a5c30)';
  const label = document.getElementById('spinCountLabel');
  if (label) label.textContent = `🪙 ×${n} — ${n * 10}🪙`;
}

function spinRoulette() {
  if (rouletteSpinning) return;
  const total = rouletteSpinCount * 10;
  if (coins < total) { showToast(`❌ Necesitas ${total}🪙 para ×${rouletteSpinCount} giros`); return; }
  coins -= total;
  updateCoinDisplay();
  if (regData.email) saveAccount();

  // Queue all spin results upfront
  roulettePrizeQueue = [];
  rouletteCollectedPrizes = [];
  for (let i = 0; i < rouletteSpinCount; i++) {
    roulettePrizeQueue.push(pickRouletteResult());
  }

  const btn = document.getElementById('rouletteSpinBtn');
  if (btn) { btn.disabled = true; btn.textContent = '⏳ Girando...'; }
  const adBtn = document.getElementById('rouletteAdSpinBtn');
  if (adBtn) adBtn.disabled = true;
  document.getElementById('roulettePrizeDisplay').style.display = 'none';
  rouletteSkipRequested = false;
  const skipBtn = document.getElementById('rouletteSkipBtn');
  if (skipBtn) skipBtn.style.display = 'block';
  rouletteSpinning = true;
  roulettePendingSpins = rouletteSpinCount;

  runNextSpin();
}

function runNextSpin() {
  if (roulettePrizeQueue.length === 0) return;
  const targetIdx = roulettePrizeQueue.shift();
  // For multi-spin, animate fast after first spin
  const isFirst = roulettePendingSpins === rouletteSpinCount;
  animateRoulette(targetIdx, !isFirst);
}

function spinRouletteAd() {
  if (rouletteSpinning) return;
  // Simulate watching 2 ads
  rouletteAdWatched++;
  if (rouletteAdWatched % 2 !== 0) {
    showToast('📺 Anuncio 1/2 visto... ¡Ve el segundo!');
    document.getElementById('rouletteAdSpinBtn').textContent = '📺 Anuncio 2/2';
    return;
  }
  rouletteAdWatched = 0;
  document.getElementById('rouletteAdSpinBtn').textContent = '📺 Ad spin';

  const btn = document.getElementById('rouletteSpinBtn');
  if (btn) btn.disabled = true;
  const adBtn = document.getElementById('rouletteAdSpinBtn');
  if (adBtn) { adBtn.disabled = true; adBtn.textContent = '⏳ Girando...'; }
  document.getElementById('roulettePrizeDisplay').style.display = 'none';
  rouletteSkipRequested = false;
  const skipBtnAd = document.getElementById('rouletteSkipBtn');
  if (skipBtnAd) skipBtnAd.style.display = 'block';
  rouletteSpinning = true;

  const targetIdx = pickRouletteResult();
  animateRoulette(targetIdx);
}

function showRouletteMultiSummary() {
  const display = document.getElementById('roulettePrizeDisplay');
  if (!display) return;

  const total = rouletteSpinCount;
  const cost = total * 10;
  const legendaries = rouletteCollectedPrizes.filter(p => p.legendary);
  const hasLegendary = legendaries.length > 0;

  let itemsHTML = rouletteCollectedPrizes
    .sort((a,b) => (b.legendary ? 1 : 0) - (a.legendary ? 1 : 0) || b.count - a.count)
    .map(p => `
      <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;
        background:${p.legendary ? 'linear-gradient(135deg,rgba(94,220,138,.1),rgba(45,138,78,.05))' : 'rgba(255,255,255,.04)'};
        border-radius:12px;border:1px solid ${p.legendary ? 'rgba(94,220,138,.3)' : 'rgba(255,255,255,.07)'};
      ">
        <span style="font-size:22px;">${p.emoji}</span>
        <div style="flex:1;">
          <div style="color:${p.legendary ? '#5edc8a' : '#fff'};font-size:13px;font-weight:800;">${p.label}</div>
          ${p.legendary ? '<div style="color:rgba(94,220,138,.6);font-size:10px;font-weight:700;">¡LEGENDARIO! 🍀</div>' : ''}
        </div>
        <div style="
          background:${p.legendary ? 'rgba(94,220,138,.2)' : 'rgba(255,255,255,.1)'};
          color:${p.legendary ? '#5edc8a' : '#fff'};
          font-size:14px;font-weight:900;
          padding:4px 10px;border-radius:10px;
          min-width:36px;text-align:center;
        ">×${p.count}</div>
      </div>`).join('');

  display.innerHTML = `
    <div style="margin-bottom:12px;">
      <div style="color:rgba(255,255,255,.4);font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;">
        📊 Resumen — ${total} giro${total>1?'s':''} · ${cost}🪙
      </div>
      ${hasLegendary ? `<div style="
        background:linear-gradient(135deg,rgba(94,220,138,.12),rgba(45,138,78,.05));
        border:1.5px solid rgba(94,220,138,.4);border-radius:14px;
        padding:10px 14px;margin-bottom:10px;text-align:center;
        animation:luckGlowFade 2s ease-in-out infinite;
      ">
        <div style="font-size:20px;margin-bottom:4px;">🎉🍀🎉</div>
        <div style="color:#5edc8a;font-size:13px;font-weight:900;">¡Obtuviste algo legendario!</div>
      </div>` : ''}
    </div>
    <div style="display:flex;flex-direction:column;gap:7px;">${itemsHTML}</div>
  `;
  display.style.display = 'block';

  if (hasLegendary) {
    launchConfettiBurst(window.innerWidth/2, window.innerHeight/3, {colors:['#5edc8a','#2d8a4e','#a8f0c0','#fff','#00ff88']});
  }
}

function collectRoulettePrizeSilent(idx) {
  const seg = ROULETTE_SEGMENTS[idx];
  let prizeLabel = seg.label;
  let prizeEmoji = seg.emoji;
  let isLegendary = false;

  if (seg.type === 'power') {
    const power = SHOP_ITEMS.poderes.find(p => p.id === seg.powerId);
    if (power) power.qty = (power.qty || 0) + 1;
  } else if (seg.type === 'badge') {
    const badge = SHOP_ITEMS.badges.find(b => b.id === seg.badgeId);
    isLegendary = true;
    if (badge && !badge.owned) {
      badge.owned = true;
      if (!equippedBadgeIds.includes(badge.id) && equippedBadgeIds.length < 3) equippedBadgeIds.push(badge.id);
    } else {
      prizeLabel = 'Escudo de Racha'; prizeEmoji = '🛡️'; isLegendary = false;
      SHOP_ITEMS.poderes[0].qty++;
    }
  } else if (seg.type === 'skin') {
    isLegendary = true;
    if (!window._luckSkinOwned) {
      window._luckSkinOwned = true;
      // Unlock the Luck theme in THEMES array
      const luckThemeIdx = THEMES.findIndex(t => t.luck);
      if (luckThemeIdx !== -1) THEMES[luckThemeIdx].unlocked = true;
    } else {
      prizeLabel = 'Doble XP'; prizeEmoji = '⚡'; isLegendary = false;
      SHOP_ITEMS.poderes[1].qty++;
    }
  }

  // Track for summary
  const existing = rouletteCollectedPrizes.find(p => p.label === prizeLabel);
  if (existing) existing.count++;
  else rouletteCollectedPrizes.push({ label: prizeLabel, emoji: prizeEmoji, count: 1, legendary: isLegendary });

  if (regData.email) saveAccount();
}

function showRoulettePrize(idx) {
  const seg = ROULETTE_SEGMENTS[idx];
  const display = document.getElementById('roulettePrizeDisplay');
  const btn = document.getElementById('rouletteSpinBtn');
  if (btn) { btn.disabled = false; btn.textContent = `🪙 ×${rouletteSpinCount||1} — ${(rouletteSpinCount||1)*10}🪙`; }
  const skipBtnReset = document.getElementById('rouletteSkipBtn');
  if (skipBtnReset) skipBtnReset.style.display = 'none';
  const adBtn2 = document.getElementById('rouletteAdSpinBtn');
  if (adBtn2) { adBtn2.disabled = false; adBtn2.textContent = '📺 Ad spin'; }

  // If multi-spin: collect last prize and show summary
  if (rouletteSpinCount > 1) {
    collectRoulettePrizeSilent(idx);
    showRouletteMultiSummary();
    return;
  }

  let prizeHTML = '';
  let toastMsg = '';

  if (seg.type === 'power') {
    const power = SHOP_ITEMS.poderes.find(p => p.id === seg.powerId);
    if (power) {
      power.qty = (power.qty || 0) + 1;
      if (regData.email) saveAccount();
      toastMsg = `🎉 ¡Ganaste ${seg.emoji} ${power.name}!`;
      prizeHTML = `
        <div style="font-size:48px;margin-bottom:8px;">${seg.emoji}</div>
        <div style="color:#fff;font-size:16px;font-weight:800;margin-bottom:4px;">¡${power.name}!</div>
        <div style="color:rgba(255,255,255,.5);font-size:12px;">${power.desc}</div>
        <div style="color:var(--green);font-size:11px;margin-top:6px;font-weight:700;">Agregado a tu inventario ✓</div>
      `;
    }
  } else if (seg.type === 'badge') {
    const badge = SHOP_ITEMS.badges.find(b => b.id === seg.badgeId);
    if (badge) {
      if (badge.owned) {
        SHOP_ITEMS.poderes[0].qty++;
        toastMsg = '🍀 Ya tienes el badge Luck. ¡Obtuviste un Escudo de Racha!';
        prizeHTML = `<div style="font-size:40px;margin-bottom:8px;">🛡️</div><div style="color:#fff;font-size:14px;font-weight:800;">Ya tienes el Badge Luck</div><div style="color:rgba(255,255,255,.5);font-size:12px;margin-top:4px;">+1 Escudo de Racha como compensación</div>`;
      } else {
        badge.owned = true;
        if (!equippedBadgeIds.includes(badge.id) && equippedBadgeIds.length < 3) {
          equippedBadgeIds.push(badge.id);
        }
        if (regData.email) saveAccount();
        toastMsg = '🍀 ¡INCREÍBLE! ¡Ganaste el Badge Luck! ¡1% de probabilidad!';
        prizeHTML = `
          <div style="font-size:14px;color:rgba(94,220,138,.6);margin-bottom:10px;font-weight:800;text-transform:uppercase;letter-spacing:2px;">¡Premio Legendario!</div>
          <div style="position:relative;display:inline-flex;align-items:center;justify-content:center;width:80px;height:80px;margin-bottom:12px;">
            <div style="position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle,rgba(94,220,138,.45) 0%,transparent 70%);animation:luckGlowFade 2s ease-in-out infinite;"></div>
            <span style="font-size:13px;font-family:'Special Elite',cursive;font-weight:900;color:#5edc8a;letter-spacing:2px;text-align:center;line-height:1.4;text-shadow:0 0 10px rgba(94,220,138,.7);">🍀<br>LUCK<br>🍀</span>
          </div>
          <div style="color:#5edc8a;font-size:15px;font-weight:900;letter-spacing:1px;">¡Badge Luck desbloqueado!</div>
          <div style="color:rgba(255,255,255,.4);font-size:11px;margin-top:6px;">Solo el 1% de jugadores lo tienen ✦</div>
        `;
      }
      if (regData.email) saveAccount();
      launchConfettiBurst(window.innerWidth/2, window.innerHeight/3);
    }
  } else if (seg.type === 'skin') {
    if (window._luckSkinOwned) {
      SHOP_ITEMS.poderes[1].qty++;
      toastMsg = '🌿 Ya tienes la Apariencia Luck. ¡Obtuviste Doble XP!';
      prizeHTML = `<div style="font-size:40px;margin-bottom:8px;">⚡</div><div style="color:#fff;font-size:14px;font-weight:800;">Ya tienes la Apariencia Luck</div><div style="color:rgba(255,255,255,.5);font-size:12px;margin-top:4px;">+1 Doble XP como compensación</div>`;
    } else {
      window._luckSkinOwned = true;
      // Unlock the Luck theme in THEMES array so it can be selected in the grid
      const luckThemeIdx = THEMES.findIndex(t => t.luck);
      if (luckThemeIdx !== -1) THEMES[luckThemeIdx].unlocked = true;
      if (regData.email) saveAccount();
      buildThemeGrid(); // refresh grid to show it as unlocked
      toastMsg = '🌿 ¡INCREÍBLE! ¡Ganaste la Apariencia Luck! ¡1% de probabilidad!';
      prizeHTML = `
        <div style="font-size:14px;color:rgba(255,255,255,.4);margin-bottom:8px;font-weight:800;text-transform:uppercase;letter-spacing:1px;">¡Apariencia Legendaria!</div>
        <div style="position:relative;display:inline-block;margin-bottom:10px;">
          <div style="position:absolute;inset:-10px;border-radius:16px;background:radial-gradient(circle,rgba(94,220,138,.35),transparent 70%);animation:luckGlowFade 1.5s ease-in-out infinite;"></div>
          <div style="
            display:inline-flex;flex-direction:column;align-items:center;gap:6px;padding:14px 22px;
            background:linear-gradient(135deg,#071a10,#0d2818,#1a5c30);
            border:2px solid #5edc8a;border-radius:16px;
            box-shadow:0 0 24px rgba(94,220,138,.4);
          ">
            <div style="font-size:28px;">🍀🌿🍀</div>
            <div style="color:#5edc8a;font-size:14px;font-weight:900;font-family:'Special Elite',cursive;letter-spacing:2px;">LUCK</div>
          </div>
        </div>
        <div style="color:#5edc8a;font-size:14px;font-weight:800;">¡Apariencia exclusiva desbloqueada!</div>
        <div style="color:rgba(255,255,255,.4);font-size:11px;margin-top:4px;">Ve a Apariencia → Luck para equiparla</div>
        <button onclick="const li=THEMES.findIndex(t=>t.luck);if(li!==-1)applyTheme(li);showToast('🍀 Apariencia Luck aplicada!');" style="
          margin-top:10px;padding:8px 18px;border-radius:12px;border:1.5px solid rgba(94,220,138,.5);
          background:linear-gradient(135deg,#2d8a4e,#1a5c30);color:#fff;font-size:12px;font-weight:800;
          cursor:pointer;font-family:'Nunito',sans-serif;touch-action:manipulation;
        ">🍀 Equipar ahora</button>
      `;
    }
  }

  display.innerHTML = prizeHTML;
  display.style.display = 'block';
  if (toastMsg) setTimeout(() => showToast(toastMsg), 300);
  if (seg.type === 'badge' || seg.type === 'skin') {
    setTimeout(() => launchConfetti(window.innerWidth/2, window.innerHeight/3), 400);
    setTimeout(() => launchConfetti(window.innerWidth/4, window.innerHeight/2), 600);
    setTimeout(() => launchConfetti(window.innerWidth*3/4, window.innerHeight/2), 800);
  }
}

function toggleLuckSkin() {
  if (!window._luckSkinOwned) { showToast('🍀 Gira la Ruleta para desbloquearla'); return; }
  // Find Luck theme index in THEMES array
  const luckIdx = THEMES.findIndex(t => t.luck);
  if (luckIdx !== -1) {
    if (activeThemeIdx === luckIdx) {
      // Already active — go back to default
      applyTheme(0);
      window._luckSkinEquipped = false;
    } else {
      applyTheme(luckIdx);
      window._luckSkinEquipped = true;
    }
    if (regData.email) saveAccount();
    syncLuckSkinSection();
  }
}

function applyLuckSkin() {
  document.documentElement.style.setProperty('--navy', '#071a10');
  document.documentElement.style.setProperty('--navy-mid', '#0d2818');
  document.documentElement.style.setProperty('--teal', '#2d8a4e');
  document.documentElement.style.setProperty('--teal-light', '#5edc8a');
  document.body.style.background = '#071a10';
}

function removeLuckSkin() {
  document.documentElement.style.setProperty('--navy', '#0d1b3e');
  document.documentElement.style.setProperty('--navy-mid', '#122050');
  document.documentElement.style.setProperty('--teal', '#2a6496');
  document.documentElement.style.setProperty('--teal-light', '#3a85c4');
  document.body.style.background = '#0d1b3e';
}

function syncLuckSkinSection() {
  // Luck skin is now part of the theme grid — just rebuild it
  buildThemeGrid();
}

function updateRouletteUI() {
  const countEl = document.getElementById('rouletteSpinCount');
  if (countEl) countEl.textContent = rouletteSpins;
}

// Save/restore luck skin with account
const _origBuildSaveDataRoulette = buildSaveData;
buildSaveData = function() {
  const data = _origBuildSaveDataRoulette();
  data.luckSkinOwned   = window._luckSkinOwned   || false;
  data.luckSkinEquipped = window._luckSkinEquipped || false;
  return data;
};

const _origRestoreSaveDataRoulette = window.restoreSaveData || restoreSaveData;
window.restoreSaveData = restoreSaveData = function(data) {
  _origRestoreSaveDataRoulette(data);
  if (data.luckSkinOwned) {
    window._luckSkinOwned = true;
    // Unlock the Luck theme entry so it shows as available in grid
    const luckThemeIdxR = THEMES.findIndex(t => t.luck);
    if (luckThemeIdxR !== -1) THEMES[luckThemeIdxR].unlocked = true;
  }
  if (data.luckSkinEquipped) { window._luckSkinEquipped = true; applyLuckSkin(); }
};

// Draw wheel when ruleta panel opens, sync luck skin on apariencia
const _origOpenPanelRoulette = openPanel;
openPanel = function(id) {
  _origOpenPanelRoulette(id);
  if (id === 'ruleta') setTimeout(initRoulette, 200);
  if (id === 'apariencia') setTimeout(syncLuckSkinSection, 100);
  if (id === 'inventario') setTimeout(() => {
    if (typeof renderInvBadges === 'function') renderInvBadges();
  }, 100);
};

// Add CSS for luck badge and roulette animations
(function() {
  const style = document.createElement('style');
  style.textContent = `
    @keyframes roulettePulse {
      0%,100% { box-shadow: 0 0 10px rgba(94,220,138,.3); transform:scale(1); }
      50% { box-shadow: 0 0 18px rgba(94,220,138,.6); transform:scale(1.08); }
    }
    @keyframes luckPulse {
      0%,100% { opacity:.6; transform:scale(1); }
      50% { opacity:1; transform:scale(1.05); }
    }
    @keyframes luckShimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
    .luck-badge-inv {
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 14px;
      background:linear-gradient(135deg,#0d2818,#1a5c30,#2d8a4e);
      border:2px solid #5edc8a;border-radius:16px;
      box-shadow:0 0 12px rgba(94,220,138,.4);
      font-size:13px;font-weight:900;color:#fff;
      font-family:'Special Elite',cursive;letter-spacing:2px;
      position:relative;overflow:hidden;
    }
    .luck-badge-inv::after {
      content:'';position:absolute;inset:0;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);
      background-size:200% 100%;
      animation:luckShimmer 2.5s linear infinite;
    }
    .luck-skin-card {
      background:linear-gradient(135deg,#071a10,#0d2818,#1a5c30) !important;
      border:2px solid #5edc8a !important;
      box-shadow:0 0 16px rgba(94,220,138,.3) !important;
    }
  `;
  document.head.appendChild(style);
})();

// ── Luck particle effect for luck skin ──
function launchLuckParticles() {
  const emojis = ['🍀','🌿','✨','💚'];
  for (let i = 0; i < 20; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.style.cssText = `
        position:fixed;pointer-events:none;z-index:9998;
        left:${Math.random()*100}vw;top:${100+Math.random()*20}vh;
        font-size:${16+Math.random()*24}px;
        animation:luckFloat ${3+Math.random()*4}s ease-in-out forwards;
        opacity:.7;
      `;
      el.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 7000);
    }, i * 120);
  }
}

// ── Add luckBgFlow to stylesheet ──
(function(){
  const s = document.createElement('style');
  s.textContent = `
    @keyframes luckBgFlow {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes luckFloat {
      0%   { transform: translateY(0) rotate(0deg) scale(1); opacity:.7; }
      100% { transform: translateY(-110vh) rotate(${Math.random()>0.5?'':'-'}${20+Math.random()*40}deg) scale(.5); opacity:0; }
    }
  `;
  document.head.appendChild(s);
})();

// ══════════════════════════════════════════════
// RUTINA — GYMBRO WEEKLY COMPARISON
// ══════════════════════════════════════════════

let rutinaMainTab = 0;

function switchRutinaMainTab(idx) {
  rutinaMainTab = idx;
  const tabMi = document.getElementById('rutinaTabMi');
  const tabVs = document.getElementById('rutinaTabVs');
  const content = document.getElementById('rutinaContent');
  const gbContent = document.getElementById('rutinaGymbroContent');
  if (!tabMi || !tabVs) return;

  if (idx === 0) {
    tabMi.style.color = '#fff'; tabMi.style.borderBottomColor = '#fff';
    tabVs.style.color = 'rgba(255,255,255,.35)'; tabVs.style.borderBottomColor = 'transparent';
    content.style.display = '';
    gbContent.style.display = 'none';
    renderRutina();
  } else {
    tabMi.style.color = 'rgba(255,255,255,.35)'; tabMi.style.borderBottomColor = 'transparent';
    tabVs.style.color = '#fff'; tabVs.style.borderBottomColor = '#fff';
    content.style.display = 'none';
    gbContent.style.display = '';
    renderGymbroComparison();
  }
}

async function renderGymbroComparison() {
  const container = document.getElementById('rutinaGymbroContent');
  if (!container) return;
  container.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,.3);font-size:13px;font-weight:700;">Cargando datos...</div>';

  const gymBroFriend = myGymBroUid ? myFriends.find(f => f.uid === myGymBroUid) : null;

  if (!myGymBroUid || !gymBroFriend) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px 20px;">
        <div style="font-size:48px;margin-bottom:12px;">🥊</div>
        <div style="color:rgba(255,255,255,.6);font-size:14px;font-weight:800;margin-bottom:6px;">Sin GymBro asignado</div>
        <div style="color:rgba(255,255,255,.3);font-size:11px;">Asigna un GymBro desde la sección Social para comparar resultados semanales</div>
      </div>`;
    return;
  }

  // Generate last 7 days keys
  const days = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    days.push({
      key: `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`,
      label: d.toLocaleDateString('es-MX', { weekday:'short', day:'numeric' })
    });
  }

  // Load my data for last 7 days
  let myWeekData = [];
  try {
    const user = window._fbAuth?.currentUser;
    if (user) {
      const snaps = await Promise.all(days.map(d =>
        window._fbDb.collection('users').doc(user.uid).collection('dailyProgress').doc(d.key).get()
          .then(s => s.exists ? { ...s.data(), dateKey: d.key } : null).catch(() => null)
      ));
      myWeekData = snaps.filter(Boolean);
    }
  } catch(e) {}

  // Load gymbro data for last 7 days
  let broWeekData = [];
  try {
    const snaps = await Promise.all(days.map(d =>
      window._fbDb.collection('users').doc(myGymBroUid).collection('dailyProgress').doc(d.key).get()
        .then(s => s.exists ? { ...s.data(), dateKey: d.key } : null).catch(() => null)
    ));
    broWeekData = snaps.filter(Boolean);
  } catch(e) {}

  // Compute weekly stats
  function weekStats(data) {
    const tasksTotal = data.reduce((a,d) => a + (d.tasks||[]).length, 0);
    const tasksDone  = data.reduce((a,d) => a + (d.tasks||[]).filter(t=>t.done).length, 0);
    const habitsTotal = data.reduce((a,d) => a + (d.habits||[]).length, 0);
    const habitsDone  = data.reduce((a,d) => a + (d.habits||[]).filter(h=>h.done).length, 0);
    const rutinaTotal = data.reduce((a,d) => a + (d.rutina||[]).length, 0);
    const rutinaDone  = data.reduce((a,d) => a + (d.rutina||[]).filter(r=>r.done).length, 0);
    const activeDays  = data.filter(d =>
      (d.tasks||[]).some(t=>t.done) || (d.habits||[]).some(h=>h.done) || (d.rutina||[]).some(r=>r.done)
    ).length;
    const maxXP = data.reduce((a,d) => Math.max(a, d.xp||0), 0);
    return { tasksTotal, tasksDone, habitsTotal, habitsDone, rutinaTotal, rutinaDone, activeDays, maxXP };
  }

  const me = weekStats(myWeekData);
  const bro = weekStats(broWeekData);
  const myName = document.getElementById('profileName')?.textContent || 'Tú';
  const broName = gymBroFriend.displayName || 'GymBro';
  const myAvatar = document.getElementById('profileAvatarHome')?.textContent || '🧑';
  const broAvatar = gymBroFriend.avatar || '🧑';

  function barPair(meVal, broVal, label, suffix='') {
    const maxVal = Math.max(meVal, broVal, 1);
    const meW = Math.round((meVal / maxVal) * 100);
    const broW = Math.round((broVal / maxVal) * 100);
    const meWins = meVal > broVal;
    const broWins = broVal > meVal;
    return `
      <div class="gb-stat-row">
        <div class="gb-stat-label">${label}</div>
        <div style="flex:1;display:flex;flex-direction:column;gap:3px;">
          <div style="display:flex;align-items:center;gap:6px;">
            <div class="gb-bar-me" style="width:${meW}%;background:${meWins?'var(--teal)':'rgba(255,255,255,.2)'};"></div>
            <span class="gb-val-me" style="color:${meWins?'var(--teal)':'rgba(255,255,255,.35)'};">${meVal}${suffix}</span>
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            <div class="gb-bar-me" style="width:${broW}%;background:${broWins?'#e8527a':'rgba(255,255,255,.15)'};border-radius:4px;"></div>
            <span class="gb-val-me" style="color:${broWins?'#e8527a':'rgba(255,255,255,.25)'};">${broVal}${suffix}</span>
          </div>
        </div>
        ${meWins ? '<span style="font-size:12px;">🏆</span>' : broWins ? '<span style="font-size:12px;" style="opacity:.4">　</span>' : '<span style="font-size:12px;">🤝</span>'}
      </div>`;
  }

  // Determine overall winner
  let myPoints = 0, broPoints = 0;
  if (me.tasksDone > bro.tasksDone) myPoints++; else if (bro.tasksDone > me.tasksDone) broPoints++;
  if (me.habitsDone > bro.habitsDone) myPoints++; else if (bro.habitsDone > me.habitsDone) broPoints++;
  if (me.rutinaDone > bro.rutinaDone) myPoints++; else if (bro.rutinaDone > me.rutinaDone) broPoints++;
  if (me.activeDays > bro.activeDays) myPoints++; else if (bro.activeDays > me.activeDays) broPoints++;
  const weekWinner = myPoints > broPoints ? 'me' : broPoints > myPoints ? 'bro' : 'tie';

  // Per-day breakdown
  const dayRowsHTML = days.map(d => {
    const myDay = myWeekData.find(x => x.dateKey === d.key);
    const broDay = broWeekData.find(x => x.dateKey === d.key);
    const myDone = (myDay?.tasks||[]).filter(t=>t.done).length + (myDay?.habits||[]).filter(h=>h.done).length + (myDay?.rutina||[]).filter(r=>r.done).length;
    const broDone = (broDay?.tasks||[]).filter(t=>t.done).length + (broDay?.habits||[]).filter(h=>h.done).length + (broDay?.rutina||[]).filter(r=>r.done).length;
    const myWins = myDone > broDone, broWins = broDone > myDone;
    return `
      <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05);">
        <div style="color:rgba(255,255,255,.4);font-size:10px;font-weight:700;width:46px;flex-shrink:0;">${d.label}</div>
        <div style="flex:1;display:flex;gap:4px;align-items:center;">
          <span style="font-size:11px;font-weight:800;color:${myWins?'var(--teal)':'rgba(255,255,255,.3)'};">${myDone}</span>
          <div style="flex:1;height:5px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;display:flex;">
            ${myDone > 0 ? `<div style="width:${Math.round(myDone/(myDone+broDone||1)*100)}%;background:${myWins?'var(--teal)':'rgba(255,255,255,.2)'};"></div>` : ''}
            ${broDone > 0 ? `<div style="width:${Math.round(broDone/(myDone+broDone||1)*100)}%;background:${broWins?'#e8527a':'rgba(232,82,122,.3)'};"></div>` : ''}
          </div>
          <span style="font-size:11px;font-weight:800;color:${broWins?'#e8527a':'rgba(255,255,255,.3)'};">${broDone}</span>
        </div>
        <div style="font-size:14px;width:20px;text-align:center;">${myWins?'🏆':broWins?'💔':'—'}</div>
      </div>`;
  }).join('');

  container.innerHTML = `
    <!-- VS Header -->
    <div class="gb-vs-header">
      <div class="gb-vs-player">
        <div class="gb-vs-avatar">${myAvatar}</div>
        <div class="gb-vs-name">${escapeHtml(myName)}</div>
        <div class="gb-vs-badge" style="color:${weekWinner==='me'?'var(--teal)':'rgba(255,255,255,.3)'};">
          ${weekWinner==='me'?'👑 Ganador':''}${weekWinner==='tie'?'🤝':''}${weekWinner==='bro'?myPoints+' pts':''}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
        <div class="gb-vs-divider">VS</div>
        <div style="font-size:9px;color:rgba(255,255,255,.25);font-weight:700;text-align:center;">Esta semana</div>
      </div>
      <div class="gb-vs-player">
        <div class="gb-vs-avatar">${broAvatar}</div>
        <div class="gb-vs-name">${escapeHtml(broName)}</div>
        <div class="gb-vs-badge" style="color:${weekWinner==='bro'?'#e8527a':'rgba(255,255,255,.3)'};">
          ${weekWinner==='bro'?'👑 Ganador':''}${weekWinner==='tie'?'🤝':''}${weekWinner==='me'?broPoints+' pts':''}
        </div>
      </div>
    </div>

    ${weekWinner !== 'tie' ? `
    <div style="
      text-align:center;padding:10px 16px;border-radius:14px;margin-bottom:14px;
      background:${weekWinner==='me'?'linear-gradient(135deg,rgba(94,220,138,.1),rgba(45,138,78,.05))':'linear-gradient(135deg,rgba(232,82,122,.1),rgba(180,40,80,.05))'};
      border:1px solid ${weekWinner==='me'?'rgba(94,220,138,.3)':'rgba(232,82,122,.3)'};
    ">
      <div style="font-size:13px;font-weight:900;color:${weekWinner==='me'?'#5edc8a':'#e8527a'};">
        ${weekWinner==='me'?`🏆 ¡Vas ganando esta semana!`:`💪 ${escapeHtml(broName)} va adelante`}
      </div>
      <div style="font-size:10px;color:rgba(255,255,255,.35);margin-top:2px;">${myPoints} vs ${broPoints} categorías ganadas</div>
    </div>` : `
    <div style="text-align:center;padding:10px;border-radius:14px;margin-bottom:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);">
      <div style="font-size:13px;font-weight:800;color:rgba(255,255,255,.6);">🤝 Empate esta semana</div>
    </div>`}

    <!-- Stats comparison -->
    <div class="gb-week-row">
      <div class="gb-week-label">
        <span>📊 Comparativa semanal</span>
        <span style="font-size:9px;">
          <span style="color:var(--teal);">■ ${escapeHtml(myName)}</span>
          <span style="color:#e8527a;margin-left:6px;">■ ${escapeHtml(broName)}</span>
        </span>
      </div>
      ${barPair(me.tasksDone, bro.tasksDone, '📋 Tareas')}
      ${barPair(me.habitsDone, bro.habitsDone, '🌿 Hábitos')}
      ${barPair(me.rutinaDone, bro.rutinaDone, '💪 Rutina')}
      ${barPair(me.activeDays, bro.activeDays, '📅 Días activos')}
    </div>

    <!-- Day by day -->
    <div class="gb-week-row">
      <div class="gb-week-label">
        <span>📅 Día a día</span>
        <span>${escapeHtml(myName)} vs ${escapeHtml(broName)}</span>
      </div>
      ${dayRowsHTML}
    </div>

    <button onclick="renderGymbroComparison()" style="
      width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.1);
      background:rgba(255,255,255,.04);color:rgba(255,255,255,.5);
      font-size:12px;font-weight:700;cursor:pointer;touch-action:manipulation;
      font-family:'Nunito',sans-serif;margin-top:4px;
    ">↻ Actualizar datos</button>
  `;
}

// Auto-login: Firebase handles this via onAuthStateChanged in the module script above
// The splash screen will be hidden automatically if a session exists

</script>
</body>
</html>
